<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math â€” Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/cert/certificate.css" />
</head>

<body>
  <div class="app cert-app">
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</span>
          </div>
        </div>

        <a class="btn btn-ghost btn-sm" href="/" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª">Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
      </div>
    </header>

    <main class="container section">
      <div class="cert-shell">
        <!-- Certificate Paper -->
        <section id="certPaper" class="cert-paper" aria-label="Ø´Ù‡Ø§Ø¯Ø©">
          <div class="cert-bg"></div>

          <!-- ØªØ­Ø³ÙŠÙ† Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± CSS: Ø¥Ø·Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠ -->
          <div aria-hidden="true" style="position:absolute; inset:18px; border-radius:14px; border:1px solid rgba(37,99,235,.18); pointer-events:none;"></div>
          <div aria-hidden="true" style="position:absolute; inset:26px; border-radius:12px; border:1px dashed rgba(212,175,55,.35); pointer-events:none;"></div>

          <div class="cert-head">
            <div class="cert-badge" aria-hidden="true">ğŸ…</div>
            <div>
              <h1 class="cert-title">Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</h1>
              <p class="cert-sub">ØªÙÙ…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±Ù‹Ø§ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­</p>
            </div>
          </div>

          <div class="cert-body">
            <p class="cert-line">Ù†ÙØ¨Ø§Ø±Ùƒ Ù„Ù„Ø·Ø§Ù„Ø¨/Ø©</p>
            <div id="certName" class="cert-name">...</div>

            <p class="cert-line">Ø¥ØªÙ…Ø§Ù…</p>
            <div id="certCardTitle" class="cert-card">...</div>

            <div class="cert-meta">
              <div class="cert-meta-item">
                <span class="cert-meta-k">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span>
                <span id="certWeek" class="cert-meta-v">â€”</span>
              </div>
              <div class="cert-meta-item">
                <span class="cert-meta-k">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                <span id="certDate" class="cert-meta-v">â€”</span>
              </div>
              <div class="cert-meta-item">
                <span class="cert-meta-k">Ø§Ù„Ø´Ø¹Ø¨Ø©</span>
                <span id="certClass" class="cert-meta-v">â€”</span>
              </div>
            </div>

            <div class="cert-footer">
              <div class="cert-sign">
                <span class="cert-sign-k">Ø§Ù„Ù…Ø¹Ù„Ù…</span>
                <span class="cert-sign-v">Ø§Ù„Ù…Ø¹Ù„Ù… Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø£Ø­Ù…Ø¯</span>
              </div>
              <div class="cert-stamp" aria-hidden="true">
                <div class="cert-stamp-ring"></div>
                <div class="cert-stamp-text">math</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Actions -->
        <section class="cert-actions">
          <button id="btnDownload" class="btn btn-primary btn-lg w-100">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
          <button id="btnShare" class="btn btn-outline w-100" disabled>Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ (Ù‚Ø±ÙŠØ¨Ù‹Ø§)</button>
          <p class="small center muted">Ø§Ù„Ù…ØµØ¯Ø±: Ø¢Ø®Ø± Ø¥Ù†Ø¬Ø§Ø² Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² (math:lastCertificate)</p>
          <p id="dlHint" class="small center muted hidden">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ùâ€¦</p>
        </section>

        <!-- Fallback message -->
        <section id="certEmpty" class="card hidden">
          <div class="card-header">
            <div>
              <h2 class="h2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø© Ø¨Ø¹Ø¯</h2>
              <p class="p">Ø£Ù†Ù‡Ù Ø¨Ø·Ø§Ù‚Ø© Ø£ÙˆÙ„Ù‹Ø§ØŒ ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ø§Ø±Ø¬Ø¹ Ù„Ù‡ÙˆÙ†.</p>
            </div>
          </div>
          <div class="card-body">
            <a href="/" class="btn btn-primary w-100">Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</a>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const LS_LAST_CERTIFICATE = 'math:lastCertificate';

      const elPaper = document.getElementById('certPaper');
      const elEmpty = document.getElementById('certEmpty');

      const elName = document.getElementById('certName');
      const elCard = document.getElementById('certCardTitle');
      const elWeek = document.getElementById('certWeek');
      const elDate = document.getElementById('certDate');
      const elClass = document.getElementById('certClass');

      const btnDownload = document.getElementById('btnDownload');
      const btnShare = document.getElementById('btnShare');
      const dlHint = document.getElementById('dlHint');

      let currentPayload = null;

      function readPayload() {
        try {
          const raw = localStorage.getItem(LS_LAST_CERTIFICATE);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          return null;
        }
      }

      function fmtDate(iso) {
        try {
          const d = new Date(iso);
          if (isNaN(d.getTime())) return 'â€”';
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
        } catch {
          return 'â€”';
        }
      }

      function safeFileName(s) {
        return String(s || '')
          .trim()
          .replace(/[\\/:*?"<>|]+/g, '')
          .replace(/\s+/g, '_')
          .slice(0, 80);
      }

      function setBusy(isBusy) {
        btnDownload.disabled = isBusy;
        dlHint.classList.toggle('hidden', !isBusy);
        btnDownload.textContent = isBusy ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„â€¦' : 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©';
      }

      // --- RENDER DATA ---
      currentPayload = readPayload();

      if (!currentPayload || !currentPayload.fullName) {
        elPaper.classList.add('hidden');
        elEmpty.classList.remove('hidden');
        btnDownload.disabled = true;
        btnShare.disabled = true;
        return;
      }

      elName.textContent = currentPayload.fullName || currentPayload.firstName || 'â€”';
      elCard.textContent = currentPayload.cardTitle || 'Ø¨Ø·Ø§Ù‚Ø©';
      elWeek.textContent = (currentPayload.week != null) ? String(currentPayload.week) : 'â€”';
      elDate.textContent = fmtDate(currentPayload.issuedAt);
      elClass.textContent = currentPayload.class || 'â€”';

      // --- DOWNLOAD AS IMAGE (PNG) ---
      // We create an SVG foreignObject snapshot with inline computed styles so it looks the same.
      function inlineComputedStyles(rootEl) {
        const all = rootEl.querySelectorAll('*');
        const toCopy = [
          'font', 'fontFamily', 'fontSize', 'fontWeight', 'lineHeight',
          'color', 'textAlign', 'letterSpacing',
          'background', 'backgroundColor', 'backgroundImage',
          'border', 'borderTop', 'borderRight', 'borderBottom', 'borderLeft',
          'borderRadius', 'boxShadow',
          'padding', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
          'margin', 'marginTop', 'marginRight', 'marginBottom', 'marginLeft',
          'display', 'position', 'top', 'right', 'bottom', 'left',
          'width', 'height', 'minWidth', 'minHeight', 'maxWidth', 'maxHeight',
          'alignItems', 'justifyContent', 'gap', 'gridTemplateColumns',
          'overflow', 'opacity', 'transform',
          'direction'
        ];

        // root too
        all.forEach((node) => {
          const cs = window.getComputedStyle(node);
          let style = node.getAttribute('style') || '';
          // prevent duplicate ; formatting issues
          if (style && !style.trim().endsWith(';')) style += ';';

          toCopy.forEach((p) => {
            const v = cs[p];
            if (v && v !== 'initial' && v !== 'none' && v !== 'normal') {
              style += `${kebab(p)}:${v};`;
            }
          });

          // make sure backgrounds render in SVG snapshot
          style += `-webkit-print-color-adjust:exact;print-color-adjust:exact;`;
          node.setAttribute('style', style);
        });

        function kebab(prop) {
          return prop.replace(/[A-Z]/g, (m) => '-' + m.toLowerCase());
        }
      }

      async function nodeToPngBlob(node, scale = 2) {
        // Clone certificate to avoid mutating the real DOM with style inlining
        const clone = node.cloneNode(true);

        // Put clone offscreen to compute styles correctly
        const sandbox = document.createElement('div');
        sandbox.style.position = 'fixed';
        sandbox.style.left = '-10000px';
        sandbox.style.top = '0';
        sandbox.style.width = node.offsetWidth + 'px';
        sandbox.style.pointerEvents = 'none';
        sandbox.style.opacity = '0';
        sandbox.appendChild(clone);
        document.body.appendChild(sandbox);

        // Inline styles
        inlineComputedStyles(clone);

        const width = node.offsetWidth;
        const height = node.offsetHeight;

        const xhtml = new XMLSerializer().serializeToString(clone);
        const svg = `
          <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
            <foreignObject x="0" y="0" width="100%" height="100%">
              <div xmlns="http://www.w3.org/1999/xhtml">${xhtml}</div>
            </foreignObject>
          </svg>
        `.trim();

        document.body.removeChild(sandbox);

        const svgBlob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);

        try {
          const img = await loadImage(url);
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(width * scale);
          canvas.height = Math.round(height * scale);
          const ctx = canvas.getContext('2d');

          // white background
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          ctx.setTransform(scale, 0, 0, scale, 0, 0);
          ctx.drawImage(img, 0, 0);

          return await new Promise((resolve) => {
            canvas.toBlob((b) => resolve(b), 'image/png', 1);
          });
        } finally {
          URL.revokeObjectURL(url);
        }
      }

      function loadImage(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„ØµÙˆØ±Ø©'));
          img.src = url;
        });
      }

      function downloadBlob(blob, filename) {
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 4000);
      }

      btnDownload.addEventListener('click', async () => {
        try {
          setBusy(true);

          const fileBase =
            safeFileName(`Ø´Ù‡Ø§Ø¯Ø©_${currentPayload.fullName}_${currentPayload.week}_${fmtDate(currentPayload.issuedAt)}`) ||
            'certificate';

          const blob = await nodeToPngBlob(elPaper, 2);

          if (!blob) throw new Error('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù');

          downloadBlob(blob, `${fileBase}.png`);
        } catch (e) {
          console.error(e);
          alert('ØµØ§Ø± Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.');
        } finally {
          setBusy(false);
        }
      });

      // placeholder for Phase 2 share
      btnShare.addEventListener('click', () => {});
    })();
  </script>
</body>
</html>
