(function () {
  if (window.customElements && customElements.get('math-field')) return;

  class MathFieldElement extends HTMLElement {
    constructor() {
      super();
      this._value = '';
      this._connected = false;
      this._handleInput = this._handleInput.bind(this);
    }

    connectedCallback() {
      if (this._connected) return;
      this._connected = true;
      this.setAttribute('contenteditable', 'true');
      this.setAttribute('role', 'textbox');
      this.setAttribute('tabindex', '0');
      this.dir = this.getAttribute('dir') || 'ltr';
      this.spellcheck = false;
      this.addEventListener('input', this._handleInput);
      if (this._value) {
        this.textContent = this._value;
      }
    }

    disconnectedCallback() {
      this.removeEventListener('input', this._handleInput);
    }

    _handleInput() {
      this._value = this.textContent || '';
    }

    getValue() {
      return this._value || this.textContent || '';
    }

    setValue(value) {
      this._value = value == null ? '' : String(value);
      this.textContent = this._value;
    }

    executeCommand(command, value) {
      if (command === 'insert') {
        this._insert(String(value ?? ''));
        return;
      }
      if (command === 'deleteBackward') {
        this._backspace();
        return;
      }
      if (command === 'deleteAll') {
        this.setValue('');
      }
    }

    _insert(value) {
      const current = this.getValue();
      this.setValue(`${current}${value}`);
    }

    _backspace() {
      const current = this.getValue();
      this.setValue(current.slice(0, -1));
    }
  }

  window.MathfieldElement = MathFieldElement;
  if (window.customElements) {
    window.customElements.define('math-field', MathFieldElement);
  }
})();
