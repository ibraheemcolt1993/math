math/.github/workflows/azure-static-web-apps-mango-smoke-0ebe00210.yml
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_SMOKE_0EBE00210 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
          action: "upload"
          ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
          # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
          app_location: "public" # App source code path
          api_location: "api" # Api source code path - optional
          output_location: "public" # Built app content directory - optional
          ###### End of Repository/Build Configurations ######

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_SMOKE_0EBE00210 }}
          action: "close"
math/.gitignore
node_modules/
api/node_modules/
server/
.DS_Store
math/api/_migrations/001_card_completions.sql
IF OBJECT_ID('dbo.CardCompletions', 'U') IS NULL
BEGIN
  CREATE TABLE dbo.CardCompletions (
    CompletionId INT IDENTITY(1,1) PRIMARY KEY,
    StudentId NVARCHAR(20) NOT NULL,
    Week INT NOT NULL,
    FinalScore INT NOT NULL,
    CompletedAt DATETIME NOT NULL DEFAULT GETDATE(),
    CONSTRAINT FK_CardCompletions_Students FOREIGN KEY (StudentId)
      REFERENCES dbo.Students(StudentId),
    CONSTRAINT FK_CardCompletions_Weeks FOREIGN KEY (Week)
      REFERENCES dbo.Weeks(Week),
    CONSTRAINT UQ_CardCompletions_StudentWeek UNIQUE (StudentId, Week)
  );

  CREATE INDEX IX_CardCompletions_Week ON dbo.CardCompletions (Week);
  CREATE INDEX IX_CardCompletions_StudentId ON dbo.CardCompletions (StudentId);
END
math/api/_migrations/002_add_week_seq_prereq.sql
IF COL_LENGTH('dbo.Weeks', 'Seq') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD Seq INT NULL;
END

IF COL_LENGTH('dbo.Weeks', 'PrereqWeek') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD PrereqWeek INT NULL;
END

;WITH Ranked AS (
  SELECT Week,
         ROW_NUMBER() OVER (PARTITION BY Grade ORDER BY Week) AS SeqValue
  FROM dbo.Weeks
  WHERE IsDeleted = 0
)
UPDATE w
SET Seq = r.SeqValue
FROM dbo.Weeks w
JOIN Ranked r ON w.Week = r.Week
WHERE w.Seq IS NULL OR w.Seq <> r.SeqValue;

UPDATE dbo.Weeks
SET Seq = 0
WHERE Seq IS NULL;

IF EXISTS (
  SELECT 1
  FROM sys.columns
  WHERE name = 'Seq'
    AND object_id = OBJECT_ID('dbo.Weeks')
    AND is_nullable = 1
)
BEGIN
  ALTER TABLE dbo.Weeks
    ALTER COLUMN Seq INT NOT NULL;
END

IF NOT EXISTS (
  SELECT 1
  FROM sys.indexes
  WHERE name = 'IX_Weeks_Grade_Seq_Active'
    AND object_id = OBJECT_ID('dbo.Weeks')
)
BEGIN
  CREATE UNIQUE INDEX IX_Weeks_Grade_Seq_Active
    ON dbo.Weeks (Grade, Seq)
    WHERE IsDeleted = 0;
END

IF NOT EXISTS (
  SELECT 1
  FROM sys.indexes
  WHERE name = 'IX_Weeks_PrereqWeek'
    AND object_id = OBJECT_ID('dbo.Weeks')
)
BEGIN
  CREATE INDEX IX_Weeks_PrereqWeek
    ON dbo.Weeks (PrereqWeek);
END
math/api/_shared/db.js
const sql = require('mssql');

let pool;

async function getPool() {
  if (pool) {
    return pool;
  }

  const connectionString = process.env.SQL_CONNECTION_STRING;
  if (!connectionString) {
    throw new Error('SQL_CONNECTION_STRING is not set.');
  }

  pool = await sql.connect(connectionString);
  pool.on('error', () => {
    pool = null;
  });
  return pool;
}

module.exports = {
  sql,
  getPool
};
math/api/_shared/http.js
const DEFAULT_HEADERS = {
  'Content-Type': 'application/json; charset=utf-8',
  'Cache-Control': 'no-store'
};

function withHeaders(headers) {
  return { ...DEFAULT_HEADERS, ...(headers || {}) };
}

function response(status, body, headers) {
  return {
    status,
    headers: withHeaders(headers),
    body
  };
}

function ok(data, headers) {
  return response(200, data, headers);
}

function badRequest(message = 'BAD_REQUEST') {
  return response(400, { ok: false, error: message });
}

function unauthorized(message = 'UNAUTHORIZED') {
  return response(401, { ok: false, error: message });
}

function notFound(message = 'NOT_FOUND') {
  return response(404, { ok: false, error: message });
}

function methodNotAllowed(message = 'Method not allowed.') {
  return response(405, { ok: false, error: message });
}

function serverError(error) {
  return response(500, { ok: false, error: 'SERVER_ERROR', detail: error?.message });
}

module.exports = {
  DEFAULT_HEADERS,
  response,
  ok,
  badRequest,
  unauthorized,
  notFound,
  methodNotAllowed,
  serverError
};
math/api/_shared/parse.js
function readJson(req) {
  if (req?.body && typeof req.body === 'object') {
    return req.body;
  }

  if (typeof req?.body === 'string') {
    try {
      return JSON.parse(req.body);
    } catch (error) {
      return null;
    }
  }

  if (req?.rawBody) {
    try {
      return JSON.parse(req.rawBody);
    } catch (error) {
      return null;
    }
  }

  return null;
}

function getQuery(req) {
  return req?.query || {};
}

module.exports = { readJson, getQuery };
math/api/cards/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "cards"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/cards/index.js
const { getPool, sql } = require('../_shared/db');
const { getQuery } = require('../_shared/parse');
const { ok, badRequest, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

module.exports = async function (context, req) {
  try {
    const query = getQuery(req);
    const grade = normalizeDigits(toCleanString(query.grade));
    const classInput = toCleanString(query.class);
    const className = normalizeDigits(classInput);

    if (!grade) {
      context.res = badRequest('grade is required.');
      return;
    }

    const dbPool = await getPool();
    const request = dbPool.request();
    request.input('grade', sql.NVarChar(50), grade);

    const conditions = ['w.IsDeleted = 0', 'w.Grade = @grade'];
    const hasClassFilter = className && className !== 'ALL_CLASSES';

    if (hasClassFilter) {
      request.input('className', sql.NVarChar(50), className);
      conditions.push(`(
        NOT EXISTS (SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week)
        OR EXISTS (
          SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week AND wt.Class = @className
        )
      )`);
    }

    const sqlQuery = `
      SELECT w.Week,
             w.Title,
             w.Grade,
             w.Seq,
             w.PrereqWeek,
             prereq.Seq AS PrereqSeq,
             t.Class
      FROM dbo.Weeks w
      LEFT JOIN dbo.Weeks prereq ON w.PrereqWeek = prereq.Week
      LEFT JOIN dbo.WeekTargets t ON w.Week = t.Week
      WHERE ${conditions.join(' AND ')}
      ORDER BY w.Seq, w.Week
    `;

    const result = await request.query(sqlQuery);

    const cardsByWeek = new Map();
    result.recordset.forEach((row) => {
      if (!cardsByWeek.has(row.Week)) {
        cardsByWeek.set(row.Week, {
          week: row.Week,
          title: row.Title,
          grade: row.Grade,
          seq: row.Seq,
          prereqWeek: row.PrereqWeek ?? null,
          prereqSeq: row.PrereqSeq ?? null,
          classes: []
        });
      }

      if (row.Class) {
        cardsByWeek.get(row.Week).classes.push(row.Class);
      }
    });

    const cards = Array.from(cardsByWeek.values()).map((card) => {
      const uniqueClasses = Array.from(new Set(card.classes));
      return {
        Week: card.week,
        Title: card.title,
        Grade: card.grade,
        Seq: card.seq,
        Classes: uniqueClasses,
        PrereqWeek: card.prereqWeek,
        PrereqSeq: card.prereqSeq
      };
    });

    context.res = ok(cards);
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/health/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "health"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/health/index.js
const { getPool } = require('../_shared/db');
const { ok, response } = require('../_shared/http');

module.exports = async function (context) {
  try {
    const dbPool = await getPool();
    await dbPool.request().query('SELECT 1 AS ok');
    context.res = ok({ ok: true, db: true });
  } catch (error) {
    context.res = response(500, { ok: false, db: false, error: error.message });
  }
};
math/api/host.json
{
  "version": "2.0"
}
math/api/mng-card-completions/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "mng/cards/{week:int}/completions"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-card-completions/index.js
const { getPool, sql } = require('../_shared/db');
const { getQuery } = require('../_shared/parse');
const { ok, badRequest, notFound, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

module.exports = async function (context, req) {
  try {
    const weekParam = Number(req.params.week);
    if (!Number.isInteger(weekParam)) {
      context.res = badRequest('week must be a valid integer.');
      return;
    }

    const query = getQuery(req);
    const classInput = toCleanString(query.class);
    const className = normalizeDigits(classInput);
    const hasClassFilter = className && className !== 'ALL_CLASSES';

    const dbPool = await getPool();
    const weekCheck = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query('SELECT Week FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!weekCheck.recordset.length) {
      context.res = notFound('Card not found.');
      return;
    }

    const request = dbPool.request();
    request.input('week', sql.Int, weekParam);

    let sqlQuery = `
      SELECT c.StudentId,
             s.Name AS FullName,
             s.Class,
             c.FinalScore,
             c.CompletedAt
      FROM dbo.CardCompletions c
      JOIN dbo.Students s ON s.StudentId = c.StudentId
      WHERE c.Week = @week
    `;

    if (hasClassFilter) {
      request.input('className', sql.NVarChar(50), className);
      sqlQuery += ' AND s.Class = @className';
    }

    sqlQuery += ' ORDER BY c.CompletedAt DESC, s.Name, s.StudentId';

    const result = await request.query(sqlQuery);

    context.res = ok({ ok: true, students: result.recordset });
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/mng-cards/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "post", "put", "delete"],
      "route": "mng/cards/{week?}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-cards/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson, getQuery } = require('../_shared/parse');
const { ok, badRequest, notFound, methodNotAllowed, serverError } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function parseWeek(value) {
  const cleaned = normalizeDigits(toCleanString(value));
  if (!cleaned || !/^\d+$/.test(cleaned)) return null;
  const parsed = Number.parseInt(cleaned, 10);
  return Number.isInteger(parsed) ? parsed : null;
}

function parseOptionalWeek(value) {
  if (value === null || value === undefined || value === '') return null;
  return parseWeek(value);
}

function normalizeClassList(value) {
  if (!Array.isArray(value)) return [];
  const seen = new Set();
  value.forEach((entry) => {
    const cleaned = normalizeDigits(toCleanString(entry));
    if (!cleaned) return;
    seen.add(cleaned);
  });
  return Array.from(seen);
}

async function renumberSeq(transaction, grade) {
  if (!grade) return;
  await new sql.Request(transaction)
    .input('grade', sql.NVarChar(50), grade)
    .query(
      `WITH Ranked AS (
         SELECT Week,
                ROW_NUMBER() OVER (ORDER BY Seq, Week) AS SeqValue
         FROM dbo.Weeks
         WHERE Grade = @grade AND IsDeleted = 0
       )
       UPDATE w
       SET Seq = r.SeqValue
       FROM dbo.Weeks w
       JOIN Ranked r ON w.Week = r.Week;`
    );
}

async function handleGet(context, req) {
  const query = getQuery(req);
  const grade = normalizeDigits(toCleanString(query.grade));
  const classInput = toCleanString(query.class);
  const className = normalizeDigits(classInput);
  const q = toCleanString(query.q);
  const search = q ? `%${normalizeDigits(q)}%` : '';

  const dbPool = await getPool();
  const request = dbPool.request();

  const conditions = ['w.IsDeleted = 0'];

  if (grade) {
    request.input('grade', sql.NVarChar(50), grade);
    conditions.push('w.Grade = @grade');
  }

  if (search) {
    request.input('q', sql.NVarChar(200), search);
    conditions.push('(CAST(w.Week AS NVARCHAR(20)) LIKE @q OR CAST(w.Seq AS NVARCHAR(20)) LIKE @q OR w.Title LIKE @q)');
  }

  const hasClassFilter = className && className !== 'ALL_CLASSES';
  if (hasClassFilter) {
    request.input('className', sql.NVarChar(50), className);
    conditions.push(`(
      NOT EXISTS (SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week)
      OR EXISTS (
        SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week AND wt.Class = @className
      )
    )`);
  } else if (className) {
    request.input('className', sql.NVarChar(50), className);
  }

  const countFilters = [];
  if (grade) {
    countFilters.push('s.Grade = @grade');
  }
  if (hasClassFilter) {
    countFilters.push('s.Class = @className');
  }

  let sqlQuery = `
    SELECT w.Week,
           w.Title,
           w.Grade,
           w.Seq,
           w.PrereqWeek,
           prereq.Seq AS PrereqSeq,
           prereq.Title AS PrereqTitle,
           t.Class,
           cc.CompletedCount
    FROM dbo.Weeks w
    LEFT JOIN dbo.Weeks prereq ON w.PrereqWeek = prereq.Week
    LEFT JOIN dbo.WeekTargets t ON w.Week = t.Week
    LEFT JOIN (
      SELECT c.Week, COUNT(*) AS CompletedCount
      FROM dbo.CardCompletions c
      JOIN dbo.Students s ON s.StudentId = c.StudentId
      ${countFilters.length ? `WHERE ${countFilters.join(' AND ')}` : ''}
      GROUP BY c.Week
    ) cc ON w.Week = cc.Week
  `;

  if (conditions.length) {
    sqlQuery += ` WHERE ${conditions.join(' AND ')}`;
  }

  sqlQuery += ' ORDER BY w.Grade, w.Seq';

  const result = await request.query(sqlQuery);

  const cardsByWeek = new Map();
  result.recordset.forEach((row) => {
    if (!cardsByWeek.has(row.Week)) {
      cardsByWeek.set(row.Week, {
        week: row.Week,
        title: row.Title,
        grade: row.Grade,
        seq: row.Seq,
        prereqWeek: row.PrereqWeek ?? null,
        prereqSeq: row.PrereqSeq ?? null,
        prereqTitle: row.PrereqTitle ?? null,
        classes: [],
        completedCount: row.CompletedCount ?? 0
      });
    }

    if (row.Class) {
      cardsByWeek.get(row.Week).classes.push(row.Class);
    }
  });

  const cards = Array.from(cardsByWeek.values()).map((card) => {
    const uniqueClasses = Array.from(new Set(card.classes));
    return {
      week: card.week,
      title: card.title,
      grade: card.grade,
      seq: card.seq,
      prereqWeek: card.prereqWeek,
      prereqSeq: card.prereqSeq,
      prereqTitle: card.prereqTitle,
      classes: uniqueClasses,
      completedCount: card.completedCount,
      isAllClasses: uniqueClasses.length === 0
    };
  });

  context.res = ok({ ok: true, cards });
}

async function handlePost(context, req) {
  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const requestedWeek = parseWeek(payload.week);
  const title = toCleanString(payload.title);
  const grade = normalizeDigits(toCleanString(payload.grade));
  const allClasses = Boolean(payload.allClasses);
  const classes = allClasses ? [] : normalizeClassList(payload.classes);
  const prereqWeekRaw = payload.prereqWeek;
  const prereqWeek = parseOptionalWeek(prereqWeekRaw);

  if (payload.week != null && !requestedWeek) {
    context.res = badRequest('week must be a valid integer.');
    return;
  }

  if (prereqWeekRaw !== undefined && prereqWeekRaw !== null && prereqWeekRaw !== '' && prereqWeek === null) {
    context.res = badRequest('prereqWeek must be a valid integer or null.');
    return;
  }

  if (!title) {
    context.res = badRequest('title is required.');
    return;
  }

  if (!grade) {
    context.res = badRequest('grade is required.');
    return;
  }

  const dbPool = await getPool();
  let week = requestedWeek;

  if (week) {
    const existing = await dbPool
      .request()
      .input('week', sql.Int, week)
      .query('SELECT Week FROM dbo.Weeks WHERE Week = @week');

    if (existing.recordset.length) {
      context.res = badRequest('week already exists.');
      return;
    }
  } else {
    const maxResult = await dbPool.request().query('SELECT ISNULL(MAX(Week), 0) AS maxWeek FROM dbo.Weeks');
    week = (maxResult.recordset[0]?.maxWeek || 0) + 1;
  }

  if (prereqWeek != null) {
    if (prereqWeek === week) {
      context.res = badRequest('prereqWeek cannot match week.');
      return;
    }

    const prereqResult = await dbPool
      .request()
      .input('week', sql.Int, prereqWeek)
      .query('SELECT Week, Grade FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!prereqResult.recordset.length) {
      context.res = badRequest('prereqWeek does not exist.');
      return;
    }

    if (normalizeDigits(prereqResult.recordset[0].Grade) !== grade) {
      context.res = badRequest('prereqWeek must belong to the same grade.');
      return;
    }
  }

  const seqResult = await dbPool
    .request()
    .input('grade', sql.NVarChar(50), grade)
    .query('SELECT ISNULL(MAX(Seq), 0) AS maxSeq FROM dbo.Weeks WHERE Grade = @grade AND IsDeleted = 0');

  const nextSeq = (seqResult.recordset[0]?.maxSeq || 0) + 1;

  const transaction = new sql.Transaction(dbPool);
  try {
    await transaction.begin();

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .input('title', sql.NVarChar(200), title)
      .input('grade', sql.NVarChar(50), grade)
      .input('seq', sql.Int, nextSeq)
      .input('prereqWeek', sql.Int, prereqWeek)
      .query(
        `INSERT INTO dbo.Weeks (Week, Title, Grade, Seq, PrereqWeek, IsDeleted)
         VALUES (@week, @title, @grade, @seq, @prereqWeek, 0);`
      );

    for (const classValue of classes) {
      await new sql.Request(transaction)
        .input('week', sql.Int, week)
        .input('className', sql.NVarChar(50), classValue)
        .query(
          `INSERT INTO dbo.WeekTargets (Week, Class)
           VALUES (@week, @className);`
        );
    }

    await transaction.commit();
    context.res = ok({ ok: true, week, seq: nextSeq });
  } catch (error) {
    await transaction.rollback();
    context.res = serverError(error);
  }
}

async function handlePut(context, req) {
  const week = parseWeek(req.params?.week);
  if (!week) {
    context.res = badRequest('week must be a valid integer.');
    return;
  }

  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const title = toCleanString(payload.title);
  const grade = normalizeDigits(toCleanString(payload.grade));
  const allClasses = Boolean(payload.allClasses);
  const classes = allClasses ? [] : normalizeClassList(payload.classes);
  const prereqWeekRaw = payload.prereqWeek;
  const prereqWeek = parseOptionalWeek(prereqWeekRaw);

  if (prereqWeekRaw !== undefined && prereqWeekRaw !== null && prereqWeekRaw !== '' && prereqWeek === null) {
    context.res = badRequest('prereqWeek must be a valid integer or null.');
    return;
  }

  if (!title) {
    context.res = badRequest('title is required.');
    return;
  }

  if (!grade) {
    context.res = badRequest('grade is required.');
    return;
  }

  if (prereqWeek === week) {
    context.res = badRequest('prereqWeek cannot match week.');
    return;
  }

  const dbPool = await getPool();
  const existing = await dbPool
    .request()
    .input('week', sql.Int, week)
    .query('SELECT Week, Grade, Seq FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!existing.recordset.length) {
    context.res = notFound('Card not found.');
    return;
  }

  const current = existing.recordset[0];
  const previousGrade = normalizeDigits(current.Grade);
  const gradeChanged = previousGrade !== grade;

  if (prereqWeek != null) {
    const prereqResult = await dbPool
      .request()
      .input('week', sql.Int, prereqWeek)
      .query('SELECT Week, Grade FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!prereqResult.recordset.length) {
      context.res = badRequest('prereqWeek does not exist.');
      return;
    }

    if (normalizeDigits(prereqResult.recordset[0].Grade) !== grade) {
      context.res = badRequest('prereqWeek must belong to the same grade.');
      return;
    }
  }

  let nextSeq = current.Seq;
  if (gradeChanged) {
    const seqResult = await dbPool
      .request()
      .input('grade', sql.NVarChar(50), grade)
      .query('SELECT ISNULL(MAX(Seq), 0) AS maxSeq FROM dbo.Weeks WHERE Grade = @grade AND IsDeleted = 0');
    nextSeq = (seqResult.recordset[0]?.maxSeq || 0) + 1;
  }

  const transaction = new sql.Transaction(dbPool);
  try {
    await transaction.begin();

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .input('title', sql.NVarChar(200), title)
      .input('grade', sql.NVarChar(50), grade)
      .input('seq', sql.Int, nextSeq)
      .input('prereqWeek', sql.Int, prereqWeek)
      .query(
        `UPDATE dbo.Weeks
         SET Title = @title,
             Grade = @grade,
             Seq = @seq,
             PrereqWeek = @prereqWeek
         WHERE Week = @week AND IsDeleted = 0;`
      );

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query('DELETE FROM dbo.WeekTargets WHERE Week = @week;');

    for (const classValue of classes) {
      await new sql.Request(transaction)
        .input('week', sql.Int, week)
        .input('className', sql.NVarChar(50), classValue)
        .query(
          `INSERT INTO dbo.WeekTargets (Week, Class)
           VALUES (@week, @className);`
        );
    }

    if (gradeChanged) {
      await renumberSeq(transaction, previousGrade);
      await renumberSeq(transaction, grade);
    }

    await transaction.commit();
    context.res = ok({ ok: true });
  } catch (error) {
    await transaction.rollback();
    context.res = serverError(error);
  }
}

async function handleDelete(context, req) {
  const week = parseWeek(req.params?.week);
  if (!week) {
    context.res = badRequest('week must be a valid integer.');
    return;
  }

  const dbPool = await getPool();
  const existing = await dbPool
    .request()
    .input('week', sql.Int, week)
    .query('SELECT Week, Grade FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!existing.recordset.length) {
    context.res = notFound('Card not found.');
    return;
  }

  const grade = normalizeDigits(existing.recordset[0].Grade);
  const transaction = new sql.Transaction(dbPool);

  try {
    await transaction.begin();

    const result = await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query(
        `UPDATE dbo.Weeks
         SET IsDeleted = 1
         WHERE Week = @week AND IsDeleted = 0;
         SELECT @@ROWCOUNT AS affected;`
      );

    const affected = result.recordset[0]?.affected || 0;
    if (!affected) {
      await transaction.rollback();
      context.res = notFound('Card not found.');
      return;
    }

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query('UPDATE dbo.Weeks SET PrereqWeek = NULL WHERE PrereqWeek = @week;');

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query('DELETE FROM dbo.WeekTargets WHERE Week = @week;');

    await renumberSeq(transaction, grade);

    await transaction.commit();
    context.res = ok({ ok: true });
  } catch (error) {
    await transaction.rollback();
    context.res = serverError(error);
  }
}

module.exports = async function (context, req) {
  try {
    switch (req.method) {
      case 'GET':
        await handleGet(context, req);
        return;
      case 'POST':
        await handlePost(context, req);
        return;
      case 'PUT':
        await handlePut(context, req);
        return;
      case 'DELETE':
        await handleDelete(context, req);
        return;
      default:
        context.res = methodNotAllowed();
    }
  } catch (error) {
    context.res = serverError(error);
  }
};
math/api/mng-students/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "post", "put", "delete"],
      "route": "mng/students/{studentId?}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-students/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson, getQuery } = require('../_shared/parse');
const { ok, badRequest, notFound, methodNotAllowed, serverError } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function normalizeGrade(value) {
  const cleaned = normalizeDigits(toCleanString(value));
  if (!cleaned) return '';
  if (/^[1-9]$/.test(cleaned)) return cleaned;

  let text = cleaned.replace(/\s+/g, '');
  text = text.replace(/^الصف/, '').replace(/^صف/, '').replace(/^ال/, '');
  text = text.replace(/[أإآ]/g, 'ا');

  const gradeMap = {
    اول: '1',
    ثاني: '2',
    ثالث: '3',
    رابع: '4',
    خامس: '5',
    سادس: '6',
    سابع: '7',
    ثامن: '8',
    تاسع: '9'
  };

  return gradeMap[text] || cleaned;
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function isValidBirthYear(value) {
  return /^\d{4}$/.test(value);
}

function deriveFirstName(name) {
  const parts = toCleanString(name).split(/\s+/).filter(Boolean);
  if (!parts.length) return '';
  if (parts[0] === 'عبد' && parts[1]) {
    return `عبد ${parts[1]}`;
  }
  return parts[0];
}

function normalizeDateString(value) {
  const cleaned = normalizeDigits(toCleanString(value));
  if (!cleaned) return '';
  const match = cleaned.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!match) return '';
  return `${match[1]}-${match[2]}-${match[3]}`;
}

async function handleGet(context, req) {
  const query = getQuery(req);
  const q = typeof query.q === 'string' ? query.q.trim() : '';
  const search = q ? `%${normalizeDigits(q)}%` : '';

  const dbPool = await getPool();
  const request = dbPool.request();
  let sqlQuery =
    'SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class FROM dbo.Students';

  if (search) {
    request.input('q', sql.NVarChar(200), search);
    sqlQuery += ' WHERE StudentId LIKE @q OR Name LIKE @q';
  }

  sqlQuery += ' ORDER BY Grade, Class, Name, StudentId';

  const result = await request.query(sqlQuery);
  context.res = ok({ ok: true, students: result.recordset });
}

async function handlePost(context, req) {
  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const studentId = normalizeDigits(toCleanString(payload.studentId));
  const birthYear = normalizeDigits(toCleanString(payload.birthYear));
  const name = toCleanString(payload.name);
  const birthDateValue = toCleanString(payload.birthDate);
  const birthDateInput = normalizeDateString(birthDateValue);
  let firstName = toCleanString(payload.firstName);
  const grade = payload.grade != null ? normalizeGrade(payload.grade) : '';
  const className = payload.class != null ? normalizeDigits(toCleanString(payload.class)) : '';

  if (!studentId) {
    context.res = badRequest('studentId is required.');
    return;
  }

  if (!birthYear || !isValidBirthYear(birthYear)) {
    context.res = badRequest('birthYear must be a 4-digit year.');
    return;
  }

  if (!name) {
    context.res = badRequest('name is required.');
    return;
  }

  if (birthDateValue && !birthDateInput) {
    context.res = badRequest('birthDate must be in YYYY-MM-DD format.');
    return;
  }

  if (!firstName) {
    firstName = deriveFirstName(name);
  }

  const birthDate = birthDateInput || `${birthYear}-01-01`;

  const dbPool = await getPool();
  const existingResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .query('SELECT StudentId FROM dbo.Students WHERE StudentId = @studentId');

  if (existingResult.recordset.length) {
    context.res = badRequest('studentId already exists.');
    return;
  }

  const insertResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .input('birthYear', sql.NVarChar(10), birthYear)
    .input('name', sql.NVarChar(200), name)
    .input('firstName', sql.NVarChar(100), firstName)
    .input('birthDate', sql.Date, birthDate)
    .input('grade', sql.NVarChar(50), grade)
    .input('className', sql.NVarChar(50), className)
    .query(
      `INSERT INTO dbo.Students (StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class)
       VALUES (@studentId, @birthYear, @name, @firstName, @birthDate, @grade, @className);
       SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class
       FROM dbo.Students
       WHERE StudentId = @studentId;`
    );

  context.res = ok({ ok: true, student: insertResult.recordset[0] });
}

async function handlePut(context, req) {
  const studentId = normalizeDigits(toCleanString(req.params?.studentId));
  if (!studentId) {
    context.res = badRequest('studentId is required.');
    return;
  }

  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const dbPool = await getPool();
  const existingResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .query('SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class FROM dbo.Students WHERE StudentId = @studentId');

  if (!existingResult.recordset.length) {
    context.res = notFound('Student not found.');
    return;
  }

  const existing = existingResult.recordset[0];
  const birthYear = payload.birthYear != null
    ? normalizeDigits(toCleanString(payload.birthYear))
    : existing.BirthYear;
  const name = payload.name != null ? String(payload.name).trim() : existing.Name;
  const incomingFirstName = payload.firstName != null ? String(payload.firstName).trim() : '';
  let firstName = payload.firstName != null ? incomingFirstName : existing.FirstName;
  if (payload.name != null && !incomingFirstName) {
    firstName = deriveFirstName(name);
  }
  const grade = payload.grade != null ? normalizeGrade(payload.grade) : existing.Grade;
  const className = payload.class != null ? normalizeDigits(toCleanString(payload.class)) : existing.Class;
  const birthDateValue = payload.birthDate != null ? toCleanString(payload.birthDate) : '';
  let birthDate = existing.BirthDate;

  if (!birthYear || !isValidBirthYear(birthYear)) {
    context.res = badRequest('birthYear must be a 4-digit year.');
    return;
  }

  if (!name) {
    context.res = badRequest('name is required.');
    return;
  }

  if (payload.birthDate != null) {
    const normalizedBirthDate = normalizeDateString(birthDateValue);
    if (birthDateValue && !normalizedBirthDate) {
      context.res = badRequest('birthDate must be in YYYY-MM-DD format.');
      return;
    }
    birthDate = normalizedBirthDate || `${birthYear}-01-01`;
  }

  const updateResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .input('birthYear', sql.NVarChar(10), birthYear)
    .input('name', sql.NVarChar(200), name)
    .input('firstName', sql.NVarChar(100), firstName)
    .input('birthDate', sql.Date, birthDate)
    .input('grade', sql.NVarChar(50), grade)
    .input('className', sql.NVarChar(50), className)
    .query(
      `UPDATE dbo.Students
       SET BirthYear = @birthYear,
           Name = @name,
           FirstName = @firstName,
           BirthDate = @birthDate,
           Grade = @grade,
           Class = @className
       WHERE StudentId = @studentId;
       SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class
       FROM dbo.Students
       WHERE StudentId = @studentId;`
    );

  context.res = ok({ ok: true, student: updateResult.recordset[0] });
}

async function handleDelete(context, req) {
  const studentId = normalizeDigits(toCleanString(req.params?.studentId));
  if (!studentId) {
    context.res = badRequest('studentId is required.');
    return;
  }

  const dbPool = await getPool();
  const result = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .query(
      `DELETE FROM dbo.Students
       WHERE StudentId = @studentId;
       SELECT @@ROWCOUNT AS affected;`
    );

  const affected = result.recordset[0]?.affected || 0;
  if (!affected) {
    context.res = notFound('Student not found.');
    return;
  }

  context.res = ok({ ok: true });
}

module.exports = async function (context, req) {
  try {
    switch (req.method) {
      case 'GET':
        await handleGet(context, req);
        return;
      case 'POST':
        await handlePost(context, req);
        return;
      case 'PUT':
        await handlePut(context, req);
        return;
      case 'DELETE':
        await handleDelete(context, req);
        return;
      default:
        context.res = methodNotAllowed();
    }
  } catch (error) {
    context.res = serverError(error);
  }
};
math/api/mng-week-content/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "put"],
      "route": "mng/weeks/{week:int}/content"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-week-content/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson } = require('../_shared/parse');
const { ok, badRequest, notFound, methodNotAllowed, response } = require('../_shared/http');

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function toNullableString(value) {
  const cleaned = toCleanString(value);
  return cleaned ? cleaned : null;
}

function toNullableInt(value) {
  if (value === null || value === undefined || value === '') return null;
  const parsed = Number(value);
  return Number.isFinite(parsed) ? parsed : null;
}

async function fetchWeekContent(dbPool, weekParam) {
  const weekResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query('SELECT Week, Title, Seq FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!weekResult.recordset.length) {
    return null;
  }

  const goalsResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query(
      'SELECT GoalId, Week, SortOrder, GoalText FROM dbo.WeekGoals WHERE Week = @week ORDER BY SortOrder'
    );

  const prerequisitesResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query(
      'SELECT PrerequisiteId, Week, SortOrder, PrerequisiteText FROM dbo.WeekPrerequisites WHERE Week = @week ORDER BY SortOrder'
    );

  const conceptsResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query('SELECT ConceptId, Week, SortOrder, Title FROM dbo.Concepts WHERE Week = @week ORDER BY SortOrder');

  const conceptIds = conceptsResult.recordset.map((concept) => concept.ConceptId);
  let flowItemsResult = { recordset: [] };
  let flowDetailsResult = { recordset: [] };
  let flowHintsResult = { recordset: [] };
  let flowChoicesResult = { recordset: [] };

  if (conceptIds.length) {
    const inClause = conceptIds.map((_, index) => `@concept${index}`).join(',');
    const flowRequest = dbPool.request();
    conceptIds.forEach((id, index) => {
      flowRequest.input(`concept${index}`, sql.Int, id);
    });

    flowItemsResult = await flowRequest.query(
      `SELECT FlowItemId, ConceptId, SortOrder, ItemType, ItemText, ItemTitle, ItemDescription, ItemUrl, Answer, CorrectIndex, Solution
       FROM dbo.FlowItems
       WHERE ConceptId IN (${inClause})
       ORDER BY ConceptId, SortOrder`
    );

    const flowItemIds = flowItemsResult.recordset.map((item) => item.FlowItemId);
    if (flowItemIds.length) {
      const itemClause = flowItemIds.map((_, index) => `@item${index}`).join(',');
      const detailRequest = dbPool.request();
      flowItemIds.forEach((id, index) => {
        detailRequest.input(`item${index}`, sql.Int, id);
      });

      flowDetailsResult = await detailRequest.query(
        `SELECT FlowItemDetailId, FlowItemId, SortOrder, DetailText
         FROM dbo.FlowItemDetails
         WHERE FlowItemId IN (${itemClause})
         ORDER BY FlowItemId, SortOrder`
      );

      const hintRequest = dbPool.request();
      flowItemIds.forEach((id, index) => {
        hintRequest.input(`item${index}`, sql.Int, id);
      });

      flowHintsResult = await hintRequest.query(
        `SELECT FlowItemHintId, FlowItemId, SortOrder, HintText
         FROM dbo.FlowItemHints
         WHERE FlowItemId IN (${itemClause})
         ORDER BY FlowItemId, SortOrder`
      );

      const choiceRequest = dbPool.request();
      flowItemIds.forEach((id, index) => {
        choiceRequest.input(`item${index}`, sql.Int, id);
      });

      flowChoicesResult = await choiceRequest.query(
        `SELECT FlowItemChoiceId, FlowItemId, SortOrder, ChoiceText
         FROM dbo.FlowItemChoices
         WHERE FlowItemId IN (${itemClause})
         ORDER BY FlowItemId, SortOrder`
      );
    }
  }

  const assessmentsResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query(
      'SELECT AssessmentId, Week, Title, Description FROM dbo.Assessments WHERE Week = @week ORDER BY AssessmentId'
    );

  const assessmentIds = assessmentsResult.recordset.map(
    (assessment) => assessment.AssessmentId
  );
  let assessmentQuestionsResult = { recordset: [] };
  let assessmentChoicesResult = { recordset: [] };

  if (assessmentIds.length) {
    const assessmentClause = assessmentIds.map((_, index) => `@assessment${index}`).join(',');
    const assessmentRequest = dbPool.request();
    assessmentIds.forEach((id, index) => {
      assessmentRequest.input(`assessment${index}`, sql.Int, id);
    });

    assessmentQuestionsResult = await assessmentRequest.query(
      `SELECT AssessmentQuestionId, AssessmentId, SortOrder, QuestionType, QuestionText, Answer, Points, CorrectIndex
       FROM dbo.AssessmentQuestions
       WHERE AssessmentId IN (${assessmentClause})
       ORDER BY AssessmentId, SortOrder`
    );

    const questionIds = assessmentQuestionsResult.recordset.map(
      (question) => question.AssessmentQuestionId
    );

    if (questionIds.length) {
      const questionClause = questionIds.map((_, index) => `@question${index}`).join(',');
      const questionRequest = dbPool.request();
      questionIds.forEach((id, index) => {
        questionRequest.input(`question${index}`, sql.Int, id);
      });

      assessmentChoicesResult = await questionRequest.query(
        `SELECT AssessmentChoiceId, AssessmentQuestionId, SortOrder, ChoiceText
         FROM dbo.AssessmentQuestionChoices
         WHERE AssessmentQuestionId IN (${questionClause})
         ORDER BY AssessmentQuestionId, SortOrder`
      );
    }
  }

  const detailsByItem = new Map();
  flowDetailsResult.recordset.forEach((detail) => {
    if (!detailsByItem.has(detail.FlowItemId)) {
      detailsByItem.set(detail.FlowItemId, []);
    }
    detailsByItem.get(detail.FlowItemId).push(detail);
  });

  const hintsByItem = new Map();
  flowHintsResult.recordset.forEach((hint) => {
    if (!hintsByItem.has(hint.FlowItemId)) {
      hintsByItem.set(hint.FlowItemId, []);
    }
    hintsByItem.get(hint.FlowItemId).push(hint);
  });

  const choicesByItem = new Map();
  flowChoicesResult.recordset.forEach((choice) => {
    if (!choicesByItem.has(choice.FlowItemId)) {
      choicesByItem.set(choice.FlowItemId, []);
    }
    choicesByItem.get(choice.FlowItemId).push(choice);
  });

  const flowItemsByConcept = new Map();
  flowItemsResult.recordset.forEach((item) => {
    if (!flowItemsByConcept.has(item.ConceptId)) {
      flowItemsByConcept.set(item.ConceptId, []);
    }
    flowItemsByConcept.get(item.ConceptId).push({
      item,
      details: detailsByItem.get(item.FlowItemId) || [],
      hints: hintsByItem.get(item.FlowItemId) || [],
      choices: choicesByItem.get(item.FlowItemId) || []
    });
  });

  const concepts = conceptsResult.recordset.map((concept) => ({
    concept,
    flow: flowItemsByConcept.get(concept.ConceptId) || []
  }));

  const choicesByQuestion = new Map();
  assessmentChoicesResult.recordset.forEach((choice) => {
    if (!choicesByQuestion.has(choice.AssessmentQuestionId)) {
      choicesByQuestion.set(choice.AssessmentQuestionId, []);
    }
    choicesByQuestion.get(choice.AssessmentQuestionId).push(choice);
  });

  const questionsByAssessment = new Map();
  assessmentQuestionsResult.recordset.forEach((question) => {
    if (!questionsByAssessment.has(question.AssessmentId)) {
      questionsByAssessment.set(question.AssessmentId, []);
    }
    questionsByAssessment.get(question.AssessmentId).push({
      question,
      choices: choicesByQuestion.get(question.AssessmentQuestionId) || []
    });
  });

  const assessments = assessmentsResult.recordset.map((assessment) => ({
    assessment,
    questions: questionsByAssessment.get(assessment.AssessmentId) || []
  }));

  const weekData = weekResult.recordset[0];
  const goals = goalsResult.recordset.map((goal) => goal.GoalText);
  const prerequisites = prerequisitesResult.recordset.map(
    (prereq) => prereq.PrerequisiteText
  );

  const normalizedConcepts = concepts.map(({ concept, flow }) => ({
    title: concept.Title,
    flow: flow.map(({ item, details, hints, choices }) => {
      const type = String(item.ItemType || '').trim().toLowerCase();
      const mapped = {
        type,
        text: item.ItemText,
        title: item.ItemTitle,
        description: item.ItemDescription,
        url: item.ItemUrl,
        answer: item.Answer,
        correctIndex: item.CorrectIndex,
        solution: item.Solution,
        details: details.map((detail) => detail.DetailText),
        hints: hints.map((hint) => hint.HintText),
        choices: choices.map((choice) => choice.ChoiceText)
      };

      if (!mapped.details.length) delete mapped.details;
      if (!mapped.hints.length) delete mapped.hints;
      if (!mapped.choices.length) delete mapped.choices;

      return mapped;
    })
  }));

  const normalizedAssessments = assessments.map(({ assessment, questions }) => ({
    title: assessment.Title,
    description: assessment.Description,
    questions: questions.map(({ question, choices }) => {
      const rawType = String(question.QuestionType || '').trim().toLowerCase();
      const choiceTexts = choices.map((choice) => choice.ChoiceText);
      let type = rawType;
      if (!['mcq', 'input'].includes(type)) {
        type = choiceTexts.length ? 'mcq' : 'input';
      }

      const normalized = {
        type,
        text: question.QuestionText,
        points: Number.isFinite(question.Points) ? question.Points : 1
      };

      if (type === 'mcq') {
        normalized.choices = choiceTexts;
        normalized.correctIndex =
          typeof question.CorrectIndex === 'number' ? question.CorrectIndex : 0;
      } else {
        normalized.answer = question.Answer ?? '';
      }

      return normalized;
    })
  }));

  return {
    week: weekData.Week,
    seq: weekData.Seq,
    title: weekData.Title,
    goals,
    prerequisites,
    concepts: normalizedConcepts,
    assessment: normalizedAssessments[0] || null
  };
}

async function handleGet(context, weekParam) {
  const dbPool = await getPool();
  const payload = await fetchWeekContent(dbPool, weekParam);

  if (!payload) {
    context.res = notFound('Week not found.');
    return;
  }

  context.res = ok(payload);
}

async function handlePut(context, req, weekParam) {
  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const dbPool = await getPool();
  const existing = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query('SELECT Week FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!existing.recordset.length) {
    context.res = notFound('Week not found.');
    return;
  }

  const goals = Array.isArray(payload.goals) ? payload.goals : [];
  const prerequisites = Array.isArray(payload.prerequisites) ? payload.prerequisites : [];
  const concepts = Array.isArray(payload.concepts) ? payload.concepts : [];
  const assessment = payload.assessment ?? null;

  const transaction = new sql.Transaction(dbPool);
  try {
    await transaction.begin();

    await new sql.Request(transaction)
      .input('week', sql.Int, weekParam)
      .query(
        `DELETE FROM dbo.FlowItemDetails
         WHERE FlowItemId IN (
           SELECT FlowItemId FROM dbo.FlowItems
           WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week)
         );
         DELETE FROM dbo.FlowItemHints
         WHERE FlowItemId IN (
           SELECT FlowItemId FROM dbo.FlowItems
           WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week)
         );
         DELETE FROM dbo.FlowItemChoices
         WHERE FlowItemId IN (
           SELECT FlowItemId FROM dbo.FlowItems
           WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week)
         );
         DELETE FROM dbo.FlowItems
         WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week);
         DELETE FROM dbo.Concepts WHERE Week = @week;
         DELETE FROM dbo.WeekGoals WHERE Week = @week;
         DELETE FROM dbo.WeekPrerequisites WHERE Week = @week;
         DELETE FROM dbo.AssessmentQuestionChoices
         WHERE AssessmentQuestionId IN (
           SELECT AssessmentQuestionId FROM dbo.AssessmentQuestions
           WHERE AssessmentId IN (SELECT AssessmentId FROM dbo.Assessments WHERE Week = @week)
         );
         DELETE FROM dbo.AssessmentQuestions
         WHERE AssessmentId IN (SELECT AssessmentId FROM dbo.Assessments WHERE Week = @week);
         DELETE FROM dbo.Assessments WHERE Week = @week;`
      );

    for (let i = 0; i < goals.length; i += 1) {
      const text = toCleanString(goals[i]);
      if (!text) continue;
      await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('sortOrder', sql.Int, i + 1)
        .input('goalText', sql.NVarChar(500), text)
        .query(
          `INSERT INTO dbo.WeekGoals (Week, SortOrder, GoalText)
           VALUES (@week, @sortOrder, @goalText);`
        );
    }

    for (let i = 0; i < prerequisites.length; i += 1) {
      const text = toCleanString(prerequisites[i]);
      if (!text) continue;
      await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('sortOrder', sql.Int, i + 1)
        .input('prereqText', sql.NVarChar(500), text)
        .query(
          `INSERT INTO dbo.WeekPrerequisites (Week, SortOrder, PrerequisiteText)
           VALUES (@week, @sortOrder, @prereqText);`
        );
    }

    for (let i = 0; i < concepts.length; i += 1) {
      const concept = concepts[i] || {};
      const conceptTitle = toCleanString(concept.title);
      const conceptResult = await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('sortOrder', sql.Int, i + 1)
        .input('title', sql.NVarChar(200), conceptTitle)
        .query(
          `INSERT INTO dbo.Concepts (Week, SortOrder, Title)
           OUTPUT INSERTED.ConceptId AS ConceptId
           VALUES (@week, @sortOrder, @title);`
        );

      const conceptId = conceptResult.recordset[0]?.ConceptId;
      const flow = Array.isArray(concept.flow) ? concept.flow : [];

      for (let j = 0; j < flow.length; j += 1) {
        const flowItem = flow[j] || {};
        const type = toCleanString(flowItem.type).toLowerCase();
        const itemResult = await new sql.Request(transaction)
          .input('conceptId', sql.Int, conceptId)
          .input('sortOrder', sql.Int, j + 1)
          .input('itemType', sql.NVarChar(50), type)
          .input('itemText', sql.NVarChar(sql.MAX), toNullableString(flowItem.text))
          .input('itemTitle', sql.NVarChar(200), toNullableString(flowItem.title))
          .input('itemDescription', sql.NVarChar(sql.MAX), toNullableString(flowItem.description))
          .input('itemUrl', sql.NVarChar(500), toNullableString(flowItem.url))
          .input('answer', sql.NVarChar(sql.MAX), toNullableString(flowItem.answer))
          .input('correctIndex', sql.Int, toNullableInt(flowItem.correctIndex))
          .input('solution', sql.NVarChar(sql.MAX), toNullableString(flowItem.solution))
          .query(
            `INSERT INTO dbo.FlowItems (
               ConceptId,
               SortOrder,
               ItemType,
               ItemText,
               ItemTitle,
               ItemDescription,
               ItemUrl,
               Answer,
               CorrectIndex,
               Solution
             )
             OUTPUT INSERTED.FlowItemId AS FlowItemId
             VALUES (
               @conceptId,
               @sortOrder,
               @itemType,
               @itemText,
               @itemTitle,
               @itemDescription,
               @itemUrl,
               @answer,
               @correctIndex,
               @solution
             );`
          );

        const flowItemId = itemResult.recordset[0]?.FlowItemId;
        const details = Array.isArray(flowItem.details) ? flowItem.details : [];
        const hints = Array.isArray(flowItem.hints) ? flowItem.hints : [];
        const choices = Array.isArray(flowItem.choices) ? flowItem.choices : [];

        for (let k = 0; k < details.length; k += 1) {
          const text = toCleanString(details[k]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('itemId', sql.Int, flowItemId)
            .input('sortOrder', sql.Int, k + 1)
            .input('detailText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.FlowItemDetails (FlowItemId, SortOrder, DetailText)
               VALUES (@itemId, @sortOrder, @detailText);`
            );
        }

        for (let k = 0; k < hints.length; k += 1) {
          const text = toCleanString(hints[k]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('itemId', sql.Int, flowItemId)
            .input('sortOrder', sql.Int, k + 1)
            .input('hintText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.FlowItemHints (FlowItemId, SortOrder, HintText)
               VALUES (@itemId, @sortOrder, @hintText);`
            );
        }

        for (let k = 0; k < choices.length; k += 1) {
          const text = toCleanString(choices[k]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('itemId', sql.Int, flowItemId)
            .input('sortOrder', sql.Int, k + 1)
            .input('choiceText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.FlowItemChoices (FlowItemId, SortOrder, ChoiceText)
               VALUES (@itemId, @sortOrder, @choiceText);`
            );
        }
      }
    }

    if (assessment) {
      const assessmentTitle = toCleanString(assessment.title);
      const assessmentDescription = toNullableString(assessment.description);
      const assessmentResult = await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('title', sql.NVarChar(200), assessmentTitle)
        .input('description', sql.NVarChar(sql.MAX), assessmentDescription)
        .query(
          `INSERT INTO dbo.Assessments (Week, Title, Description)
           OUTPUT INSERTED.AssessmentId AS AssessmentId
           VALUES (@week, @title, @description);`
        );

      const assessmentId = assessmentResult.recordset[0]?.AssessmentId;
      const questions = Array.isArray(assessment.questions) ? assessment.questions : [];

      for (let i = 0; i < questions.length; i += 1) {
        const question = questions[i] || {};
        const questionType = toCleanString(question.type).toLowerCase() || 'input';
        const questionText = toCleanString(question.text);
        const points = toNullableInt(question.points) ?? 1;
        const answer = questionType === 'input' ? toNullableString(question.answer) : null;
        const correctIndex = questionType === 'mcq' ? toNullableInt(question.correctIndex) : null;

        const questionResult = await new sql.Request(transaction)
          .input('assessmentId', sql.Int, assessmentId)
          .input('sortOrder', sql.Int, i + 1)
          .input('questionType', sql.NVarChar(50), questionType)
          .input('questionText', sql.NVarChar(sql.MAX), questionText)
          .input('answer', sql.NVarChar(sql.MAX), answer)
          .input('points', sql.Int, points)
          .input('correctIndex', sql.Int, correctIndex)
          .query(
            `INSERT INTO dbo.AssessmentQuestions (
               AssessmentId,
               SortOrder,
               QuestionType,
               QuestionText,
               Answer,
               Points,
               CorrectIndex
             )
             OUTPUT INSERTED.AssessmentQuestionId AS AssessmentQuestionId
             VALUES (
               @assessmentId,
               @sortOrder,
               @questionType,
               @questionText,
               @answer,
               @points,
               @correctIndex
             );`
          );

        const questionId = questionResult.recordset[0]?.AssessmentQuestionId;
        const choices = Array.isArray(question.choices) ? question.choices : [];

        for (let j = 0; j < choices.length; j += 1) {
          const text = toCleanString(choices[j]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('questionId', sql.Int, questionId)
            .input('sortOrder', sql.Int, j + 1)
            .input('choiceText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.AssessmentQuestionChoices (AssessmentQuestionId, SortOrder, ChoiceText)
               VALUES (@questionId, @sortOrder, @choiceText);`
            );
        }
      }
    }

    await transaction.commit();
    context.res = ok({ ok: true });
  } catch (error) {
    await transaction.rollback();
    context.res = response(500, { ok: false, error: error.message });
  }
}

module.exports = async function (context, req) {
  const weekParam = Number(req.params.week);
  if (!Number.isInteger(weekParam)) {
    context.res = badRequest('Invalid week parameter.');
    return;
  }

  try {
    switch (req.method) {
      case 'GET':
        await handleGet(context, weekParam);
        return;
      case 'PUT':
        await handlePut(context, req, weekParam);
        return;
      default:
        context.res = methodNotAllowed();
    }
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/package.json
{
  "name": "math-api",
  "version": "1.0.0",
  "private": true,
  "description": "Azure Functions API for Math app",
  "main": "index.js",
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "mssql": "^10.0.2"
  }
}
math/api/progress-complete/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["post"],
      "route": "progress/complete"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/progress-complete/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson } = require('../_shared/parse');
const { ok, badRequest, notFound, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };

  return String(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

module.exports = async function (context, req) {
  try {
    const payload = readJson(req);
    if (!payload) {
      context.res = badRequest('Invalid JSON body.');
      return;
    }

    const studentId =
      typeof payload.studentId === 'string'
        ? normalizeDigits(payload.studentId).trim()
        : '';
    const week = Number(payload.week);
    const finalScore = Number(payload.finalScore);

    if (!studentId) {
      context.res = badRequest('studentId is required.');
      return;
    }

    if (!Number.isInteger(week)) {
      context.res = badRequest('week must be an integer.');
      return;
    }

    if (!Number.isInteger(finalScore) || finalScore < 0 || finalScore > 100) {
      context.res = badRequest('finalScore must be an integer between 0 and 100.');
      return;
    }

    const dbPool = await getPool();

    const studentResult = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .query('SELECT StudentId FROM dbo.Students WHERE StudentId = @studentId');

    if (!studentResult.recordset.length) {
      context.res = notFound('Student not found.');
      return;
    }

    const weekResult = await dbPool
      .request()
      .input('week', sql.Int, week)
      .query('SELECT Week FROM dbo.Weeks WHERE Week = @week');

    if (!weekResult.recordset.length) {
      context.res = notFound('Week not found.');
      return;
    }

    const completionResult = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .input('week', sql.Int, week)
      .input('finalScore', sql.Int, finalScore)
      .query(
        `IF EXISTS (SELECT 1 FROM dbo.CardCompletions WHERE StudentId = @studentId AND Week = @week)
         BEGIN
           UPDATE dbo.CardCompletions
           SET FinalScore = @finalScore,
               CompletedAt = GETDATE()
           WHERE StudentId = @studentId AND Week = @week;
         END
         ELSE
         BEGIN
           INSERT INTO dbo.CardCompletions (StudentId, Week, FinalScore)
           VALUES (@studentId, @week, @finalScore);
         END

         SELECT StudentId, Week, FinalScore, CompletedAt
         FROM dbo.CardCompletions
         WHERE StudentId = @studentId AND Week = @week;`
      );

    const record = completionResult.recordset[0];

    context.res = ok({
      ok: true,
      studentId: record.StudentId,
      week: record.Week,
      finalScore: record.FinalScore,
      completedAt: record.CompletedAt
    });
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/progress-completed/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "progress/completed"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/progress-completed/index.js
const { getPool, sql } = require('../_shared/db');
const { getQuery } = require('../_shared/parse');
const { ok, badRequest, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };

  return String(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

module.exports = async function (context, req) {
  try {
    const query = getQuery(req);
    const studentId =
      typeof query.studentId === 'string' ? normalizeDigits(query.studentId).trim() : '';

    if (!studentId) {
      context.res = badRequest('studentId is required.');
      return;
    }

    const dbPool = await getPool();
    const result = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .query(
        'SELECT Week, FinalScore, CompletedAt FROM dbo.CardCompletions WHERE StudentId = @studentId ORDER BY CompletedAt DESC'
      );

    context.res = ok(result.recordset);
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/routes/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "routes"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/routes/index.js
const { ok } = require('../_shared/http');

const ROUTES = {
  official: [
    { methods: ['GET'], path: '/api/health', description: 'Health check.' },
    { methods: ['POST'], path: '/api/progress/complete', description: 'Record student completion.' },
    { methods: ['GET'], path: '/api/progress/completed', description: 'Fetch completed progress.' },
    { methods: ['POST'], path: '/api/students/login', description: 'Student login.' },
    { methods: ['GET'], path: '/api/mng/students', description: 'List students for management.' },
    { methods: ['POST'], path: '/api/mng/students', description: 'Create student (management).' },
    { methods: ['PUT'], path: '/api/mng/students/{studentId}', description: 'Update student (management).' },
    { methods: ['DELETE'], path: '/api/mng/students/{studentId}', description: 'Delete student (management).' },
    { methods: ['GET'], path: '/api/mng/cards', description: 'List cards for management.' },
    { methods: ['POST'], path: '/api/mng/cards', description: 'Create card (management).' },
    { methods: ['PUT'], path: '/api/mng/cards/{week}', description: 'Update card (management).' },
    { methods: ['DELETE'], path: '/api/mng/cards/{week}', description: 'Delete card (management).' },
    { methods: ['GET'], path: '/api/mng/cards/{week}/completions', description: 'List card completions (management).' },
    { methods: ['GET'], path: '/api/mng/weeks/{week}/content', description: 'Fetch week content (management).' },
    { methods: ['PUT'], path: '/api/mng/weeks/{week}/content', description: 'Update week content (management).' },
    { methods: ['GET'], path: '/api/cards', description: 'Cards list.' },
    { methods: ['GET'], path: '/api/weeks/{week:int}', description: 'Week details.' },
    { methods: ['GET'], path: '/api/weeks', description: 'Weeks list.' },
    { methods: ['GET'], path: '/api/routes', description: 'Route catalog.' }
  ],
  aliases: []
};

module.exports = async function (context) {
  context.res = ok({ ok: true, routes: ROUTES });
};
math/api/student-login/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["post"],
      "route": "students/login"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/student-login/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson } = require('../_shared/parse');
const { ok, badRequest, unauthorized, response } = require('../_shared/http');

function toLatinDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function deriveFirstName(firstName, fullName) {
  const trimmedFirst = typeof firstName === 'string' ? firstName.trim() : '';
  if (trimmedFirst) {
    return trimmedFirst;
  }

  const trimmedFull = typeof fullName === 'string' ? fullName.trim() : '';
  if (!trimmedFull) {
    return '';
  }

  return trimmedFull.split(/\s+/)[0];
}

module.exports = async function (context, req) {
  try {
    const payload = readJson(req);
    if (!payload) {
      context.res = badRequest('Invalid JSON body.');
      return;
    }

    const studentId =
      typeof payload.studentId === 'string' ? toLatinDigits(payload.studentId).trim() : '';
    const birthYear =
      typeof payload.birthYear === 'string' ? toLatinDigits(payload.birthYear).trim() : '';

    if (!studentId || !birthYear) {
      context.res = badRequest('studentId and birthYear are required.');
      return;
    }

    const dbPool = await getPool();
    const result = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .input('birthYear', sql.NVarChar(10), birthYear)
      .query(
        `SELECT TOP (1) StudentId, BirthYear, Name, Grade, Class, FirstName
         FROM dbo.Students
         WHERE StudentId = @studentId AND BirthYear = @birthYear`
      );

    if (!result.recordset.length) {
      context.res = unauthorized('INVALID_CREDENTIALS');
      return;
    }

    const student = result.recordset[0];
    const fullName = typeof student.Name === 'string' ? student.Name.trim() : '';
    const firstName = deriveFirstName(student.FirstName, fullName);

    context.res = ok({
      ok: true,
      student: {
        StudentId: student.StudentId,
        BirthYear: student.BirthYear,
        FirstName: firstName,
        FullName: fullName,
        Grade: student.Grade,
        Class: student.Class
      }
    });
  } catch (error) {
    context.res = response(500, { ok: false, message: 'DB_ERROR' });
  }
};
math/api/week/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "weeks/{week:int}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/week/index.js
const { getPool, sql } = require('../_shared/db');
const { DEFAULT_HEADERS } = require('../_shared/http');

module.exports = async function (context, req) {
  try {
    const weekParam = Number(req.params.week);
    if (!Number.isInteger(weekParam)) {
      context.res = {
        status: 400,
        headers: DEFAULT_HEADERS,
        body: { ok: false, error: 'Invalid week parameter.' }
      };
      return;
    }

    const dbPool = await getPool();

    if (req.method !== 'GET') {
      context.res = {
        status: 405,
        headers: DEFAULT_HEADERS,
        body: { ok: false, error: 'Method not allowed.' }
      };
      return;
    }

    const weekResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query('SELECT Week, Title FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!weekResult.recordset.length) {
      context.res = {
        status: 404,
        headers: DEFAULT_HEADERS,
        body: { ok: false, error: 'Week not found.' }
      };
      return;
    }

    const goalsResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query(
        'SELECT GoalId, Week, SortOrder, GoalText FROM dbo.WeekGoals WHERE Week = @week ORDER BY SortOrder'
      );

    const prerequisitesResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query(
        'SELECT PrerequisiteId, Week, SortOrder, PrerequisiteText FROM dbo.WeekPrerequisites WHERE Week = @week ORDER BY SortOrder'
      );

    const conceptsResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query('SELECT ConceptId, Week, SortOrder, Title FROM dbo.Concepts WHERE Week = @week ORDER BY SortOrder');

    const conceptIds = conceptsResult.recordset.map((concept) => concept.ConceptId);
    let flowItemsResult = { recordset: [] };
    let flowDetailsResult = { recordset: [] };
    let flowHintsResult = { recordset: [] };
    let flowChoicesResult = { recordset: [] };

    if (conceptIds.length) {
      const inClause = conceptIds.map((_, index) => `@concept${index}`).join(',');
      const flowRequest = dbPool.request();
      conceptIds.forEach((id, index) => {
        flowRequest.input(`concept${index}`, sql.Int, id);
      });

      flowItemsResult = await flowRequest.query(
        `SELECT FlowItemId, ConceptId, SortOrder, ItemType, ItemText, ItemTitle, ItemDescription, ItemUrl, Answer, CorrectIndex, Solution
         FROM dbo.FlowItems
         WHERE ConceptId IN (${inClause})
         ORDER BY ConceptId, SortOrder`
      );

      const flowItemIds = flowItemsResult.recordset.map((item) => item.FlowItemId);
      if (flowItemIds.length) {
        const itemClause = flowItemIds.map((_, index) => `@item${index}`).join(',');
        const detailRequest = dbPool.request();
        flowItemIds.forEach((id, index) => {
          detailRequest.input(`item${index}`, sql.Int, id);
        });

        flowDetailsResult = await detailRequest.query(
          `SELECT FlowItemDetailId, FlowItemId, SortOrder, DetailText
           FROM dbo.FlowItemDetails
           WHERE FlowItemId IN (${itemClause})
           ORDER BY FlowItemId, SortOrder`
        );

        const hintRequest = dbPool.request();
        flowItemIds.forEach((id, index) => {
          hintRequest.input(`item${index}`, sql.Int, id);
        });

        flowHintsResult = await hintRequest.query(
          `SELECT FlowItemHintId, FlowItemId, SortOrder, HintText
           FROM dbo.FlowItemHints
           WHERE FlowItemId IN (${itemClause})
           ORDER BY FlowItemId, SortOrder`
        );

        const choiceRequest = dbPool.request();
        flowItemIds.forEach((id, index) => {
          choiceRequest.input(`item${index}`, sql.Int, id);
        });

        flowChoicesResult = await choiceRequest.query(
          `SELECT FlowItemChoiceId, FlowItemId, SortOrder, ChoiceText
           FROM dbo.FlowItemChoices
           WHERE FlowItemId IN (${itemClause})
           ORDER BY FlowItemId, SortOrder`
        );
      }
    }

    const assessmentsResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query(
        'SELECT AssessmentId, Week, Title, Description FROM dbo.Assessments WHERE Week = @week ORDER BY AssessmentId'
      );

    const assessmentIds = assessmentsResult.recordset.map(
      (assessment) => assessment.AssessmentId
    );
    let assessmentQuestionsResult = { recordset: [] };
    let assessmentChoicesResult = { recordset: [] };

    if (assessmentIds.length) {
      const assessmentClause = assessmentIds.map((_, index) => `@assessment${index}`).join(',');
      const assessmentRequest = dbPool.request();
      assessmentIds.forEach((id, index) => {
        assessmentRequest.input(`assessment${index}`, sql.Int, id);
      });

      assessmentQuestionsResult = await assessmentRequest.query(
        `SELECT AssessmentQuestionId, AssessmentId, SortOrder, QuestionType, QuestionText, Answer, Points, CorrectIndex
         FROM dbo.AssessmentQuestions
         WHERE AssessmentId IN (${assessmentClause})
         ORDER BY AssessmentId, SortOrder`
      );

      const questionIds = assessmentQuestionsResult.recordset.map(
        (question) => question.AssessmentQuestionId
      );

      if (questionIds.length) {
        const questionClause = questionIds.map((_, index) => `@question${index}`).join(',');
        const questionRequest = dbPool.request();
        questionIds.forEach((id, index) => {
          questionRequest.input(`question${index}`, sql.Int, id);
        });

        assessmentChoicesResult = await questionRequest.query(
          `SELECT AssessmentChoiceId, AssessmentQuestionId, SortOrder, ChoiceText
           FROM dbo.AssessmentQuestionChoices
           WHERE AssessmentQuestionId IN (${questionClause})
           ORDER BY AssessmentQuestionId, SortOrder`
        );
      }
    }

    const detailsByItem = new Map();
    flowDetailsResult.recordset.forEach((detail) => {
      if (!detailsByItem.has(detail.FlowItemId)) {
        detailsByItem.set(detail.FlowItemId, []);
      }
      detailsByItem.get(detail.FlowItemId).push(detail);
    });

    const hintsByItem = new Map();
    flowHintsResult.recordset.forEach((hint) => {
      if (!hintsByItem.has(hint.FlowItemId)) {
        hintsByItem.set(hint.FlowItemId, []);
      }
      hintsByItem.get(hint.FlowItemId).push(hint);
    });

    const choicesByItem = new Map();
    flowChoicesResult.recordset.forEach((choice) => {
      if (!choicesByItem.has(choice.FlowItemId)) {
        choicesByItem.set(choice.FlowItemId, []);
      }
      choicesByItem.get(choice.FlowItemId).push(choice);
    });

    const flowItemsByConcept = new Map();
    flowItemsResult.recordset.forEach((item) => {
      if (!flowItemsByConcept.has(item.ConceptId)) {
        flowItemsByConcept.set(item.ConceptId, []);
      }
      flowItemsByConcept.get(item.ConceptId).push({
        item,
        details: detailsByItem.get(item.FlowItemId) || [],
        hints: hintsByItem.get(item.FlowItemId) || [],
        choices: choicesByItem.get(item.FlowItemId) || []
      });
    });

    const concepts = conceptsResult.recordset.map((concept) => ({
      concept,
      flow: flowItemsByConcept.get(concept.ConceptId) || []
    }));

    const choicesByQuestion = new Map();
    assessmentChoicesResult.recordset.forEach((choice) => {
      if (!choicesByQuestion.has(choice.AssessmentQuestionId)) {
        choicesByQuestion.set(choice.AssessmentQuestionId, []);
      }
      choicesByQuestion.get(choice.AssessmentQuestionId).push(choice);
    });

    const questionsByAssessment = new Map();
    assessmentQuestionsResult.recordset.forEach((question) => {
      if (!questionsByAssessment.has(question.AssessmentId)) {
        questionsByAssessment.set(question.AssessmentId, []);
      }
      questionsByAssessment.get(question.AssessmentId).push({
        question,
        choices: choicesByQuestion.get(question.AssessmentQuestionId) || []
      });
    });

    const assessments = assessmentsResult.recordset.map((assessment) => ({
      assessment,
      questions: questionsByAssessment.get(assessment.AssessmentId) || []
    }));

    const weekData = weekResult.recordset[0];
    const goals = goalsResult.recordset.map((goal) => goal.GoalText);
    const prerequisites = prerequisitesResult.recordset.map(
      (prereq) => prereq.PrerequisiteText
    );

    const normalizedConcepts = concepts.map(({ concept, flow }) => ({
      title: concept.Title,
      flow: flow.map(({ item, details, hints, choices }) => {
        const type = String(item.ItemType || '').trim().toLowerCase();
        const mapped = {
          type,
          text: item.ItemText,
          title: item.ItemTitle,
          description: item.ItemDescription,
          url: item.ItemUrl,
          answer: item.Answer,
          correctIndex: item.CorrectIndex,
          solution: item.Solution,
          details: details.map((detail) => detail.DetailText),
          hints: hints.map((hint) => hint.HintText),
          choices: choices.map((choice) => choice.ChoiceText)
        };

        if (!mapped.details.length) delete mapped.details;
        if (!mapped.hints.length) delete mapped.hints;
        if (!mapped.choices.length) delete mapped.choices;

        return mapped;
      })
    }));

    const normalizedAssessments = assessments.map(({ assessment, questions }) => ({
      title: assessment.Title,
      description: assessment.Description,
      questions: questions.map(({ question, choices }) => {
        const rawType = String(question.QuestionType || '').trim().toLowerCase();
        const choiceTexts = choices.map((choice) => choice.ChoiceText);
        let type = rawType;
        if (!['mcq', 'input'].includes(type)) {
          type = choiceTexts.length ? 'mcq' : 'input';
        }

        const normalized = {
          type,
          text: question.QuestionText,
          points: Number.isFinite(question.Points) ? question.Points : 1
        };

        if (type === 'mcq') {
          normalized.choices = choiceTexts;
          normalized.correctIndex =
            typeof question.CorrectIndex === 'number' ? question.CorrectIndex : 0;
        } else {
          normalized.answer = question.Answer ?? '';
        }

        return normalized;
      })
    }));

    context.res = {
      status: 200,
      headers: DEFAULT_HEADERS,
      body: {
        week: weekData.Week,
        title: weekData.Title,
        goals,
        prerequisites,
        concepts: normalizedConcepts,
        assessment: normalizedAssessments[0] || null
      }
    };
  } catch (error) {
    context.res = {
      status: 500,
      headers: DEFAULT_HEADERS,
      body: { ok: false, error: error.message }
    };
  }
};
math/api/weeks/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "weeks"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/weeks/index.js
const { getPool } = require('../_shared/db');
const { ok, response } = require('../_shared/http');

module.exports = async function (context) {
  try {
    const dbPool = await getPool();
    const result = await dbPool
      .request()
      .query('SELECT Week, Title FROM dbo.Weeks WHERE IsDeleted = 0 ORDER BY Week');
    context.res = ok(result.recordset);
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/docs/api-routes.md
# API Routes

## Official routes

| Method | Path | Description |
| --- | --- | --- |
| GET | `/api/health` | Health check. |
| POST | `/api/progress/complete` | Record student completion. |
| GET | `/api/progress/completed` | Fetch completed progress. |
| POST | `/api/students/login` | Student login. |
| GET | `/api/weeks/{week:int}` | Week details. |
| GET | `/api/weeks` | Weeks list. |
| GET | `/api/routes` | Route catalog. |

## cURL examples

```bash
curl -X POST "https://<your-app>.azurestaticapps.net/api/students/login" \
  -H "Content-Type: application/json" \
  -d '{"studentId":"123456","birthYear":"2012"}'
```

```bash
curl -X GET "https://<your-app>.azurestaticapps.net/api/weeks"
```

```bash
curl -X GET "https://<your-app>.azurestaticapps.net/api/routes"
```

```bash
curl -X GET "https://<your-app>.azurestaticapps.net/api/health"
```
math/docs/removed-files.md
# Removed Files Log

The following files were removed as requested:

- public/assets/cert/certificate.html
- server/package.json
- server/.env.example
- server/.env
- server/src/db.js
- server/src/server.js
- server/src/app.js
- dumb.txt
- server/ (untracked directory)
- api/node_modules/ (generated dependencies)
math/dumb.txt
math/.github/workflows/azure-static-web-apps-mango-smoke-0ebe00210.yml
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_SMOKE_0EBE00210 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
          action: "upload"
          ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
          # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
          app_location: "public" # App source code path
          api_location: "api" # Api source code path - optional
          output_location: "public" # Built app content directory - optional
          ###### End of Repository/Build Configurations ######

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_SMOKE_0EBE00210 }}
          action: "close"
math/.gitignore
node_modules/
api/node_modules/
server/
.DS_Store
math/api/_migrations/001_card_completions.sql
IF OBJECT_ID('dbo.CardCompletions', 'U') IS NULL
BEGIN
  CREATE TABLE dbo.CardCompletions (
    CompletionId INT IDENTITY(1,1) PRIMARY KEY,
    StudentId NVARCHAR(20) NOT NULL,
    Week INT NOT NULL,
    FinalScore INT NOT NULL,
    CompletedAt DATETIME NOT NULL DEFAULT GETDATE(),
    CONSTRAINT FK_CardCompletions_Students FOREIGN KEY (StudentId)
      REFERENCES dbo.Students(StudentId),
    CONSTRAINT FK_CardCompletions_Weeks FOREIGN KEY (Week)
      REFERENCES dbo.Weeks(Week),
    CONSTRAINT UQ_CardCompletions_StudentWeek UNIQUE (StudentId, Week)
  );

  CREATE INDEX IX_CardCompletions_Week ON dbo.CardCompletions (Week);
  CREATE INDEX IX_CardCompletions_StudentId ON dbo.CardCompletions (StudentId);
END
math/api/_migrations/002_add_week_seq_prereq.sql
IF COL_LENGTH('dbo.Weeks', 'Seq') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD Seq INT NULL;
END

IF COL_LENGTH('dbo.Weeks', 'PrereqWeek') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD PrereqWeek INT NULL;
END

;WITH Ranked AS (
  SELECT Week,
         ROW_NUMBER() OVER (PARTITION BY Grade ORDER BY Week) AS SeqValue
  FROM dbo.Weeks
  WHERE IsDeleted = 0
)
UPDATE w
SET Seq = r.SeqValue
FROM dbo.Weeks w
JOIN Ranked r ON w.Week = r.Week
WHERE w.Seq IS NULL OR w.Seq <> r.SeqValue;

UPDATE dbo.Weeks
SET Seq = 0
WHERE Seq IS NULL;

IF EXISTS (
  SELECT 1
  FROM sys.columns
  WHERE name = 'Seq'
    AND object_id = OBJECT_ID('dbo.Weeks')
    AND is_nullable = 1
)
BEGIN
  ALTER TABLE dbo.Weeks
    ALTER COLUMN Seq INT NOT NULL;
END

IF NOT EXISTS (
  SELECT 1
  FROM sys.indexes
  WHERE name = 'IX_Weeks_Grade_Seq_Active'
    AND object_id = OBJECT_ID('dbo.Weeks')
)
BEGIN
  CREATE UNIQUE INDEX IX_Weeks_Grade_Seq_Active
    ON dbo.Weeks (Grade, Seq)
    WHERE IsDeleted = 0;
END

IF NOT EXISTS (
  SELECT 1
  FROM sys.indexes
  WHERE name = 'IX_Weeks_PrereqWeek'
    AND object_id = OBJECT_ID('dbo.Weeks')
)
BEGIN
  CREATE INDEX IX_Weeks_PrereqWeek
    ON dbo.Weeks (PrereqWeek);
END
math/api/_shared/db.js
const sql = require('mssql');

let pool;

async function getPool() {
  if (pool) {
    return pool;
  }

  const connectionString = process.env.SQL_CONNECTION_STRING;
  if (!connectionString) {
    throw new Error('SQL_CONNECTION_STRING is not set.');
  }

  pool = await sql.connect(connectionString);
  pool.on('error', () => {
    pool = null;
  });
  return pool;
}

module.exports = {
  sql,
  getPool
};
math/api/_shared/http.js
const DEFAULT_HEADERS = {
  'Content-Type': 'application/json; charset=utf-8',
  'Cache-Control': 'no-store'
};

function withHeaders(headers) {
  return { ...DEFAULT_HEADERS, ...(headers || {}) };
}

function response(status, body, headers) {
  return {
    status,
    headers: withHeaders(headers),
    body
  };
}

function ok(data, headers) {
  return response(200, data, headers);
}

function badRequest(message = 'BAD_REQUEST') {
  return response(400, { ok: false, error: message });
}

function unauthorized(message = 'UNAUTHORIZED') {
  return response(401, { ok: false, error: message });
}

function notFound(message = 'NOT_FOUND') {
  return response(404, { ok: false, error: message });
}

function methodNotAllowed(message = 'Method not allowed.') {
  return response(405, { ok: false, error: message });
}

function serverError(error) {
  return response(500, { ok: false, error: 'SERVER_ERROR', detail: error?.message });
}

module.exports = {
  DEFAULT_HEADERS,
  response,
  ok,
  badRequest,
  unauthorized,
  notFound,
  methodNotAllowed,
  serverError
};
math/api/_shared/parse.js
function readJson(req) {
  if (req?.body && typeof req.body === 'object') {
    return req.body;
  }

  if (typeof req?.body === 'string') {
    try {
      return JSON.parse(req.body);
    } catch (error) {
      return null;
    }
  }

  if (req?.rawBody) {
    try {
      return JSON.parse(req.rawBody);
    } catch (error) {
      return null;
    }
  }

  return null;
}

function getQuery(req) {
  return req?.query || {};
}

module.exports = { readJson, getQuery };
math/api/cards/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "cards"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/cards/index.js
const { getPool, sql } = require('../_shared/db');
const { getQuery } = require('../_shared/parse');
const { ok, badRequest, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

module.exports = async function (context, req) {
  try {
    const query = getQuery(req);
    const grade = normalizeDigits(toCleanString(query.grade));
    const classInput = toCleanString(query.class);
    const className = normalizeDigits(classInput);

    if (!grade) {
      context.res = badRequest('grade is required.');
      return;
    }

    const dbPool = await getPool();
    const request = dbPool.request();
    request.input('grade', sql.NVarChar(50), grade);

    const conditions = ['w.IsDeleted = 0', 'w.Grade = @grade'];
    const hasClassFilter = className && className !== 'ALL_CLASSES';

    if (hasClassFilter) {
      request.input('className', sql.NVarChar(50), className);
      conditions.push(`(
        NOT EXISTS (SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week)
        OR EXISTS (
          SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week AND wt.Class = @className
        )
      )`);
    }

    const sqlQuery = `
      SELECT w.Week,
             w.Title,
             w.Grade,
             w.Seq,
             w.PrereqWeek,
             prereq.Seq AS PrereqSeq,
             t.Class
      FROM dbo.Weeks w
      LEFT JOIN dbo.Weeks prereq ON w.PrereqWeek = prereq.Week
      LEFT JOIN dbo.WeekTargets t ON w.Week = t.Week
      WHERE ${conditions.join(' AND ')}
      ORDER BY w.Seq, w.Week
    `;

    const result = await request.query(sqlQuery);

    const cardsByWeek = new Map();
    result.recordset.forEach((row) => {
      if (!cardsByWeek.has(row.Week)) {
        cardsByWeek.set(row.Week, {
          week: row.Week,
          title: row.Title,
          grade: row.Grade,
          seq: row.Seq,
          prereqWeek: row.PrereqWeek ?? null,
          prereqSeq: row.PrereqSeq ?? null,
          classes: []
        });
      }

      if (row.Class) {
        cardsByWeek.get(row.Week).classes.push(row.Class);
      }
    });

    const cards = Array.from(cardsByWeek.values()).map((card) => {
      const uniqueClasses = Array.from(new Set(card.classes));
      return {
        Week: card.week,
        Title: card.title,
        Grade: card.grade,
        Seq: card.seq,
        Classes: uniqueClasses,
        PrereqWeek: card.prereqWeek,
        PrereqSeq: card.prereqSeq
      };
    });

    context.res = ok(cards);
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/health/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "health"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/health/index.js
const { getPool } = require('../_shared/db');
const { ok, response } = require('../_shared/http');

module.exports = async function (context) {
  try {
    const dbPool = await getPool();
    await dbPool.request().query('SELECT 1 AS ok');
    context.res = ok({ ok: true, db: true });
  } catch (error) {
    context.res = response(500, { ok: false, db: false, error: error.message });
  }
};
math/api/host.json
{
  "version": "2.0"
}
math/api/mng-card-completions/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "mng/cards/{week:int}/completions"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-card-completions/index.js
const { getPool, sql } = require('../_shared/db');
const { getQuery } = require('../_shared/parse');
const { ok, badRequest, notFound, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

module.exports = async function (context, req) {
  try {
    const weekParam = Number(req.params.week);
    if (!Number.isInteger(weekParam)) {
      context.res = badRequest('week must be a valid integer.');
      return;
    }

    const query = getQuery(req);
    const classInput = toCleanString(query.class);
    const className = normalizeDigits(classInput);
    const hasClassFilter = className && className !== 'ALL_CLASSES';

    const dbPool = await getPool();
    const weekCheck = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query('SELECT Week FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!weekCheck.recordset.length) {
      context.res = notFound('Card not found.');
      return;
    }

    const request = dbPool.request();
    request.input('week', sql.Int, weekParam);

    let sqlQuery = `
      SELECT c.StudentId,
             s.Name AS FullName,
             s.Class,
             c.FinalScore,
             c.CompletedAt
      FROM dbo.CardCompletions c
      JOIN dbo.Students s ON s.StudentId = c.StudentId
      WHERE c.Week = @week
    `;

    if (hasClassFilter) {
      request.input('className', sql.NVarChar(50), className);
      sqlQuery += ' AND s.Class = @className';
    }

    sqlQuery += ' ORDER BY c.CompletedAt DESC, s.Name, s.StudentId';

    const result = await request.query(sqlQuery);

    context.res = ok({ ok: true, students: result.recordset });
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/mng-cards/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "post", "put", "delete"],
      "route": "mng/cards/{week?}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-cards/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson, getQuery } = require('../_shared/parse');
const { ok, badRequest, notFound, methodNotAllowed, serverError } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function parseWeek(value) {
  const cleaned = normalizeDigits(toCleanString(value));
  if (!cleaned || !/^\d+$/.test(cleaned)) return null;
  const parsed = Number.parseInt(cleaned, 10);
  return Number.isInteger(parsed) ? parsed : null;
}

function parseOptionalWeek(value) {
  if (value === null || value === undefined || value === '') return null;
  return parseWeek(value);
}

function normalizeClassList(value) {
  if (!Array.isArray(value)) return [];
  const seen = new Set();
  value.forEach((entry) => {
    const cleaned = normalizeDigits(toCleanString(entry));
    if (!cleaned) return;
    seen.add(cleaned);
  });
  return Array.from(seen);
}

async function renumberSeq(transaction, grade) {
  if (!grade) return;
  await new sql.Request(transaction)
    .input('grade', sql.NVarChar(50), grade)
    .query(
      `WITH Ranked AS (
         SELECT Week,
                ROW_NUMBER() OVER (ORDER BY Seq, Week) AS SeqValue
         FROM dbo.Weeks
         WHERE Grade = @grade AND IsDeleted = 0
       )
       UPDATE w
       SET Seq = r.SeqValue
       FROM dbo.Weeks w
       JOIN Ranked r ON w.Week = r.Week;`
    );
}

async function handleGet(context, req) {
  const query = getQuery(req);
  const grade = normalizeDigits(toCleanString(query.grade));
  const classInput = toCleanString(query.class);
  const className = normalizeDigits(classInput);
  const q = toCleanString(query.q);
  const search = q ? `%${normalizeDigits(q)}%` : '';

  const dbPool = await getPool();
  const request = dbPool.request();

  const conditions = ['w.IsDeleted = 0'];

  if (grade) {
    request.input('grade', sql.NVarChar(50), grade);
    conditions.push('w.Grade = @grade');
  }

  if (search) {
    request.input('q', sql.NVarChar(200), search);
    conditions.push('(CAST(w.Week AS NVARCHAR(20)) LIKE @q OR CAST(w.Seq AS NVARCHAR(20)) LIKE @q OR w.Title LIKE @q)');
  }

  const hasClassFilter = className && className !== 'ALL_CLASSES';
  if (hasClassFilter) {
    request.input('className', sql.NVarChar(50), className);
    conditions.push(`(
      NOT EXISTS (SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week)
      OR EXISTS (
        SELECT 1 FROM dbo.WeekTargets wt WHERE wt.Week = w.Week AND wt.Class = @className
      )
    )`);
  } else if (className) {
    request.input('className', sql.NVarChar(50), className);
  }

  const countFilters = [];
  if (grade) {
    countFilters.push('s.Grade = @grade');
  }
  if (hasClassFilter) {
    countFilters.push('s.Class = @className');
  }

  let sqlQuery = `
    SELECT w.Week,
           w.Title,
           w.Grade,
           w.Seq,
           w.PrereqWeek,
           prereq.Seq AS PrereqSeq,
           prereq.Title AS PrereqTitle,
           t.Class,
           cc.CompletedCount
    FROM dbo.Weeks w
    LEFT JOIN dbo.Weeks prereq ON w.PrereqWeek = prereq.Week
    LEFT JOIN dbo.WeekTargets t ON w.Week = t.Week
    LEFT JOIN (
      SELECT c.Week, COUNT(*) AS CompletedCount
      FROM dbo.CardCompletions c
      JOIN dbo.Students s ON s.StudentId = c.StudentId
      ${countFilters.length ? `WHERE ${countFilters.join(' AND ')}` : ''}
      GROUP BY c.Week
    ) cc ON w.Week = cc.Week
  `;

  if (conditions.length) {
    sqlQuery += ` WHERE ${conditions.join(' AND ')}`;
  }

  sqlQuery += ' ORDER BY w.Grade, w.Seq';

  const result = await request.query(sqlQuery);

  const cardsByWeek = new Map();
  result.recordset.forEach((row) => {
    if (!cardsByWeek.has(row.Week)) {
      cardsByWeek.set(row.Week, {
        week: row.Week,
        title: row.Title,
        grade: row.Grade,
        seq: row.Seq,
        prereqWeek: row.PrereqWeek ?? null,
        prereqSeq: row.PrereqSeq ?? null,
        prereqTitle: row.PrereqTitle ?? null,
        classes: [],
        completedCount: row.CompletedCount ?? 0
      });
    }

    if (row.Class) {
      cardsByWeek.get(row.Week).classes.push(row.Class);
    }
  });

  const cards = Array.from(cardsByWeek.values()).map((card) => {
    const uniqueClasses = Array.from(new Set(card.classes));
    return {
      week: card.week,
      title: card.title,
      grade: card.grade,
      seq: card.seq,
      prereqWeek: card.prereqWeek,
      prereqSeq: card.prereqSeq,
      prereqTitle: card.prereqTitle,
      classes: uniqueClasses,
      completedCount: card.completedCount,
      isAllClasses: uniqueClasses.length === 0
    };
  });

  context.res = ok({ ok: true, cards });
}

async function handlePost(context, req) {
  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const requestedWeek = parseWeek(payload.week);
  const title = toCleanString(payload.title);
  const grade = normalizeDigits(toCleanString(payload.grade));
  const allClasses = Boolean(payload.allClasses);
  const classes = allClasses ? [] : normalizeClassList(payload.classes);
  const prereqWeekRaw = payload.prereqWeek;
  const prereqWeek = parseOptionalWeek(prereqWeekRaw);

  if (payload.week != null && !requestedWeek) {
    context.res = badRequest('week must be a valid integer.');
    return;
  }

  if (prereqWeekRaw !== undefined && prereqWeekRaw !== null && prereqWeekRaw !== '' && prereqWeek === null) {
    context.res = badRequest('prereqWeek must be a valid integer or null.');
    return;
  }

  if (!title) {
    context.res = badRequest('title is required.');
    return;
  }

  if (!grade) {
    context.res = badRequest('grade is required.');
    return;
  }

  const dbPool = await getPool();
  let week = requestedWeek;

  if (week) {
    const existing = await dbPool
      .request()
      .input('week', sql.Int, week)
      .query('SELECT Week FROM dbo.Weeks WHERE Week = @week');

    if (existing.recordset.length) {
      context.res = badRequest('week already exists.');
      return;
    }
  } else {
    const maxResult = await dbPool.request().query('SELECT ISNULL(MAX(Week), 0) AS maxWeek FROM dbo.Weeks');
    week = (maxResult.recordset[0]?.maxWeek || 0) + 1;
  }

  if (prereqWeek != null) {
    if (prereqWeek === week) {
      context.res = badRequest('prereqWeek cannot match week.');
      return;
    }

    const prereqResult = await dbPool
      .request()
      .input('week', sql.Int, prereqWeek)
      .query('SELECT Week, Grade FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!prereqResult.recordset.length) {
      context.res = badRequest('prereqWeek does not exist.');
      return;
    }

    if (normalizeDigits(prereqResult.recordset[0].Grade) !== grade) {
      context.res = badRequest('prereqWeek must belong to the same grade.');
      return;
    }
  }

  const seqResult = await dbPool
    .request()
    .input('grade', sql.NVarChar(50), grade)
    .query('SELECT ISNULL(MAX(Seq), 0) AS maxSeq FROM dbo.Weeks WHERE Grade = @grade AND IsDeleted = 0');

  const nextSeq = (seqResult.recordset[0]?.maxSeq || 0) + 1;

  const transaction = new sql.Transaction(dbPool);
  try {
    await transaction.begin();

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .input('title', sql.NVarChar(200), title)
      .input('grade', sql.NVarChar(50), grade)
      .input('seq', sql.Int, nextSeq)
      .input('prereqWeek', sql.Int, prereqWeek)
      .query(
        `INSERT INTO dbo.Weeks (Week, Title, Grade, Seq, PrereqWeek, IsDeleted)
         VALUES (@week, @title, @grade, @seq, @prereqWeek, 0);`
      );

    for (const classValue of classes) {
      await new sql.Request(transaction)
        .input('week', sql.Int, week)
        .input('className', sql.NVarChar(50), classValue)
        .query(
          `INSERT INTO dbo.WeekTargets (Week, Class)
           VALUES (@week, @className);`
        );
    }

    await transaction.commit();
    context.res = ok({ ok: true, week, seq: nextSeq });
  } catch (error) {
    await transaction.rollback();
    context.res = serverError(error);
  }
}

async function handlePut(context, req) {
  const week = parseWeek(req.params?.week);
  if (!week) {
    context.res = badRequest('week must be a valid integer.');
    return;
  }

  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const title = toCleanString(payload.title);
  const grade = normalizeDigits(toCleanString(payload.grade));
  const allClasses = Boolean(payload.allClasses);
  const classes = allClasses ? [] : normalizeClassList(payload.classes);
  const prereqWeekRaw = payload.prereqWeek;
  const prereqWeek = parseOptionalWeek(prereqWeekRaw);

  if (prereqWeekRaw !== undefined && prereqWeekRaw !== null && prereqWeekRaw !== '' && prereqWeek === null) {
    context.res = badRequest('prereqWeek must be a valid integer or null.');
    return;
  }

  if (!title) {
    context.res = badRequest('title is required.');
    return;
  }

  if (!grade) {
    context.res = badRequest('grade is required.');
    return;
  }

  if (prereqWeek === week) {
    context.res = badRequest('prereqWeek cannot match week.');
    return;
  }

  const dbPool = await getPool();
  const existing = await dbPool
    .request()
    .input('week', sql.Int, week)
    .query('SELECT Week, Grade, Seq FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!existing.recordset.length) {
    context.res = notFound('Card not found.');
    return;
  }

  const current = existing.recordset[0];
  const previousGrade = normalizeDigits(current.Grade);
  const gradeChanged = previousGrade !== grade;

  if (prereqWeek != null) {
    const prereqResult = await dbPool
      .request()
      .input('week', sql.Int, prereqWeek)
      .query('SELECT Week, Grade FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!prereqResult.recordset.length) {
      context.res = badRequest('prereqWeek does not exist.');
      return;
    }

    if (normalizeDigits(prereqResult.recordset[0].Grade) !== grade) {
      context.res = badRequest('prereqWeek must belong to the same grade.');
      return;
    }
  }

  let nextSeq = current.Seq;
  if (gradeChanged) {
    const seqResult = await dbPool
      .request()
      .input('grade', sql.NVarChar(50), grade)
      .query('SELECT ISNULL(MAX(Seq), 0) AS maxSeq FROM dbo.Weeks WHERE Grade = @grade AND IsDeleted = 0');
    nextSeq = (seqResult.recordset[0]?.maxSeq || 0) + 1;
  }

  const transaction = new sql.Transaction(dbPool);
  try {
    await transaction.begin();

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .input('title', sql.NVarChar(200), title)
      .input('grade', sql.NVarChar(50), grade)
      .input('seq', sql.Int, nextSeq)
      .input('prereqWeek', sql.Int, prereqWeek)
      .query(
        `UPDATE dbo.Weeks
         SET Title = @title,
             Grade = @grade,
             Seq = @seq,
             PrereqWeek = @prereqWeek
         WHERE Week = @week AND IsDeleted = 0;`
      );

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query('DELETE FROM dbo.WeekTargets WHERE Week = @week;');

    for (const classValue of classes) {
      await new sql.Request(transaction)
        .input('week', sql.Int, week)
        .input('className', sql.NVarChar(50), classValue)
        .query(
          `INSERT INTO dbo.WeekTargets (Week, Class)
           VALUES (@week, @className);`
        );
    }

    if (gradeChanged) {
      await renumberSeq(transaction, previousGrade);
      await renumberSeq(transaction, grade);
    }

    await transaction.commit();
    context.res = ok({ ok: true });
  } catch (error) {
    await transaction.rollback();
    context.res = serverError(error);
  }
}

async function handleDelete(context, req) {
  const week = parseWeek(req.params?.week);
  if (!week) {
    context.res = badRequest('week must be a valid integer.');
    return;
  }

  const dbPool = await getPool();
  const existing = await dbPool
    .request()
    .input('week', sql.Int, week)
    .query('SELECT Week, Grade FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!existing.recordset.length) {
    context.res = notFound('Card not found.');
    return;
  }

  const grade = normalizeDigits(existing.recordset[0].Grade);
  const transaction = new sql.Transaction(dbPool);

  try {
    await transaction.begin();

    const result = await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query(
        `UPDATE dbo.Weeks
         SET IsDeleted = 1
         WHERE Week = @week AND IsDeleted = 0;
         SELECT @@ROWCOUNT AS affected;`
      );

    const affected = result.recordset[0]?.affected || 0;
    if (!affected) {
      await transaction.rollback();
      context.res = notFound('Card not found.');
      return;
    }

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query('UPDATE dbo.Weeks SET PrereqWeek = NULL WHERE PrereqWeek = @week;');

    await new sql.Request(transaction)
      .input('week', sql.Int, week)
      .query('DELETE FROM dbo.WeekTargets WHERE Week = @week;');

    await renumberSeq(transaction, grade);

    await transaction.commit();
    context.res = ok({ ok: true });
  } catch (error) {
    await transaction.rollback();
    context.res = serverError(error);
  }
}

module.exports = async function (context, req) {
  try {
    switch (req.method) {
      case 'GET':
        await handleGet(context, req);
        return;
      case 'POST':
        await handlePost(context, req);
        return;
      case 'PUT':
        await handlePut(context, req);
        return;
      case 'DELETE':
        await handleDelete(context, req);
        return;
      default:
        context.res = methodNotAllowed();
    }
  } catch (error) {
    context.res = serverError(error);
  }
};
math/api/mng-students/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "post", "put", "delete"],
      "route": "mng/students/{studentId?}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-students/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson, getQuery } = require('../_shared/parse');
const { ok, badRequest, notFound, methodNotAllowed, serverError } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function normalizeGrade(value) {
  const cleaned = normalizeDigits(toCleanString(value));
  if (!cleaned) return '';
  if (/^[1-9]$/.test(cleaned)) return cleaned;

  let text = cleaned.replace(/\s+/g, '');
  text = text.replace(/^الصف/, '').replace(/^صف/, '').replace(/^ال/, '');
  text = text.replace(/[أإآ]/g, 'ا');

  const gradeMap = {
    اول: '1',
    ثاني: '2',
    ثالث: '3',
    رابع: '4',
    خامس: '5',
    سادس: '6',
    سابع: '7',
    ثامن: '8',
    تاسع: '9'
  };

  return gradeMap[text] || cleaned;
}

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function isValidBirthYear(value) {
  return /^\d{4}$/.test(value);
}

function deriveFirstName(name) {
  const parts = toCleanString(name).split(/\s+/).filter(Boolean);
  if (!parts.length) return '';
  if (parts[0] === 'عبد' && parts[1]) {
    return `عبد ${parts[1]}`;
  }
  return parts[0];
}

function normalizeDateString(value) {
  const cleaned = normalizeDigits(toCleanString(value));
  if (!cleaned) return '';
  const match = cleaned.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!match) return '';
  return `${match[1]}-${match[2]}-${match[3]}`;
}

async function handleGet(context, req) {
  const query = getQuery(req);
  const q = typeof query.q === 'string' ? query.q.trim() : '';
  const search = q ? `%${normalizeDigits(q)}%` : '';

  const dbPool = await getPool();
  const request = dbPool.request();
  let sqlQuery =
    'SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class FROM dbo.Students';

  if (search) {
    request.input('q', sql.NVarChar(200), search);
    sqlQuery += ' WHERE StudentId LIKE @q OR Name LIKE @q';
  }

  sqlQuery += ' ORDER BY Grade, Class, Name, StudentId';

  const result = await request.query(sqlQuery);
  context.res = ok({ ok: true, students: result.recordset });
}

async function handlePost(context, req) {
  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const studentId = normalizeDigits(toCleanString(payload.studentId));
  const birthYear = normalizeDigits(toCleanString(payload.birthYear));
  const name = toCleanString(payload.name);
  const birthDateValue = toCleanString(payload.birthDate);
  const birthDateInput = normalizeDateString(birthDateValue);
  let firstName = toCleanString(payload.firstName);
  const grade = payload.grade != null ? normalizeGrade(payload.grade) : '';
  const className = payload.class != null ? normalizeDigits(toCleanString(payload.class)) : '';

  if (!studentId) {
    context.res = badRequest('studentId is required.');
    return;
  }

  if (!birthYear || !isValidBirthYear(birthYear)) {
    context.res = badRequest('birthYear must be a 4-digit year.');
    return;
  }

  if (!name) {
    context.res = badRequest('name is required.');
    return;
  }

  if (birthDateValue && !birthDateInput) {
    context.res = badRequest('birthDate must be in YYYY-MM-DD format.');
    return;
  }

  if (!firstName) {
    firstName = deriveFirstName(name);
  }

  const birthDate = birthDateInput || `${birthYear}-01-01`;

  const dbPool = await getPool();
  const existingResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .query('SELECT StudentId FROM dbo.Students WHERE StudentId = @studentId');

  if (existingResult.recordset.length) {
    context.res = badRequest('studentId already exists.');
    return;
  }

  const insertResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .input('birthYear', sql.NVarChar(10), birthYear)
    .input('name', sql.NVarChar(200), name)
    .input('firstName', sql.NVarChar(100), firstName)
    .input('birthDate', sql.Date, birthDate)
    .input('grade', sql.NVarChar(50), grade)
    .input('className', sql.NVarChar(50), className)
    .query(
      `INSERT INTO dbo.Students (StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class)
       VALUES (@studentId, @birthYear, @name, @firstName, @birthDate, @grade, @className);
       SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class
       FROM dbo.Students
       WHERE StudentId = @studentId;`
    );

  context.res = ok({ ok: true, student: insertResult.recordset[0] });
}

async function handlePut(context, req) {
  const studentId = normalizeDigits(toCleanString(req.params?.studentId));
  if (!studentId) {
    context.res = badRequest('studentId is required.');
    return;
  }

  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const dbPool = await getPool();
  const existingResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .query('SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class FROM dbo.Students WHERE StudentId = @studentId');

  if (!existingResult.recordset.length) {
    context.res = notFound('Student not found.');
    return;
  }

  const existing = existingResult.recordset[0];
  const birthYear = payload.birthYear != null
    ? normalizeDigits(toCleanString(payload.birthYear))
    : existing.BirthYear;
  const name = payload.name != null ? String(payload.name).trim() : existing.Name;
  const incomingFirstName = payload.firstName != null ? String(payload.firstName).trim() : '';
  let firstName = payload.firstName != null ? incomingFirstName : existing.FirstName;
  if (payload.name != null && !incomingFirstName) {
    firstName = deriveFirstName(name);
  }
  const grade = payload.grade != null ? normalizeGrade(payload.grade) : existing.Grade;
  const className = payload.class != null ? normalizeDigits(toCleanString(payload.class)) : existing.Class;
  const birthDateValue = payload.birthDate != null ? toCleanString(payload.birthDate) : '';
  let birthDate = existing.BirthDate;

  if (!birthYear || !isValidBirthYear(birthYear)) {
    context.res = badRequest('birthYear must be a 4-digit year.');
    return;
  }

  if (!name) {
    context.res = badRequest('name is required.');
    return;
  }

  if (payload.birthDate != null) {
    const normalizedBirthDate = normalizeDateString(birthDateValue);
    if (birthDateValue && !normalizedBirthDate) {
      context.res = badRequest('birthDate must be in YYYY-MM-DD format.');
      return;
    }
    birthDate = normalizedBirthDate || `${birthYear}-01-01`;
  }

  const updateResult = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .input('birthYear', sql.NVarChar(10), birthYear)
    .input('name', sql.NVarChar(200), name)
    .input('firstName', sql.NVarChar(100), firstName)
    .input('birthDate', sql.Date, birthDate)
    .input('grade', sql.NVarChar(50), grade)
    .input('className', sql.NVarChar(50), className)
    .query(
      `UPDATE dbo.Students
       SET BirthYear = @birthYear,
           Name = @name,
           FirstName = @firstName,
           BirthDate = @birthDate,
           Grade = @grade,
           Class = @className
       WHERE StudentId = @studentId;
       SELECT StudentId, BirthYear, Name, FirstName, BirthDate, Grade, Class
       FROM dbo.Students
       WHERE StudentId = @studentId;`
    );

  context.res = ok({ ok: true, student: updateResult.recordset[0] });
}

async function handleDelete(context, req) {
  const studentId = normalizeDigits(toCleanString(req.params?.studentId));
  if (!studentId) {
    context.res = badRequest('studentId is required.');
    return;
  }

  const dbPool = await getPool();
  const result = await dbPool
    .request()
    .input('studentId', sql.NVarChar(20), studentId)
    .query(
      `DELETE FROM dbo.Students
       WHERE StudentId = @studentId;
       SELECT @@ROWCOUNT AS affected;`
    );

  const affected = result.recordset[0]?.affected || 0;
  if (!affected) {
    context.res = notFound('Student not found.');
    return;
  }

  context.res = ok({ ok: true });
}

module.exports = async function (context, req) {
  try {
    switch (req.method) {
      case 'GET':
        await handleGet(context, req);
        return;
      case 'POST':
        await handlePost(context, req);
        return;
      case 'PUT':
        await handlePut(context, req);
        return;
      case 'DELETE':
        await handleDelete(context, req);
        return;
      default:
        context.res = methodNotAllowed();
    }
  } catch (error) {
    context.res = serverError(error);
  }
};
math/api/mng-week-content/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get", "put"],
      "route": "mng/weeks/{week:int}/content"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/mng-week-content/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson } = require('../_shared/parse');
const { ok, badRequest, notFound, methodNotAllowed, response } = require('../_shared/http');

function toCleanString(value) {
  return typeof value === 'string' ? value.trim() : '';
}

function toNullableString(value) {
  const cleaned = toCleanString(value);
  return cleaned ? cleaned : null;
}

function toNullableInt(value) {
  if (value === null || value === undefined || value === '') return null;
  const parsed = Number(value);
  return Number.isFinite(parsed) ? parsed : null;
}

async function fetchWeekContent(dbPool, weekParam) {
  const weekResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query('SELECT Week, Title, Seq FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!weekResult.recordset.length) {
    return null;
  }

  const goalsResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query(
      'SELECT GoalId, Week, SortOrder, GoalText FROM dbo.WeekGoals WHERE Week = @week ORDER BY SortOrder'
    );

  const prerequisitesResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query(
      'SELECT PrerequisiteId, Week, SortOrder, PrerequisiteText FROM dbo.WeekPrerequisites WHERE Week = @week ORDER BY SortOrder'
    );

  const conceptsResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query('SELECT ConceptId, Week, SortOrder, Title FROM dbo.Concepts WHERE Week = @week ORDER BY SortOrder');

  const conceptIds = conceptsResult.recordset.map((concept) => concept.ConceptId);
  let flowItemsResult = { recordset: [] };
  let flowDetailsResult = { recordset: [] };
  let flowHintsResult = { recordset: [] };
  let flowChoicesResult = { recordset: [] };

  if (conceptIds.length) {
    const inClause = conceptIds.map((_, index) => `@concept${index}`).join(',');
    const flowRequest = dbPool.request();
    conceptIds.forEach((id, index) => {
      flowRequest.input(`concept${index}`, sql.Int, id);
    });

    flowItemsResult = await flowRequest.query(
      `SELECT FlowItemId, ConceptId, SortOrder, ItemType, ItemText, ItemTitle, ItemDescription, ItemUrl, Answer, CorrectIndex, Solution
       FROM dbo.FlowItems
       WHERE ConceptId IN (${inClause})
       ORDER BY ConceptId, SortOrder`
    );

    const flowItemIds = flowItemsResult.recordset.map((item) => item.FlowItemId);
    if (flowItemIds.length) {
      const itemClause = flowItemIds.map((_, index) => `@item${index}`).join(',');
      const detailRequest = dbPool.request();
      flowItemIds.forEach((id, index) => {
        detailRequest.input(`item${index}`, sql.Int, id);
      });

      flowDetailsResult = await detailRequest.query(
        `SELECT FlowItemDetailId, FlowItemId, SortOrder, DetailText
         FROM dbo.FlowItemDetails
         WHERE FlowItemId IN (${itemClause})
         ORDER BY FlowItemId, SortOrder`
      );

      const hintRequest = dbPool.request();
      flowItemIds.forEach((id, index) => {
        hintRequest.input(`item${index}`, sql.Int, id);
      });

      flowHintsResult = await hintRequest.query(
        `SELECT FlowItemHintId, FlowItemId, SortOrder, HintText
         FROM dbo.FlowItemHints
         WHERE FlowItemId IN (${itemClause})
         ORDER BY FlowItemId, SortOrder`
      );

      const choiceRequest = dbPool.request();
      flowItemIds.forEach((id, index) => {
        choiceRequest.input(`item${index}`, sql.Int, id);
      });

      flowChoicesResult = await choiceRequest.query(
        `SELECT FlowItemChoiceId, FlowItemId, SortOrder, ChoiceText
         FROM dbo.FlowItemChoices
         WHERE FlowItemId IN (${itemClause})
         ORDER BY FlowItemId, SortOrder`
      );
    }
  }

  const assessmentsResult = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query(
      'SELECT AssessmentId, Week, Title, Description FROM dbo.Assessments WHERE Week = @week ORDER BY AssessmentId'
    );

  const assessmentIds = assessmentsResult.recordset.map(
    (assessment) => assessment.AssessmentId
  );
  let assessmentQuestionsResult = { recordset: [] };
  let assessmentChoicesResult = { recordset: [] };

  if (assessmentIds.length) {
    const assessmentClause = assessmentIds.map((_, index) => `@assessment${index}`).join(',');
    const assessmentRequest = dbPool.request();
    assessmentIds.forEach((id, index) => {
      assessmentRequest.input(`assessment${index}`, sql.Int, id);
    });

    assessmentQuestionsResult = await assessmentRequest.query(
      `SELECT AssessmentQuestionId, AssessmentId, SortOrder, QuestionType, QuestionText, Answer, Points, CorrectIndex
       FROM dbo.AssessmentQuestions
       WHERE AssessmentId IN (${assessmentClause})
       ORDER BY AssessmentId, SortOrder`
    );

    const questionIds = assessmentQuestionsResult.recordset.map(
      (question) => question.AssessmentQuestionId
    );

    if (questionIds.length) {
      const questionClause = questionIds.map((_, index) => `@question${index}`).join(',');
      const questionRequest = dbPool.request();
      questionIds.forEach((id, index) => {
        questionRequest.input(`question${index}`, sql.Int, id);
      });

      assessmentChoicesResult = await questionRequest.query(
        `SELECT AssessmentChoiceId, AssessmentQuestionId, SortOrder, ChoiceText
         FROM dbo.AssessmentQuestionChoices
         WHERE AssessmentQuestionId IN (${questionClause})
         ORDER BY AssessmentQuestionId, SortOrder`
      );
    }
  }

  const detailsByItem = new Map();
  flowDetailsResult.recordset.forEach((detail) => {
    if (!detailsByItem.has(detail.FlowItemId)) {
      detailsByItem.set(detail.FlowItemId, []);
    }
    detailsByItem.get(detail.FlowItemId).push(detail);
  });

  const hintsByItem = new Map();
  flowHintsResult.recordset.forEach((hint) => {
    if (!hintsByItem.has(hint.FlowItemId)) {
      hintsByItem.set(hint.FlowItemId, []);
    }
    hintsByItem.get(hint.FlowItemId).push(hint);
  });

  const choicesByItem = new Map();
  flowChoicesResult.recordset.forEach((choice) => {
    if (!choicesByItem.has(choice.FlowItemId)) {
      choicesByItem.set(choice.FlowItemId, []);
    }
    choicesByItem.get(choice.FlowItemId).push(choice);
  });

  const flowItemsByConcept = new Map();
  flowItemsResult.recordset.forEach((item) => {
    if (!flowItemsByConcept.has(item.ConceptId)) {
      flowItemsByConcept.set(item.ConceptId, []);
    }
    flowItemsByConcept.get(item.ConceptId).push({
      item,
      details: detailsByItem.get(item.FlowItemId) || [],
      hints: hintsByItem.get(item.FlowItemId) || [],
      choices: choicesByItem.get(item.FlowItemId) || []
    });
  });

  const concepts = conceptsResult.recordset.map((concept) => ({
    concept,
    flow: flowItemsByConcept.get(concept.ConceptId) || []
  }));

  const choicesByQuestion = new Map();
  assessmentChoicesResult.recordset.forEach((choice) => {
    if (!choicesByQuestion.has(choice.AssessmentQuestionId)) {
      choicesByQuestion.set(choice.AssessmentQuestionId, []);
    }
    choicesByQuestion.get(choice.AssessmentQuestionId).push(choice);
  });

  const questionsByAssessment = new Map();
  assessmentQuestionsResult.recordset.forEach((question) => {
    if (!questionsByAssessment.has(question.AssessmentId)) {
      questionsByAssessment.set(question.AssessmentId, []);
    }
    questionsByAssessment.get(question.AssessmentId).push({
      question,
      choices: choicesByQuestion.get(question.AssessmentQuestionId) || []
    });
  });

  const assessments = assessmentsResult.recordset.map((assessment) => ({
    assessment,
    questions: questionsByAssessment.get(assessment.AssessmentId) || []
  }));

  const weekData = weekResult.recordset[0];
  const goals = goalsResult.recordset.map((goal) => goal.GoalText);
  const prerequisites = prerequisitesResult.recordset.map(
    (prereq) => prereq.PrerequisiteText
  );

  const normalizedConcepts = concepts.map(({ concept, flow }) => ({
    title: concept.Title,
    flow: flow.map(({ item, details, hints, choices }) => {
      const type = String(item.ItemType || '').trim().toLowerCase();
      const mapped = {
        type,
        text: item.ItemText,
        title: item.ItemTitle,
        description: item.ItemDescription,
        url: item.ItemUrl,
        answer: item.Answer,
        correctIndex: item.CorrectIndex,
        solution: item.Solution,
        details: details.map((detail) => detail.DetailText),
        hints: hints.map((hint) => hint.HintText),
        choices: choices.map((choice) => choice.ChoiceText)
      };

      if (!mapped.details.length) delete mapped.details;
      if (!mapped.hints.length) delete mapped.hints;
      if (!mapped.choices.length) delete mapped.choices;

      return mapped;
    })
  }));

  const normalizedAssessments = assessments.map(({ assessment, questions }) => ({
    title: assessment.Title,
    description: assessment.Description,
    questions: questions.map(({ question, choices }) => {
      const rawType = String(question.QuestionType || '').trim().toLowerCase();
      const choiceTexts = choices.map((choice) => choice.ChoiceText);
      let type = rawType;
      if (!['mcq', 'input'].includes(type)) {
        type = choiceTexts.length ? 'mcq' : 'input';
      }

      const normalized = {
        type,
        text: question.QuestionText,
        points: Number.isFinite(question.Points) ? question.Points : 1
      };

      if (type === 'mcq') {
        normalized.choices = choiceTexts;
        normalized.correctIndex =
          typeof question.CorrectIndex === 'number' ? question.CorrectIndex : 0;
      } else {
        normalized.answer = question.Answer ?? '';
      }

      return normalized;
    })
  }));

  return {
    week: weekData.Week,
    seq: weekData.Seq,
    title: weekData.Title,
    goals,
    prerequisites,
    concepts: normalizedConcepts,
    assessment: normalizedAssessments[0] || null
  };
}

async function handleGet(context, weekParam) {
  const dbPool = await getPool();
  const payload = await fetchWeekContent(dbPool, weekParam);

  if (!payload) {
    context.res = notFound('Week not found.');
    return;
  }

  context.res = ok(payload);
}

async function handlePut(context, req, weekParam) {
  const payload = readJson(req);
  if (!payload) {
    context.res = badRequest('Invalid JSON body.');
    return;
  }

  const dbPool = await getPool();
  const existing = await dbPool
    .request()
    .input('week', sql.Int, weekParam)
    .query('SELECT Week FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

  if (!existing.recordset.length) {
    context.res = notFound('Week not found.');
    return;
  }

  const goals = Array.isArray(payload.goals) ? payload.goals : [];
  const prerequisites = Array.isArray(payload.prerequisites) ? payload.prerequisites : [];
  const concepts = Array.isArray(payload.concepts) ? payload.concepts : [];
  const assessment = payload.assessment ?? null;

  const transaction = new sql.Transaction(dbPool);
  try {
    await transaction.begin();

    await new sql.Request(transaction)
      .input('week', sql.Int, weekParam)
      .query(
        `DELETE FROM dbo.FlowItemDetails
         WHERE FlowItemId IN (
           SELECT FlowItemId FROM dbo.FlowItems
           WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week)
         );
         DELETE FROM dbo.FlowItemHints
         WHERE FlowItemId IN (
           SELECT FlowItemId FROM dbo.FlowItems
           WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week)
         );
         DELETE FROM dbo.FlowItemChoices
         WHERE FlowItemId IN (
           SELECT FlowItemId FROM dbo.FlowItems
           WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week)
         );
         DELETE FROM dbo.FlowItems
         WHERE ConceptId IN (SELECT ConceptId FROM dbo.Concepts WHERE Week = @week);
         DELETE FROM dbo.Concepts WHERE Week = @week;
         DELETE FROM dbo.WeekGoals WHERE Week = @week;
         DELETE FROM dbo.WeekPrerequisites WHERE Week = @week;
         DELETE FROM dbo.AssessmentQuestionChoices
         WHERE AssessmentQuestionId IN (
           SELECT AssessmentQuestionId FROM dbo.AssessmentQuestions
           WHERE AssessmentId IN (SELECT AssessmentId FROM dbo.Assessments WHERE Week = @week)
         );
         DELETE FROM dbo.AssessmentQuestions
         WHERE AssessmentId IN (SELECT AssessmentId FROM dbo.Assessments WHERE Week = @week);
         DELETE FROM dbo.Assessments WHERE Week = @week;`
      );

    for (let i = 0; i < goals.length; i += 1) {
      const text = toCleanString(goals[i]);
      if (!text) continue;
      await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('sortOrder', sql.Int, i + 1)
        .input('goalText', sql.NVarChar(500), text)
        .query(
          `INSERT INTO dbo.WeekGoals (Week, SortOrder, GoalText)
           VALUES (@week, @sortOrder, @goalText);`
        );
    }

    for (let i = 0; i < prerequisites.length; i += 1) {
      const text = toCleanString(prerequisites[i]);
      if (!text) continue;
      await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('sortOrder', sql.Int, i + 1)
        .input('prereqText', sql.NVarChar(500), text)
        .query(
          `INSERT INTO dbo.WeekPrerequisites (Week, SortOrder, PrerequisiteText)
           VALUES (@week, @sortOrder, @prereqText);`
        );
    }

    for (let i = 0; i < concepts.length; i += 1) {
      const concept = concepts[i] || {};
      const conceptTitle = toCleanString(concept.title);
      const conceptResult = await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('sortOrder', sql.Int, i + 1)
        .input('title', sql.NVarChar(200), conceptTitle)
        .query(
          `INSERT INTO dbo.Concepts (Week, SortOrder, Title)
           OUTPUT INSERTED.ConceptId AS ConceptId
           VALUES (@week, @sortOrder, @title);`
        );

      const conceptId = conceptResult.recordset[0]?.ConceptId;
      const flow = Array.isArray(concept.flow) ? concept.flow : [];

      for (let j = 0; j < flow.length; j += 1) {
        const flowItem = flow[j] || {};
        const type = toCleanString(flowItem.type).toLowerCase();
        const itemResult = await new sql.Request(transaction)
          .input('conceptId', sql.Int, conceptId)
          .input('sortOrder', sql.Int, j + 1)
          .input('itemType', sql.NVarChar(50), type)
          .input('itemText', sql.NVarChar(sql.MAX), toNullableString(flowItem.text))
          .input('itemTitle', sql.NVarChar(200), toNullableString(flowItem.title))
          .input('itemDescription', sql.NVarChar(sql.MAX), toNullableString(flowItem.description))
          .input('itemUrl', sql.NVarChar(500), toNullableString(flowItem.url))
          .input('answer', sql.NVarChar(sql.MAX), toNullableString(flowItem.answer))
          .input('correctIndex', sql.Int, toNullableInt(flowItem.correctIndex))
          .input('solution', sql.NVarChar(sql.MAX), toNullableString(flowItem.solution))
          .query(
            `INSERT INTO dbo.FlowItems (
               ConceptId,
               SortOrder,
               ItemType,
               ItemText,
               ItemTitle,
               ItemDescription,
               ItemUrl,
               Answer,
               CorrectIndex,
               Solution
             )
             OUTPUT INSERTED.FlowItemId AS FlowItemId
             VALUES (
               @conceptId,
               @sortOrder,
               @itemType,
               @itemText,
               @itemTitle,
               @itemDescription,
               @itemUrl,
               @answer,
               @correctIndex,
               @solution
             );`
          );

        const flowItemId = itemResult.recordset[0]?.FlowItemId;
        const details = Array.isArray(flowItem.details) ? flowItem.details : [];
        const hints = Array.isArray(flowItem.hints) ? flowItem.hints : [];
        const choices = Array.isArray(flowItem.choices) ? flowItem.choices : [];

        for (let k = 0; k < details.length; k += 1) {
          const text = toCleanString(details[k]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('itemId', sql.Int, flowItemId)
            .input('sortOrder', sql.Int, k + 1)
            .input('detailText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.FlowItemDetails (FlowItemId, SortOrder, DetailText)
               VALUES (@itemId, @sortOrder, @detailText);`
            );
        }

        for (let k = 0; k < hints.length; k += 1) {
          const text = toCleanString(hints[k]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('itemId', sql.Int, flowItemId)
            .input('sortOrder', sql.Int, k + 1)
            .input('hintText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.FlowItemHints (FlowItemId, SortOrder, HintText)
               VALUES (@itemId, @sortOrder, @hintText);`
            );
        }

        for (let k = 0; k < choices.length; k += 1) {
          const text = toCleanString(choices[k]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('itemId', sql.Int, flowItemId)
            .input('sortOrder', sql.Int, k + 1)
            .input('choiceText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.FlowItemChoices (FlowItemId, SortOrder, ChoiceText)
               VALUES (@itemId, @sortOrder, @choiceText);`
            );
        }
      }
    }

    if (assessment) {
      const assessmentTitle = toCleanString(assessment.title);
      const assessmentDescription = toNullableString(assessment.description);
      const assessmentResult = await new sql.Request(transaction)
        .input('week', sql.Int, weekParam)
        .input('title', sql.NVarChar(200), assessmentTitle)
        .input('description', sql.NVarChar(sql.MAX), assessmentDescription)
        .query(
          `INSERT INTO dbo.Assessments (Week, Title, Description)
           OUTPUT INSERTED.AssessmentId AS AssessmentId
           VALUES (@week, @title, @description);`
        );

      const assessmentId = assessmentResult.recordset[0]?.AssessmentId;
      const questions = Array.isArray(assessment.questions) ? assessment.questions : [];

      for (let i = 0; i < questions.length; i += 1) {
        const question = questions[i] || {};
        const questionType = toCleanString(question.type).toLowerCase() || 'input';
        const questionText = toCleanString(question.text);
        const points = toNullableInt(question.points) ?? 1;
        const answer = questionType === 'input' ? toNullableString(question.answer) : null;
        const correctIndex = questionType === 'mcq' ? toNullableInt(question.correctIndex) : null;

        const questionResult = await new sql.Request(transaction)
          .input('assessmentId', sql.Int, assessmentId)
          .input('sortOrder', sql.Int, i + 1)
          .input('questionType', sql.NVarChar(50), questionType)
          .input('questionText', sql.NVarChar(sql.MAX), questionText)
          .input('answer', sql.NVarChar(sql.MAX), answer)
          .input('points', sql.Int, points)
          .input('correctIndex', sql.Int, correctIndex)
          .query(
            `INSERT INTO dbo.AssessmentQuestions (
               AssessmentId,
               SortOrder,
               QuestionType,
               QuestionText,
               Answer,
               Points,
               CorrectIndex
             )
             OUTPUT INSERTED.AssessmentQuestionId AS AssessmentQuestionId
             VALUES (
               @assessmentId,
               @sortOrder,
               @questionType,
               @questionText,
               @answer,
               @points,
               @correctIndex
             );`
          );

        const questionId = questionResult.recordset[0]?.AssessmentQuestionId;
        const choices = Array.isArray(question.choices) ? question.choices : [];

        for (let j = 0; j < choices.length; j += 1) {
          const text = toCleanString(choices[j]);
          if (!text) continue;
          await new sql.Request(transaction)
            .input('questionId', sql.Int, questionId)
            .input('sortOrder', sql.Int, j + 1)
            .input('choiceText', sql.NVarChar(sql.MAX), text)
            .query(
              `INSERT INTO dbo.AssessmentQuestionChoices (AssessmentQuestionId, SortOrder, ChoiceText)
               VALUES (@questionId, @sortOrder, @choiceText);`
            );
        }
      }
    }

    await transaction.commit();
    context.res = ok({ ok: true });
  } catch (error) {
    await transaction.rollback();
    context.res = response(500, { ok: false, error: error.message });
  }
}

module.exports = async function (context, req) {
  const weekParam = Number(req.params.week);
  if (!Number.isInteger(weekParam)) {
    context.res = badRequest('Invalid week parameter.');
    return;
  }

  try {
    switch (req.method) {
      case 'GET':
        await handleGet(context, weekParam);
        return;
      case 'PUT':
        await handlePut(context, req, weekParam);
        return;
      default:
        context.res = methodNotAllowed();
    }
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/package.json
{
  "name": "math-api",
  "version": "1.0.0",
  "private": true,
  "description": "Azure Functions API for Math app",
  "main": "index.js",
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "mssql": "^10.0.2"
  }
}
math/api/progress-complete/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["post"],
      "route": "progress/complete"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/progress-complete/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson } = require('../_shared/parse');
const { ok, badRequest, notFound, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };

  return String(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

module.exports = async function (context, req) {
  try {
    const payload = readJson(req);
    if (!payload) {
      context.res = badRequest('Invalid JSON body.');
      return;
    }

    const studentId =
      typeof payload.studentId === 'string'
        ? normalizeDigits(payload.studentId).trim()
        : '';
    const week = Number(payload.week);
    const finalScore = Number(payload.finalScore);

    if (!studentId) {
      context.res = badRequest('studentId is required.');
      return;
    }

    if (!Number.isInteger(week)) {
      context.res = badRequest('week must be an integer.');
      return;
    }

    if (!Number.isInteger(finalScore) || finalScore < 0 || finalScore > 100) {
      context.res = badRequest('finalScore must be an integer between 0 and 100.');
      return;
    }

    const dbPool = await getPool();

    const studentResult = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .query('SELECT StudentId FROM dbo.Students WHERE StudentId = @studentId');

    if (!studentResult.recordset.length) {
      context.res = notFound('Student not found.');
      return;
    }

    const weekResult = await dbPool
      .request()
      .input('week', sql.Int, week)
      .query('SELECT Week FROM dbo.Weeks WHERE Week = @week');

    if (!weekResult.recordset.length) {
      context.res = notFound('Week not found.');
      return;
    }

    const completionResult = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .input('week', sql.Int, week)
      .input('finalScore', sql.Int, finalScore)
      .query(
        `IF EXISTS (SELECT 1 FROM dbo.CardCompletions WHERE StudentId = @studentId AND Week = @week)
         BEGIN
           UPDATE dbo.CardCompletions
           SET FinalScore = @finalScore,
               CompletedAt = GETDATE()
           WHERE StudentId = @studentId AND Week = @week;
         END
         ELSE
         BEGIN
           INSERT INTO dbo.CardCompletions (StudentId, Week, FinalScore)
           VALUES (@studentId, @week, @finalScore);
         END

         SELECT StudentId, Week, FinalScore, CompletedAt
         FROM dbo.CardCompletions
         WHERE StudentId = @studentId AND Week = @week;`
      );

    const record = completionResult.recordset[0];

    context.res = ok({
      ok: true,
      studentId: record.StudentId,
      week: record.Week,
      finalScore: record.FinalScore,
      completedAt: record.CompletedAt
    });
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/progress-completed/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "progress/completed"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/progress-completed/index.js
const { getPool, sql } = require('../_shared/db');
const { getQuery } = require('../_shared/parse');
const { ok, badRequest, response } = require('../_shared/http');

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };

  return String(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

module.exports = async function (context, req) {
  try {
    const query = getQuery(req);
    const studentId =
      typeof query.studentId === 'string' ? normalizeDigits(query.studentId).trim() : '';

    if (!studentId) {
      context.res = badRequest('studentId is required.');
      return;
    }

    const dbPool = await getPool();
    const result = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .query(
        'SELECT Week, FinalScore, CompletedAt FROM dbo.CardCompletions WHERE StudentId = @studentId ORDER BY CompletedAt DESC'
      );

    context.res = ok(result.recordset);
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/api/routes/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "routes"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/routes/index.js
const { ok } = require('../_shared/http');

const ROUTES = {
  official: [
    { methods: ['GET'], path: '/api/health', description: 'Health check.' },
    { methods: ['POST'], path: '/api/progress/complete', description: 'Record student completion.' },
    { methods: ['GET'], path: '/api/progress/completed', description: 'Fetch completed progress.' },
    { methods: ['POST'], path: '/api/students/login', description: 'Student login.' },
    { methods: ['GET'], path: '/api/mng/students', description: 'List students for management.' },
    { methods: ['POST'], path: '/api/mng/students', description: 'Create student (management).' },
    { methods: ['PUT'], path: '/api/mng/students/{studentId}', description: 'Update student (management).' },
    { methods: ['DELETE'], path: '/api/mng/students/{studentId}', description: 'Delete student (management).' },
    { methods: ['GET'], path: '/api/mng/cards', description: 'List cards for management.' },
    { methods: ['POST'], path: '/api/mng/cards', description: 'Create card (management).' },
    { methods: ['PUT'], path: '/api/mng/cards/{week}', description: 'Update card (management).' },
    { methods: ['DELETE'], path: '/api/mng/cards/{week}', description: 'Delete card (management).' },
    { methods: ['GET'], path: '/api/mng/cards/{week}/completions', description: 'List card completions (management).' },
    { methods: ['GET'], path: '/api/mng/weeks/{week}/content', description: 'Fetch week content (management).' },
    { methods: ['PUT'], path: '/api/mng/weeks/{week}/content', description: 'Update week content (management).' },
    { methods: ['GET'], path: '/api/cards', description: 'Cards list.' },
    { methods: ['GET'], path: '/api/weeks/{week:int}', description: 'Week details.' },
    { methods: ['GET'], path: '/api/weeks', description: 'Weeks list.' },
    { methods: ['GET'], path: '/api/routes', description: 'Route catalog.' }
  ],
  aliases: []
};

module.exports = async function (context) {
  context.res = ok({ ok: true, routes: ROUTES });
};
math/api/student-login/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["post"],
      "route": "students/login"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/student-login/index.js
const { getPool, sql } = require('../_shared/db');
const { readJson } = require('../_shared/parse');
const { ok, badRequest, unauthorized, response } = require('../_shared/http');

function toLatinDigits(value) {
  const map = {
    '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
    '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
    '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
    '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9'
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}

function deriveFirstName(firstName, fullName) {
  const trimmedFirst = typeof firstName === 'string' ? firstName.trim() : '';
  if (trimmedFirst) {
    return trimmedFirst;
  }

  const trimmedFull = typeof fullName === 'string' ? fullName.trim() : '';
  if (!trimmedFull) {
    return '';
  }

  return trimmedFull.split(/\s+/)[0];
}

module.exports = async function (context, req) {
  try {
    const payload = readJson(req);
    if (!payload) {
      context.res = badRequest('Invalid JSON body.');
      return;
    }

    const studentId =
      typeof payload.studentId === 'string' ? toLatinDigits(payload.studentId).trim() : '';
    const birthYear =
      typeof payload.birthYear === 'string' ? toLatinDigits(payload.birthYear).trim() : '';

    if (!studentId || !birthYear) {
      context.res = badRequest('studentId and birthYear are required.');
      return;
    }

    const dbPool = await getPool();
    const result = await dbPool
      .request()
      .input('studentId', sql.NVarChar(20), studentId)
      .input('birthYear', sql.NVarChar(10), birthYear)
      .query(
        `SELECT TOP (1) StudentId, BirthYear, Name, Grade, Class, FirstName
         FROM dbo.Students
         WHERE StudentId = @studentId AND BirthYear = @birthYear`
      );

    if (!result.recordset.length) {
      context.res = unauthorized('INVALID_CREDENTIALS');
      return;
    }

    const student = result.recordset[0];
    const fullName = typeof student.Name === 'string' ? student.Name.trim() : '';
    const firstName = deriveFirstName(student.FirstName, fullName);

    context.res = ok({
      ok: true,
      student: {
        StudentId: student.StudentId,
        BirthYear: student.BirthYear,
        FirstName: firstName,
        FullName: fullName,
        Grade: student.Grade,
        Class: student.Class
      }
    });
  } catch (error) {
    context.res = response(500, { ok: false, message: 'DB_ERROR' });
  }
};
math/api/week/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "weeks/{week:int}"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/week/index.js
const { getPool, sql } = require('../_shared/db');
const { DEFAULT_HEADERS } = require('../_shared/http');

module.exports = async function (context, req) {
  try {
    const weekParam = Number(req.params.week);
    if (!Number.isInteger(weekParam)) {
      context.res = {
        status: 400,
        headers: DEFAULT_HEADERS,
        body: { ok: false, error: 'Invalid week parameter.' }
      };
      return;
    }

    const dbPool = await getPool();

    if (req.method !== 'GET') {
      context.res = {
        status: 405,
        headers: DEFAULT_HEADERS,
        body: { ok: false, error: 'Method not allowed.' }
      };
      return;
    }

    const weekResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query('SELECT Week, Title FROM dbo.Weeks WHERE Week = @week AND IsDeleted = 0');

    if (!weekResult.recordset.length) {
      context.res = {
        status: 404,
        headers: DEFAULT_HEADERS,
        body: { ok: false, error: 'Week not found.' }
      };
      return;
    }

    const goalsResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query(
        'SELECT GoalId, Week, SortOrder, GoalText FROM dbo.WeekGoals WHERE Week = @week ORDER BY SortOrder'
      );

    const prerequisitesResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query(
        'SELECT PrerequisiteId, Week, SortOrder, PrerequisiteText FROM dbo.WeekPrerequisites WHERE Week = @week ORDER BY SortOrder'
      );

    const conceptsResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query('SELECT ConceptId, Week, SortOrder, Title FROM dbo.Concepts WHERE Week = @week ORDER BY SortOrder');

    const conceptIds = conceptsResult.recordset.map((concept) => concept.ConceptId);
    let flowItemsResult = { recordset: [] };
    let flowDetailsResult = { recordset: [] };
    let flowHintsResult = { recordset: [] };
    let flowChoicesResult = { recordset: [] };

    if (conceptIds.length) {
      const inClause = conceptIds.map((_, index) => `@concept${index}`).join(',');
      const flowRequest = dbPool.request();
      conceptIds.forEach((id, index) => {
        flowRequest.input(`concept${index}`, sql.Int, id);
      });

      flowItemsResult = await flowRequest.query(
        `SELECT FlowItemId, ConceptId, SortOrder, ItemType, ItemText, ItemTitle, ItemDescription, ItemUrl, Answer, CorrectIndex, Solution
         FROM dbo.FlowItems
         WHERE ConceptId IN (${inClause})
         ORDER BY ConceptId, SortOrder`
      );

      const flowItemIds = flowItemsResult.recordset.map((item) => item.FlowItemId);
      if (flowItemIds.length) {
        const itemClause = flowItemIds.map((_, index) => `@item${index}`).join(',');
        const detailRequest = dbPool.request();
        flowItemIds.forEach((id, index) => {
          detailRequest.input(`item${index}`, sql.Int, id);
        });

        flowDetailsResult = await detailRequest.query(
          `SELECT FlowItemDetailId, FlowItemId, SortOrder, DetailText
           FROM dbo.FlowItemDetails
           WHERE FlowItemId IN (${itemClause})
           ORDER BY FlowItemId, SortOrder`
        );

        const hintRequest = dbPool.request();
        flowItemIds.forEach((id, index) => {
          hintRequest.input(`item${index}`, sql.Int, id);
        });

        flowHintsResult = await hintRequest.query(
          `SELECT FlowItemHintId, FlowItemId, SortOrder, HintText
           FROM dbo.FlowItemHints
           WHERE FlowItemId IN (${itemClause})
           ORDER BY FlowItemId, SortOrder`
        );

        const choiceRequest = dbPool.request();
        flowItemIds.forEach((id, index) => {
          choiceRequest.input(`item${index}`, sql.Int, id);
        });

        flowChoicesResult = await choiceRequest.query(
          `SELECT FlowItemChoiceId, FlowItemId, SortOrder, ChoiceText
           FROM dbo.FlowItemChoices
           WHERE FlowItemId IN (${itemClause})
           ORDER BY FlowItemId, SortOrder`
        );
      }
    }

    const assessmentsResult = await dbPool
      .request()
      .input('week', sql.Int, weekParam)
      .query(
        'SELECT AssessmentId, Week, Title, Description FROM dbo.Assessments WHERE Week = @week ORDER BY AssessmentId'
      );

    const assessmentIds = assessmentsResult.recordset.map(
      (assessment) => assessment.AssessmentId
    );
    let assessmentQuestionsResult = { recordset: [] };
    let assessmentChoicesResult = { recordset: [] };

    if (assessmentIds.length) {
      const assessmentClause = assessmentIds.map((_, index) => `@assessment${index}`).join(',');
      const assessmentRequest = dbPool.request();
      assessmentIds.forEach((id, index) => {
        assessmentRequest.input(`assessment${index}`, sql.Int, id);
      });

      assessmentQuestionsResult = await assessmentRequest.query(
        `SELECT AssessmentQuestionId, AssessmentId, SortOrder, QuestionType, QuestionText, Answer, Points, CorrectIndex
         FROM dbo.AssessmentQuestions
         WHERE AssessmentId IN (${assessmentClause})
         ORDER BY AssessmentId, SortOrder`
      );

      const questionIds = assessmentQuestionsResult.recordset.map(
        (question) => question.AssessmentQuestionId
      );

      if (questionIds.length) {
        const questionClause = questionIds.map((_, index) => `@question${index}`).join(',');
        const questionRequest = dbPool.request();
        questionIds.forEach((id, index) => {
          questionRequest.input(`question${index}`, sql.Int, id);
        });

        assessmentChoicesResult = await questionRequest.query(
          `SELECT AssessmentChoiceId, AssessmentQuestionId, SortOrder, ChoiceText
           FROM dbo.AssessmentQuestionChoices
           WHERE AssessmentQuestionId IN (${questionClause})
           ORDER BY AssessmentQuestionId, SortOrder`
        );
      }
    }

    const detailsByItem = new Map();
    flowDetailsResult.recordset.forEach((detail) => {
      if (!detailsByItem.has(detail.FlowItemId)) {
        detailsByItem.set(detail.FlowItemId, []);
      }
      detailsByItem.get(detail.FlowItemId).push(detail);
    });

    const hintsByItem = new Map();
    flowHintsResult.recordset.forEach((hint) => {
      if (!hintsByItem.has(hint.FlowItemId)) {
        hintsByItem.set(hint.FlowItemId, []);
      }
      hintsByItem.get(hint.FlowItemId).push(hint);
    });

    const choicesByItem = new Map();
    flowChoicesResult.recordset.forEach((choice) => {
      if (!choicesByItem.has(choice.FlowItemId)) {
        choicesByItem.set(choice.FlowItemId, []);
      }
      choicesByItem.get(choice.FlowItemId).push(choice);
    });

    const flowItemsByConcept = new Map();
    flowItemsResult.recordset.forEach((item) => {
      if (!flowItemsByConcept.has(item.ConceptId)) {
        flowItemsByConcept.set(item.ConceptId, []);
      }
      flowItemsByConcept.get(item.ConceptId).push({
        item,
        details: detailsByItem.get(item.FlowItemId) || [],
        hints: hintsByItem.get(item.FlowItemId) || [],
        choices: choicesByItem.get(item.FlowItemId) || []
      });
    });

    const concepts = conceptsResult.recordset.map((concept) => ({
      concept,
      flow: flowItemsByConcept.get(concept.ConceptId) || []
    }));

    const choicesByQuestion = new Map();
    assessmentChoicesResult.recordset.forEach((choice) => {
      if (!choicesByQuestion.has(choice.AssessmentQuestionId)) {
        choicesByQuestion.set(choice.AssessmentQuestionId, []);
      }
      choicesByQuestion.get(choice.AssessmentQuestionId).push(choice);
    });

    const questionsByAssessment = new Map();
    assessmentQuestionsResult.recordset.forEach((question) => {
      if (!questionsByAssessment.has(question.AssessmentId)) {
        questionsByAssessment.set(question.AssessmentId, []);
      }
      questionsByAssessment.get(question.AssessmentId).push({
        question,
        choices: choicesByQuestion.get(question.AssessmentQuestionId) || []
      });
    });

    const assessments = assessmentsResult.recordset.map((assessment) => ({
      assessment,
      questions: questionsByAssessment.get(assessment.AssessmentId) || []
    }));

    const weekData = weekResult.recordset[0];
    const goals = goalsResult.recordset.map((goal) => goal.GoalText);
    const prerequisites = prerequisitesResult.recordset.map(
      (prereq) => prereq.PrerequisiteText
    );

    const normalizedConcepts = concepts.map(({ concept, flow }) => ({
      title: concept.Title,
      flow: flow.map(({ item, details, hints, choices }) => {
        const type = String(item.ItemType || '').trim().toLowerCase();
        const mapped = {
          type,
          text: item.ItemText,
          title: item.ItemTitle,
          description: item.ItemDescription,
          url: item.ItemUrl,
          answer: item.Answer,
          correctIndex: item.CorrectIndex,
          solution: item.Solution,
          details: details.map((detail) => detail.DetailText),
          hints: hints.map((hint) => hint.HintText),
          choices: choices.map((choice) => choice.ChoiceText)
        };

        if (!mapped.details.length) delete mapped.details;
        if (!mapped.hints.length) delete mapped.hints;
        if (!mapped.choices.length) delete mapped.choices;

        return mapped;
      })
    }));

    const normalizedAssessments = assessments.map(({ assessment, questions }) => ({
      title: assessment.Title,
      description: assessment.Description,
      questions: questions.map(({ question, choices }) => {
        const rawType = String(question.QuestionType || '').trim().toLowerCase();
        const choiceTexts = choices.map((choice) => choice.ChoiceText);
        let type = rawType;
        if (!['mcq', 'input'].includes(type)) {
          type = choiceTexts.length ? 'mcq' : 'input';
        }

        const normalized = {
          type,
          text: question.QuestionText,
          points: Number.isFinite(question.Points) ? question.Points : 1
        };

        if (type === 'mcq') {
          normalized.choices = choiceTexts;
          normalized.correctIndex =
            typeof question.CorrectIndex === 'number' ? question.CorrectIndex : 0;
        } else {
          normalized.answer = question.Answer ?? '';
        }

        return normalized;
      })
    }));

    context.res = {
      status: 200,
      headers: DEFAULT_HEADERS,
      body: {
        week: weekData.Week,
        title: weekData.Title,
        goals,
        prerequisites,
        concepts: normalizedConcepts,
        assessment: normalizedAssessments[0] || null
      }
    };
  } catch (error) {
    context.res = {
      status: 500,
      headers: DEFAULT_HEADERS,
      body: { ok: false, error: error.message }
    };
  }
};
math/api/weeks/function.json
{
  "bindings": [
    {
      "authLevel": "anonymous",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["get"],
      "route": "weeks"
    },
    {
      "type": "http",
      "direction": "out",
      "name": "res"
    }
  ]
}
math/api/weeks/index.js
const { getPool } = require('../_shared/db');
const { ok, response } = require('../_shared/http');

module.exports = async function (context) {
  try {
    const dbPool = await getPool();
    const result = await dbPool
      .request()
      .query('SELECT Week, Title FROM dbo.Weeks WHERE IsDeleted = 0 ORDER BY Week');
    context.res = ok(result.recordset);
  } catch (error) {
    context.res = response(500, { ok: false, error: error.message });
  }
};
math/docs/api-routes.md
# API Routes

## Official routes

| Method | Path | Description |
| --- | --- | --- |
| GET | `/api/health` | Health check. |
| POST | `/api/progress/complete` | Record student completion. |
| GET | `/api/progress/completed` | Fetch completed progress. |
| POST | `/api/students/login` | Student login. |
| GET | `/api/weeks/{week:int}` | Week details. |
| GET | `/api/weeks` | Weeks list. |
| GET | `/api/routes` | Route catalog. |

## cURL examples

```bash
curl -X POST "https://<your-app>.azurestaticapps.net/api/students/login" \
  -H "Content-Type: application/json" \
  -d '{"studentId":"123456","birthYear":"2012"}'
```

```bash
curl -X GET "https://<your-app>.azurestaticapps.net/api/weeks"
```

```bash
curl -X GET "https://<your-app>.azurestaticapps.net/api/routes"
```

```bash
curl -X GET "https://<your-app>.azurestaticapps.net/api/health"
```
math/docs/removed-files.md
# Removed Files Log

The following files were removed as requested:

- public/assets/cert/certificate.html
- server/package.json
- server/.env.example
- server/.env
- server/src/db.js
- server/src/server.js
- server/src/app.js
- dumb.txt
- server/ (untracked directory)
- api/node_modules/ (generated dependencies)
math/public/assets/cert/certificate.css
/* =========================================================
   certificate.css — Certificate Page Styles (Light Material)
   هدف النسخة الحالية:
   - الشهادة تظهر كاملة داخل شاشة الجوال (Screenshot واحد بدون سكرول)
   - إخفاء أزرار الأكشن على الجوال عشان ما تزود الارتفاع
   ========================================================= */

.cert-app {
  background: #f6f7fb;
}

.cert-shell {
  max-width: 980px;
  margin: 0 auto;
}

/* Certificate Paper */
.cert-paper {
  position: relative;
  background: #fff;
  border-radius: 16px;
  padding: 40px 36px 32px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
  overflow: hidden;
}

/* Subtle background */
.cert-bg {
  position: absolute;
  inset: -20% -10% auto auto;
  width: 420px;
  height: 420px;
  background: radial-gradient(closest-side, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0));
  pointer-events: none;
}

/* Header */
.cert-head {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 16px;
  align-items: center;
  margin-bottom: 24px;
}

.cert-badge {
  font-size: 44px;
  line-height: 1;
}

.cert-title {
  font-size: 32px;
  margin: 0;
}

.cert-sub {
  margin: 4px 0 0;
  color: #64748b;
}

/* Body */
.cert-body {
  margin-top: 8px;
}

.cert-line {
  margin: 18px 0 6px;
  color: #475569;
  font-size: 14px;
}

.cert-name {
  font-size: 34px;
  font-weight: 800;
  letter-spacing: 0.2px;
  color: #0f172a;
  padding: 6px 0 2px;
}

.cert-card {
  font-size: 22px;
  font-weight: 700;
  color: #1e293b;
  padding: 4px 0 10px;
}

/* Meta */
.cert-meta {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 20px;
}

.cert-meta-item {
  background: #f8fafc;
  border: 1px dashed #e5e7eb;
  border-radius: 12px;
  padding: 10px 12px;
  text-align: center;
}

.cert-meta-k {
  display: block;
  font-size: 12px;
  color: #64748b;
}

.cert-meta-v {
  display: block;
  margin-top: 2px;
  font-weight: 700;
  color: #0f172a;
}

/* Footer */
.cert-footer {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 16px;
  align-items: center;
  margin-top: 28px;
}

.cert-sign {
  display: flex;
  gap: 8px;
  align-items: baseline;
}

.cert-sign-k {
  font-size: 12px;
  color: #64748b;
}

.cert-sign-v {
  font-weight: 700;
}

/* Stamp */
.cert-stamp {
  position: relative;
  width: 86px;
  height: 86px;
}

.cert-stamp-ring {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid #2563eb;
  opacity: 0.9;
}

.cert-stamp-text {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-weight: 800;
  color: #2563eb;
  transform: rotate(-12deg);
}

/* Actions */
.cert-actions {
  display: grid;
  gap: 10px;
  margin-top: 16px;
}

/* Empty */
#certEmpty.card {
  margin-top: 16px;
}

/* Print */
@media print {
  body {
    background: #fff;
  }

  .topbar,
  .cert-actions {
    display: none !important;
  }

  .cert-paper {
    box-shadow: none;
    border-radius: 0;
    padding: 24mm 20mm;
  }

  @page {
    size: A4;
    margin: 10mm;
  }
}

/* =========================================================
   Mobile Screenshot Mode (default on small screens)
   - Center certificate
   - Fit inside viewport (no scroll)
   - Hide actions to keep one-shot screenshot
   ========================================================= */
@media (max-width: 640px) {
  /* make page fit screen */
  html, body {
    height: 100%;
    overflow: hidden; /* screenshot بدون سكرول */
  }

  .container.section {
    padding-block: 12px;
  }

  .cert-shell {
    height: calc(100vh - 72px); /* تقريبًا ارتفاع topbar */
    display: grid;
    place-items: center;
  }

  /* Hide actions on mobile for one-screen screenshot */
  .cert-actions {
    display: none !important;
  }

  /* Fit paper into viewport */
  .cert-paper {
    width: min(94vw, 420px);
    max-height: calc(100vh - 92px);
    padding: 18px 16px 14px;
    box-shadow: 0 14px 30px rgba(15, 23, 42, 0.10);
    overflow: hidden;
  }

  .cert-bg {
    width: 320px;
    height: 320px;
    inset: -25% -20% auto auto;
  }

  .cert-head {
    gap: 12px;
    margin-bottom: 14px;
  }

  .cert-badge {
    font-size: 34px;
  }

  .cert-title {
    font-size: 22px;
  }

  .cert-sub {
    font-size: 12px;
  }

  .cert-line {
    margin: 10px 0 4px;
    font-size: 12px;
  }

  .cert-name {
    font-size: 22px;
    padding: 2px 0 2px;
  }

  .cert-card {
    font-size: 15px;
    padding: 2px 0 6px;
  }

  .cert-meta {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
  }

  .cert-meta-item {
    padding: 8px 8px;
    border-radius: 10px;
  }

  .cert-meta-k {
    font-size: 11px;
  }

  .cert-meta-v {
    font-size: 12px;
  }

  .cert-footer {
    margin-top: 12px;
    grid-template-columns: 1fr auto;
    gap: 10px;
  }

  .cert-stamp {
    width: 64px;
    height: 64px;
  }

  .cert-stamp-ring {
    border-width: 2px;
  }

  .cert-sign-k {
    font-size: 11px;
  }

  .cert-sign-v {
    font-size: 12px;
  }
}
math/public/assets/css/base.css
/* =========================================================
   base.css — Light Material Design System (Arabic-first)
   - Daylight theme, soft shadows, rounded buttons/cards
   - Mobile-first, responsive container
   - Works for index.html + lesson.html
   ========================================================= */

/* ---------- Fonts (system + Arabic-friendly fallbacks) ---------- */
:root{
  /* Typography */
  --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Kufi Arabic", "Cairo", "Tajawal", Arial, sans-serif;

  /* Colors (Light Material) */
  --bg: #f6f8fc;
  --surface: #ffffff;
  --surface-2: #eef2f9;
  --text: #0b1324;
  --muted: #586174;
  --border: rgba(15, 23, 42, 0.08);

  /* Brand */
  --primary: #2563eb;
  --primary-600: #1d4ed8;
  --primary-100: rgba(37, 99, 235, 0.12);

  --success: #16a34a;
  --warning: #f59e0b;
  --danger:  #dc2626;

  /* Completion (Gold) */
  --gold: #d4af37;
  --gold-2: #f5d76e;
  --gold-surface: rgba(212, 175, 55, 0.12);

  /* Radii */
  --r-xs: 10px;
  --r-sm: 14px;
  --r-md: 18px;
  --r-lg: 24px;

  /* Shadows (soft) */
  --shadow-xs: 0 1px 2px rgba(15,23,42,.05), 0 1px 1px rgba(15,23,42,.03);
  --shadow-sm: 0 10px 20px rgba(15,23,42,.08);
  --shadow-md: 0 18px 36px rgba(15,23,42,.10);
  --shadow-lg: 0 30px 68px rgba(15,23,42,.14);
  --shadow-soft: 0 12px 34px rgba(15,23,42,.08);

  /* Spacing */
  --container: 1040px;
  --pad: 18px;

  /* Focus */
  --focus: 0 0 0 4px rgba(37, 99, 235, 0.18);
}

/* ---------- Reset & Base ---------- */
*{ box-sizing: border-box; }
html, body{ height:100%; }
html{ -webkit-text-size-adjust:100%; }
body{
  margin:0;
  font-family: var(--font-sans);
  background: radial-gradient(1200px 700px at 80% -10%, rgba(37,99,235,.08), transparent 60%),
              radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.08), transparent 55%),
              var(--bg);
  color: var(--text);
  line-height: 1.75;
  direction: rtl;
  font-weight: 500;
  letter-spacing: 0;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

body.is-loading #screen-id,
body.is-loading #screen-welcome,
body.is-loading #screen-cards{
  display: none !important;
}

.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.loading-overlay.hidden {
  display: none;
}

.loading-panel {
  background: var(--surface);
  padding: 18px 22px;
  border-radius: var(--r-md);
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  gap: 12px;
}

.loading-spinner {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 3px solid rgba(37, 99, 235, 0.2);
  border-top-color: var(--primary);
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

img{ max-width:100%; display:block; }
a{ color: inherit; text-decoration: none; }
button, input, select, textarea{
  font: inherit;
  color: inherit;
}
::selection{
  background: rgba(37, 99, 235, 0.18);
}

/* ---------- Layout ---------- */
.app{
  min-height: 100%;
  display:flex;
  flex-direction: column;
}
.container{
  width: min(var(--container), calc(100% - (var(--pad) * 2)));
  margin-inline: auto;
}
.section{
  padding-block: 28px;
}
.stack{ display:flex; flex-direction: column; gap: 18px; }
.row{ display:flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.grid{
  display:grid;
  gap: 18px;
}
.grid.cards{
  grid-template-columns: repeat(1, minmax(0, 1fr));
}
@media (min-width: 560px){
  .grid.cards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (min-width: 920px){
  .grid.cards{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
}

/* ---------- Top Bar ---------- */
.topbar{
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(246,248,252,.92);
  backdrop-filter: blur(14px);
  border-bottom: 1px solid rgba(15,23,42,.08);
  box-shadow: 0 6px 14px rgba(15,23,42,.04);
}
.topbar-inner{
  padding: 14px 0;
  display:flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
.brand{
  display:flex;
  align-items:center;
  gap: 10px;
  user-select:none;
}
.brand-mark{
  width: 38px;
  height: 38px;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(99,102,241,.90));
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow:hidden;
}
.brand-mark::after{
  content:"";
  position:absolute;
  inset: -40% -40% auto auto;
  width: 70px;
  height: 70px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
  transform: rotate(25deg);
}
.brand-title{
  display:flex;
  flex-direction: column;
  line-height: 1.2;
}
.brand-title b{
  font-size: 16px;
  letter-spacing: .2px;
}
.brand-title span{
  font-size: 12px;
  color: var(--muted);
}

/* ---------- Typography ---------- */
.h1{
  font-size: 25px;
  font-weight: 800;
  margin: 0;
  letter-spacing: .1px;
}
.h2{
  font-size: 20px;
  font-weight: 800;
  margin: 0;
}
.p{
  margin: 0;
  color: var(--muted);
  font-size: 15px;
}
.small{ font-size: 12px; color: var(--muted); }
.kbd{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 2px 8px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--surface);
  font-size: 12px;
  box-shadow: var(--shadow-xs);
}

/* ---------- Card ---------- */
.card{
  position: relative;
  overflow: hidden;
  background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-sm);
  padding: 20px;
  transition: box-shadow .2s ease, transform .2s ease;
}
.card::after{
  content:"";
  position:absolute;
  inset: 0;
  background: radial-gradient(320px 120px at 15% -20%, rgba(37,99,235,.08), transparent 70%);
  opacity: .7;
  pointer-events: none;
}
@media (hover: hover){
  .card:hover{
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
  }
}
.card.soft{
  background: linear-gradient(180deg, var(--surface), var(--surface-2));
}
.card-header{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.card-title{
  font-weight: 800;
  font-size: 16px;
  margin: 0;
}
.card-subtitle{
  margin: 6px 0 0;
  font-size: 13px;
  color: var(--muted);
}
.card-body{ display:flex; flex-direction: column; gap: 12px; }
.card-footer{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-top: 14px;
}

/* ---------- Buttons ---------- */
.btn{
  appearance:none;
  border: 1px solid transparent;
  border-radius: 999px;
  padding: 12px 18px;
  min-height: 44px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  font-weight: 800;
  font-size: 15px;
  user-select:none;
  transition: transform .08s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
}
.btn:active{ transform: translateY(1px); }
.btn:disabled{
  opacity: .55;
  cursor:not-allowed;
  transform:none;
}
.btn-primary{
  background: linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1));
  color:#fff;
  box-shadow: 0 12px 26px rgba(37,99,235,.20);
}
.btn-primary:hover{ box-shadow: 0 16px 34px rgba(37,99,235,.26); }
.btn-outline{
  background: rgba(255,255,255,.9);
  border-color: rgba(15,23,42,.14);
  color: var(--text);
  box-shadow: var(--shadow-xs);
}
.btn-outline:hover{
  background: var(--surface);
  box-shadow: var(--shadow-sm);
}
.btn-ghost{
  background: transparent;
  border-color: transparent;
  color: var(--text);
}
.btn-ghost:hover{
  background: rgba(17,24,39,.06);
}
.btn-sm{ padding: 9px 12px; font-size: 13px; min-height: 36px; }
.btn-lg{ padding: 14px 20px; font-size: 16px; }

/* ---------- Inputs ---------- */
.field{
  display:flex;
  flex-direction: column;
  gap: 8px;
}
.label{
  font-size: 14px;
  color: var(--muted);
  font-weight: 700;
}
.input{
  width: 100%;
  border: 1px solid rgba(15,23,42,.14);
  background: linear-gradient(180deg, #ffffff 0%, #f7faff 100%);
  border-radius: 16px;
  padding: 13px 14px;
  min-height: 44px;
  box-shadow: var(--shadow-xs);
  outline: none;
  transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
  font-size: 15px;
}
.input.is-static{
  display:flex;
  align-items:center;
  color: var(--text);
  user-select: text;
}
.input::placeholder{ color: rgba(107,114,128,.85); }
.input:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: var(--focus), var(--shadow-sm);
  background: #fff;
}
.help{
  font-size: 12px;
  color: var(--muted);
}

/* ---------- Badges & Status ---------- */
.badge{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.8);
}
.badge.primary{
  border-color: rgba(37,99,235,.22);
  background: rgba(37,99,235,.10);
  color: var(--primary-600);
}
.badge.locked{
  border-color: rgba(17,24,39,.14);
  background: rgba(17,24,39,.06);
  color: var(--muted);
}
.badge.disabled{
  border-color: rgba(148,163,184,.45);
  background: rgba(226,232,240,.6);
  color: rgba(100,116,139,.95);
}
.badge.done{
  border-color: rgba(212,175,55,.40);
  background: var(--gold-surface);
  color: #6b4f00;
}

/* ---------- Card States (Locked / Done) ---------- */
.card.is-locked{
  opacity: .72;
  filter: grayscale(.05);
}
.card.is-locked .card-title{ color: rgba(17,24,39,.80); }
.card.is-disabled{
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
  border-color: rgba(148,163,184,.35);
  opacity: .72;
  box-shadow: var(--shadow-xs);
}
.card.is-disabled::after{
  opacity: .35;
}
.card.is-disabled:hover{
  transform: none;
  box-shadow: var(--shadow-xs);
}
.card.is-done{
  border-color: rgba(212,175,55,.65);
  background:
    radial-gradient(700px 220px at 80% -40%, rgba(245,215,110,.28), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,1), rgba(255,248,226,1));
}
.star{
  width: 26px;
  height: 26px;
  border-radius: 10px;
  background: linear-gradient(180deg, var(--gold-2), var(--gold));
  box-shadow: 0 10px 18px rgba(212,175,55,.22);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 auto;
}
.star svg{
  width: 16px;
  height: 16px;
  fill: #6b4f00;
}

/* ---------- Divider ---------- */
.hr{
  border: none;
  height: 1px;
  background: rgba(15,23,42,.10);
  margin: 12px 0;
}

/* ---------- Focus ring for buttons/links ---------- */
:focus-visible{
  outline: none;
  box-shadow: var(--focus);
  border-radius: 14px;
}

/* ---------- Utility ---------- */
.hidden,
[hidden]{ display:none !important; }
.center{ text-align:center; }
.muted{ color: var(--muted); }
.spacer{ height: 10px; }
.w-100{ width:100%; }
.nowrap{ white-space:nowrap; }
.ltr{ direction:ltr; }
.rtl{ direction:rtl; }

@media (max-width: 640px){
  .topbar-inner{ padding: 12px 0; }
  .section{ padding-block: 22px; }
  .card{ padding: 16px; }
  .card-header{ flex-direction: column; align-items: flex-start; }
  .h1{ font-size: 22px; }
  .h2{ font-size: 18px; }
  .p{ font-size: 14px; }
  .btn{ width: 100%; }
  .btn.btn-sm{ width: auto; }
}
math/public/assets/css/lesson.css
/* =========================================================
   lesson.css — Lesson Page Layout & Progress (Light Material)
   Depends on base.css
   ========================================================= */

/* ---------- Header (Lesson Title) ---------- */
.lesson-header{
  margin-top: 14px;
}
.lesson-title{
  display:flex;
  flex-direction: column;
  gap: 6px;
}
.lesson-title .h1{
  font-size: 23px;
}
.lesson-meta{
  display:flex;
  gap: 12px;
  align-items:center;
  flex-wrap: wrap;
}
.lesson-student{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 999px;
  background: rgba(37,99,235,.10);
  border: 1px solid rgba(37,99,235,.18);
  font-size: 12px;
  font-weight: 800;
}

/* ---------- Progress Bar ---------- */
.progress-wrap{
  margin: 20px 0 24px;
}
.progress-label{
  display:flex;
  align-items:center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.progress-label span{
  font-size: 12px;
  color: var(--muted);
  font-weight: 800;
}
.progress{
  height: 14px;
  border-radius: 999px;
  background: rgba(17,24,39,.10);
  overflow: hidden;
  box-shadow: inset 0 1px 2px rgba(17,24,39,.12);
}
.progress > i{
  display:block;
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, rgba(37,99,235,1), rgba(99,102,241,1));
  border-radius: 999px;
  transition: width .28s ease;
}

/* ---------- Concept Card ---------- */
.concept{
  margin-bottom: 22px;
}
.concept .card{
  padding: 20px;
}
.concept-header{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 14px;
  flex-wrap: wrap;
}
.concept-index{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 34px;
  height: 34px;
  border-radius: 14px;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.18);
  font-weight: 900;
  font-size: 14px;
}
.concept-title{
  font-size: 18px;
  font-weight: 900;
  margin: 0;
}
.concept-body{
  display:flex;
  flex-direction: column;
  gap: 16px;
}
.lesson-stage{
  display:flex;
  flex-direction: column;
  gap: 16px;
  padding: 20px;
}
.stage-header{
  display:flex;
  flex-direction: column;
  gap: 6px;
}
.stage-badge{
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.18);
  font-size: 12px;
  font-weight: 800;
}
.stage-title{
  font-size: 18px;
  font-weight: 900;
  margin: 0;
}
.stage-desc{
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}
.stage-body{
  display:flex;
  flex-direction: column;
  gap: 12px;
}
.stage-empty{
  padding: 12px;
  border-radius: 12px;
  background: rgba(17,24,39,.04);
  border: 1px dashed rgba(17,24,39,.12);
  font-size: 14px;
  color: var(--muted);
}
.stage-progress{
  display:flex;
  flex-direction: column;
  gap: 12px;
  padding-bottom: 12px;
  margin-bottom: 12px;
  border-bottom: 1px solid rgba(17,24,39,.08);
}
.goal-list,
.goal-progress{
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.goal-item{
  display:flex;
  gap: 10px;
  align-items:center;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(17,24,39,.08);
  background: rgba(255,255,255,.9);
}
.goal-index{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.2);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 12px;
  font-weight: 900;
}
.goal-progress-item{
  display:flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(17,24,39,.08);
  background: rgba(255,255,255,.9);
}
.goal-progress-item .goal-text{
  font-size: 15px;
}
.goal-progress-item.done{
  border-color: rgba(16,185,129,.4);
  background: rgba(16,185,129,.08);
}
.goal-progress-item.current{
  border-color: rgba(37,99,235,.4);
  background: rgba(37,99,235,.08);
}
.goal-progress-item.current .goal-text{
  font-weight: 900;
}
.goal-progress-item.upcoming{
  color: rgba(17,24,39,.6);
  background: rgba(17,24,39,.03);
}
.goal-progress-item.muted{
  color: rgba(17,24,39,.5);
}
.goal-status{
  font-size: 12px;
  font-weight: 800;
  color: var(--muted);
}
.goal-progress-item.current .goal-status{
  color: #1d4ed8;
}
.goal-progress-item.done .goal-status{
  color: #16a34a;
}

/* ---------- Steps ---------- */
.step{
  border-radius: 16px;
  padding: 16px;
  border: 1px dashed rgba(17,24,39,.14);
  background: rgba(255,255,255,.86);
  box-shadow: var(--shadow-xs);
}
.step-title{
  font-weight: 900;
  font-size: 14px;
  margin: 0 0 6px;
}
.step-text{
  font-size: 15px;
  color: var(--text);
}
.step.muted{
  background: rgba(17,24,39,.04);
}
.step.example{
  background: rgba(37,99,235,.06);
  border-style: solid;
}
.step.warning{
  background: rgba(245,158,11,.10);
  border-style: solid;
}
.step.note{
  background: rgba(16,185,129,.08);
  border-style: solid;
}
.step.detail{
  background: rgba(99,102,241,.08);
  border-style: solid;
}
.step-details{
  margin: 10px 0 0;
  padding-inline-start: 18px;
  color: var(--muted);
  font-size: 14px;
}
.step.video{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.video-frame{
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(17,24,39,.12);
  background: rgba(17,24,39,.04);
}
.video-embed{
  width: 100%;
  min-height: 240px;
  border: 0;
  display: block;
}
.video-empty{
  padding: 16px;
  font-size: 14px;
  color: var(--muted);
}

/* ---------- Question Area ---------- */
.question-wrap{
  margin-top: 10px;
  padding: 18px;
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,1), rgba(243,245,251,1));
  border: 1px solid rgba(17,24,39,.14);
  box-shadow: var(--shadow-sm);
}
.question-title{
  font-size: 17px;
  font-weight: 900;
  margin: 0 0 10px;
}
.question-actions{
  display:flex;
  gap: 10px;
  align-items:center;
  justify-content: space-between;
  flex-wrap: wrap;
  margin-top: 12px;
}

/* ---------- Attempts / Status ---------- */
.attempts{
  display:flex;
  gap: 6px;
  align-items:center;
}
.dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: rgba(17,24,39,.18);
}
.dot.used{
@@ -173,49 +175,54 @@
}

/* ---------- Solution Box ---------- */
.solution{
  margin-top: 12px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(220,38,38,.06);
  border: 1px solid rgba(220,38,38,.18);
}
.solution-title{
  font-size: 13px;
  font-weight: 900;
  margin: 0 0 6px;
}
.solution-text{
  font-size: 14px;
}

/* ---------- Navigation Buttons ---------- */
.lesson-nav{
  display:flex;
  gap: 10px;
  justify-content: space-between;
  margin-top: 16px;
  flex-wrap: wrap;
}
.lesson-nav .btn{
  min-width: 120px;
}
.assessment{
  border: 1px solid rgba(37,99,235,.12);
}
.assessment-body{
  display:flex;
  flex-direction: column;
  gap: 14px;
}
.assessment-question{
  border-radius: 14px;
  padding: 12px;
  border: 1px dashed rgba(17,24,39,.12);
  background: rgba(255,255,255,.92);
}
.assessment-title{
  font-weight: 800;
  margin: 0 0 8px;
}
.assessment-result{
  margin-top: 16px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(37,99,235,.2);
  display:flex;
  flex-direction: column;
  gap: 8px;
}
.assessment-score{
  font-size: 15px;
}
.assessment-note{
  font-size: 13px;
  color: var(--muted);
}

/* ---------- Completion State ---------- */
.lesson-complete{
  margin-top: 18px;
}
.lesson-complete .card{
  border-color: rgba(212,175,55,.65);
  background:
    radial-gradient(800px 240px at 80% -40%, rgba(245,215,110,.28), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,1), rgba(255,248,226,1));
}
.lesson-complete .h2{
  color: #6b4f00;
}

/* ---------- Responsive tweaks ---------- */
@media (max-width: 480px){
  .lesson-title .h1{ font-size: 20px; }
  .lesson-meta{ gap: 8px; }
  .progress{ height: 12px; }
  .question-wrap{ padding: 12px; }
  .lesson-nav{ flex-direction: column; }
  .lesson-nav .btn{ width: 100%; }
}
math/public/assets/css/mng/card-editor.css
.page-shell {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.editor-header {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 16px 0;
}

.editor-header .header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

.editor-title {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
}

.editor-subtitle {
  margin: 4px 0 0;
  color: #6b7280;
  font-size: 14px;
}

.editor-layout {
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: 20px;
  padding: 20px 0 80px;
}

.editor-sidebar {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  position: sticky;
  top: 16px;
  height: fit-content;
}

.sidebar-title {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 12px;
}

.sidebar-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 8px;
}

.sidebar-item {
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  background: #f3f4f6;
  color: #111827;
  font-size: 14px;
}

.sidebar-item.active {
  background: #2563eb;
  color: #fff;
}

.editor-panel {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
  min-height: 400px;
}

.section-title {
  font-size: 18px;
  margin: 0 0 12px;
}

.item-card {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  background: #f9fafb;
}

.item-card .row {
  gap: 8px;
}

.item-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.small-btn {
  padding: 4px 8px;
  font-size: 12px;
}

.flow-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  background: #eef2ff;
  color: #4f46e5;
  font-size: 12px;
  margin-bottom: 10px;
}

.inline-input {
  margin-top: 8px;
}

.floating-actions {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: grid;
  gap: 8px;
  z-index: 20;
}

.floating-actions .btn {
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
}

.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

@media (max-width: 960px) {
  .editor-layout {
    grid-template-columns: 1fr;
  }

  .editor-sidebar {
    position: static;
  }

  .floating-actions {
    right: 12px;
    bottom: 12px;
  }
}
math/public/assets/css/mng/manager.css
.warning-banner {
  background: rgba(245, 158, 11, 0.14);
  border: 1px solid rgba(245, 158, 11, 0.3);
  color: #8a4b00;
  padding: 12px 16px;
  border-radius: var(--r-md);
  box-shadow: var(--shadow-xs);
  margin-bottom: 16px;
  font-size: 14px;
}

.manager-card .card-body {
  gap: 16px;
}

.manager-toolbar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.search-row {
  align-items: flex-end;
}

.table-wrap {
  width: 100%;
  overflow: auto;
  max-height: 70vh;
  border-radius: var(--r-lg);
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-xs);
}

.table {
  width: 100%;
  border-collapse: collapse;
  min-width: 720px;
}

.table th,
.table td {
  padding: 6px 8px;
  text-align: right;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.table th {
  background: rgba(37, 99, 235, 0.06);
  color: var(--muted);
  font-weight: 800;
  position: sticky;
  top: 0;
  z-index: 1;
}

.table tbody tr:hover {
  background: rgba(37, 99, 235, 0.04);
}

.table td.actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  width: 132px;
  min-width: 132px;
}

.table .select-cell {
  width: 36px;
  text-align: center;
}

.icon-btn {
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--r-sm);
}

.pagination {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  flex-wrap: wrap;
}

.pagination-pages {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.pagination .btn.is-active {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
}

.modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
  max-height: 92vh;
}

.modal.hidden {
  display: none;
}

.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.4);
  backdrop-filter: blur(4px);
}

.modal-card {
  position: relative;
  background: var(--surface);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-lg);
  width: min(720px, 96vw);
  max-height: 92vh;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 1;
}

.modal-card-sm {
  width: min(420px, 92vw);
}

.modal-card-lg {
  width: min(960px, 96vw);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.modal-body {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: calc(92vh - 180px);
  overflow: auto;
}

.modal-footer {
  position: sticky;
  bottom: 0;
  background: var(--surface);
  padding-top: 8px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.import-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
  align-items: end;
}

.field-inline .label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.import-preview,
.import-mapping,
.import-results {
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 12px;
  background: rgba(37, 99, 235, 0.04);
}

.import-preview h3,
.import-mapping h3,
.import-results h3 {
  margin-bottom: 8px;
}

.preview-table {
  max-height: 220px;
  overflow: auto;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--surface);
}

.table-compact {
  min-width: 100%;
}

.table-compact th,
.table-compact td {
  font-size: 13px;
  padding: 6px;
}

.mapping-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.import-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.import-progress {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.progress-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 13px;
}

.progress-track {
  height: 10px;
  background: #e2e8f0;
  border-radius: 999px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: var(--primary);
  transition: width 0.2s ease;
}

.result-summary {
  white-space: pre-line;
}

.result-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0;
}

.wheel-row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: nowrap;
}

.wheel {
  width: 110px;
  height: 120px;
  overflow-y: auto;
  scroll-snap-type: y mandatory;
  border: 1px solid #ddd;
  border-radius: 10px;
  position: relative;
  padding: 40px 0;
  background: #fff;
}

.wheel-item {
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  scroll-snap-align: center;
  color: var(--muted);
}

.wheel-item.is-selected {
  color: var(--text);
  font-weight: 700;
}

.wheel::after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  height: 40px;
  border-top: 1px solid #bbb;
  border-bottom: 1px solid #bbb;
  pointer-events: none;
  background: rgba(0, 0, 0, 0.03);
}

@media (max-width: 640px) {
  .modal-card-lg {
    width: min(720px, 96vw);
  }

  .table {
    min-width: 600px;
  }

  .modal-actions .btn {
    width: 100%;
  }

  .wheel {
    width: 96px;
  }
}

@media (max-width: 520px) {
  .wheel-row {
    flex-wrap: wrap;
  }
}
math/public/assets/css/questions.css
/* =========================================================
   questions.css — Question Types Styling (Light Material)
   Depends on base.css
   ========================================================= */

/* ---------- Common Question Block ---------- */
.q{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.q-desc{
  font-size: 15px;
  color: var(--text);
  line-height: 1.75;
}

/* ---------- Input Question ---------- */
.q-input{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.q-input .input{
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  letter-spacing: .3px;
}
.q-input .hint{
  font-size: 12px;
  color: var(--muted);
}

/* ---------- MCQ ---------- */
.q-mcq{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
.q-mcq .choice{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 14px 16px;
  min-height: 48px;
  border-radius: 16px;
  border: 1px solid rgba(17,24,39,.14);
  background: rgba(255,255,255,.9);
  box-shadow: var(--shadow-xs);
  cursor:pointer;
  transition: background .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.q-mcq .choice:hover{
  background: #fff;
  box-shadow: var(--shadow-sm);
}
.q-mcq .choice input{
  accent-color: var(--primary);
  cursor:pointer;
}
.q-mcq .choice.correct{
  border-color: rgba(22,163,74,.45);
  background: rgba(22,163,74,.10);
}
.q-mcq .choice.wrong{
  border-color: rgba(220,38,38,.45);
  background: rgba(220,38,38,.10);
}

/* ---------- Ordering ---------- */
.q-ordering{
  display:flex;
  flex-direction: column;
  gap: 14px;
}
.ordering-pool{
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 12px;
  border-radius: 16px;
  border: 1px dashed rgba(37,99,235,.28);
  background: rgba(239,246,255,.7);
}
.ordering-choice{
  border: 1px solid rgba(37,99,235,.28);
  background: #fff;
  border-radius: 999px;
  padding: 8px 14px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  box-shadow: var(--shadow-xs);
  transition: transform .08s ease, box-shadow .18s ease, border-color .18s ease;
}
.ordering-choice:active{
  transform: translateY(1px);
}
.ordering-choice:hover{
  box-shadow: var(--shadow-sm);
}
.ordering-slots{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.ordering-slot{
  min-height: 54px;
  border-radius: 14px;
  border: 1px dashed rgba(148,163,184,.6);
  background: rgba(248,250,252,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 10px;
  transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
}
.ordering-slot.is-active{
  border-color: rgba(37,99,235,.55);
  background: rgba(219,234,254,.6);
  box-shadow: var(--shadow-xs);
}
.ordering-slot.is-dragover{
  border-color: rgba(37,99,235,.8);
  background: rgba(191,219,254,.6);
}
.ordering-placeholder{
  color: var(--muted);
  font-size: 13px;
}
.ordering-slot-item{
  width: 100%;
  text-align:center;
  padding: 10px 12px;
  border-radius: 12px;
  background: #fff;
  border: 1px solid rgba(37,99,235,.28);
  font-weight: 700;
  box-shadow: var(--shadow-xs);
  cursor: pointer;
}
.ordering-empty{
  width: 100%;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px dashed rgba(15,23,42,.18);
  background: rgba(241,245,249,.6);
  color: var(--muted);
  text-align: center;
  font-size: 13px;
}

/* ---------- Match (Structure only / future) ---------- */
.q-match{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.q-match .col{
  display:flex;
  flex-direction: column;
  gap: 8px;
}
.q-match .item{
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(17,24,39,.14);
  background: rgba(255,255,255,.9);
  box-shadow: var(--shadow-xs);
}

/* ---------- Feedback ---------- */
.q-feedback{
  font-size: 13px;
  font-weight: 800;
}
.q-feedback.ok{
  color: var(--success);
}
.q-feedback.err{
  color: var(--danger);
}

@media (max-width: 560px){
  .q-match{
    grid-template-columns: 1fr;
  }
}
math/public/assets/css/toast.css
/* =========================================================
   toast.css — Material Light Toast + Countdown Bar
   used by assets/js/ui/toast.js

   UPDATE (2026-01-14):
   - Toast host is anchored to the TOP of the *visual viewport*
     (handled by JS via translateY + height adjustment).
   ========================================================= */

:root{
  --toast-max: 420px;
  --toast-pad: 12px;
  --toast-gap: 10px;

  --toast-bg: rgba(255,255,255,.86);
  --toast-border: rgba(17,24,39,.12);
  --toast-shadow: 0 18px 40px rgba(17,24,39,.16);
  --toast-blur: 12px;

  --toast-title: #111827;
  --toast-text: #4b5563;
  --toast-bar-bg: rgba(17,24,39,.10);
  --toast-bar: rgba(37,99,235,1);

  --toast-ok: rgba(22,163,74,1);
  --toast-warn: rgba(245,158,11,1);
  --toast-err: rgba(220,38,38,1);
}

/* Container fixed on viewport */
.toast-host{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  display:flex;
  align-items:flex-start;          /* top */
  justify-content:center;

  /* JS will place us at top of VISUAL viewport; keep a small inner padding */
  padding: 12px 16px;
}

/* Toast element */
.toast{
  width: min(var(--toast-max), calc(100vw - 32px));
  pointer-events: auto;
  background: var(--toast-bg);
  border: 1px solid var(--toast-border);
  border-radius: 18px;
  box-shadow: var(--toast-shadow);
  backdrop-filter: blur(var(--toast-blur));
  -webkit-backdrop-filter: blur(var(--toast-blur));
  overflow: hidden;

  transform: translateY(-10px) scale(.98);
  opacity: 0;
  transition: transform .22s ease, opacity .22s ease;
}

.toast.is-show{
  transform: translateY(0) scale(1);
  opacity: 1;
}

.toast-inner{
  display:flex;
  gap: var(--toast-gap);
  padding: var(--toast-pad);
  align-items:flex-start;
}

/* Icon pill */
.toast-ic{
  width: 34px;
  height: 34px;
  border-radius: 14px;
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.18);
  box-shadow: 0 10px 18px rgba(37,99,235,.10);
}

.toast-ic svg{
  width: 18px;
  height: 18px;
  fill: rgba(29,78,216,1);
}

.toast-content{
  flex: 1 1 auto;
  min-width: 0;
}

.toast-title{
  margin: 0;
  font-weight: 900;
  font-size: 14px;
  color: var(--toast-title);
  line-height: 1.2;
}

.toast-msg{
  margin: 6px 0 0;
  font-size: 13px;
  color: var(--toast-text);
  line-height: 1.45;
  word-wrap: break-word;
}

/* Progress bar (countdown) */
.toast-bar{
  height: 4px;
  width: 100%;
  background: var(--toast-bar-bg);
  position: relative;
}

.toast-bar > i{
  display:block;
  height: 100%;
  width: 100%;
  background: var(--toast-bar);
  transform-origin: right center; /* RTL feel */
  transform: scaleX(0);
}

/* Variants */
.toast[data-type="info"] .toast-ic{
  background: rgba(37,99,235,.12);
  border-color: rgba(37,99,235,.18);
}
.toast[data-type="info"] .toast-ic svg{ fill: rgba(29,78,216,1); }
.toast[data-type="info"] .toast-bar > i{ background: rgba(37,99,235,1); }

.toast[data-type="success"] .toast-ic{
  background: rgba(22,163,74,.12);
  border-color: rgba(22,163,74,.18);
  box-shadow: 0 10px 18px rgba(22,163,74,.10);
}
.toast[data-type="success"] .toast-ic svg{ fill: var(--toast-ok); }
.toast[data-type="success"] .toast-bar > i{ background: var(--toast-ok); }

.toast[data-type="warning"] .toast-ic{
  background: rgba(245,158,11,.14);
  border-color: rgba(245,158,11,.22);
  box-shadow: 0 10px 18px rgba(245,158,11,.10);
}
.toast[data-type="warning"] .toast-ic svg{ fill: var(--toast-warn); }
.toast[data-type="warning"] .toast-bar > i{ background: var(--toast-warn); }

.toast[data-type="danger"] .toast-ic,
.toast[data-type="error"] .toast-ic{
  background: rgba(220,38,38,.12);
  border-color: rgba(220,38,38,.18);
  box-shadow: 0 10px 18px rgba(220,38,38,.10);
}
.toast[data-type="danger"] .toast-ic svg,
.toast[data-type="error"] .toast-ic svg{ fill: var(--toast-err); }
.toast[data-type="danger"] .toast-bar > i,
.toast[data-type="error"] .toast-bar > i{ background: var(--toast-err); }

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .toast{ transition: none; }
}

/* Mobile spacing tweak */
@media (max-width: 420px){
  .toast-inner{ padding: 10px; }
}
math/public/assets/js/app.js
/* =========================================================
   app.js — App Bootstrap & Page Router
   - Login uses: (Student ID + Birth Year) against local data
   - Greets by firstName
   - Stores current student profile for later certificates

   UPDATE (2026-01-14):
   - Fix UI flash: hide all screens first, show correct one
   - Remove old auto-welcome based on lastStudentId only
   ========================================================= */

import {
  clearStudentSession,
  getLastStudentId,
  getStudentSession,
  setCachedCards,
  setLastStudentId,
  setStudentCompletions,
  setStudentSession,
  syncCardCompletions,
} from './core/storage.js';
import { initCardsPage } from './cards/cardsPage.js';
import { getWeekParam } from './core/router.js';
import { showToast } from './ui/toast.js';
import { initLessonPage } from './lesson/lessonPage.js';
import { findStudentByIdentity } from './core/students.js';
import { fetchJson } from './core/api.js';
import { API_PATHS } from './core/constants.js';
import { normalizeDigits } from './core/normalizeDigits.js';

const LS_CURRENT_STUDENT = 'math:currentStudent'; // legacy cache

document.addEventListener('DOMContentLoaded', () => {
  const week = getWeekParam();

  if (week) {
    initLessonPage();
  } else {
    initIndexPage();
  }
});

/* ---------- Index Page Logic ---------- */
function initIndexPage() {
  const screenId = document.getElementById('screen-id');
  const screenWelcome = document.getElementById('screen-welcome');
  const screenCards = document.getElementById('screen-cards');

  const inputId = document.getElementById('studentId');
  const btnLogin = document.getElementById('btnLogin');
  const btnToCards = document.getElementById('btnToCards');
  const btnChangeId = document.getElementById('btnChangeId');
  const btnLogout = document.getElementById('btnLogout');

  const welcomeTitle = document.getElementById('welcomeTitle');
  const welcomeChip = document.getElementById('welcomeChip');
  const welcomeName = document.getElementById('welcomeName');

  // Ensure Birth Year input exists (inject if missing)
  const inputBirthYear = ensureBirthYearInput(inputId);

  hideAllScreens();

  let currentSession = normalizeStoredStudent(getStudentSession());
  if (!currentSession?.grade) {
    const legacyStudent = readCurrentStudent();
    if (legacyStudent && (legacyStudent?.Grade || legacyStudent?.grade || legacyStudent?.Class || legacyStudent?.class)) {
      const migratedSession = normalizeStoredStudent(legacyStudent);
      setStudentSession(migratedSession);
      currentSession = migratedSession;
    }
  }
  if (currentSession?.id && currentSession?.birthYear) {
    setLastStudentId(currentSession.id);
    showCards();
    loadStudentData(currentSession, { silent: true });
  } else {
    const lastId = getLastStudentId();
    if (lastId && inputId) inputId.value = String(lastId);
    showId();
  }

  async function attemptLogin() {
    const id = normalizeDigits(inputId?.value || '').trim();
    const birthYear = normalizeDigits(inputBirthYear?.value || '').trim();

    if (!id) {
      showToast('تنبيه', 'ادخل رقم الهوية أولًا', 'warning');
      return;
    }
    if (!birthYear) {
      showToast('تنبيه', 'ادخل سنة الميلاد (مثال: 2012)', 'warning');
      return;
    }

    const fallbackLogin = async () => {
      const found = await findStudentByIdentity(id, birthYear);

      if (!found) {
        showToast('بيانات غير صحيحة', 'تأكد من رقم الهوية وسنة الميلاد', 'warning', 3500);
        return;
      }

      const legacyClassValue = found?.class ?? found?.Class ?? '';
      const gradeValue = found?.grade ?? found?.Grade ?? '';
      let resolvedGrade = '';
      let resolvedClass = '';

      if (isLegacyClassString(legacyClassValue)) {
        const legacyInfo = parseStudentClass(legacyClassValue);
        resolvedGrade = legacyInfo.grade;
        resolvedClass = legacyInfo.className;
      } else if (gradeValue && legacyClassValue) {
        resolvedGrade = String(gradeValue);
        resolvedClass = String(legacyClassValue);
      }

      const student = {
        id: String(found.id),
        birthYear: String(found.birthYear),
        firstName: String(found.firstName || '').trim() || String(found.fullName || '').trim().split(' ')[0] || `طالب ${found.id}`,
        fullName: String(found.fullName || '').trim() || `طالب ${found.id}`,
        grade: resolvedGrade,
        class: resolvedClass,
      };

      setLastStudentId(student.id);
      setStudentSession(student);
      writeCurrentStudent(student);
      showWelcome(student);
      showToast('تم الدخول', `أهلًا ${student.firstName} 👋`, 'success', 2500);
      await loadStudentData(student);
    };

    try {
      setLoginLoading(true);
      const data = await fetchJson(API_PATHS.STUDENT_LOGIN, {
        method: 'POST',
        body: { studentId: id, birthYear },
      });

      const payload = data?.student ?? data;
      const profile = normalizeStoredStudent(payload);

      if (profile?.id && profile?.birthYear) {
        writeCurrentStudent(payload);
        setStudentSession(profile);
        if (profile?.id) setLastStudentId(profile.id);
        showWelcome(profile);
        showToast('تم الدخول', `أهلًا ${profile.firstName} 👋`, 'success', 2500);
        await loadStudentData(profile);
        return;
      }
    } catch (e) {
      console.warn('API login failed, falling back to local data.', e);
    } finally {
      setLoginLoading(false);
    }

    try {
      await fallbackLogin();
    } catch (e) {
      console.error(e);
      showToast('خطأ', 'تعذر تحميل بيانات الطلاب', 'error', 4000);
    }
  }

  btnLogin?.addEventListener('click', () => {
    attemptLogin();
  });

  const enterHandler = (event) => {
    if (event.key !== 'Enter') return;
    event.preventDefault();
    attemptLogin();
  };

  inputId?.addEventListener('keydown', enterHandler);
  inputBirthYear?.addEventListener('keydown', enterHandler);

  btnToCards?.addEventListener('click', () => showCards());
  btnChangeId?.addEventListener('click', () => showId());

  btnLogout?.addEventListener('click', () => {
    clearCurrentStudent();
    clearStudentSession();
    try { localStorage.removeItem('math:lastStudentId'); } catch {}
    showId();
    if (inputId) inputId.value = '';
    if (inputBirthYear) inputBirthYear.value = '';
  });

  function setScreenVisibility(screen, isVisible) {
    if (!screen) return;
    screen.classList.toggle('hidden', !isVisible);
    screen.toggleAttribute('hidden', !isVisible);
    if (isVisible) {
      screen.style.removeProperty('display');
      if (!screen.getAttribute('style')) {
        screen.removeAttribute('style');
      }
    } else {
      screen.style.display = 'none';
    }
  }

  function hideAllScreens() {
    setScreenVisibility(screenId, false);
    setScreenVisibility(screenWelcome, false);
    setScreenVisibility(screenCards, false);
  }

  function setAppReady() {
    document.body.classList.remove('is-loading');
  }

  function setLoginLoading(isLoading) {
    if (!btnLogin) return;
    btnLogin.disabled = isLoading;
    btnLogin.textContent = isLoading ? 'جارٍ التحقق...' : 'دخول';
  }

  function showId() {
    setAppReady();
    setScreenVisibility(screenId, true);
    setScreenVisibility(screenWelcome, false);
    setScreenVisibility(screenCards, false);
  }

  function showWelcome(student) {
    const firstName = student?.firstName || student?.id || 'طالب';
    const fullName = student?.fullName || `طالب ${student?.id || ''}`.trim();

    if (welcomeTitle) welcomeTitle.textContent = `مرحبًا يا ${firstName} 👋`;
    if (welcomeChip) welcomeChip.textContent = fullName;
    if (welcomeName) welcomeName.textContent = fullName;

    setAppReady();
    setScreenVisibility(screenId, false);
    setScreenVisibility(screenWelcome, true);
    setScreenVisibility(screenCards, false);

  }

  function showCards() {
    setAppReady();
    setScreenVisibility(screenId, false);
    setScreenVisibility(screenWelcome, false);
    setScreenVisibility(screenCards, true);
    initCardsPage();
  }

}

function writeCurrentStudent(student) {
  try {
    localStorage.setItem(LS_CURRENT_STUDENT, JSON.stringify(student));
  } catch {}
}

function readCurrentStudent() {
  try {
    const raw = localStorage.getItem(LS_CURRENT_STUDENT);
    return raw ? JSON.parse(raw) : null;
  } catch {
    return null;
  }
}

function clearCurrentStudent() {
  try {
    localStorage.removeItem(LS_CURRENT_STUDENT);
  } catch {}
}

async function loadStudentData(student, { silent = false } = {}) {
  if (!student?.id) return;

  const btnToCards = document.getElementById('btnToCards');
  const originalLabel = btnToCards?.textContent;
  if (btnToCards) {
    btnToCards.disabled = true;
    btnToCards.textContent = 'جاري التحميل...';
  }

  try {
    const session = normalizeStoredStudent(getStudentSession()) || normalizeStoredStudent(student);
    const gradeValue = session?.grade ?? session?.Grade ?? '';
    const hasGrade = isNumericValue(gradeValue);
    if (!hasGrade) {
      console.debug('Skip cards warmup: missing grade');
    }
    const cardsUrl = buildCardsUrl(session || student);
    const [progress, cards] = await Promise.all([
      fetchJson(`${API_PATHS.PROGRESS_COMPLETED}?studentId=${encodeURIComponent(student.id)}`, { noStore: true }),
      hasGrade ? fetchJson(cardsUrl, { noStore: true }) : Promise.resolve(null),
    ]);

    setStudentCompletions(student.id, Array.isArray(progress) ? progress : []);
    syncCardCompletions(student.id, Array.isArray(progress) ? progress : []);
    if (hasGrade) {
      setCachedCards(Array.isArray(cards) ? cards : []);
    }
  } catch (error) {
    if (!silent) {
      showToast('خطأ', error.message || 'تعذر تحميل بيانات الطالب', 'error');
    }
  } finally {
    if (btnToCards) {
      btnToCards.disabled = false;
      btnToCards.textContent = originalLabel || 'الانتقال للبطاقات';
    }
  }
}

function normalizeStoredStudent(student) {
  if (!student) return null;
  const normalizedId = student.id ?? student.studentId ?? student.StudentId ?? '';
  const normalizedBirthYear = student.birthYear ?? student.BirthYear ?? '';
  const fullName = student.fullName ?? student.FullName ?? student.name ?? student.Name ?? '';
  const firstName = student.firstName ?? student.FirstName ?? '';
  const resolvedFullName = String(fullName || '').trim() || `طالب ${normalizedId}`.trim();
  const resolvedFirstName =
    String(firstName || '').trim() ||
    resolvedFullName.split(' ')[0] ||
    `طالب ${normalizedId}`.trim();
  const resolvedGrade = student.grade ?? student.Grade ?? '';
  const resolvedClass = student.class ?? student.Class ?? '';
  let normalizedGrade = String(resolvedGrade);
  let normalizedClass = String(resolvedClass);

  if (!normalizedGrade && isLegacyClassString(normalizedClass)) {
    const legacyInfo = parseStudentClass(normalizedClass);
    normalizedGrade = legacyInfo.grade;
    normalizedClass = legacyInfo.className;
  }

  return {
    id: String(normalizedId),
    birthYear: String(normalizedBirthYear),
    firstName: resolvedFirstName,
    fullName: resolvedFullName,
    grade: normalizedGrade,
    class: normalizedClass
  };
}

function parseStudentClass(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  if (!raw) return { grade: '', className: '' };
  const match = raw.match(/^(\\d+)\\s*[/\\-]\\s*(\\d+)$/);
  if (match) {
    return { grade: match[1], className: match[2] };
  }
  return { grade: raw, className: raw };
}

function isLegacyClassString(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  return /^(\\d+)\\s*[/\\-]\\s*(\\d+)$/.test(raw);
}

function isNumericValue(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  return raw !== '' && /^\\d+$/.test(raw);
}

function buildCardsUrl(student) {
  const params = new URLSearchParams();
  const gradeValue = student?.grade ?? student?.Grade ?? '';
  const classValue = student?.class ?? student?.Class ?? '';

  if (isNumericValue(gradeValue) && isNumericValue(classValue)) {
    params.set('grade', normalizeDigits(String(gradeValue)).trim());
    params.set('class', normalizeDigits(String(classValue)).trim());
    return `${API_PATHS.CARDS}?${params.toString()}`;
  }

  const legacyValue = student?.class ?? student?.grade;
  if (isLegacyClassString(legacyValue)) {
    const { grade, className } = parseStudentClass(legacyValue);
    if (grade) params.set('grade', grade);
    if (className) params.set('class', className);
  }
  return `${API_PATHS.CARDS}?${params.toString()}`;
}

/* ---------- UI: Birth Year input injection ---------- */
function ensureBirthYearInput(inputIdEl) {
  let el = document.getElementById('studentBirthYear');
  if (el) return el;

  if (!inputIdEl) return null;

  const field = inputIdEl.closest('.field') || inputIdEl.parentElement;
  if (!field) return null;

  const wrap = document.createElement('div');
  wrap.className = 'field';
  wrap.style.marginTop = '12px';

  wrap.innerHTML = `
    <label class="label" for="studentBirthYear">سنة الميلاد</label>
    <input id="studentBirthYear" class="input ltr" inputmode="numeric" autocomplete="off" placeholder="مثال: 2012" />
    <div class="help">اكتب سنة الميلاد فقط (4 أرقام).</div>
  `;

  field.insertAdjacentElement('afterend', wrap);
  el = wrap.querySelector('#studentBirthYear');

  el.addEventListener('input', () => {
    el.value = normalizeDigits(String(el.value || '')).replace(/[^0-9]/g, '').slice(0, 4);
  });

  el.addEventListener('keydown', (e) => {
    const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Tab','Home','End','Enter'];
    if (allowed.includes(e.key)) return;
    if (e.ctrlKey || e.metaKey) return;
    if (!/^[0-9٠-٩۰-۹]$/.test(e.key)) e.preventDefault();
  });

  return el;
}
math/public/assets/js/cards/cardsPage.js
/* =========================================================
   cardsPage.js — Cards List Logic (index.html)
   - Loads cards from local data
   - Applies sequential locking via prereq
   - Shows completed cards as gold + star (base.css styles)
   - Shows student name (firstName/fullName) instead of "طالب {id}"
   ========================================================= */

import { fetchJson } from '../core/api.js';
import { API_PATHS } from '../core/constants.js';
import { normalizeDigits } from '../core/normalizeDigits.js';
import {
  getCachedCards,
  getLastStudentId,
  getStudentCompletions,
  getStudentSession,
  isCardDone,
  setCachedCards,
  setStudentSession,
  syncCardCompletions,
} from '../core/storage.js';
import { goToLesson } from '../core/router.js';
import { showToast } from '../ui/toast.js';

export async function initCardsPage(options = {}) {
  const { didRefresh = false } = options;
  const studentId = getLastStudentId();
  if (!studentId) return;

  const listEl = document.getElementById('cardsList');
  const studentNameEl = document.getElementById('cardsStudentName');
  let readyWeeks = null;

  let student = getStudentSession();
  if (!student?.grade && !didRefresh && student?.id && student?.birthYear) {
    const refreshed = await refreshStudentSession(student);
    if (refreshed) {
      return initCardsPage({ didRefresh: true });
    }
  }

  const gradeValue = normalizeDigits(student?.grade ?? '');
  const hasGrade = gradeValue !== '' && /^\\d+$/.test(gradeValue);
  const classInfo = {
    grade: gradeValue,
    className: normalizeDigits(student?.class ?? ''),
  };
  const displayName =
    (student?.firstName && String(student.firstName).trim()) ||
    (student?.fullName && String(student.fullName).trim()) ||
    `طالب ${studentId}`;

  if (studentNameEl) studentNameEl.textContent = displayName;

  try {
    const cached = getCachedCards();
    if (cached?.length) {
      renderCards(listEl, cached, studentId, readyWeeks);
    }

    const progress = getStudentCompletions(studentId);
    syncCardCompletions(studentId, progress);

    if (!hasGrade) {
      console.debug('Skip cards fetch: missing grade');
      return;
    }

    const cardsUrl = buildCardsUrl(classInfo);
    const [cards, weeks] = await Promise.all([
      fetchJson(cardsUrl, { noStore: true }),
      fetchJson(API_PATHS.WEEKS, { noStore: true }),
    ]);
    const normalized = Array.isArray(cards) ? cards : [];
    readyWeeks = normalizeReadyWeeks(weeks);
    setCachedCards(normalized);
    renderCards(listEl, normalized, studentId, readyWeeks);
  } catch (e) {
    showToast('خطأ', 'فشل تحميل البطاقات', 'error');
    console.error(e);
  }
}

async function refreshStudentSession(session) {
  try {
    const data = await fetchJson(API_PATHS.STUDENT_LOGIN, {
      method: 'POST',
      body: {
        studentId: session.id,
        birthYear: session.birthYear,
      },
    });

    const payload = data?.student ?? data;
    const normalized = normalizeSessionStudent(payload);
    if (normalized?.id) {
      setStudentSession(normalized);
      return normalized;
    }
  } catch (error) {
    console.warn('Student refresh failed', error);
  }

  return null;
}

function parseStudentClass(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  if (!raw) return { grade: '', className: '' };
  const match = raw.match(/^(\d+)\s*[/\\-]\s*(\d+)$/);
  if (match) {
    return { grade: match[1], className: match[2] };
  }
  return { grade: raw, className: raw };
}

function normalizeSessionStudent(student) {
  if (!student) return null;
  const normalizedId = student.id ?? student.studentId ?? student.StudentId ?? '';
  const normalizedBirthYear = student.birthYear ?? student.BirthYear ?? '';
  const fullName = student.fullName ?? student.FullName ?? student.name ?? student.Name ?? '';
  const firstName = student.firstName ?? student.FirstName ?? '';
  const resolvedFullName = String(fullName || '').trim() || `طالب ${normalizedId}`.trim();
  const resolvedFirstName =
    String(firstName || '').trim() ||
    resolvedFullName.split(' ')[0] ||
    `طالب ${normalizedId}`.trim();
  const resolvedGrade = student.grade ?? student.Grade ?? '';
  const resolvedClass = student.class ?? student.Class ?? '';
  let normalizedGrade = String(resolvedGrade);
  let normalizedClass = String(resolvedClass);

  if (!normalizedGrade && isLegacyClassString(normalizedClass)) {
    const legacyInfo = parseStudentClass(normalizedClass);
    normalizedGrade = legacyInfo.grade;
    normalizedClass = legacyInfo.className;
  }

  return {
    id: String(normalizedId),
    birthYear: String(normalizedBirthYear),
    firstName: resolvedFirstName,
    fullName: resolvedFullName,
    grade: normalizedGrade,
    class: normalizedClass,
  };
}

function isLegacyClassString(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  return /^(\d+)\s*[/\\-]\s*(\d+)$/.test(raw);
}

function buildCardsUrl({ grade, className }) {
  const params = new URLSearchParams();
  if (grade) params.set('grade', grade);
  if (className) params.set('class', className);
  return `${API_PATHS.CARDS}?${params.toString()}`;
}

function normalizeReadyWeeks(weeks) {
  if (!Array.isArray(weeks)) return null;
  const list = weeks
    .map((week) => Number(week?.Week ?? week?.week))
    .filter((week) => Number.isFinite(week));
  return list.length ? new Set(list) : null;
}

function renderCards(container, cards, studentId, readyWeeks) {
  if (!container) return;
  container.innerHTML = '';

  cards.forEach((card) => {
    const weekValue = card.week ?? card.Week;
    const prereqWeek = card.prereqWeek ?? card.PrereqWeek ?? card.prereq;
    const done = isCardDone(studentId, weekValue);
    const prereqDone = !prereqWeek || isCardDone(studentId, prereqWeek);
    const locked = !prereqDone;
    const isReady = !readyWeeks || readyWeeks.has(Number(weekValue));
    const disabled = !isReady;

    const cardEl = document.createElement('div');
    cardEl.className = `card ${locked ? 'is-locked' : ''} ${done ? 'is-done' : ''} ${disabled ? 'is-disabled' : ''}`;

    cardEl.innerHTML = `
      <div class="card-header">
        <div>
          <h3 class="card-title">${escapeHtml(card.title ?? card.Title)}</h3>
          <p class="card-subtitle">الأسبوع ${escapeHtml(weekValue)}</p>
        </div>
        ${done ? starHtml() : ''}
      </div>

      <div class="card-body">
        <span class="badge ${done ? 'done' : disabled ? 'disabled' : locked ? 'locked' : 'primary'}">
          ${done ? 'منجزة' : disabled ? 'غير جاهزة' : locked ? 'مقفلة' : 'مفتوحة'}
        </span>
      </div>

      <div class="card-footer">
        <button class="btn ${locked || disabled ? 'btn-outline' : 'btn-primary'} w-100"
                ${locked || disabled ? 'disabled' : ''}>
          ${disabled ? 'غير متاحة' : done ? 'إعادة فتح' : 'ابدأ'}
        </button>
      </div>
    `;

    const btn = cardEl.querySelector('button');
    if (!locked && !disabled) {
      btn.addEventListener('click', () => {
        goToLesson(weekValue);
      });
    } else if (locked) {
      btn.addEventListener('click', () => {
        showToast('مقفلة 🔒', 'لازم تنهي البطاقة السابقة أولًا', 'warning');
      });
    }

    container.appendChild(cardEl);
  });
}

function starHtml() {
  return `
    <div class="star" title="منجزة">
      <svg viewBox="0 0 24 24">
        <path d="M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.6-6.2 3.6 1.6-7-5.4-4.7 7.1-.6z"></path>
      </svg>
    </div>
  `;
}

function escapeHtml(s) {
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
math/public/assets/js/core/api.js
/* =========================================================
   api.js — JSON Loader (API helpers)
   ========================================================= */

export async function fetchJson(url, { noStore = false, method = 'GET', body, headers } = {}) {
  const opts = {
    method,
    headers: {
      ...(headers || {}),
    },
  };

  if (body !== undefined) {
    opts.body = JSON.stringify(body);
    opts.headers['Content-Type'] = 'application/json';
  }

  if (noStore) {
    opts.cache = 'no-store';
    opts.headers['Cache-Control'] = 'no-store';
    opts.headers['Pragma'] = 'no-cache';
  }

  const res = await fetch(url, opts);
  if (!res.ok) {
    let message = `فشل تحميل البيانات: ${url}`;
    try {
      const errorPayload = await res.json();
      if (errorPayload?.error) {
        message = errorPayload.error;
      }
    } catch {
      // ignore parse errors
    }
    throw new Error(message);
  }

  if (res.status === 204) return null;
  return await res.json();
}
math/public/assets/js/core/constants.js
/* =========================================================
   constants.js — Global Constants & Paths
   ========================================================= */

// App
export const APP_NAME = 'math';

// Storage keys
export const STORAGE_KEYS = {
  LAST_STUDENT_ID: 'math:lastStudentId',
  STUDENTS: 'math:students', // root object for all students progress
  STUDENT_SESSION: 'math:studentSession',
  CACHED_CARDS: 'math:cardsCache',
  STUDENT_COMPLETIONS: 'math:studentCompletions',
};

// Data paths
export const DATA_PATHS = {
  CARDS: '/data/cards.json',
  WEEKS_DIR: '/data/weeks',
  STUDENTS: '/data/students.json',
};

// API paths
export const API_PATHS = {
  CARDS: '/api/cards',
  WEEKS: '/api/weeks',
  STUDENT_LOGIN: '/api/students/login',
  PROGRESS_COMPLETED: '/api/progress/completed',
  PROGRESS_COMPLETE: '/api/progress/complete',
};

// Lesson / Engine
export const ENGINE = {
  MAX_ATTEMPTS: 3,
};

// UI defaults
export const UI = {
  TOAST_DURATION_SHORT: 2500,
  TOAST_DURATION_MEDIUM: 3500,
  TOAST_DURATION_LONG: 5000,
};

// Progress
export const PROGRESS = {
  START: 0,
  COMPLETE: 100,
};

// Helpers
export function weekJsonPath(week) {
  return `/api/weeks/${encodeURIComponent(week)}`;
}
math/public/assets/js/core/gradeMap.js
export const GRADE_WEEK_MAP = {
  '7/1': [999, 1000],
  '7/2': [999],
  '8/1': [1000],
};

export function getWeeksForClass(studentClass) {
  if (!studentClass) return null;
  const key = String(studentClass).trim();
  return GRADE_WEEK_MAP[key] || null;
}
math/public/assets/js/core/normalizeDigits.js
export function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9',
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}
math/public/assets/js/core/router.js
/* =========================================================
   router.js — Query String Reader & Navigation Helpers
   ========================================================= */

export function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

export function getWeekParam() {
  const w = getQueryParam('week');
  if (!w) return null;
  const n = Number(w);
  return Number.isFinite(n) ? n : null;
}

export function goTo(url) {
  window.location.href = url;
}

export function goHome() {
  goTo('/');
}

export function goToLesson(week) {
  goTo(`/lesson.html?week=${encodeURIComponent(week)}`);
}
math/public/assets/js/core/storage.js
/* =========================================================
   storage.js — LocalStorage Persistence
   - Students progress per device
   ========================================================= */

import { STORAGE_KEYS } from './constants.js';

/* ---------- Internal helpers ---------- */
function readRoot() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.STUDENTS);
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}

function writeRoot(root) {
  localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(root));
}

function readJson(key, fallback = null) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}

function writeJson(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

/* ---------- Student Session ---------- */
export function getStudentSession() {
  return readJson(STORAGE_KEYS.STUDENT_SESSION, null);
}

export function setStudentSession(session) {
  if (!session) return;
  writeJson(STORAGE_KEYS.STUDENT_SESSION, session);
}

export function clearStudentSession() {
  try {
    localStorage.removeItem(STORAGE_KEYS.STUDENT_SESSION);
  } catch {}
}

/* ---------- Student ID ---------- */
export function getLastStudentId() {
  return localStorage.getItem(STORAGE_KEYS.LAST_STUDENT_ID);
}

export function setLastStudentId(studentId) {
  localStorage.setItem(STORAGE_KEYS.LAST_STUDENT_ID, studentId);
}

/* ---------- Student Progress ---------- */
/*
Structure:
students = {
  "123456": {
    cards: {
      "999": {
        done: false,
        progress: { conceptIndex: 0, stepIndex: 0 }
      }
    }
  }
}
*/

export function getStudent(studentId) {
  const root = readRoot();
  if (!root[studentId]) {
    root[studentId] = { cards: {} };
    writeRoot(root);
  }
  return root[studentId];
}

export function getStudentProgress(studentId, week) {
  const student = getStudent(studentId);
  return student.cards[String(week)] || null;
}

export function setStudentProgress(studentId, week, progress) {
  const root = readRoot();
  if (!root[studentId]) root[studentId] = { cards: {} };

  root[studentId].cards[String(week)] = {
    ...(root[studentId].cards[String(week)] || {}),
    progress,
  };

  writeRoot(root);
}

/* ---------- Completion helpers ---------- */
export function clearCardProgress(studentId, week) {
  const root = readRoot();
  if (!root[studentId]?.cards?.[String(week)]) return;

  const card = root[studentId].cards[String(week)];
  delete card.progress;

  root[studentId].cards[String(week)] = card;
  writeRoot(root);
}

export function markCardDone(studentId, week) {
  const root = readRoot();
  if (!root[studentId]) root[studentId] = { cards: {} };

  const key = String(week);
  const prev = root[studentId].cards[key] || {};

  // عندما تُنجز البطاقة: نثبت done ونحذف progress حتى ما يصير Resume على بطاقة منجزة
  const next = { ...prev, done: true };
  delete next.progress;

  root[studentId].cards[key] = next;

  writeRoot(root);
}

export function isCardDone(studentId, week) {
  const student = getStudent(studentId);
  return Boolean(student.cards[String(week)]?.done);
}

export function syncCardCompletions(studentId, completions) {
  if (!studentId || !Array.isArray(completions)) return;
  completions.forEach((completion) => {
    const weekValue = completion?.Week ?? completion?.week;
    if (Number.isInteger(Number(weekValue))) {
      markCardDone(studentId, Number(weekValue));
    }
  });
}

/* ---------- Cards cache ---------- */
export function getCachedCards() {
  return readJson(STORAGE_KEYS.CACHED_CARDS, []);
}

export function setCachedCards(cards) {
  if (!Array.isArray(cards)) return;
  writeJson(STORAGE_KEYS.CACHED_CARDS, cards);
}

/* ---------- Progress cache ---------- */
export function getStudentCompletions(studentId) {
  if (!studentId) return [];
  const root = readJson(STORAGE_KEYS.STUDENT_COMPLETIONS, {});
  return Array.isArray(root[studentId]) ? root[studentId] : [];
}

export function setStudentCompletions(studentId, completions) {
  if (!studentId || !Array.isArray(completions)) return;
  const root = readJson(STORAGE_KEYS.STUDENT_COMPLETIONS, {});
  root[studentId] = completions;
  writeJson(STORAGE_KEYS.STUDENT_COMPLETIONS, root);
}

export function upsertStudentCompletion(studentId, completion) {
  if (!studentId || !completion) return;
  const root = readJson(STORAGE_KEYS.STUDENT_COMPLETIONS, {});
  const current = Array.isArray(root[studentId]) ? root[studentId] : [];
  const weekValue = completion?.Week ?? completion?.week;
  const next = current.filter((item) => (item?.Week ?? item?.week) !== weekValue);
  next.unshift(completion);
  root[studentId] = next;
  writeJson(STORAGE_KEYS.STUDENT_COMPLETIONS, root);
}
math/public/assets/js/core/students.js
import { fetchJson } from './api.js';
import { DATA_PATHS } from './constants.js';
import { normalizeDigits } from './normalizeDigits.js';

let studentsCache = null;

/**
 * Load students list (cached after first load)
 */
export async function loadStudents() {
  if (studentsCache) {
    return studentsCache;
  }

  const data = await fetchJson(DATA_PATHS.STUDENTS, { noStore: true });
  const list = Array.isArray(data) ? data : data?.students;

  if (!Array.isArray(list)) {
    throw new Error('Students list format is invalid');
  }

  studentsCache = list.map(normalizeStudent);
  return studentsCache;
}

/**
 * Find student by ID number and birth year
 * @param {string} id
 * @param {string} birthYear
 * @returns {object|null}
 */
export async function findStudentByIdentity(id, birthYear) {
  const students = await loadStudents();

  const normalizedId = normalizeDigits(String(id).trim());
  const normalizedYear = normalizeDigits(String(birthYear).trim());

  const student = students.find(s =>
    normalizeDigits(String(s.id)) === normalizedId &&
    normalizeDigits(String(s.birthYear)) === normalizedYear
  );

  return student || null;
}

function normalizeStudent(student) {
  return {
    id: student.StudentId ?? student.studentId ?? student.id ?? '',
    birthYear: student.BirthYear ?? student.birthYear ?? '',
    firstName: student.FirstName ?? student.firstName ?? '',
    fullName: student.FullName ?? student.fullName ?? '',
    grade: student.Grade ?? student.grade ?? '',
    class: student.Class ?? student.class ?? '',
  };
}
math/public/assets/js/lesson/completion.js
/* =========================================================
   completion.js — Card Completion Handling + Certificate Hook
   - Marks card done
   - Prepares certificate payload
   - Stores last certificate payload in LocalStorage
   - Shows "عرض الشهادة" button on completion (no HTML edits needed)

   ========================================================= */

import { fetchJson } from '../core/api.js';
import { API_PATHS } from '../core/constants.js';
import { getStudentSession, isCardDone, markCardDone, upsertStudentCompletion } from '../core/storage.js';
import { showToast } from '../ui/toast.js';
import { goHome } from '../core/router.js';

const LS_LAST_CERTIFICATE = 'math:lastCertificate';      // prepared here
const CERT_URL = '/assets/cert/certificate.html';

export function completeLesson({ studentId, week, cardTitle = '', finalScore = 0 }) {
  const wasDone = isCardDone(studentId, week);
  // mark card as done
  markCardDone(studentId, week);

  // Prepare certificate payload
  const student = getStudentSession();
  const payload = buildCertificatePayload({ studentId, week, cardTitle, student });
  writeLastCertificate(payload);

  // UI: show completion section if exists
  const completeEl = document.getElementById('lessonComplete');
  if (completeEl) {
    completeEl.classList.remove('hidden');
    completeEl.removeAttribute('hidden');
    completeEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Inject data for future UI usage
    completeEl.setAttribute('data-student-name', payload.fullName || payload.firstName || '');
    completeEl.setAttribute('data-week', String(week));

    // Add certificate button (idempotent)
    ensureCertActions(completeEl);
  }

  // Toast includes first name
  if (!wasDone) {
    const firstName = payload.firstName || 'بطل';
    showToast('ممتاز 🎉', `أحسنت يا ${firstName} — تم إنجاز البطاقة`, 'success', 3500);
  }

  syncCompletionToApi({ studentId, week, finalScore });

  // NOTE: we no longer auto-return quickly, to allow opening the certificate
  setTimeout(() => {
    // goHome();
  }, 12000);
}

/* ---------- Certificate UI Actions ---------- */
function ensureCertActions(completeEl) {
  if (completeEl.querySelector('#btnViewCert')) return;

  // Find a good place to inject (card-body preferred)
  const body = completeEl.querySelector('.card-body') || completeEl;

  const wrap = document.createElement('div');
  wrap.className = 'row';
  wrap.style.marginTop = '12px';
  wrap.style.gap = '10px';

  const btnCert = document.createElement('a');
  btnCert.id = 'btnViewCert';
  btnCert.className = 'btn btn-primary btn-lg w-100';
  btnCert.href = CERT_URL;
  btnCert.textContent = 'عرض الشهادة';

  const btnBack = document.createElement('button');
  btnBack.type = 'button';
  btnBack.className = 'btn btn-outline w-100';
  btnBack.textContent = 'العودة للبطاقات';
  btnBack.addEventListener('click', () => goHome());

  wrap.appendChild(btnCert);
  wrap.appendChild(btnBack);
  body.appendChild(wrap);
}

/* ---------- Certificate Hook Helpers ---------- */
async function syncCompletionToApi({ studentId, week, finalScore }) {
  try {
    const response = await fetchJson(API_PATHS.PROGRESS_COMPLETE, {
      method: 'POST',
      body: { studentId, week, finalScore },
    });

    if (response?.ok === false) {
      throw new Error(response?.error || 'تعذر تسجيل الإنجاز');
    }

    upsertStudentCompletion(studentId, response);
  } catch (error) {
    showToast('تنبيه', error.message || 'تعذر تحديث الإنجاز في الخادم', 'warning');
  }
}

function buildCertificatePayload({ studentId, week, cardTitle, student }) {
  const fullName =
    (student?.fullName && String(student.fullName).trim()) ||
    `طالب ${studentId}`;

  const firstName =
    (student?.firstName && String(student.firstName).trim()) ||
    String(fullName).trim().split(' ')[0] ||
    '';

  const issuedAt = new Date().toISOString();

  return {
    version: 1,
    week: Number(week),
    cardTitle: String(cardTitle || ''),
    studentId: String(studentId),
    firstName,
    fullName,
    class: student?.class ? String(student.class) : '',
    issuedAt
  };
}

function writeLastCertificate(payload) {
  try {
    localStorage.setItem(LS_LAST_CERTIFICATE, JSON.stringify(payload));
  } catch {
    // ignore storage errors
  }
}
math/public/assets/js/lesson/engine.js
/* =========================================================
   engine.js — Unlimited Flow Engine (single "متابعة" button) + Resume + Completion
   - Concepts can use: concept.flow = [ {type:..., ...}, ... ]  ✅ (no limits)
   - Backward compatible: if no flow, we build flow from legacy fields
   - Stages: goals (once) -> prereq (once) -> goals per concept -> assessment (final)
   - One button only: "متابعة"
     * On text items: reveals next item
     * On question items: "متابعة" = تحقق للسؤال الحالي
       - Wrong: hints/attempts/solution
       - Correct: toast تعزيز + مهلة قصيرة ثم يكشف اللي بعده تلقائيًا
   - Auto scroll + focus to newly revealed item after advancing
   - Fix: infer question.type if flow item doesn't include it
   - Resume: load saved { stage, conceptIndex, stepIndex } from storage and continue
   - Completion: when finishing the last item -> mark done + show completion + return home
   - Certificate Hook: pass cardTitle to completion.js (data.title)

   UPDATE (2026-01-14):
   - Fix #1: Preserve question state across re-renders (input value / mcq selection)
     by caching built flow + caching normalized question object per flow item.
   ========================================================= */

import { ENGINE } from '../core/constants.js';
import { showToast } from '../ui/toast.js';
import { ENCOURAGEMENTS, DEFAULT_HINTS, FINAL_HINT, pickRandom } from '../ui/text.js';
import { renderQuestion } from '../questions/registry.js';
import { setStudentProgress, getStudentProgress, isCardDone, markCardDone } from '../core/storage.js';
import { setProgressUI } from './progress.js';
import { completeLesson } from './completion.js';

const LEGACY_ORDER = ['goal', 'explain', 'example', 'example2', 'mistake', 'note', 'question'];
const STAGES = {
  GOALS: 'goals',
  PREREQ: 'prereq',
  CONCEPT: 'concept',
  ASSESSMENT: 'assessment',
};

export function initEngine({ week, studentId, data, mountEl }) {
  mountEl.innerHTML = '';

  let stage = STAGES.GOALS;
  let conceptIndex = 0;
  let itemIndex = 0;

  let assessmentState = {
    attempts: 0,
    completed: false,
    score: null,
    total: null,
  };

  const goalsList = getGoalsList(data);
  const prereqList = getPrereqList(data);
  const assessment = normalizeAssessment(data?.assessment);

  // Scroll/focus control
  let pendingFocus = null; // { conceptIndex, itemIndex }
  let firstPaint = true;

  // Question state (for current question only)
  let activeQuestion = null; // { check, attempts, solutionShown, btn, dotsWrap, container, qData, verifiedOk }

  function getConceptFlow(concept) {
    // IMPORTANT: cache flow so items keep runtime state across re-renders
    if (concept && Array.isArray(concept._flowCache) && concept._flowCache.length) {
      return concept._flowCache;
    }

    let flow = null;

    if (Array.isArray(concept?.flow) && concept.flow.length) {
      // Use original flow array (stable reference) + cache it
      flow = concept.flow;
    } else {
      // Backward compatible: build flow from legacy keys (once)
      flow = [];
      for (const key of LEGACY_ORDER) {
        if (key === 'question') {
          if (concept?.question) {
            flow.push({ type: 'question', q: concept.question });
          }
        } else {
          if (concept?.[key]) flow.push({ type: key, text: concept[key] });
        }
      }
    }

    // cache for stability
    if (concept) concept._flowCache = flow || [];
    return concept?._flowCache || [];
  }

  function buildNormalizedQuestionFromItem(item) {
    // If flow item already contains q object:
    if (item?.q && typeof item.q === 'object') {
      // Use the same object reference as base, but ensure required fields exist
      const q = item.q;

      // Ensure type exists (if missing infer)
      if (!q.type) {
        q.type =
          item?.qtype ||
          item?.questionType ||
          (item?.type && item.type !== 'question' ? item.type : null) ||
          (Array.isArray(q?.choices) ? 'mcq' : 'input');
      }

      // Ensure common fields exist
      if (q.text == null) q.text = item?.text || 'سؤال';
      if (!Array.isArray(q.hints)) q.hints = q.hints ? [q.hints] : [];
      if (q.solution == null) q.solution = '';
      if (q.type === 'ordering' && !Array.isArray(q.items)) {
        q.items = Array.isArray(item?.items)
          ? item.items
          : Array.isArray(item?.choices)
            ? item.choices
            : Array.isArray(q?.choices)
              ? q.choices
              : [];
      }

      return q;
    }

    // Otherwise infer from item structure (question written directly in flow)
    const inferredType =
      item?.qtype ||
      item?.questionType ||
      (item?.type && item.type !== 'question' ? item.type : null) ||
      (Array.isArray(item?.choices) ? 'mcq' : 'input');

    const q = {
      type: inferredType,
      text: item?.text || 'سؤال',
      hints: Array.isArray(item?.hints) ? item.hints : [],
      solution: item?.solution || '',
    };

    if (inferredType === 'mcq') {
      q.choices = item?.choices || [];
      q.correctIndex = typeof item?.correctIndex === 'number' ? item.correctIndex : 0;
    } else if (inferredType === 'ordering') {
      q.items = Array.isArray(item?.items)
        ? item.items
        : Array.isArray(item?.choices)
          ? item.choices
          : [];
    } else {
      q.answer = item?.answer ?? '';
      q.placeholder = item?.placeholder;
    }

    return q;
  }

  function getStableQuestionObjectForFlowItem(item) {
    // IMPORTANT: keep one normalized question object per flow item
    // so UI state (like input value / selected choice) can persist across re-renders.
    if (item?._qState && typeof item._qState === 'object') {
      return item._qState;
    }

    const q = buildNormalizedQuestionFromItem(item);

    // Store on the flow item itself (stable if flow is cached)
    if (item) item._qState = q;

    return q;
  }

  function normalizeAssessment(assessmentData) {
    if (!assessmentData || !Array.isArray(assessmentData.questions)) return null;

    const questions = assessmentData.questions.map((question) => {
      if (!question || typeof question !== 'object') return null;

      const inferredType =
        question?.type ||
        (Array.isArray(question?.choices) ? 'mcq' : 'input');

      const normalized = {
        ...question,
        type: inferredType,
        text: question?.text || 'سؤال',
        points: Number.isFinite(question?.points) ? Number(question.points) : 1,
      };

      if (inferredType === 'mcq') {
        normalized.choices = Array.isArray(question?.choices) ? question.choices : [];
        normalized.correctIndex =
          typeof question?.correctIndex === 'number' ? question.correctIndex : 0;
      } else {
        normalized.answer = question?.answer ?? '';
        normalized.placeholder = question?.placeholder || 'اكتب إجابتك هنا';
      }

      return normalized;
    }).filter(Boolean);

    if (!questions.length) return null;

    return {
      title: assessmentData?.title || 'تقييم الدرس',
      description: assessmentData?.description || 'اختبار تقييم من نقاط دون تصويب.',
      questions,
    };
  }

  function totalFlowItems() {
    const concepts = data.concepts || [];
    let total = 0;
    for (const c of concepts) total += getConceptFlow(c).length;
    return total;
  }

  function totalStages() {
    const base = 2 + totalFlowItems();
    const total = assessment ? base + 1 : base;
    return Math.max(1, total);
  }

  function currentFlowPosition() {
    const concepts = data.concepts || [];
    let pos = 0;
    for (let i = 0; i < conceptIndex; i++) pos += getConceptFlow(concepts[i]).length;
    pos += itemIndex;
    return pos;
  }

  function currentStagePosition() {
    if (stage === STAGES.GOALS) return 0;
    if (stage === STAGES.PREREQ) return 1;
    if (stage === STAGES.CONCEPT) return 2 + currentFlowPosition();
    return totalStages() - 1;
  }

  function updateProgress() {
    const total = totalStages();
    const pos = currentStagePosition();
    const pct = Math.max(0, Math.min(100, Math.round(((pos + 1) / total) * 100)));
    setProgressUI(pct);
  }

  function saveProgress() {
    setStudentProgress(studentId, week, {
      stage,
      conceptIndex,
      stepIndex: itemIndex,
      assessment: assessmentState,
    });
  }

  function clampToValidPosition() {
    const concepts = data.concepts || [];
    if (!concepts.length) {
      conceptIndex = 0;
      itemIndex = 0;
      return;
    }

    conceptIndex = Math.max(0, Math.min(conceptIndex, concepts.length - 1));

    const flow = getConceptFlow(concepts[conceptIndex]);
    if (!flow.length) {
      itemIndex = 0;
      return;
    }

    itemIndex = Math.max(0, Math.min(itemIndex, flow.length - 1));
  }

  function applyResumeIfAvailable() {
    if (isCardDone(studentId, week)) return;

    const saved = getStudentProgress(studentId, week)?.progress;
    if (!saved) return;

    if (saved.stage && Object.values(STAGES).includes(saved.stage)) {
      stage = saved.stage;
    }

    if (Number.isFinite(saved.conceptIndex)) conceptIndex = Number(saved.conceptIndex);
    if (Number.isFinite(saved.stepIndex)) itemIndex = Number(saved.stepIndex);

    if (saved.assessment && typeof saved.assessment === 'object') {
      assessmentState = {
        ...assessmentState,
        ...saved.assessment,
      };
    }

    clampToValidPosition();

    // focus the current item after first render
    pendingFocus = { conceptIndex, itemIndex };
    firstPaint = true;
  }

  function isLastPosition() {
    const concepts = data.concepts || [];
    if (!concepts.length) return true;

    const lastConceptIdx = concepts.length - 1;
    const lastFlow = getConceptFlow(concepts[lastConceptIdx]);
    const lastItemIdx = Math.max(0, lastFlow.length - 1);

    return conceptIndex === lastConceptIdx && itemIndex === lastItemIdx;
  }

  function finishCard() {
    // Persist completion
    markCardDone(studentId, week);

    // Pass title for certificate hook readiness
    const cardTitle = String(data?.title || '');
    const finalScore = Number.isFinite(assessmentState?.score) ? assessmentState.score : 0;

    // Use existing completion handler (shows UI + returns home)
    completeLesson({ studentId, week, cardTitle, finalScore });
  }

  function render() {
    mountEl.innerHTML = '';
    activeQuestion = null;

    if (stage === STAGES.GOALS) {
      renderGoalsStage();
      return;
    }

    if (stage === STAGES.PREREQ) {
      renderPrereqStage();
      return;
    }

    if (stage === STAGES.ASSESSMENT) {
      renderAssessmentStage();
      return;
    }

    renderConceptStage();
  }

  function renderGoalsStage() {
    const card = document.createElement('div');
    card.className = 'lesson-stage card';

    card.innerHTML = `
      <div class="stage-header">
        <span class="stage-badge">المرحلة الأولى</span>
        <h3 class="stage-title">عرض الأهداف كاملة</h3>
      </div>
      <div class="stage-body"></div>
    `;

    const body = card.querySelector('.stage-body');
    const list = document.createElement('ul');
    list.className = 'goal-list';

    if (goalsList.length) {
      goalsList.forEach((goal, idx) => {
        const item = document.createElement('li');
        item.className = 'goal-item';
        item.innerHTML = `
          <span class="goal-index">${idx + 1}</span>
          <span class="goal-text">${escapeHtml(goal.text)}</span>
        `;
        list.appendChild(item);
      });
    } else {
      const empty = document.createElement('div');
      empty.className = 'stage-empty';
      empty.textContent = 'لا توجد أهداف مسجلة بعد.';
      body.appendChild(empty);
    }

    body.appendChild(list);

    const nav = document.createElement('div');
    nav.className = 'lesson-nav';

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary w-100';
    btn.textContent = 'متابعة';
    btn.addEventListener('click', () => {
      stage = STAGES.PREREQ;
      render();
    });

    nav.appendChild(btn);
    card.appendChild(nav);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();
  }

  function renderPrereqStage() {
    const card = document.createElement('div');
    card.className = 'lesson-stage card';

    card.innerHTML = `
      <div class="stage-header">
        <span class="stage-badge">المرحلة الثانية</span>
        <h3 class="stage-title">عرض المتطلبات السابقة</h3>
      </div>
      <div class="stage-body"></div>
    `;

    const body = card.querySelector('.stage-body');
    const list = document.createElement('ul');
    list.className = 'goal-list prereq-list';

    if (prereqList.length) {
      prereqList.forEach((req, idx) => {
        const item = document.createElement('li');
        item.className = 'goal-item';
        item.innerHTML = `
          <span class="goal-index">${idx + 1}</span>
          <span class="goal-text">${escapeHtml(req)}</span>
        `;
        list.appendChild(item);
      });
    } else {
      const empty = document.createElement('div');
      empty.className = 'stage-empty';
      empty.textContent = 'لا توجد متطلبات سابقة لهذه البطاقة.';
      body.appendChild(empty);
    }

    body.appendChild(list);

    const nav = document.createElement('div');
    nav.className = 'lesson-nav';

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary w-100';
    btn.textContent = 'متابعة';
    btn.addEventListener('click', () => {
      stage = STAGES.CONCEPT;
      conceptIndex = 0;
      itemIndex = 0;
      render();
    });

    nav.appendChild(btn);
    card.appendChild(nav);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();
  }

  function renderConceptStage() {
    const concept = data.concepts?.[conceptIndex];
    if (!concept) {
      if (assessment) {
        stage = STAGES.ASSESSMENT;
        render();
        return;
      }
      finishCard();
      return;
    }

    const flow = getConceptFlow(concept);
    if (!flow.length) {
      conceptIndex++;
      itemIndex = 0;
      render();
      return;
    }

    // clamp
    if (itemIndex < 0) itemIndex = 0;

    if (itemIndex >= flow.length) {
      conceptIndex++;
      itemIndex = 0;
      render();
      return;
    }

    const card = document.createElement('div');
    card.className = 'concept';

    const cardInner = document.createElement('div');
    cardInner.className = 'card';

    cardInner.innerHTML = `
      <div class="stage-progress">
        <span class="stage-badge">المرحلة الثالثة</span>
        <div class="stage-progress-body"></div>
      </div>
      <div class="concept-header">
        <div class="row">
          <span class="concept-index">${conceptIndex + 1}</span>
          <h3 class="concept-title">${escapeHtml(concept.title || '')}</h3>
        </div>
      </div>
      <div class="concept-body" data-concept-index="${conceptIndex}"></div>
    `;

    const stageBody = cardInner.querySelector('.stage-progress-body');
    stageBody.appendChild(renderGoalsProgress(conceptIndex));

    const body = cardInner.querySelector('.concept-body');

    // render items up to current
    for (let i = 0; i <= itemIndex; i++) {
      const item = flow[i];
      if (!item || !item.type) continue;

      if (isQuestionItem(item)) {
        body.appendChild(renderQuestionItem(item, i));
      } else if (item.type === 'video') {
        body.appendChild(renderVideoItem(item, i));
      } else {
        body.appendChild(renderTextItem(item, i));
      }
    }

    // single button bar (always)
    const bar = document.createElement('div');
    bar.className = 'lesson-nav';

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary w-100';
    btn.textContent = 'متابعة';

    bar.appendChild(btn);
    body.appendChild(bar);

    // decide behavior for current item
    const currentItem = flow[itemIndex];
    if (isQuestionItem(currentItem) && activeQuestion) {
      activeQuestion.btn = btn;
      btn.addEventListener('click', () => onVerifyOrAdvanceQuestion());
    } else {
      btn.addEventListener('click', () => advanceWithFocus());
    }

    card.appendChild(cardInner);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();

    if (pendingFocus) {
      requestAnimationFrame(() => {
        scrollAndFocusToItem(pendingFocus.itemIndex);
        pendingFocus = null;
      });
    }
    firstPaint = false;
  }

  function renderAssessmentStage() {
    if (!assessment) {
      finishCard();
      return;
    }

    const card = document.createElement('div');
    card.className = 'lesson-stage card assessment';

    card.innerHTML = `
      <div class="stage-header">
        <span class="stage-badge">المرحلة الرابعة</span>
        <h3 class="stage-title">${escapeHtml(assessment.title)}</h3>
        <p class="stage-desc">${escapeHtml(assessment.description)}</p>
      </div>
      <div class="stage-body assessment-body"></div>
    `;

    const body = card.querySelector('.assessment-body');

    assessment.questions.forEach((question, index) => {
      const item = document.createElement('div');
      item.className = 'assessment-question';
      item.appendChild(renderAssessmentQuestion(question, index));
      body.appendChild(item);
    });

    const actions = document.createElement('div');
    actions.className = 'lesson-nav';

    const btnSubmit = document.createElement('button');
    btnSubmit.className = 'btn btn-primary w-100';
    btnSubmit.textContent = 'احسب النتيجة';

    const btnFinish = document.createElement('button');
    btnFinish.className = 'btn btn-outline w-100';
    btnFinish.textContent = 'إنهاء البطاقة';

    const result = document.createElement('div');
    result.className = 'assessment-result hidden';

    if (assessmentState.completed) {
      applyAssessmentResult(result, assessmentState);
      result.classList.remove('hidden');
      btnSubmit.disabled = true;
    }

    btnSubmit.addEventListener('click', () => {
      if (assessmentState.completed && assessmentState.attempts >= 2) return;

      const { score, total } = scoreAssessment(assessment.questions);
      assessmentState = {
        attempts: assessmentState.attempts + 1,
        completed: true,
        score,
        total,
      };

      showToast('نتيجة التقييم', `حصلت على ${score} من ${total} نقطة.`, 'success', 3500);
      render();
    });

    btnFinish.addEventListener('click', () => {
      if (!assessmentState.completed) {
        showToast('تنبيه', 'احسب النتيجة أولًا قبل إنهاء البطاقة', 'warning');
        return;
      }
      finishCard();
    });

    actions.appendChild(btnSubmit);
    actions.appendChild(btnFinish);

    card.appendChild(actions);
    card.appendChild(result);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();
  }

  function applyAssessmentResult(container, state) {
    const retryLeft = state.attempts < 2;

    container.innerHTML = `
      <div class="assessment-score">
        حصلت على <strong>${state.score}</strong> من <strong>${state.total}</strong> نقطة.
      </div>
      <div class="assessment-note">
        ${retryLeft ? 'يمكنك إعادة المحاولة مرة واحدة فقط.' : 'تم استهلاك فرصة إعادة المحاولة.'}
      </div>
    `;

    if (retryLeft) {
      const btnRetry = document.createElement('button');
      btnRetry.type = 'button';
      btnRetry.className = 'btn btn-ghost w-100';
      btnRetry.textContent = 'إعادة المحاولة (مرة واحدة)';
      btnRetry.addEventListener('click', () => {
        assessmentState = {
          attempts: state.attempts,
          completed: false,
          score: null,
          total: null,
        };

        assessment.questions.forEach((question) => resetAssessmentQuestion(question));
        render();
      });
      container.appendChild(btnRetry);
    }
  }

  function renderTextItem(item, idx) {
    const map = {
      goal:     { title: 'الهدف', cls: '' },
      explain:  { title: 'الشرح', cls: '' },
      example:  { title: 'مثال محلول', cls: 'example' },
      example2: { title: 'مثال إضافي', cls: 'example' },
      mistake:  { title: 'خطأ شائع', cls: 'warning' },
      note:     { title: 'ملاحظة', cls: 'note' },
      detail:   { title: 'تفصيل إضافي', cls: 'detail' },
    };

    const cfg = map[item.type] || { title: 'محتوى', cls: '' };

    const el = document.createElement('div');
    el.className = `step ${cfg.cls || ''}`.trim();
    el.setAttribute('data-step-index', String(idx));
    el.setAttribute('data-step-key', item.type);

    const details = Array.isArray(item.details)
      ? item.details.map((line) => `<li>${escapeHtml(line)}</li>`).join('')
      : '';

    el.innerHTML = `
      <p class="step-title">${cfg.title}</p>
      <div class="step-text">${escapeHtml(item.text ?? '')}</div>
      ${details ? `<ul class="step-details">${details}</ul>` : ''}
    `;
    return el;
  }

  function renderVideoItem(item, idx) {
    const el = document.createElement('div');
    el.className = 'step video';
    el.setAttribute('data-step-index', String(idx));
    el.setAttribute('data-step-key', 'video');

    const title = item?.title || 'فيديو توضيحي';
    const description = item?.description || item?.text || '';
    const url = item?.url || item?.src || '';

    const embed = renderVideoEmbed(url);

    el.innerHTML = `
      <p class="step-title">${escapeHtml(title)}</p>
      ${description ? `<div class="step-text">${escapeHtml(description)}</div>` : ''}
      <div class="video-frame">${embed}</div>
    `;

    return el;
  }

  function renderVideoEmbed(url) {
    if (!url) {
      return '<div class="video-empty">لم يتم إضافة رابط فيديو بعد.</div>';
    }

    const youtubeId = getYouTubeId(url);
    if (youtubeId) {
      const safeId = encodeURIComponent(youtubeId);
      return `
        <iframe
          class="video-embed"
          src="https://www.youtube.com/embed/${safeId}"
          title="فيديو الدرس"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      `;
    }

    return `
      <video class="video-embed" controls preload="metadata" src="${escapeHtml(url)}"></video>
    `;
  }

  function isQuestionItem(item) {
    return item?.type === 'question' || item?.type === 'ordering';
  }

  function renderQuestionItem(item, idx) {
    const wrap = document.createElement('div');
    wrap.className = 'question-wrap';
    wrap.setAttribute('data-step-index', String(idx));
    wrap.setAttribute('data-step-key', 'question');

    // IMPORTANT: stable question object for this flow item (persists across re-renders)
    const qData = getStableQuestionObjectForFlowItem(item);

    const title = document.createElement('p');
    title.className = 'question-title';
    title.textContent = qData.text || 'سؤال';

    const attemptsWrap = document.createElement('div');
    attemptsWrap.className = 'attempts';
    attemptsWrap.innerHTML = `
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    `;

    const qMount = document.createElement('div');

    const actions = document.createElement('div');
    actions.className = 'question-actions';
    actions.appendChild(attemptsWrap);

    wrap.appendChild(title);
    wrap.appendChild(qMount);
    wrap.appendChild(actions);

    try {
      const q = renderQuestion({ mountEl: qMount, question: qData });

      activeQuestion = {
        check: q.check,
        attempts: 0,
        solutionShown: false,
        btn: null,
        dotsWrap: attemptsWrap,
        container: wrap,
        qData,
        verifiedOk: false,
      };
    } catch (err) {
      console.error(err);
      const errBox = document.createElement('div');
      errBox.className = 'solution';
      errBox.innerHTML = `
        <p class="solution-title">خطأ في إعداد السؤال</p>
        <div class="solution-text">تأكد من نوع السؤال وحقوله (input/mcq).</div>
      `;
      wrap.appendChild(errBox);
      showToast('خطأ', 'في مشكلة ببيانات السؤال (JSON)', 'error', 4500);
      activeQuestion = null;
    }

    return wrap;
  }

  function renderAssessmentQuestion(question, index) {
    const wrap = document.createElement('div');
    wrap.className = 'assessment-item';

    const title = document.createElement('p');
    title.className = 'assessment-title';
    title.textContent = `${index + 1}. ${question.text}`;

    wrap.appendChild(title);

    if (question.type === 'mcq') {
      const groupName = `assessment-${index}`;

      (question.choices || []).forEach((choice, cIdx) => {
        const label = document.createElement('label');
        label.className = 'choice';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = groupName;
        radio.value = String(cIdx);
        radio.checked = question._selectedIndex === cIdx;
        radio.addEventListener('change', () => {
          question._selectedIndex = cIdx;
        });

        const span = document.createElement('span');
        span.textContent = choice;

        label.appendChild(radio);
        label.appendChild(span);
        wrap.appendChild(label);
      });

      return wrap;
    }

    const input = document.createElement('input');
    input.className = 'input ltr';
    input.type = 'text';
    input.placeholder = question.placeholder || 'اكتب إجابتك هنا';
    input.value = question._value || '';
    input.addEventListener('input', () => {
      question._value = input.value;
    });

    wrap.appendChild(input);
    return wrap;
  }

  function resetAssessmentQuestion(question) {
    delete question._value;
    delete question._selectedIndex;
  }

  function scoreAssessment(questions) {
    let score = 0;
    let total = 0;

    questions.forEach((question) => {
      const points = Number.isFinite(question.points) ? question.points : 1;
      total += points;

      if (question.type === 'mcq') {
        if (question._selectedIndex === question.correctIndex) score += points;
        return;
      }

      const rawUser = question._value ?? '';
      const rawAns = question.answer ?? '';
      const ok = compareAnswer(rawUser, rawAns);
      if (ok) score += points;
    });

    return { score, total };
  }

  function compareAnswer(userValue, answerValue) {
    const user = normalizeSpaces(userValue);
    const ans = normalizeSpaces(answerValue);

    if (isNumericAnswer(ans)) {
      const userNum = parseNumericValue(user);
      const ansNum = parseNumericValue(ans);

      return Number.isFinite(userNum) && Number.isFinite(ansNum) && userNum === ansNum;
    }

    return user !== '' && user === ans;
  }

  function normalizeSpaces(s) {
    if (s == null) return '';
    return String(s).trim().replace(/\s+/g, ' ');
  }

  function toLatinDigits(str) {
    const map = {
      '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
      '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
      '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
      '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
    };
    return String(str).replace(/[٠-٩۰-۹]/g, (d) => map[d] ?? d);
  }

  function parseNumericValue(value) {
    if (value == null) return NaN;
    const normalized = toLatinDigits(String(value))
      .trim()
      .replace(',', '.')
      .replace(/\s+/g, '');

    if (!/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(normalized)) return NaN;

    const num = Number(normalized);
    return Number.isFinite(num) ? num : NaN;
  }

  function isNumericAnswer(ans) {
    return Number.isFinite(parseNumericValue(ans));
  }

  function getYouTubeId(url) {
    try {
      const parsed = new URL(url);
      if (parsed.hostname.includes('youtu.be')) {
        return parsed.pathname.replace('/', '');
      }
      if (parsed.hostname.includes('youtube.com')) {
        return parsed.searchParams.get('v');
      }
    } catch {
      return null;
    }
    return null;
  }

  function onVerifyOrAdvanceQuestion() {
    if (!activeQuestion || !activeQuestion.btn) return;

    if (activeQuestion.verifiedOk) {
      advanceWithFocus();
      return;
    }

    const ok = activeQuestion.check();

    if (ok) {
      activeQuestion.verifiedOk = true;
      activeQuestion.btn.disabled = true;

      showToast('صح ✔', pickRandom(ENCOURAGEMENTS), 'success');

      setTimeout(() => {
        advanceWithFocus();
      }, 850);

      return;
    }

    activeQuestion.attempts++;
    const a = activeQuestion.attempts;

    if (a <= ENGINE.MAX_ATTEMPTS) {
      markAttempt(activeQuestion.dotsWrap, a);

      if (a < ENGINE.MAX_ATTEMPTS) {
        const hint =
          activeQuestion.qData.hints?.[a - 1] ||
          DEFAULT_HINTS[a - 1] ||
          FINAL_HINT;

        showToast('تلميح', hint, 'warning', 4000);
      } else {
        const hint3 = activeQuestion.qData.hints?.[a - 1] || FINAL_HINT;
        showToast('تلميح قوي', hint3, 'warning', 4500);

        if (!activeQuestion.solutionShown) {
          showToast('الحل', 'تم عرض الحل النموذجي تحت', 'danger', 4500);
          showSolution(activeQuestion.container, activeQuestion.qData.solution);
          activeQuestion.solutionShown = true;
        }
      }
    } else {
      showToast('جرّب كمان', 'ارجع للحل واعمل متابعة مرة ثانية', 'info', 2500);
    }
  }

  function markAttempt(wrap, count) {
    const dots = wrap.querySelectorAll('.dot');
    for (let i = 0; i < count && i < dots.length; i++) {
      dots[i].classList.add('used');
    }
  }

  function showSolution(container, solutionText) {
    const existing = container.querySelector('.solution');
    if (existing) return;

    const sol = document.createElement('div');
    sol.className = 'solution';
    sol.innerHTML = `
      <p class="solution-title">الحل النموذجي</p>
      <div class="solution-text">${escapeHtml(solutionText || '')}</div>
    `;
    container.appendChild(sol);
  }

  function setPendingFocusToNext() {
    const concepts = data.concepts || [];
    const concept = concepts[conceptIndex];
    const flow = concept ? getConceptFlow(concept) : [];

    let nextConcept = conceptIndex;
    let nextItem = itemIndex + 1;

    if (nextItem >= flow.length) {
      nextConcept = conceptIndex + 1;
      nextItem = 0;
    }

    pendingFocus = { conceptIndex: nextConcept, itemIndex: nextItem };
  }

  function advance() {
    const concepts = data.concepts || [];
    const concept = concepts[conceptIndex];
    const flow = concept ? getConceptFlow(concept) : [];

    // If we are at the last item of the last concept and trying to advance
    if (isLastPosition()) {
      if (assessment) {
        stage = STAGES.ASSESSMENT;
        render();
        return;
      }
      finishCard();
      return;
    }

    itemIndex++;
    if (itemIndex >= flow.length) {
      conceptIndex++;
      itemIndex = 0;
    }
    render();
  }

  function advanceWithFocus() {
    setPendingFocusToNext();
    advance();
  }

  function scrollAndFocusToItem(iIdx) {
    const target = mountEl.querySelector(`[data-step-index="${iIdx}"]`);
    if (!target) return;

    if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex', '-1');

    target.scrollIntoView({ behavior: 'smooth', block: 'start' });

    try {
      target.focus({ preventScroll: true });
    } catch {
      target.focus();
    }
  }

  function renderGoalsProgress(currentIndex) {
    const list = document.createElement('ul');
    list.className = 'goal-progress';

    if (!goalsList.length) {
      const empty = document.createElement('li');
      empty.className = 'goal-progress-item muted';
      empty.textContent = 'لم يتم تحديد أهداف لهذه البطاقة بعد.';
      list.appendChild(empty);
      return list;
    }

    goalsList.forEach((goal, idx) => {
      const item = document.createElement('li');
      let status = 'upcoming';
      let statusText = 'قادم';

      if (idx < currentIndex) {
        status = 'done';
        statusText = 'مكتمل ✔️';
      } else if (idx === currentIndex) {
        status = 'current';
        statusText = 'الهدف الحالي';
      }

      item.className = `goal-progress-item ${status}`;
      item.innerHTML = `
        <span class="goal-status">${statusText}</span>
        <span class="goal-text">${escapeHtml(goal.text)}</span>
      `;

      list.appendChild(item);
    });

    return list;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function getGoalsList(dataObj) {
    if (Array.isArray(dataObj?.goals) && dataObj.goals.length) {
      return dataObj.goals.map((goal) => ({
        text: typeof goal === 'string' ? goal : String(goal?.text || ''),
      })).filter((goal) => goal.text.trim() !== '');
    }

    const goals = [];
    (dataObj?.concepts || []).forEach((concept) => {
      const flow = Array.isArray(concept?.flow) ? concept.flow : [];
      const goalItem = flow.find((item) => item?.type === 'goal');
      const text = goalItem?.text || concept?.title || 'هدف';
      goals.push({ text: String(text) });
    });

    return goals;
  }

  function getPrereqList(dataObj) {
    if (Array.isArray(dataObj?.prerequisites)) {
      return dataObj.prerequisites.filter((item) => String(item).trim() !== '')
        .map((item) => String(item));
    }

    if (Array.isArray(dataObj?.prereq)) {
      return dataObj.prereq.filter((item) => String(item).trim() !== '')
        .map((item) => String(item));
    }

    return [];
  }

  // Apply resume (if any) before first render
  applyResumeIfAvailable();

  // start
  render();
}
math/public/assets/js/lesson/lessonPage.js
/* =========================================================
   lessonPage.js — Lesson Page Bootstrap
   - Reads student + week
   - Loads week JSON
   - Initializes engine
   - Shows student name (firstName/fullName) instead of id
   ========================================================= */

import { getWeekParam, goHome } from '../core/router.js';
import { fetchJson } from '../core/api.js';
import { weekJsonPath } from '../core/constants.js';
import { getLastStudentId, getStudentSession } from '../core/storage.js';
import { showToast } from '../ui/toast.js';
import { initEngine } from './engine.js';


export async function initLessonPage() {
  const week = getWeekParam();
  const studentId = getLastStudentId();

  if (!week) {
    goHome();
    return;
  }

  if (!studentId) {
    showToast('تنبيه', 'لازم تدخل بيانات الطالب أولًا', 'warning');
    goHome();
    return;
  }

  const student = getStudentSession();
  const displayName =
    (student?.firstName && String(student.firstName).trim()) ||
    (student?.fullName && String(student.fullName).trim()) ||
    `طالب ${studentId}`;

  // UI refs
  const titleEl = document.getElementById('lessonTitle');
  const studentEl = document.getElementById('lessonStudent');
  const weekEl = document.getElementById('lessonWeek');
  const contentEl = document.getElementById('lessonContent');
  const completeEl = document.getElementById('lessonComplete');

  studentEl.textContent = displayName;
  weekEl.textContent = `week ${week}`;

  if (completeEl) {
    completeEl.classList.add('hidden');
    completeEl.setAttribute('hidden', 'hidden');
  }

  try {
    const data = await fetchJson(weekJsonPath(week), { noStore: true });

    titleEl.textContent = data.title || `بطاقة الأسبوع ${week}`;

    // init engine
    initEngine({
      week,
      studentId,
      data,
      mountEl: contentEl,
    });
  } catch (e) {
    console.error(e);
    titleEl.textContent = 'خطأ في تحميل البطاقة';
    showToast('خطأ', 'تعذر تحميل بيانات الدرس', 'error');
  }
}
math/public/assets/js/lesson/progress.js
/* =========================================================
   progress.js — Progress Calculation & UI
   ========================================================= */

export function calcProgressPercent({ data, conceptIndex, stepIndex, stepsPerConcept }) {
  const concepts = data?.concepts || [];
  const totalConcepts = concepts.length || 1;

  const totalSteps = totalConcepts * stepsPerConcept;
  const currentStep = (conceptIndex * stepsPerConcept) + stepIndex;

  const pct = Math.max(0, Math.min(100, Math.round((currentStep / totalSteps) * 100)));
  return pct;
}

export function setProgressUI(percent) {
  const bar = document.getElementById('progressBar');
  const txt = document.getElementById('progressPercent');
  if (bar) bar.style.width = `${percent}%`;
  if (txt) txt.textContent = `${percent}%`;
}
math/public/assets/js/lesson/registry.js
/* =========================================================
   registry.js — Question Type Registry
   - renderQuestion({ mountEl, question }) => { check() }
   ========================================================= */

import { renderInputQuestion } from './input.js';
import { renderMcqQuestion } from './mcq.js';
import { renderMatchQuestion } from './match.js';

const REGISTRY = {
  input: renderInputQuestion,
  mcq: renderMcqQuestion,
  match: renderMatchQuestion, // structure only for now
};

export function renderQuestion({ mountEl, question }) {
  if (!question || !question.type) {
    throw new Error('سؤال غير صالح: type مفقود');
  }

  const renderer = REGISTRY[question.type];
  if (!renderer) {
    throw new Error(`نوع سؤال غير مدعوم: ${question.type}`);
  }

  return renderer({ mountEl, question });
}

export function registerQuestionType(type, renderer) {
  REGISTRY[type] = renderer;
}
math/public/assets/js/mng/cardEditor.js
import { showToast } from '../ui/toast.js';

const elements = {
  cardTitle: document.getElementById('cardTitle'),
  cardSubtitle: document.getElementById('cardSubtitle'),
  sectionsList: document.getElementById('sectionsList'),
  editorContent: document.getElementById('editorContent'),
  btnSave: document.getElementById('btnSave'),
  btnAddConcept: document.getElementById('btnAddConcept'),
  btnAddItem: document.getElementById('btnAddItem'),
  btnAddQuestion: document.getElementById('btnAddQuestion'),
  btnBack: document.getElementById('btnBack'),
  confirmLeave: document.getElementById('confirmLeave'),
  btnCloseLeave: document.getElementById('btnCloseLeave'),
  btnCancelLeave: document.getElementById('btnCancelLeave'),
  btnConfirmLeave: document.getElementById('btnConfirmLeave')
};

const state = {
  week: null,
  seq: null,
  title: '',
  goals: [],
  prerequisites: [],
  concepts: [],
  assessment: { title: '', description: '', questions: [] },
  activeSection: 'goals',
  dirty: false,
  pendingNavigation: null
};

function normalizeValue(value) {
  return value == null ? '' : String(value).trim();
}

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function setDirty(value = true) {
  state.dirty = value;
}

function getWeekParam() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get('week');
  const parsed = raw ? Number(raw) : null;
  return Number.isFinite(parsed) ? parsed : null;
}

function setHeader() {
  const seqLabel = state.seq != null ? state.seq : '—';
  const titleLabel = state.title || 'بدون عنوان';
  elements.cardTitle.textContent = `بطاقة رقم ${seqLabel}: ${titleLabel}`;
  elements.cardSubtitle.textContent = `المعرّف الداخلي: ${state.week ?? '—'}`;
}

function buildSections() {
  const sections = [
    { id: 'goals', label: 'ترحيب / ماذا سنتعلم' },
    { id: 'prerequisites', label: 'متطلب سابق' }
  ];

  state.concepts.forEach((concept, index) => {
    sections.push({
      id: `concept-${index}`,
      label: `المفهوم ${index + 1}: ${concept.title || 'بدون عنوان'}`
    });
  });

  sections.push({ id: 'assessment', label: 'التقييم النهائي' });
  return sections;
}

function renderSidebar() {
  const sections = buildSections();
  elements.sectionsList.innerHTML = sections
    .map((section) => {
      const activeClass = section.id === state.activeSection ? 'active' : '';
      return `<li class="sidebar-item ${activeClass}" data-section="${section.id}">${escapeHtml(section.label)}</li>`;
    })
    .join('');
}

function renderGoalsSection() {
  const items = state.goals.length ? state.goals : [''];
  elements.editorContent.innerHTML = `
    <h2 class="section-title">ترحيب / ماذا سنتعلم</h2>
    ${items
      .map(
        (goal, index) => `
          <div class="item-card" data-index="${index}">
            <label class="label">هدف ${index + 1}</label>
            <input class="input" data-type="goal" data-index="${index}" value="${escapeHtml(goal)}" />
            <div class="item-actions">
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-goal" data-direction="up" data-index="${index}">⬆️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-goal" data-direction="down" data-index="${index}">⬇️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-goal" data-index="${index}">حذف</button>
            </div>
          </div>
        `
      )
      .join('')}
    <button class="btn btn-outline" data-action="add-goal">إضافة هدف</button>
  `;
}

function renderPrereqSection() {
  const items = state.prerequisites.length ? state.prerequisites : [''];
  elements.editorContent.innerHTML = `
    <h2 class="section-title">المتطلب السابق</h2>
    ${items
      .map(
        (item, index) => `
          <div class="item-card" data-index="${index}">
            <label class="label">متطلب ${index + 1}</label>
            <input class="input" data-type="prereq" data-index="${index}" value="${escapeHtml(item)}" />
            <div class="item-actions">
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-prereq" data-direction="up" data-index="${index}">⬆️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-prereq" data-direction="down" data-index="${index}">⬇️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-prereq" data-index="${index}">حذف</button>
            </div>
          </div>
        `
      )
      .join('')}
    <button class="btn btn-outline" data-action="add-prereq">إضافة متطلب</button>
  `;
}

function renderStringList(list, listName, conceptIndex, flowIndex) {
  const items = list.length ? list : [''];
  return `
    <div class="inline-input">
      ${items
        .map(
          (value, index) => `
            <div class="row" style="margin-top: 6px;">
              <input class="input" data-list="${listName}" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" data-index="${index}" value="${escapeHtml(value)}" />
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-list-item" data-list="${listName}" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" data-index="${index}">حذف</button>
            </div>
          `
        )
        .join('')}
      <button class="btn btn-ghost btn-sm small-btn" data-action="add-list-item" data-list="${listName}" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">إضافة</button>
    </div>
  `;
}

function renderFlowItem(item, conceptIndex, flowIndex) {
  const type = item.type || 'goal';
  const showText = ['goal', 'explain', 'question', 'note', 'mcq'].includes(type);
  const showTitle = ['explain', 'video'].includes(type);
  const showDescription = ['explain', 'note', 'image', 'video'].includes(type);
  const showUrl = ['image', 'video'].includes(type);
  const showAnswer = ['question', 'mcq'].includes(type);
  const showChoices = type === 'mcq';

  return `
    <div class="item-card" data-flow-index="${flowIndex}">
      <div class="flow-badge">${escapeHtml(type.toUpperCase())}</div>
      <div class="field">
        <label class="label">نوع العنصر</label>
        <select class="input" data-field="type" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">
          <option value="goal" ${type === 'goal' ? 'selected' : ''}>هدف</option>
          <option value="explain" ${type === 'explain' ? 'selected' : ''}>شرح</option>
          <option value="question" ${type === 'question' ? 'selected' : ''}>سؤال نصي</option>
          <option value="note" ${type === 'note' ? 'selected' : ''}>ملاحظة</option>
          <option value="image" ${type === 'image' ? 'selected' : ''}>صورة</option>
          <option value="video" ${type === 'video' ? 'selected' : ''}>فيديو</option>
          <option value="mcq" ${type === 'mcq' ? 'selected' : ''}>اختيار متعدد</option>
        </select>
      </div>
      ${showTitle ? `
        <div class="field">
          <label class="label">العنوان</label>
          <input class="input" data-field="title" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.title || '')}" />
        </div>
      ` : ''}
      ${showText ? `
        <div class="field">
          <label class="label">النص</label>
          <textarea class="input" rows="3" data-field="text" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">${escapeHtml(item.text || '')}</textarea>
        </div>
      ` : ''}
      ${showDescription ? `
        <div class="field">
          <label class="label">الوصف</label>
          <textarea class="input" rows="2" data-field="description" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">${escapeHtml(item.description || '')}</textarea>
        </div>
      ` : ''}
      ${showUrl ? `
        <div class="field">
          <label class="label">الرابط</label>
          <input class="input ltr" data-field="url" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.url || '')}" />
        </div>
      ` : ''}
      ${showAnswer ? `
        <div class="field">
          <label class="label">الإجابة</label>
          <input class="input" data-field="answer" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.answer || '')}" />
        </div>
      ` : ''}
      ${showChoices ? `
        <div class="field">
          <label class="label">الاختيارات</label>
          ${renderStringList(item.choices || [], 'choices', conceptIndex, flowIndex)}
        </div>
        <div class="field">
          <label class="label">رقم الإجابة الصحيحة</label>
          <input class="input ltr" data-field="correctIndex" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.correctIndex ?? 0)}" />
        </div>
      ` : ''}
      <div class="field">
        <label class="label">تفاصيل إضافية</label>
        ${renderStringList(item.details || [], 'details', conceptIndex, flowIndex)}
      </div>
      <div class="field">
        <label class="label">تلميحات</label>
        ${renderStringList(item.hints || [], 'hints', conceptIndex, flowIndex)}
      </div>
      <div class="field">
        <label class="label">الحل</label>
        <input class="input" data-field="solution" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.solution || '')}" />
      </div>
      <div class="item-actions">
        <button class="btn btn-ghost btn-sm small-btn" data-action="move-flow" data-direction="up" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">⬆️</button>
        <button class="btn btn-ghost btn-sm small-btn" data-action="move-flow" data-direction="down" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">⬇️</button>
        <button class="btn btn-ghost btn-sm small-btn" data-action="delete-flow" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">حذف</button>
      </div>
    </div>
  `;
}

function renderConceptSection(index) {
  const concept = state.concepts[index] || { title: '', flow: [] };
  const flowItems = concept.flow.length ? concept.flow : [];

  elements.editorContent.innerHTML = `
    <h2 class="section-title">المفهوم ${index + 1}</h2>
    <div class="field">
      <label class="label">عنوان المفهوم</label>
      <input class="input" data-concept-title="true" data-concept-index="${index}" value="${escapeHtml(concept.title || '')}" />
    </div>
    <div>
      ${flowItems.length
        ? flowItems.map((item, flowIndex) => renderFlowItem(item, index, flowIndex)).join('')
        : '<p class="muted">لا يوجد عناصر بعد. استخدم زر إضافة عنصر.</p>'}
    </div>
  `;
}

function renderAssessmentSection() {
  const assessment = state.assessment || { title: '', description: '', questions: [] };
  const questions = assessment.questions.length ? assessment.questions : [];

  elements.editorContent.innerHTML = `
    <h2 class="section-title">التقييم النهائي</h2>
    <div class="field">
      <label class="label">عنوان التقييم</label>
      <input class="input" data-assessment-field="title" value="${escapeHtml(assessment.title || '')}" />
    </div>
    <div class="field">
      <label class="label">الوصف</label>
      <textarea class="input" rows="2" data-assessment-field="description">${escapeHtml(assessment.description || '')}</textarea>
    </div>
    <div>
      ${questions.length
        ? questions
            .map(
              (question, index) => `
                <div class="item-card" data-question-index="${index}">
                  <label class="label">سؤال ${index + 1}</label>
                  <select class="input" data-question-field="type" data-question-index="${index}">
                    <option value="mcq" ${question.type === 'mcq' ? 'selected' : ''}>اختيار متعدد</option>
                    <option value="input" ${question.type === 'input' ? 'selected' : ''}>إجابة نصية</option>
                  </select>
                  <input class="input" data-question-field="text" data-question-index="${index}" value="${escapeHtml(question.text || '')}" />
                  <div class="row" style="margin-top: 8px;">
                    <input class="input ltr" data-question-field="points" data-question-index="${index}" value="${escapeHtml(question.points ?? 1)}" />
                    <span class="small muted">الدرجة</span>
                  </div>
                  ${question.type === 'input' ? `
                    <div class="field">
                      <label class="label">الإجابة النموذجية</label>
                      <input class="input" data-question-field="answer" data-question-index="${index}" value="${escapeHtml(question.answer || '')}" />
                    </div>
                  ` : `
                    <div class="field">
                      <label class="label">الاختيارات</label>
                      ${renderAssessmentChoices(question.choices || [], index)}
                    </div>
                    <div class="field">
                      <label class="label">رقم الإجابة الصحيحة</label>
                      <input class="input ltr" data-question-field="correctIndex" data-question-index="${index}" value="${escapeHtml(question.correctIndex ?? 0)}" />
                    </div>
                  `}
                  <div class="item-actions">
                    <button class="btn btn-ghost btn-sm small-btn" data-action="move-question" data-direction="up" data-question-index="${index}">⬆️</button>
                    <button class="btn btn-ghost btn-sm small-btn" data-action="move-question" data-direction="down" data-question-index="${index}">⬇️</button>
                    <button class="btn btn-ghost btn-sm small-btn" data-action="delete-question" data-question-index="${index}">حذف</button>
                  </div>
                </div>
              `
            )
            .join('')
        : '<p class="muted">لا يوجد أسئلة بعد. استخدم زر إضافة سؤال.</p>'}
    </div>
  `;
}

function renderAssessmentChoices(list, questionIndex) {
  const items = list.length ? list : [''];
  return `
    <div class="inline-input">
      ${items
        .map(
          (value, index) => `
            <div class="row" style="margin-top: 6px;">
              <input class="input" data-question-choice="true" data-question-index="${questionIndex}" data-index="${index}" value="${escapeHtml(value)}" />
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-question-choice" data-question-index="${questionIndex}" data-index="${index}">حذف</button>
            </div>
          `
        )
        .join('')}
      <button class="btn btn-ghost btn-sm small-btn" data-action="add-question-choice" data-question-index="${questionIndex}">إضافة اختيار</button>
    </div>
  `;
}

function renderPanel() {
  if (state.activeSection === 'goals') {
    renderGoalsSection();
  } else if (state.activeSection === 'prerequisites') {
    renderPrereqSection();
  } else if (state.activeSection.startsWith('concept-')) {
    const index = Number(state.activeSection.split('-')[1]);
    renderConceptSection(index);
  } else if (state.activeSection === 'assessment') {
    renderAssessmentSection();
  }
}

function renderAll() {
  renderSidebar();
  renderPanel();
}

function moveItem(array, fromIndex, direction) {
  const toIndex = direction === 'up' ? fromIndex - 1 : fromIndex + 1;
  if (toIndex < 0 || toIndex >= array.length) return;
  const item = array.splice(fromIndex, 1)[0];
  array.splice(toIndex, 0, item);
  setDirty(true);
  renderAll();
}

function handleSidebarClick(event) {
  const item = event.target.closest('.sidebar-item');
  if (!item) return;
  state.activeSection = item.dataset.section;
  renderAll();
}

function handleEditorInput(event) {
  const target = event.target;
  if (target.dataset.type === 'goal') {
    const index = Number(target.dataset.index);
    state.goals[index] = target.value;
    setDirty(true);
    return;
  }

  if (target.dataset.type === 'prereq') {
    const index = Number(target.dataset.index);
    state.prerequisites[index] = target.value;
    setDirty(true);
    return;
  }

  if (target.dataset.conceptTitle) {
    const index = Number(target.dataset.conceptIndex);
    state.concepts[index].title = target.value;
    setDirty(true);
    renderSidebar();
    return;
  }

  if (target.dataset.field) {
    const conceptIndex = Number(target.dataset.conceptIndex);
    const flowIndex = Number(target.dataset.flowIndex);
    const field = target.dataset.field;
    state.concepts[conceptIndex].flow[flowIndex][field] = target.value;
    setDirty(true);
    if (field === 'type') {
      renderPanel();
    }
    return;
  }

  if (target.dataset.list) {
    const conceptIndex = Number(target.dataset.conceptIndex);
    const flowIndex = Number(target.dataset.flowIndex);
    const listName = target.dataset.list;
    const index = Number(target.dataset.index);
    const list = state.concepts[conceptIndex].flow[flowIndex][listName] || [];
    list[index] = target.value;
    state.concepts[conceptIndex].flow[flowIndex][listName] = list;
    setDirty(true);
    return;
  }

  if (target.dataset.assessmentField) {
    const field = target.dataset.assessmentField;
    state.assessment[field] = target.value;
    setDirty(true);
    return;
  }

  if (target.dataset.questionField) {
    const index = Number(target.dataset.questionIndex);
    const field = target.dataset.questionField;
    state.assessment.questions[index][field] = target.value;
    setDirty(true);
    renderPanel();
    return;
  }

  if (target.dataset.questionChoice) {
    const questionIndex = Number(target.dataset.questionIndex);
    const index = Number(target.dataset.index);
    const choices = state.assessment.questions[questionIndex].choices || [];
    choices[index] = target.value;
    state.assessment.questions[questionIndex].choices = choices;
    setDirty(true);
  }
}

function handleEditorClick(event) {
  const button = event.target.closest('button[data-action]');
  if (!button) return;

  const action = button.dataset.action;

  if (action === 'add-goal') {
    state.goals.push('');
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-goal') {
    const index = Number(button.dataset.index);
    state.goals.splice(index, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-goal') {
    const index = Number(button.dataset.index);
    moveItem(state.goals, index, button.dataset.direction);
    return;
  }

  if (action === 'add-prereq') {
    state.prerequisites.push('');
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-prereq') {
    const index = Number(button.dataset.index);
    state.prerequisites.splice(index, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-prereq') {
    const index = Number(button.dataset.index);
    moveItem(state.prerequisites, index, button.dataset.direction);
    return;
  }

  if (action === 'add-list-item') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    const listName = button.dataset.list;
    const list = state.concepts[conceptIndex].flow[flowIndex][listName] || [];
    list.push('');
    state.concepts[conceptIndex].flow[flowIndex][listName] = list;
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-list-item') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    const listName = button.dataset.list;
    const index = Number(button.dataset.index);
    const list = state.concepts[conceptIndex].flow[flowIndex][listName] || [];
    list.splice(index, 1);
    state.concepts[conceptIndex].flow[flowIndex][listName] = list;
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-flow') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    state.concepts[conceptIndex].flow.splice(flowIndex, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-flow') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    moveItem(state.concepts[conceptIndex].flow, flowIndex, button.dataset.direction);
    return;
  }

  if (action === 'delete-question') {
    const index = Number(button.dataset.questionIndex);
    state.assessment.questions.splice(index, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-question') {
    const index = Number(button.dataset.questionIndex);
    moveItem(state.assessment.questions, index, button.dataset.direction);
    return;
  }

  if (action === 'add-question-choice') {
    const questionIndex = Number(button.dataset.questionIndex);
    const choices = state.assessment.questions[questionIndex].choices || [];
    choices.push('');
    state.assessment.questions[questionIndex].choices = choices;
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-question-choice') {
    const questionIndex = Number(button.dataset.questionIndex);
    const index = Number(button.dataset.index);
    const choices = state.assessment.questions[questionIndex].choices || [];
    choices.splice(index, 1);
    state.assessment.questions[questionIndex].choices = choices;
    setDirty(true);
    renderPanel();
  }
}

function addConcept() {
  state.concepts.push({ title: '', flow: [] });
  state.activeSection = `concept-${state.concepts.length - 1}`;
  setDirty(true);
  renderAll();
}

function addFlowItem() {
  if (!state.activeSection.startsWith('concept-')) {
    showToast('تنبيه', 'اختر مفهومًا لإضافة عنصر.', 'warning');
    return;
  }
  const index = Number(state.activeSection.split('-')[1]);
  state.concepts[index].flow.push({ type: 'goal', text: '', title: '', description: '', url: '', answer: '', correctIndex: 0, solution: '', details: [], hints: [], choices: [] });
  setDirty(true);
  renderPanel();
}

function addQuestion() {
  const questions = state.assessment.questions || [];
  questions.push({ type: 'mcq', text: '', points: 1, choices: [''], correctIndex: 0, answer: '' });
  state.assessment.questions = questions;
  setDirty(true);
  renderPanel();
}

async function saveContent() {
  const payload = {
    week: state.week,
    seq: state.seq,
    title: state.title,
    goals: state.goals.filter((goal) => normalizeValue(goal)),
    prerequisites: state.prerequisites.filter((item) => normalizeValue(item)),
    concepts: state.concepts.map((concept) => ({
      title: normalizeValue(concept.title),
      flow: (concept.flow || []).map((item) => ({
        type: normalizeValue(item.type),
        text: normalizeValue(item.text),
        title: normalizeValue(item.title),
        description: normalizeValue(item.description),
        url: normalizeValue(item.url),
        answer: normalizeValue(item.answer),
        correctIndex: item.correctIndex ?? 0,
        solution: normalizeValue(item.solution),
        details: (item.details || []).filter((entry) => normalizeValue(entry)),
        hints: (item.hints || []).filter((entry) => normalizeValue(entry)),
        choices: (item.choices || []).filter((entry) => normalizeValue(entry))
      }))
    })),
    assessment: {
      title: normalizeValue(state.assessment.title),
      description: normalizeValue(state.assessment.description),
      questions: (state.assessment.questions || []).map((question) => ({
        type: normalizeValue(question.type) || 'input',
        text: normalizeValue(question.text),
        points: Number(question.points) || 1,
        answer: normalizeValue(question.answer),
        correctIndex: question.correctIndex ?? 0,
        choices: (question.choices || []).filter((entry) => normalizeValue(entry))
      }))
    }
  };

  try {
    const response = await fetch(`/api/mng/weeks/${encodeURIComponent(state.week)}/content`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر حفظ المحتوى.');
    }

    setDirty(false);
    showToast('نجاح', 'تم الحفظ', 'success');
  } catch (error) {
    showToast('خطأ', error.message || 'تعذر حفظ المحتوى.', 'error');
  }
}

function openLeaveModal(callback) {
  state.pendingNavigation = callback;
  elements.confirmLeave.classList.remove('hidden');
  elements.confirmLeave.setAttribute('aria-hidden', 'false');
}

function closeLeaveModal() {
  elements.confirmLeave.classList.add('hidden');
  elements.confirmLeave.setAttribute('aria-hidden', 'true');
  state.pendingNavigation = null;
}

function handleBackClick(event) {
  if (!state.dirty) return;
  event.preventDefault();
  openLeaveModal(() => {
    window.location.href = event.currentTarget.href;
  });
}

function bindEvents() {
  elements.sectionsList.addEventListener('click', handleSidebarClick);
  elements.editorContent.addEventListener('input', handleEditorInput);
  elements.editorContent.addEventListener('click', handleEditorClick);
  elements.btnAddConcept.addEventListener('click', addConcept);
  elements.btnAddItem.addEventListener('click', addFlowItem);
  elements.btnAddQuestion.addEventListener('click', addQuestion);
  elements.btnSave.addEventListener('click', saveContent);
  elements.btnBack.addEventListener('click', handleBackClick);
  elements.btnCloseLeave.addEventListener('click', closeLeaveModal);
  elements.btnCancelLeave.addEventListener('click', closeLeaveModal);
  elements.confirmLeave.addEventListener('click', (event) => {
    if (event.target.dataset?.close) closeLeaveModal();
  });
  elements.btnConfirmLeave.addEventListener('click', () => {
    if (state.pendingNavigation) {
      const next = state.pendingNavigation;
      closeLeaveModal();
      next();
    }
  });

  window.addEventListener('beforeunload', (event) => {
    if (!state.dirty) return;
    event.preventDefault();
    event.returnValue = '';
  });
}

async function init() {
  const week = getWeekParam();
  if (!week) {
    elements.editorContent.textContent = 'رقم البطاقة غير صالح.';
    return;
  }

  state.week = week;
  bindEvents();

  try {
    const response = await fetch(`/api/mng/weeks/${encodeURIComponent(week)}/content`, { cache: 'no-store' });
    const data = await response.json();
    if (!response.ok || data?.ok === false) {
      throw new Error(data?.error || 'تعذر تحميل المحتوى.');
    }

    state.seq = data.seq;
    state.title = data.title || '';
    state.goals = Array.isArray(data.goals) ? data.goals : [];
    state.prerequisites = Array.isArray(data.prerequisites) ? data.prerequisites : [];
    state.concepts = Array.isArray(data.concepts) ? data.concepts : [];
    state.assessment = data.assessment || { title: '', description: '', questions: [] };

    setHeader();
    renderAll();
  } catch (error) {
    elements.editorContent.textContent = 'تعذر تحميل المحتوى.';
    showToast('خطأ', error.message || 'تعذر تحميل المحتوى.', 'error');
  }
}

init();
math/public/assets/js/mng/cardsManager.js
import { showToast } from '../ui/toast.js';

const API_BASE = '/api/mng/cards';

const elements = {
  body: document.getElementById('cardsBody'),
  addButton: document.getElementById('btnAddCard'),
  deleteSelectedButton: document.getElementById('btnDeleteSelected'),
  exportButton: document.getElementById('btnExportCards'),
  searchInput: document.getElementById('searchInput'),
  searchButton: document.getElementById('btnSearch'),
  gradeFilter: document.getElementById('gradeFilter'),
  classFilter: document.getElementById('classFilter'),
  selectAll: document.getElementById('selectAllCards'),
  modal: document.getElementById('cardModal'),
  modalTitle: document.getElementById('modalTitle'),
  modalClose: document.getElementById('btnCloseModal'),
  modalCancel: document.getElementById('btnCancel'),
  form: document.getElementById('cardForm'),
  submitButton: document.getElementById('btnSubmit'),
  weekDisplayRow: document.getElementById('weekDisplayRow'),
  weekDisplay: document.getElementById('weekDisplay'),
  titleInput: document.getElementById('titleInput'),
  gradeInput: document.getElementById('gradeInput'),
  prereqSelect: document.getElementById('prereqSelect'),
  allClassesToggle: document.getElementById('allClassesToggle'),
  classesOptions: document.getElementById('classesOptions'),
  classesManual: document.getElementById('classesManual'),
  confirmModal: document.getElementById('confirmModal'),
  confirmTitle: document.getElementById('confirmTitle'),
  confirmMessage: document.getElementById('confirmMessage'),
  confirmClose: document.getElementById('btnCloseConfirm'),
  confirmCancel: document.getElementById('btnCancelDelete'),
  confirmSubmit: document.getElementById('btnConfirmDelete'),
  completionsModal: document.getElementById('completionsModal'),
  completionsTitle: document.getElementById('completionsTitle'),
  completionsSubtitle: document.getElementById('completionsSubtitle'),
  completionsBody: document.getElementById('completionsBody'),
  completionsClose: document.getElementById('btnCloseCompletions')
};

const state = {
  cards: [],
  mode: 'add',
  activeWeek: null,
  prereqOptions: []
};

const gradeLabels = {
  '1': 'الأول',
  '2': 'الثاني',
  '3': 'الثالث',
  '4': 'الرابع',
  '5': 'الخامس',
  '6': 'السادس',
  '7': 'السابع',
  '8': 'الثامن',
  '9': 'التاسع'
};

const classOptions = Array.from({ length: 10 }, (_, index) => String(index + 1));

let searchTimeout = null;
let confirmAction = null;
let confirmBusy = false;

function setLoading(message) {
  elements.body.innerHTML = `
    <tr>
      <td colspan="7" class="muted center">${message}</td>
    </tr>
  `;
}

function setCompletionsLoading(message) {
  elements.completionsBody.innerHTML = `
    <tr>
      <td colspan="5" class="muted center">${message}</td>
    </tr>
  `;
}

function normalizeValue(value) {
  return value == null ? '' : String(value).trim();
}

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };
  return normalizeValue(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

function formatGrade(value) {
  const normalized = normalizeDigits(value);
  return gradeLabels[normalized] || normalized || '-';
}

function formatPrereqLabel(card) {
  const prereqSeq = normalizeDigits(card.prereqSeq);
  const prereqTitle = normalizeValue(card.prereqTitle);
  if (!prereqSeq && !prereqTitle) return '—';
  return `${escapeHtml(prereqSeq)} — ${escapeHtml(prereqTitle || 'بدون عنوان')}`;
}

function setClassFilterEnabled(enabled) {
  if (!elements.classFilter) return;
  if (!enabled) {
    elements.classFilter.innerHTML = '<option value="">كل الشعب</option>';
    elements.classFilter.value = '';
    elements.classFilter.disabled = true;
    return;
  }

  const options = ['<option value="">كل الشعب</option>'];
  classOptions.forEach((className) => {
    options.push(`<option value="${escapeHtml(className)}">${escapeHtml(className)}</option>`);
  });
  elements.classFilter.innerHTML = options.join('');
  elements.classFilter.disabled = false;
}

function buildClassOptions() {
  if (!elements.classesOptions) return;
  elements.classesOptions.innerHTML = classOptions
    .map(
      (className) => `
        <label class="label">
          <input class="class-check" type="checkbox" value="${escapeHtml(className)}" />
          شعبة ${escapeHtml(className)}
        </label>
      `
    )
    .join('');
}

function setClassesDisabled(disabled) {
  const inputs = elements.classesOptions?.querySelectorAll('.class-check') || [];
  inputs.forEach((input) => {
    input.disabled = disabled;
  });
  if (elements.classesManual) {
    elements.classesManual.disabled = disabled;
  }
}

function getFilters() {
  return {
    grade: normalizeDigits(elements.gradeFilter.value),
    className: normalizeDigits(elements.classFilter.value),
    q: normalizeValue(elements.searchInput.value)
  };
}

async function fetchCards() {
  setLoading('تحميل البيانات...');
  const { grade, className, q } = getFilters();
  const params = new URLSearchParams();
  if (grade) params.set('grade', grade);
  if (className) params.set('class', className);
  if (q) params.set('q', q);

  try {
    const response = await fetch(`${API_BASE}?${params.toString()}`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر تحميل البيانات.');
    }

    state.cards = data.cards || [];
    renderCards(state.cards);
    updateExportButtonState(state.cards.length);
    updateBulkDeleteState();
  } catch (error) {
    setLoading('تعذر تحميل البيانات.');
    showToast('خطأ', error.message || 'تعذر تحميل البيانات.', 'error');
  }
}

function renderCards(list) {
  if (!list.length) {
    setLoading('لا توجد نتائج حالياً.');
    return;
  }

  elements.body.innerHTML = list
    .map((card) => {
      const week = normalizeDigits(card.week);
      const seq = normalizeDigits(card.seq);
      const title = normalizeValue(card.title);
      const gradeLabel = formatGrade(card.grade);
      const classes = Array.isArray(card.classes) ? card.classes : [];
      const hasAllClasses = Boolean(card.isAllClasses);
      const classesLabel = hasAllClasses
        ? 'كل الشعب'
        : classes.length
          ? classes.map((entry) => escapeHtml(normalizeDigits(entry))).join(', ')
          : 'غير محدد';
      const prereqLabel = formatPrereqLabel(card);

      return `
        <tr>
          <td class="select-cell">
            <input class="row-check" type="checkbox" data-week="${escapeHtml(week)}" aria-label="تحديد البطاقة" />
          </td>
          <td class="ltr">${escapeHtml(seq || '-')}
            <div class="small muted">ID: ${escapeHtml(week)}</div>
          </td>
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(gradeLabel)}</td>
          <td>${classesLabel}</td>
          <td>${prereqLabel}</td>
          <td class="actions">
            <button class="btn btn-outline btn-sm icon-btn" data-action="edit" data-week="${escapeHtml(week)}" title="تعديل" aria-label="تعديل">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M3 17.25V21h3.75l11-11-3.75-3.75-11 11zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="content" data-week="${escapeHtml(week)}" title="تحرير المحتوى" aria-label="تحرير المحتوى">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14H7v-2h3v2zm0-4H7v-2h3v2zm0-4H7V7h3v2zm7 8h-5v-2h5v2zm0-4h-5v-2h5v2zm0-4h-5V7h5v2z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="completions" data-week="${escapeHtml(week)}" title="من أنهى البطاقة" aria-label="من أنهى البطاقة">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="delete" data-week="${escapeHtml(week)}" title="حذف" aria-label="حذف">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 13.41l-6.29 6.3-1.42-1.42L10.59 12 4.29 5.71 5.7 4.29 12 10.59l6.29-6.3z"/>
              </svg>
            </button>
          </td>
        </tr>
      `;
    })
    .join('');
}

function getSelectedWeeks() {
  return Array.from(elements.body.querySelectorAll('.row-check:checked'))
    .map((checkbox) => checkbox.dataset.week)
    .filter(Boolean);
}

function updateBulkDeleteState() {
  const selected = getSelectedWeeks();
  elements.deleteSelectedButton.disabled = selected.length === 0;
  elements.deleteSelectedButton.textContent = selected.length
    ? `حذف المحدد (${selected.length})`
    : 'حذف المحدد';

  if (elements.selectAll) {
    const total = elements.body.querySelectorAll('.row-check').length;
    elements.selectAll.checked = total > 0 && selected.length === total;
    elements.selectAll.indeterminate = selected.length > 0 && selected.length < total;
  }
}

function updateExportButtonState(total) {
  if (!elements.exportButton) return;
  elements.exportButton.disabled = total === 0;
}

function buildExportFileName() {
  const gradePart = normalizeDigits(elements.gradeFilter.value) || 'all';
  const classPart = normalizeDigits(elements.classFilter.value) || 'all';
  const datePart = new Date().toISOString().split('T')[0];
  return `cards_${datePart}_grade-${gradePart}_class-${classPart}.xlsx`;
}

function handleExportCards() {
  if (!state.cards.length) {
    updateExportButtonState(0);
    showToast('تنبيه', 'لا توجد نتائج للتصدير.', 'warning');
    return;
  }

  if (!window.XLSX) {
    showToast('خطأ', 'تعذر تحميل مكتبة تصدير Excel.', 'error');
    return;
  }

  const headers = ['Seq', 'Title', 'Grade', 'Classes', 'Prereq', 'CompletedCount'];
  const rows = state.cards.map((card) => {
    const seq = normalizeDigits(card.seq);
    const title = normalizeValue(card.title);
    const grade = normalizeDigits(card.grade);
    const classes = Array.isArray(card.classes) ? card.classes : [];
    const classesText = classes.map((entry) => normalizeDigits(entry)).join(', ');
    const prereqSeq = normalizeDigits(card.prereqSeq);
    const prereqTitle = normalizeValue(card.prereqTitle);
    const prereqText = prereqSeq || prereqTitle ? `${prereqSeq} - ${prereqTitle}` : '';
    const completedCount = Number(card.completedCount || 0);

    return [seq, title, grade, classesText, prereqText, completedCount];
  });

  const worksheet = window.XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const workbook = window.XLSX.utils.book_new();
  window.XLSX.utils.book_append_sheet(workbook, worksheet, 'Cards');
  window.XLSX.writeFile(workbook, buildExportFileName());
}

function buildPrereqOptions(cards, currentWeek) {
  const options = ['<option value="">لا يوجد</option>'];
  cards
    .filter((card) => normalizeDigits(card.week) !== normalizeDigits(currentWeek))
    .forEach((card) => {
      const seq = normalizeDigits(card.seq);
      const title = normalizeValue(card.title);
      const week = normalizeDigits(card.week);
      options.push(`<option value="${escapeHtml(week)}">${escapeHtml(seq || '-') } - ${escapeHtml(title || 'بدون عنوان')}</option>`);
    });
  return options.join('');
}

async function updatePrereqOptions(grade, currentWeek, selectedWeek) {
  if (!elements.prereqSelect) return;
  if (!grade) {
    elements.prereqSelect.innerHTML = '<option value="">لا يوجد</option>';
    elements.prereqSelect.disabled = true;
    return;
  }

  elements.prereqSelect.disabled = true;
  elements.prereqSelect.innerHTML = '<option value="">جاري التحميل...</option>';

  try {
    const params = new URLSearchParams();
    params.set('grade', grade);
    params.set('class', 'ALL_CLASSES');

    const response = await fetch(`${API_BASE}?${params.toString()}`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر تحميل المتطلبات السابقة.');
    }

    const cards = Array.isArray(data.cards) ? data.cards : [];
    cards.sort((a, b) => Number(a.seq) - Number(b.seq));
    state.prereqOptions = cards;
    elements.prereqSelect.innerHTML = buildPrereqOptions(cards, currentWeek);
    elements.prereqSelect.value = normalizeDigits(selectedWeek || '');
    elements.prereqSelect.disabled = false;
  } catch (error) {
    elements.prereqSelect.innerHTML = '<option value="">لا يوجد</option>';
    elements.prereqSelect.disabled = false;
    showToast('خطأ', error.message || 'تعذر تحميل المتطلبات السابقة.', 'error');
  }
}

function openModal(mode, card = {}) {
  state.mode = mode;
  state.activeWeek = normalizeDigits(card.week);
  const isEdit = mode === 'edit';

  elements.modalTitle.textContent = isEdit ? 'تعديل بيانات البطاقة' : 'إضافة بطاقة';
  elements.submitButton.textContent = isEdit ? 'حفظ التعديلات' : 'إضافة البطاقة';

  elements.modal.classList.remove('hidden');
  elements.modal.setAttribute('aria-hidden', 'false');

  elements.weekDisplayRow.style.display = isEdit ? 'block' : 'none';
  if (elements.weekDisplay) {
    elements.weekDisplay.textContent = isEdit ? `ID: ${normalizeDigits(card.week)}` : 'سيتم توليد المعرّف تلقائياً';
  }

  elements.titleInput.value = normalizeValue(card.title);
  elements.gradeInput.value = normalizeDigits(card.grade);
  elements.classesManual.value = '';

  const hasAllClasses = Boolean(card.isAllClasses);
  elements.allClassesToggle.checked = hasAllClasses || !Array.isArray(card.classes) || !card.classes.length;

  const checkedClasses = new Set(
    (card.classes || []).map((entry) => normalizeDigits(entry)).filter(Boolean)
  );
  const checkboxes = elements.classesOptions.querySelectorAll('.class-check');
  checkboxes.forEach((checkbox) => {
    checkbox.checked = checkedClasses.has(checkbox.value);
  });

  setClassesDisabled(elements.allClassesToggle.checked);
  updatePrereqOptions(elements.gradeInput.value, card.week, card.prereqWeek);
}

function closeModal() {
  elements.modal.classList.add('hidden');
  elements.modal.setAttribute('aria-hidden', 'true');
  elements.form.reset();
  setClassesDisabled(elements.allClassesToggle.checked);
}

function openConfirmModal({ title, message, onConfirm }) {
  confirmAction = onConfirm;
  elements.confirmTitle.textContent = title;
  elements.confirmMessage.textContent = message;
  elements.confirmModal.classList.remove('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'false');
}

function closeConfirmModal(force = false) {
  if (confirmBusy && !force) return;
  confirmAction = null;
  elements.confirmModal.classList.add('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'true');
}

function openCompletionsModal(card) {
  elements.completionsTitle.textContent = `من أنهى البطاقة ${normalizeDigits(card.seq)}`;
  elements.completionsSubtitle.textContent = 'جاري التحميل...';
  setCompletionsLoading('تحميل البيانات...');
  elements.completionsModal.classList.remove('hidden');
  elements.completionsModal.setAttribute('aria-hidden', 'false');

  fetchCompletions(card);
}

function closeCompletionsModal() {
  elements.completionsModal.classList.add('hidden');
  elements.completionsModal.setAttribute('aria-hidden', 'true');
}

async function fetchCompletions(card) {
  const className = normalizeDigits(elements.classFilter.value) || 'ALL_CLASSES';
  const params = new URLSearchParams();
  if (className) params.set('class', className);

  try {
    const response = await fetch(`${API_BASE}/${encodeURIComponent(card.week)}/completions?${params.toString()}`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر تحميل البيانات.');
    }

    const students = Array.isArray(data.students) ? data.students : [];
    elements.completionsSubtitle.textContent = `الإجمالي: ${students.length}`;

    if (!students.length) {
      setCompletionsLoading('لا يوجد طلاب أكملوا البطاقة بعد.');
      return;
    }

    elements.completionsBody.innerHTML = students
      .map((student) => `
        <tr>
          <td class="ltr">${escapeHtml(student.StudentId)}</td>
          <td>${escapeHtml(student.FullName || '—')}</td>
          <td>${escapeHtml(student.Class || '—')}</td>
          <td>${escapeHtml(student.FinalScore ?? '-') }</td>
          <td>${escapeHtml(new Date(student.CompletedAt).toLocaleString('ar'))}</td>
        </tr>
      `)
      .join('');
  } catch (error) {
    elements.completionsSubtitle.textContent = 'تعذر تحميل البيانات.';
    setCompletionsLoading('تعذر تحميل البيانات.');
    showToast('خطأ', error.message || 'تعذر تحميل البيانات.', 'error');
  }
}

async function handleConfirmSubmit() {
  if (!confirmAction || confirmBusy) return;
  confirmBusy = true;
  elements.confirmSubmit.disabled = true;

  try {
    await confirmAction();
    closeConfirmModal(true);
  } catch (error) {
    showToast('خطأ', error.message || 'حدث خطأ أثناء الحذف.', 'error');
  } finally {
    confirmBusy = false;
    elements.confirmSubmit.disabled = false;
  }
}

function collectClasses() {
  if (elements.allClassesToggle.checked) return [];

  const selected = Array.from(elements.classesOptions.querySelectorAll('.class-check:checked'))
    .map((input) => normalizeDigits(input.value))
    .filter(Boolean);

  const manualValues = normalizeValue(elements.classesManual.value)
    .split(',')
    .map((entry) => normalizeDigits(entry))
    .map((entry) => entry.trim())
    .filter(Boolean);

  return Array.from(new Set([...selected, ...manualValues]));
}

async function handleSubmit(event) {
  event.preventDefault();

  const title = normalizeValue(elements.titleInput.value);
  const grade = normalizeDigits(elements.gradeInput.value);
  const allClasses = Boolean(elements.allClassesToggle.checked);
  const classes = collectClasses();
  const prereqWeekRaw = normalizeDigits(elements.prereqSelect.value);
  const prereqWeek = prereqWeekRaw ? Number(prereqWeekRaw) : null;

  if (!title) {
    showToast('تنبيه', 'العنوان مطلوب.', 'warning');
    return;
  }

  if (!grade) {
    showToast('تنبيه', 'اختر الصف.', 'warning');
    return;
  }

  const payload = {
    title,
    grade,
    classes,
    allClasses,
    prereqWeek
  };

  const isEdit = state.mode === 'edit';
  const url = isEdit ? `${API_BASE}/${encodeURIComponent(state.activeWeek)}` : API_BASE;
  const method = isEdit ? 'PUT' : 'POST';

  try {
    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر حفظ البطاقة.');
    }

    closeModal();
    showToast('نجاح', isEdit ? 'تم تحديث البطاقة.' : 'تمت إضافة البطاقة.', 'success');
    await fetchCards();
  } catch (error) {
    showToast('خطأ', error.message || 'تعذر حفظ البطاقة.', 'error');
  }
}

function handleEdit(week) {
  const card = state.cards.find((item) => normalizeDigits(item.week) === normalizeDigits(week));
  if (!card) return;
  openModal('edit', card);
}

function handleDelete(week) {
  openConfirmModal({
    title: 'تأكيد الحذف',
    message: 'هل أنت متأكد من حذف البطاقة؟',
    onConfirm: async () => {
      const response = await fetch(`${API_BASE}/${encodeURIComponent(week)}`, {
        method: 'DELETE'
      });
      const data = await response.json();
      if (!response.ok || !data.ok) {
        throw new Error(data?.error || 'تعذر حذف البطاقة.');
      }
      showToast('نجاح', 'تم حذف البطاقة.', 'success');
      await fetchCards();
    }
  });
}

function handleBulkDelete() {
  const selected = getSelectedWeeks();
  if (!selected.length) return;

  openConfirmModal({
    title: 'تأكيد الحذف',
    message: `هل أنت متأكد من حذف البطاقات المحددة؟ (${selected.length})`,
    onConfirm: async () => {
      const results = await Promise.all(
        selected.map((week) =>
          fetch(`${API_BASE}/${encodeURIComponent(week)}`, { method: 'DELETE' })
            .then((response) => response.json().then((data) => ({ response, data })))
        )
      );

      const failed = results.filter(({ response, data }) => !response.ok || !data.ok);
      if (failed.length) {
        throw new Error('تعذر حذف بعض البطاقات.');
      }

      showToast('نجاح', 'تم حذف البطاقات المحددة.', 'success');
      await fetchCards();
    }
  });
}

function handleTableClick(event) {
  const button = event.target.closest('button[data-action]');
  if (!button) return;
  const action = button.dataset.action;
  const week = button.dataset.week;
  if (!week) return;
  if (action === 'edit') {
    handleEdit(week);
  }
  if (action === 'delete') {
    handleDelete(week);
  }
  if (action === 'content') {
    window.open(`/mng/card-editor.html?week=${encodeURIComponent(week)}`, '_blank');
  }
  if (action === 'completions') {
    const card = state.cards.find((item) => normalizeDigits(item.week) === normalizeDigits(week));
    if (card) openCompletionsModal(card);
  }
}

function handleTableChange(event) {
  if (event.target?.classList.contains('row-check')) {
    updateBulkDeleteState();
  }
}

function handleSelectAllChange() {
  const shouldSelect = elements.selectAll.checked;
  elements.body.querySelectorAll('.row-check').forEach((checkbox) => {
    checkbox.checked = shouldSelect;
  });
  updateBulkDeleteState();
}

function handleSearch() {
  fetchCards();
}

function handleSearchInput() {
  if (searchTimeout) window.clearTimeout(searchTimeout);
  searchTimeout = window.setTimeout(() => {
    handleSearch();
  }, 350);
}

function handleGradeFilterChange() {
  const grade = normalizeDigits(elements.gradeFilter.value);
  setClassFilterEnabled(Boolean(grade));
  fetchCards();
}

function handleClassFilterChange() {
  fetchCards();
}

function handleAllClassesToggle() {
  setClassesDisabled(elements.allClassesToggle.checked);
}

function handleBackdropClick(event) {
  if (event.target.dataset?.close) {
    closeModal();
  }
}

function handleConfirmBackdropClick(event) {
  if (event.target.dataset?.close) {
    closeConfirmModal();
  }
}

function handleCompletionsBackdropClick(event) {
  if (event.target.dataset?.close) {
    closeCompletionsModal();
  }
}

function bindEvents() {
  elements.addButton.addEventListener('click', () => openModal('add'));
  elements.modalClose.addEventListener('click', closeModal);
  elements.modalCancel.addEventListener('click', closeModal);
  elements.modal.addEventListener('click', handleBackdropClick);
  elements.form.addEventListener('submit', handleSubmit);
  elements.body.addEventListener('click', handleTableClick);
  elements.body.addEventListener('change', handleTableChange);
  elements.selectAll.addEventListener('change', handleSelectAllChange);
  elements.deleteSelectedButton.addEventListener('click', handleBulkDelete);
  elements.exportButton.addEventListener('click', handleExportCards);
  elements.searchButton.addEventListener('click', handleSearch);
  elements.searchInput.addEventListener('input', handleSearchInput);
  elements.gradeFilter.addEventListener('change', handleGradeFilterChange);
  elements.classFilter.addEventListener('change', handleClassFilterChange);
  elements.gradeInput.addEventListener('change', () => {
    updatePrereqOptions(normalizeDigits(elements.gradeInput.value), state.activeWeek, null);
  });
  elements.allClassesToggle.addEventListener('change', handleAllClassesToggle);
  elements.confirmClose.addEventListener('click', closeConfirmModal);
  elements.confirmCancel.addEventListener('click', closeConfirmModal);
  elements.confirmModal.addEventListener('click', handleConfirmBackdropClick);
  elements.confirmSubmit.addEventListener('click', handleConfirmSubmit);
  elements.completionsClose.addEventListener('click', closeCompletionsModal);
  elements.completionsModal.addEventListener('click', handleCompletionsBackdropClick);
}

function init() {
  buildClassOptions();
  setClassFilterEnabled(false);
  bindEvents();
  fetchCards();
}

init();
math/public/assets/js/mng/studentsManager.js
import { showToast } from '../ui/toast.js';

const API_BASE = '/api/mng/students';

const elements = {
  body: document.getElementById('studentsBody'),
  addButton: document.getElementById('btnAddStudent'),
  deleteSelectedButton: document.getElementById('btnDeleteSelected'),
  exportButton: document.getElementById('btnExportStudents'),
  searchInput: document.getElementById('searchInput'),
  searchButton: document.getElementById('btnSearch'),
  gradeFilter: document.getElementById('gradeFilter'),
  classFilter: document.getElementById('classFilter'),
  pagination: document.getElementById('studentsPagination'),
  selectAll: document.getElementById('selectAllStudents'),
  modal: document.getElementById('studentModal'),
  modalTitle: document.getElementById('modalTitle'),
  modalClose: document.getElementById('btnCloseModal'),
  modalCancel: document.getElementById('btnCancel'),
  form: document.getElementById('studentForm'),
  submitButton: document.getElementById('btnSubmit'),
  studentIdInput: document.getElementById('studentIdInput'),
  wheelYear: document.getElementById('wheelYear'),
  wheelMonth: document.getElementById('wheelMonth'),
  wheelDay: document.getElementById('wheelDay'),
  nameInput: document.getElementById('nameInput'),
  firstNameInput: document.getElementById('firstNameInput'),
  wheelGrade: document.getElementById('wheelGrade'),
  classInput: document.getElementById('classInput'),
  confirmModal: document.getElementById('confirmModal'),
  confirmTitle: document.getElementById('confirmTitle'),
  confirmMessage: document.getElementById('confirmMessage'),
  confirmClose: document.getElementById('btnCloseConfirm'),
  confirmCancel: document.getElementById('btnCancelDelete'),
  confirmSubmit: document.getElementById('btnConfirmDelete'),
  importButton: document.getElementById('btnImportStudents'),
  importModal: document.getElementById('importModal'),
  importClose: document.getElementById('btnCloseImport'),
  importCancel: document.getElementById('btnCancelImport'),
  importFile: document.getElementById('importFile'),
  importHasHeader: document.getElementById('importHasHeader'),
  importPreviewHead: document.getElementById('importPreviewHead'),
  importPreviewBody: document.getElementById('importPreviewBody'),
  mapStudentId: document.getElementById('mapStudentId'),
  mapName: document.getElementById('mapName'),
  mapBirthDate: document.getElementById('mapBirthDate'),
  mapGrade: document.getElementById('mapGrade'),
  mapClass: document.getElementById('mapClass'),
  importValidate: document.getElementById('btnImportValidate'),
  importExecute: document.getElementById('btnImportExecute'),
  importProgressBar: document.getElementById('importProgressBar'),
  importProgressLabel: document.getElementById('importProgressLabel'),
  importProgressTrack: document.querySelector('.progress-track'),
  importSummary: document.getElementById('importSummary'),
  downloadSkipped: document.getElementById('btnDownloadSkipped'),
  downloadErrors: document.getElementById('btnDownloadErrors'),
  importTeacherNote: document.getElementById('importTeacherNote')
};

const state = {
  students: [],
  mode: 'add',
  currentPage: 1,
  pageSize: 10
};

let searchTimeout = null;
let firstNameTouched = false;
let confirmAction = null;
let confirmBusy = false;
let importBusy = false;

const importState = {
  rows: [],
  hasHeader: true,
  headers: [],
  columnLabels: [],
  validated: false,
  existingSet: null,
  results: {
    toAdd: [],
    skipped: [],
    invalid: []
  }
};

const gradeLabels = {
  '1': 'الأول',
  '2': 'الثاني',
  '3': 'الثالث',
  '4': 'الرابع',
  '5': 'الخامس',
  '6': 'السادس',
  '7': 'السابع',
  '8': 'الثامن',
  '9': 'التاسع'
};

function setLoading(message) {
  elements.body.innerHTML = `
    <tr>
      <td colspan="7" class="muted center">${message}</td>
    </tr>
  `;
}

function normalizeValue(value) {
  return value == null ? '' : String(value).trim();
}

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };
  return normalizeValue(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

function normalizeGrade(value) {
  const normalized = normalizeDigits(value);
  const trimmed = normalizeValue(normalized);
  if (!trimmed) return '';
  if (/^[1-9]$/.test(trimmed)) return trimmed;

  let text = trimmed.replace(/\s+/g, '');
  text = text.replace(/^الصف/, '').replace(/^صف/, '').replace(/^ال/, '');
  text = text.replace(/[أإآ]/g, 'ا');

  const gradeMap = {
    اول: '1',
    ثاني: '2',
    ثالث: '3',
    رابع: '4',
    خامس: '5',
    سادس: '6',
    سابع: '7',
    ثامن: '8',
    تاسع: '9'
  };

  return gradeMap[text] || trimmed;
}

function toNumber(value) {
  return Number.parseInt(value, 10);
}

function deriveFirstNameFromName(name) {
  const parts = normalizeValue(name).split(/\s+/).filter(Boolean);
  if (!parts.length) return '';
  if (parts[0] === 'عبد' && parts[1]) {
    return `عبد ${parts[1]}`;
  }
  return parts[0];
}

function padTwo(value) {
  return String(value).padStart(2, '0');
}

function formatIsoDate(year, month, day) {
  if (!year || !month || !day) return '';
  return `${year}-${padTwo(month)}-${padTwo(day)}`;
}

function excelSerialToDate(serial) {
  const excelEpoch = Date.UTC(1899, 11, 30);
  const utc = excelEpoch + Number(serial) * 86400000;
  return new Date(utc);
}

function parseBirthDate(value) {
  if (value == null || value === '') {
    return { iso: '', error: 'تاريخ الميلاد مطلوب.' };
  }

  if (value instanceof Date && !Number.isNaN(value.getTime())) {
    const year = value.getUTCFullYear();
    const month = value.getUTCMonth() + 1;
    const day = value.getUTCDate();
    return { iso: formatIsoDate(year, month, day), error: '' };
  }

  const normalized = normalizeDigits(value);
  const numeric = Number(normalized);
  if (!Number.isNaN(numeric) && Number.isFinite(numeric) && String(normalized).trim() !== '') {
    const date = excelSerialToDate(numeric);
    if (!Number.isNaN(date.getTime())) {
      return {
        iso: formatIsoDate(date.getUTCFullYear(), date.getUTCMonth() + 1, date.getUTCDate()),
        error: ''
      };
    }
  }

  const text = normalizeDigits(value).replace(/\s+/g, '');
  let match = text.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (match) {
    const [, year, month, day] = match;
    const date = new Date(Number(year), Number(month) - 1, Number(day));
    if (
      date.getFullYear() === Number(year) &&
      date.getMonth() === Number(month) - 1 &&
      date.getDate() === Number(day)
    ) {
      return { iso: formatIsoDate(year, month, day), error: '' };
    }
  }

  match = text.match(/^(\d{2})[/-](\d{2})[/-](\d{4})$/);
  if (match) {
    const [, day, month, year] = match;
    const date = new Date(Number(year), Number(month) - 1, Number(day));
    if (
      date.getFullYear() === Number(year) &&
      date.getMonth() === Number(month) - 1 &&
      date.getDate() === Number(day)
    ) {
      return { iso: formatIsoDate(year, month, day), error: '' };
    }
  }

  return { iso: '', error: 'تاريخ الميلاد غير صالح.' };
}

function toColumnLabel(index) {
  let label = '';
  let current = index;
  while (current >= 0) {
    label = String.fromCharCode((current % 26) + 65) + label;
    current = Math.floor(current / 26) - 1;
  }
  return label;
}

function getImportColumns() {
  return [elements.mapStudentId, elements.mapName, elements.mapBirthDate, elements.mapGrade, elements.mapClass];
}

function resetImportState() {
  importState.rows = [];
  importState.headers = [];
  importState.columnLabels = [];
  importState.validated = false;
  importState.results = { toAdd: [], skipped: [], invalid: [] };
  elements.importFile.value = '';
  elements.importHasHeader.checked = true;
  elements.importPreviewHead.innerHTML = '';
  elements.importPreviewBody.innerHTML = `
    <tr>
      <td class="muted center">اختر ملفًا لعرض المعاينة.</td>
    </tr>
  `;
  getImportColumns().forEach((select) => {
    if (select) select.innerHTML = '';
  });
  updateImportResultsSummary('لم يتم تنفيذ أي عملية بعد.');
  updateImportProgress(0);
  elements.importExecute.disabled = true;
  elements.downloadSkipped.disabled = true;
  elements.downloadErrors.disabled = true;
  elements.importTeacherNote.value = '';
  importState.hasHeader = true;
}

function updateImportProgress(percent) {
  const safePercent = Math.max(0, Math.min(100, percent));
  elements.importProgressBar.style.width = `${safePercent}%`;
  elements.importProgressLabel.textContent = `${safePercent}%`;
  if (elements.importProgressTrack) {
    elements.importProgressTrack.setAttribute('aria-valuenow', String(safePercent));
  }
}

function updateImportResultsSummary(text) {
  elements.importSummary.textContent = text;
}

function openImportModal() {
  resetImportState();
  elements.importModal.classList.remove('hidden');
  elements.importModal.setAttribute('aria-hidden', 'false');
  window.setTimeout(() => {
    elements.importFile?.focus();
  }, 0);
}

function closeImportModal() {
  if (importBusy) return;
  elements.importModal.classList.add('hidden');
  elements.importModal.setAttribute('aria-hidden', 'true');
}

function buildWheelItems(wheel, items) {
  wheel.innerHTML = '';
  const fragment = document.createDocumentFragment();
  items.forEach((item) => {
    const div = document.createElement('div');
    div.className = 'wheel-item';
    div.textContent = item.label;
    div.dataset.value = item.value;
    fragment.appendChild(div);
  });
  wheel.appendChild(fragment);
}

function getWheelItems(wheel) {
  return Array.from(wheel.querySelectorAll('.wheel-item'));
}

function getWheelSelectedItem(wheel) {
  const items = getWheelItems(wheel);
  if (!items.length) return null;
  const wheelRect = wheel.getBoundingClientRect();
  const center = wheelRect.top + wheelRect.height / 2;
  let closest = items[0];
  let closestDistance = Infinity;
  items.forEach((item) => {
    const rect = item.getBoundingClientRect();
    const distance = Math.abs(rect.top + rect.height / 2 - center);
    if (distance < closestDistance) {
      closest = item;
      closestDistance = distance;
    }
  });
  return closest;
}

function setWheelSelectedItem(wheel, targetItem, smooth = true) {
  if (!targetItem) return;
  getWheelItems(wheel).forEach((item) => item.classList.remove('is-selected'));
  targetItem.classList.add('is-selected');
  const wheelRect = wheel.getBoundingClientRect();
  const itemRect = targetItem.getBoundingClientRect();
  const offset = itemRect.top - wheelRect.top + wheel.scrollTop;
  const targetScroll = offset - (wheelRect.height / 2 - itemRect.height / 2);
  wheel.scrollTo({ top: targetScroll, behavior: smooth ? 'smooth' : 'auto' });
}

function selectWheelValue(wheel, value, smooth = false) {
  const items = getWheelItems(wheel);
  if (!items.length) return;
  const match = items.find((item) => item.dataset.value === String(value));
  setWheelSelectedItem(wheel, match || items[0], smooth);
}

function getWheelValue(wheel) {
  const selected = getWheelSelectedItem(wheel);
  return selected?.dataset.value ?? '';
}

function attachWheelHandler(wheel, onChange) {
  let timeout = null;
  wheel.addEventListener('scroll', () => {
    if (timeout) window.clearTimeout(timeout);
    timeout = window.setTimeout(() => {
      const selected = getWheelSelectedItem(wheel);
      setWheelSelectedItem(wheel, selected, true);
      if (onChange) onChange(selected?.dataset.value ?? '');
    }, 120);
  });
}

function buildBirthYearWheel() {
  const currentYear = new Date().getFullYear();
  const startYear = 1980;
  const years = [];
  for (let year = currentYear; year >= startYear; year -= 1) {
    years.push({ value: year, label: year });
  }
  buildWheelItems(elements.wheelYear, years);
}

function buildBirthMonthWheel() {
  const months = [
    { value: 1, label: 'يناير' },
    { value: 2, label: 'فبراير' },
    { value: 3, label: 'مارس' },
    { value: 4, label: 'أبريل' },
    { value: 5, label: 'مايو' },
    { value: 6, label: 'يونيو' },
    { value: 7, label: 'يوليو' },
    { value: 8, label: 'أغسطس' },
    { value: 9, label: 'سبتمبر' },
    { value: 10, label: 'أكتوبر' },
    { value: 11, label: 'نوفمبر' },
    { value: 12, label: 'ديسمبر' }
  ];
  buildWheelItems(elements.wheelMonth, months);
}

function buildBirthDayWheel(year, month, selectedDay) {
  const daysInMonth = new Date(year, month, 0).getDate();
  const days = Array.from({ length: daysInMonth }, (_, index) => {
    const day = index + 1;
    return { value: day, label: padTwo(day) };
  });
  buildWheelItems(elements.wheelDay, days);
  const targetDay = Math.min(selectedDay || 1, daysInMonth);
  selectWheelValue(elements.wheelDay, targetDay);
}

function buildGradeWheel() {
  const items = [
    { value: '', label: 'غير محدد' },
    ...Object.entries(gradeLabels).map(([value, label]) => ({ value, label }))
  ];
  buildWheelItems(elements.wheelGrade, items);
}

function parseDateParts(value) {
  if (!value) return null;
  const match = String(value).match(/(\d{4})-(\d{2})-(\d{2})/);
  if (!match) return null;
  return {
    year: match[1],
    month: String(parseInt(match[2], 10)),
    day: String(parseInt(match[3], 10))
  };
}

function initializeWheels() {
  buildBirthYearWheel();
  buildBirthMonthWheel();
  buildGradeWheel();

  const currentYear = new Date().getFullYear();
  selectWheelValue(elements.wheelYear, currentYear);
  selectWheelValue(elements.wheelMonth, 1);
  buildBirthDayWheel(currentYear, 1, 1);
  selectWheelValue(elements.wheelGrade, '');

  attachWheelHandler(elements.wheelYear, (value) => {
    const year = toNumber(value) || currentYear;
    const month = toNumber(getWheelValue(elements.wheelMonth)) || 1;
    const day = toNumber(getWheelValue(elements.wheelDay)) || 1;
    buildBirthDayWheel(year, month, day);
  });
  attachWheelHandler(elements.wheelMonth, (value) => {
    const year = toNumber(getWheelValue(elements.wheelYear)) || currentYear;
    const month = toNumber(value) || 1;
    const day = toNumber(getWheelValue(elements.wheelDay)) || 1;
    buildBirthDayWheel(year, month, day);
  });
  attachWheelHandler(elements.wheelDay);
  attachWheelHandler(elements.wheelGrade);
}

async function fetchJson(url, options) {
  const response = await fetch(url, options);
  const data = await response.json().catch(() => ({}));
  if (!response.ok) {
    const message = data?.error || data?.message || 'تعذر تنفيذ الطلب.';
    const error = new Error(message);
    error.status = response.status;
    error.data = data;
    throw error;
  }
  return data;
}

async function loadStudents() {
  setLoading('جاري تحميل البيانات...');
  try {
    const data = await fetchJson(API_BASE);
    const list = Array.isArray(data) ? data : data.students || [];
    state.students = list;
    updateClassFilterOptions(elements.gradeFilter.value);
    applyFilters({ resetPage: true });
  } catch (error) {
    setLoading('تعذر تحميل البيانات.');
    showToast('خطأ', error.message, 'error');
    updateExportButtonState(0);
  }
}

function buildImportHeaders(rows, hasHeader) {
  const maxColumns = rows.reduce((max, row) => Math.max(max, row.length), 0);
  const headerRow = hasHeader ? rows[0] || [] : [];
  const headers = Array.from({ length: maxColumns }, (_, index) => {
    const value = normalizeValue(headerRow[index]);
    return value || toColumnLabel(index);
  });
  return {
    headers,
    dataRows: hasHeader ? rows.slice(1) : rows
  };
}

function renderImportPreview(headers, rows) {
  if (!headers.length) {
    elements.importPreviewHead.innerHTML = '';
  } else {
    const headerCells = headers
      .map((label) => `<th>${escapeHtml(label)}</th>`)
      .join('');
    elements.importPreviewHead.innerHTML = `<tr>${headerCells}</tr>`;
  }

  if (!rows.length) {
    elements.importPreviewBody.innerHTML = `
      <tr>
        <td class="muted center">لا توجد بيانات للعرض.</td>
      </tr>
    `;
    return;
  }

  const previewRows = rows.slice(0, 10).map((row) => {
    const cells = headers.map((_, index) => `<td>${escapeHtml(normalizeValue(row[index]))}</td>`);
    return `<tr>${cells.join('')}</tr>`;
  });
  elements.importPreviewBody.innerHTML = previewRows.join('');
}

function buildMappingOptions(headers) {
  const options = ['<option value="">— اختر العمود —</option>'];
  headers.forEach((label, index) => {
    options.push(`<option value="${index}">${escapeHtml(label)}</option>`);
  });
  return options.join('');
}

function normalizeHeaderLabel(label) {
  return normalizeValue(label).toLowerCase().replace(/\s+/g, '');
}

function guessColumn(headers, keywords) {
  const normalizedHeaders = headers.map((label) => normalizeHeaderLabel(label));
  for (const keyword of keywords) {
    const index = normalizedHeaders.findIndex((label) => label.includes(keyword));
    if (index !== -1) return index;
  }
  return '';
}

function applyMappingDefaults(headers) {
  const studentIdIndex = guessColumn(headers, ['رقمالهوية', 'الهوية', 'studentid', 'id']);
  const nameIndex = guessColumn(headers, ['الاسم', 'name', 'studentname']);
  const birthIndex = guessColumn(headers, ['تاريخالميلاد', 'تاريخ', 'birthdate', 'dob']);
  const gradeIndex = guessColumn(headers, ['الصف', 'grade']);
  const classIndex = guessColumn(headers, ['الشعبة', 'class', 'section']);

  elements.mapStudentId.value = studentIdIndex !== '' ? String(studentIdIndex) : '';
  elements.mapName.value = nameIndex !== '' ? String(nameIndex) : '';
  elements.mapBirthDate.value = birthIndex !== '' ? String(birthIndex) : '';
  elements.mapGrade.value = gradeIndex !== '' ? String(gradeIndex) : '';
  elements.mapClass.value = classIndex !== '' ? String(classIndex) : '';
}

function refreshImportMapping() {
  const options = buildMappingOptions(importState.headers);
  getImportColumns().forEach((select) => {
    if (select) select.innerHTML = options;
  });
  applyMappingDefaults(importState.headers);
}

async function handleImportFileChange() {
  const file = elements.importFile.files?.[0];
  if (!file) return;
  if (!window.XLSX) {
    showToast('خطأ', 'تعذر تحميل مكتبة قراءة Excel.', 'error');
    return;
  }

  try {
    const arrayBuffer = await file.arrayBuffer();
    const workbook = window.XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    if (!sheet) {
      showToast('تنبيه', 'تعذر قراءة الملف المحدد.', 'warning');
      return;
    }

    const rows = window.XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: '' });
    importState.rows = rows;
    importState.hasHeader = elements.importHasHeader.checked;
    const { headers, dataRows } = buildImportHeaders(rows, importState.hasHeader);
    importState.headers = headers;
    importState.columnLabels = headers;
    renderImportPreview(headers, dataRows);
    refreshImportMapping();
    importState.validated = false;
    elements.importExecute.disabled = true;
    updateImportResultsSummary('تم تحميل الملف. يرجى تعيين الأعمدة ثم الضغط على "تحقق".');
  } catch (error) {
    showToast('خطأ', 'تعذر قراءة الملف. يرجى التأكد من صحة الملف.', 'error');
  }
}

function handleImportHeaderToggle() {
  if (!importState.rows.length) return;
  importState.hasHeader = elements.importHasHeader.checked;
  const { headers, dataRows } = buildImportHeaders(importState.rows, importState.hasHeader);
  importState.headers = headers;
  renderImportPreview(headers, dataRows);
  refreshImportMapping();
  importState.validated = false;
  elements.importExecute.disabled = true;
  updateImportResultsSummary('تم تحديث المعاينة. يرجى الضغط على "تحقق" مرة أخرى.');
}

function buildCsvContent(headers, rows) {
  const escapeCsv = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
  const lines = [headers.map(escapeCsv).join(',')];
  rows.forEach((row) => {
    lines.push(headers.map((header) => escapeCsv(row[header])).join(','));
  });
  return `\ufeff${lines.join('\n')}`;
}

function downloadCsv(filename, headers, rows) {
  const content = buildCsvContent(headers, rows);
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function buildImportRows() {
  const mapping = {
    studentId: elements.mapStudentId.value,
    name: elements.mapName.value,
    birthDate: elements.mapBirthDate.value,
    grade: elements.mapGrade.value,
    className: elements.mapClass.value
  };

  if (!mapping.studentId || !mapping.name || !mapping.birthDate) {
    showToast('تنبيه', 'يرجى تعيين الأعمدة الإلزامية قبل التحقق.', 'warning');
    return null;
  }

  const dataRows = importState.hasHeader ? importState.rows.slice(1) : importState.rows;
  const rows = [];

  dataRows.forEach((row, index) => {
    const values = Array.isArray(row) ? row : [];
    const rowNumber = importState.hasHeader ? index + 2 : index + 1;
    const allValues = values.map((cell) => normalizeValue(cell)).filter(Boolean);
    if (!allValues.length) return;

    const studentIdRaw = values[Number(mapping.studentId)];
    const nameRaw = values[Number(mapping.name)];
    const birthRaw = values[Number(mapping.birthDate)];
    const gradeRaw = mapping.grade ? values[Number(mapping.grade)] : '';
    const classRaw = mapping.className ? values[Number(mapping.className)] : '';

    const studentId = normalizeDigits(studentIdRaw);
    const name = normalizeValue(nameRaw);
    const { iso: birthDate, error: birthError } = parseBirthDate(birthRaw);
    const grade = normalizeGrade(gradeRaw);
    const className = normalizeDigits(classRaw);

    rows.push({
      rowNumber,
      studentId,
      name,
      birthDate,
      grade,
      className,
      birthError
    });
  });

  return rows;
}

async function handleImportValidate() {
  if (!importState.rows.length) {
    showToast('تنبيه', 'يرجى اختيار ملف أولًا.', 'warning');
    return;
  }

  const rows = buildImportRows();
  if (!rows) return;

  if (!importState.existingSet) {
    try {
      const data = await fetchJson(API_BASE);
      const list = Array.isArray(data) ? data : data.students || [];
      importState.existingSet = new Set(
        list.map((student) => normalizeDigits(student.StudentId || student.studentId))
      );
    } catch (error) {
      showToast('خطأ', 'تعذر التحقق من قائمة الطلاب الحالية.', 'error');
      return;
    }
  }

  const results = { toAdd: [], skipped: [], invalid: [] };
  rows.forEach((row) => {
    const errors = [];
    if (!row.studentId) {
      errors.push('رقم الهوية مفقود.');
    }
    if (!row.name) {
      errors.push('الاسم مفقود.');
    }
    if (!row.birthDate) {
      errors.push(row.birthError || 'تاريخ الميلاد مفقود.');
    }

    if (errors.length) {
      results.invalid.push({
        ...row,
        error: errors.join(' ')
      });
      return;
    }

    if (importState.existingSet?.has(row.studentId)) {
      results.skipped.push({
        ...row,
        reason: 'لم تتم إضافة هذا الطالب لأنه موجود مسبقًا في النظام.'
      });
      return;
    }

    const [birthYear, birthMonth, birthDay] = row.birthDate.split('-');
    results.toAdd.push({
      studentId: row.studentId,
      name: row.name,
      birthDate: row.birthDate,
      birthYear,
      birthMonth,
      birthDay,
      grade: row.grade,
      class: row.className,
      firstName: deriveFirstNameFromName(row.name),
      rowNumber: row.rowNumber
    });
  });

  importState.results = results;
  importState.validated = true;
  elements.importExecute.disabled = results.toAdd.length === 0;
  updateImportResultsSummary(
    `تم التحقق من الملف.\nالمرشّح للإضافة: ${results.toAdd.length} طالبًا.\n` +
      `المتخطّون (موجودون مسبقًا): ${results.skipped.length} طالبًا.\n` +
      `الصفوف ذات الأخطاء: ${results.invalid.length} صفًا.`
  );
}

async function handleImportExecute() {
  if (!importState.validated) {
    showToast('تنبيه', 'يرجى تنفيذ التحقق أولًا.', 'warning');
    return;
  }

  if (!importState.results.toAdd.length) {
    showToast('تنبيه', 'لا توجد بيانات جديدة للإضافة.', 'warning');
    return;
  }

  importBusy = true;
  elements.importExecute.disabled = true;
  elements.importValidate.disabled = true;

  const batchSize = 30;
  const total = importState.results.toAdd.length;
  let completed = 0;
  let added = 0;
  const skipped = [...importState.results.skipped];
  const invalid = [...importState.results.invalid];

  for (let i = 0; i < total; i += batchSize) {
    const batch = importState.results.toAdd.slice(i, i + batchSize);
    const results = await Promise.allSettled(
      batch.map((student) =>
        fetchJson(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            studentId: student.studentId,
            birthYear: student.birthYear,
            birthMonth: student.birthMonth,
            birthDay: student.birthDay,
            name: student.name,
            firstName: student.firstName,
            birthDate: student.birthDate,
            grade: student.grade,
            class: student.class
          })
        })
      )
    );

    results.forEach((result, index) => {
      const student = batch[index];
      if (result.status === 'fulfilled') {
        added += 1;
        return;
      }

      const error = result.reason;
      const message = normalizeValue(error?.message || error?.data?.message || '');
      const isExisting =
        error?.status === 409 ||
        message.includes('موجود') ||
        message.toLowerCase().includes('exists');

      if (isExisting) {
        skipped.push({
          studentId: student.studentId,
          name: student.name,
          birthDate: student.birthDate,
          grade: student.grade,
          className: student.class,
          reason: 'لم تتم إضافة هذا الطالب لأنه موجود مسبقًا في النظام.'
        });
      } else {
        invalid.push({
          rowNumber: student.rowNumber,
          studentId: student.studentId,
          name: student.name,
          birthDate: student.birthDate,
          grade: student.grade,
          className: student.class,
          error: message || 'تعذر إضافة الطالب بسبب خطأ غير معروف.'
        });
      }
    });

    completed += batch.length;
    const percent = Math.round((completed / total) * 100);
    updateImportProgress(percent);
  }

  const summaryText = [
    `تمّت إضافة (${added}) طالبًا بنجاح.`,
    `لم تتم إضافة (${skipped.length}) طالبًا لأنهم موجودون مسبقًا في النظام.`,
    `تعذّرت معالجة (${invalid.length}) صفوف بسبب أخطاء في البيانات.`
  ].join('\n');

  updateImportResultsSummary(summaryText);
  elements.importTeacherNote.value = summaryText;
  elements.downloadSkipped.disabled = skipped.length === 0;
  elements.downloadErrors.disabled = invalid.length === 0;
  importState.results = { toAdd: [], skipped, invalid };
  importBusy = false;
  elements.importValidate.disabled = false;
  elements.importExecute.disabled = true;
  showToast('اكتمل الاستيراد', 'تمت معالجة ملف الاستيراد.', 'success');
  loadStudents();
}

function handleDownloadSkipped() {
  const skipped = importState.results.skipped || [];
  if (!skipped.length) return;
  downloadCsv(
    'report-skipped.csv',
    ['StudentId', 'Name', 'BirthDate', 'Grade', 'Class', 'Reason'],
    skipped.map((row) => ({
      StudentId: row.studentId,
      Name: row.name,
      BirthDate: row.birthDate,
      Grade: row.grade,
      Class: row.className,
      Reason: row.reason
    }))
  );
}

function handleDownloadErrors() {
  const invalid = importState.results.invalid || [];
  if (!invalid.length) return;
  downloadCsv(
    'report-errors.csv',
    ['RowNumber', 'StudentId', 'Name', 'BirthDate', 'Grade', 'Class', 'Error'],
    invalid.map((row) => ({
      RowNumber: row.rowNumber,
      StudentId: row.studentId,
      Name: row.name,
      BirthDate: row.birthDate,
      Grade: row.grade,
      Class: row.className,
      Error: row.error
    }))
  );
}

function renderStudents(list) {
  if (!list.length) {
    setLoading('لا توجد نتائج حالياً.');
    return;
  }

  elements.body.innerHTML = list
    .map((student) => {
      const studentId = normalizeDigits(student.StudentId || student.studentId);
      const birthYear = normalizeDigits(student.BirthYear || student.birthYear);
      const name = normalizeValue(student.Name || student.name);
      const grade = normalizeGrade(student.Grade || student.grade);
      const className = normalizeDigits(student.Class || student.class);
      const gradeLabel = gradeLabels[grade] || grade;

      return `
        <tr>
          <td class="select-cell">
            <input class="row-check" type="checkbox" data-id="${escapeHtml(studentId)}" aria-label="تحديد الطالب" />
          </td>
          <td class="ltr">${escapeHtml(studentId)}</td>
          <td class="ltr">${escapeHtml(birthYear)}</td>
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(gradeLabel)}</td>
          <td>${escapeHtml(className)}</td>
          <td class="actions">
            <button class="btn btn-outline btn-sm icon-btn" data-action="edit" data-id="${escapeHtml(studentId)}" title="تعديل" aria-label="تعديل">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M3 17.25V21h3.75l11-11-3.75-3.75-11 11zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="delete" data-id="${escapeHtml(studentId)}" title="حذف" aria-label="حذف">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 13.41l-6.29 6.3-1.42-1.42L10.59 12 4.29 5.71 5.7 4.29 12 10.59l6.29-6.3z"/>
              </svg>
            </button>
          </td>
        </tr>
      `;
    })
    .join('');
}

function openModal(mode, student = {}) {
  state.mode = mode;
  const isEdit = mode === 'edit';
  firstNameTouched = false;

  elements.modalTitle.textContent = isEdit ? 'تعديل بيانات الطالب' : 'إضافة طالب';
  elements.submitButton.textContent = isEdit ? 'حفظ التعديلات' : 'إضافة الطالب';

  elements.modal.classList.remove('hidden');
  elements.modal.setAttribute('aria-hidden', 'false');

  elements.studentIdInput.value = normalizeValue(student.StudentId || student.studentId);
  elements.nameInput.value = normalizeValue(student.Name || student.name);
  elements.firstNameInput.value = normalizeValue(student.FirstName || student.firstName);
  elements.classInput.value = normalizeValue(student.Class || student.class);

  const birthDateParts = parseDateParts(student.BirthDate || student.birthDate);
  const fallbackBirthYear = normalizeValue(student.BirthYear || student.birthYear);
  const yearValue = birthDateParts?.year || fallbackBirthYear || String(new Date().getFullYear());
  const monthValue = birthDateParts?.month || '1';
  const dayValue = birthDateParts?.day || '1';
  selectWheelValue(elements.wheelYear, yearValue);
  selectWheelValue(elements.wheelMonth, monthValue);
  buildBirthDayWheel(toNumber(yearValue), toNumber(monthValue), toNumber(dayValue));

  const gradeValue = normalizeGrade(student.Grade || student.grade);
  selectWheelValue(elements.wheelGrade, gradeValue);

  elements.studentIdInput.disabled = isEdit;
}

function closeModal() {
  elements.form.reset();
  const currentYear = new Date().getFullYear();
  selectWheelValue(elements.wheelYear, currentYear);
  selectWheelValue(elements.wheelMonth, 1);
  buildBirthDayWheel(currentYear, 1, 1);
  selectWheelValue(elements.wheelGrade, '');
  elements.studentIdInput.disabled = false;
  firstNameTouched = false;
  elements.modal.classList.add('hidden');
  elements.modal.setAttribute('aria-hidden', 'true');
}

function findStudentById(studentId) {
  return state.students.find((student) =>
    normalizeValue(student.StudentId || student.studentId) === studentId
  );
}

async function handleSubmit(event) {
  event.preventDefault();

  const payload = {
    studentId: normalizeValue(elements.studentIdInput.value),
    birthYear: normalizeValue(getWheelValue(elements.wheelYear)),
    birthMonth: normalizeValue(getWheelValue(elements.wheelMonth)),
    birthDay: normalizeValue(getWheelValue(elements.wheelDay)),
    name: normalizeValue(elements.nameInput.value),
    firstName: normalizeValue(elements.firstNameInput.value),
    grade: normalizeValue(getWheelValue(elements.wheelGrade)),
    class: normalizeValue(elements.classInput.value)
  };

  if (!payload.studentId || !payload.birthYear || !payload.name) {
    showToast('تنبيه', 'يرجى تعبئة الحقول المطلوبة.', 'warning');
    return;
  }

  if (!payload.birthMonth || !payload.birthDay) {
    showToast('تنبيه', 'يرجى اختيار تاريخ الميلاد بالكامل.', 'warning');
    return;
  }

  const birthDate = `${payload.birthYear}-${padTwo(payload.birthMonth)}-${padTwo(payload.birthDay)}`;

  try {
    if (state.mode === 'add') {
      await fetchJson(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          studentId: payload.studentId,
          birthYear: payload.birthYear,
          name: payload.name,
          firstName: payload.firstName,
          birthDate,
          grade: payload.grade,
          class: payload.class
        })
      });
      showToast('تمت الإضافة', 'تم إضافة الطالب بنجاح.', 'success');
    } else {
      await fetchJson(`${API_BASE}/${encodeURIComponent(payload.studentId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          birthYear: payload.birthYear,
          name: payload.name,
          firstName: payload.firstName,
          birthDate,
          grade: payload.grade,
          class: payload.class
        })
      });
      showToast('تم التعديل', 'تم تحديث بيانات الطالب.', 'success');
    }

    closeModal();
    loadStudents();
  } catch (error) {
    showToast('خطأ', error.message, 'error');
  }
}

function handleNameBlur() {
  const nameValue = normalizeValue(elements.nameInput.value);
  const firstNameValue = normalizeValue(elements.firstNameInput.value);
  if (!nameValue) return;
  if (!firstNameValue || !firstNameTouched) {
    elements.firstNameInput.value = deriveFirstNameFromName(nameValue);
    firstNameTouched = false;
  }
}

function handleFirstNameInput() {
  firstNameTouched = true;
}

function getSelectedStudentIds() {
  return Array.from(elements.body.querySelectorAll('.row-check:checked'))
    .map((checkbox) => checkbox.dataset.id)
    .filter(Boolean);
}

function updateBulkDeleteState() {
  const selected = getSelectedStudentIds();
  elements.deleteSelectedButton.disabled = selected.length === 0;
  elements.deleteSelectedButton.textContent = selected.length
    ? `حذف المحدد (${selected.length})`
    : 'حذف المحدد';
  if (elements.selectAll) {
    const total = elements.body.querySelectorAll('.row-check').length;
    elements.selectAll.checked = total > 0 && selected.length === total;
    elements.selectAll.indeterminate = selected.length > 0 && selected.length < total;
  }
}

function updateExportButtonState(total) {
  if (!elements.exportButton) return;
  elements.exportButton.disabled = total === 0;
}

function buildExportFileName() {
  const rawGrade = normalizeGrade(elements.gradeFilter.value);
  const rawClass = normalizeDigits(elements.classFilter.value);
  const toSafePart = (value) => {
    const text = normalizeValue(value);
    return text ? text.replace(/\s+/g, '-') : 'all';
  };
  const gradePart = toSafePart(rawGrade);
  const classPart = toSafePart(rawClass);
  return `students_grade-${gradePart}_class-${classPart}.xlsx`;
}

function handleExportStudents() {
  const filtered = getFilteredStudents();
  if (!filtered.length) {
    updateExportButtonState(0);
    showToast('تنبيه', 'لا توجد نتائج للتصدير.', 'warning');
    return;
  }

  if (!window.XLSX) {
    showToast('خطأ', 'تعذر تحميل مكتبة تصدير Excel.', 'error');
    return;
  }

  const headers = ['StudentId', 'BirthYear', 'Name', 'FirstName', 'Grade', 'Class', 'BirthDate'];
  const rows = filtered.map((student) => {
    const studentId = normalizeDigits(student.StudentId || student.studentId);
    const birthYear = normalizeDigits(student.BirthYear || student.birthYear);
    const name = normalizeValue(student.Name || student.name);
    const firstName = normalizeValue(student.FirstName || student.firstName);
    const grade = normalizeGrade(student.Grade || student.grade);
    const className = normalizeDigits(student.Class || student.class);
    const birthDate = normalizeValue(student.BirthDate || student.birthDate);

    return [studentId, birthYear, name, firstName, grade, className, birthDate];
  });

  const worksheet = window.XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const workbook = window.XLSX.utils.book_new();
  window.XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
  window.XLSX.writeFile(workbook, buildExportFileName());
}

function openConfirmModal({ title, message, onConfirm }) {
  confirmAction = onConfirm;
  elements.confirmTitle.textContent = title;
  elements.confirmMessage.textContent = message;
  elements.confirmModal.classList.remove('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'false');
}

function closeConfirmModal(force = false) {
  if (confirmBusy && !force) return;
  confirmAction = null;
  elements.confirmModal.classList.add('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'true');
}

async function handleConfirmSubmit() {
  if (!confirmAction || confirmBusy) return;
  confirmBusy = true;
  elements.confirmSubmit.disabled = true;
  try {
    await confirmAction();
    confirmBusy = false;
    closeConfirmModal(true);
  } catch (error) {
    showToast('خطأ', error.message, 'error');
  } finally {
    confirmBusy = false;
    elements.confirmSubmit.disabled = false;
  }
}

async function handleDelete(studentId) {
  openConfirmModal({
    title: 'تأكيد الحذف',
    message: 'هل أنت متأكد من حذف الطالب؟',
    onConfirm: async () => {
      await fetchJson(`${API_BASE}/${encodeURIComponent(studentId)}`, {
        method: 'DELETE'
      });
      showToast('تم الحذف', 'تم حذف الطالب بنجاح.', 'success');
      loadStudents();
    }
  });
}

function handleDeleteSelected() {
  const selected = getSelectedStudentIds();
  if (!selected.length) return;
  openConfirmModal({
    title: 'تأكيد الحذف الجماعي',
    message: `سيتم حذف ${selected.length} طالب/طلاب. هل تريد المتابعة؟`,
    onConfirm: async () => {
      const deletions = await Promise.allSettled(
        selected.map((id) =>
          fetchJson(`${API_BASE}/${encodeURIComponent(id)}`, { method: 'DELETE' })
        )
      );
      const failed = deletions.filter((result) => result.status === 'rejected');
      if (failed.length) {
        throw new Error('حدثت أخطاء أثناء الحذف الجماعي.');
      }
      showToast('تم الحذف', 'تم حذف الطلاب المحددين بنجاح.', 'success');
      loadStudents();
    }
  });
}

function handleTableClick(event) {
  const actionButton = event.target?.closest('[data-action]');
  const action = actionButton?.dataset?.action;
  const studentId = actionButton?.dataset?.id;
  if (!action || !studentId) return;

  if (action === 'edit') {
    const student = findStudentById(studentId);
    if (!student) {
      showToast('تنبيه', 'تعذر العثور على بيانات الطالب.', 'warning');
      return;
    }
    openModal('edit', student);
    return;
  }

  if (action === 'delete') {
    handleDelete(studentId);
  }
}

function handleTableChange(event) {
  if (event.target?.classList.contains('row-check')) {
    updateBulkDeleteState();
  }
}

function handleSelectAllChange() {
  const shouldSelect = elements.selectAll.checked;
  elements.body.querySelectorAll('.row-check').forEach((checkbox) => {
    checkbox.checked = shouldSelect;
  });
  updateBulkDeleteState();
}

function handleSearch() {
  applyFilters({ resetPage: true });
}

function handleSearchInput() {
  if (searchTimeout) window.clearTimeout(searchTimeout);
  searchTimeout = window.setTimeout(() => {
    handleSearch();
  }, 350);
}

function updateClassFilterOptions(gradeValue) {
  if (!elements.classFilter) return;
  const grade = normalizeGrade(gradeValue);
  if (!grade) {
    elements.classFilter.innerHTML = '<option value="">كل الشعب</option>';
    elements.classFilter.value = '';
    elements.classFilter.disabled = true;
    return;
  }

  const classes = new Set();
  state.students.forEach((student) => {
    const studentGrade = normalizeGrade(student.Grade || student.grade);
    if (studentGrade !== grade) return;
    const className = normalizeDigits(student.Class || student.class);
    if (className) classes.add(className);
  });

  const options = ['<option value="">كل الشعب</option>'];
  Array.from(classes)
    .sort((a, b) => a.localeCompare(b, 'ar'))
    .forEach((className) => {
      options.push(`<option value="${escapeHtml(className)}">${escapeHtml(className)}</option>`);
    });

  const currentValue = elements.classFilter.value;
  elements.classFilter.innerHTML = options.join('');
  elements.classFilter.disabled = false;
  elements.classFilter.value = classes.has(currentValue) ? currentValue : '';
}

function getFilteredStudents() {
  const query = normalizeValue(elements.searchInput.value).toLowerCase();
  const gradeFilter = normalizeGrade(elements.gradeFilter.value);
  const classFilter = normalizeDigits(elements.classFilter.value);

  return state.students.filter((student) => {
    const studentId = normalizeDigits(student.StudentId || student.studentId);
    const name = normalizeValue(student.Name || student.name);
    const grade = normalizeGrade(student.Grade || student.grade);
    const className = normalizeDigits(student.Class || student.class);

    if (query) {
      const matchesId = studentId.toLowerCase().includes(query);
      const matchesName = name.toLowerCase().includes(query);
      if (!matchesId && !matchesName) return false;
    }

    if (gradeFilter && grade !== gradeFilter) return false;
    if (classFilter && className !== classFilter) return false;

    return true;
  });
}

function updatePagination(totalPages) {
  if (!elements.pagination) return;
  if (!totalPages || totalPages <= 1) {
    elements.pagination.innerHTML = '';
    return;
  }

  const pageButtons = Array.from({ length: totalPages }, (_, index) => {
    const page = index + 1;
    const isActive = page === state.currentPage;
    return `
      <button class="btn btn-outline btn-sm${isActive ? ' is-active' : ''}" data-page="${page}">
        ${page}
      </button>
    `;
  }).join('');

  elements.pagination.innerHTML = `
    <button class="btn btn-outline btn-sm" data-page="prev" ${state.currentPage === 1 ? 'disabled' : ''}>
      السابق
    </button>
    <div class="pagination-pages">${pageButtons}</div>
    <button class="btn btn-outline btn-sm" data-page="next" ${state.currentPage === totalPages ? 'disabled' : ''}>
      التالي
    </button>
  `;
}

function applyFilters({ resetPage = false } = {}) {
  if (resetPage) {
    state.currentPage = 1;
  }

  const filtered = getFilteredStudents();
  const totalPages = filtered.length ? Math.ceil(filtered.length / state.pageSize) : 0;
  if (totalPages && state.currentPage > totalPages) {
    state.currentPage = totalPages;
  }
  const start = (state.currentPage - 1) * state.pageSize;
  const paginated = filtered.slice(start, start + state.pageSize);
  renderStudents(paginated);
  updatePagination(totalPages);
  updateBulkDeleteState();
  updateExportButtonState(filtered.length);
}

function handleGradeFilterChange() {
  updateClassFilterOptions(elements.gradeFilter.value);
  applyFilters({ resetPage: true });
}

function handleClassFilterChange() {
  applyFilters({ resetPage: true });
}

function handlePaginationClick(event) {
  const button = event.target.closest('[data-page]');
  if (!button || button.disabled) return;
  const pageValue = button.dataset.page;
  const totalPages = Math.ceil(getFilteredStudents().length / state.pageSize);
  if (!totalPages) return;

  if (pageValue === 'prev') {
    state.currentPage = Math.max(1, state.currentPage - 1);
  } else if (pageValue === 'next') {
    state.currentPage = Math.min(totalPages, state.currentPage + 1);
  } else {
    state.currentPage = Number(pageValue) || 1;
  }

  applyFilters();
}

function handleBackdropClick(event) {
  if (event.target?.dataset?.close) {
    if (event.currentTarget === elements.modal) {
      closeModal();
    }
    if (event.currentTarget === elements.confirmModal) {
      closeConfirmModal();
    }
    if (event.currentTarget === elements.importModal) {
      closeImportModal();
    }
  }
}

function handleImportMappingChange() {
  importState.validated = false;
  elements.importExecute.disabled = true;
}

function handleGlobalKeydown(event) {
  if (event.key !== 'Escape') return;
  if (!elements.importModal.classList.contains('hidden')) {
    closeImportModal();
    return;
  }
  if (!elements.modal.classList.contains('hidden')) {
    closeModal();
    return;
  }
  if (!elements.confirmModal.classList.contains('hidden')) {
    closeConfirmModal();
  }
}

function init() {
  initializeWheels();
  elements.addButton.addEventListener('click', () => openModal('add'));
  elements.deleteSelectedButton.addEventListener('click', handleDeleteSelected);
  if (elements.exportButton) {
    elements.exportButton.addEventListener('click', handleExportStudents);
  }
  elements.searchButton.addEventListener('click', handleSearch);
  elements.searchInput.addEventListener('input', handleSearchInput);
  elements.gradeFilter.addEventListener('change', handleGradeFilterChange);
  elements.classFilter.addEventListener('change', handleClassFilterChange);
  elements.pagination.addEventListener('click', handlePaginationClick);
  elements.body.addEventListener('click', handleTableClick);
  elements.body.addEventListener('change', handleTableChange);
  elements.form.addEventListener('submit', handleSubmit);
  elements.modalClose.addEventListener('click', closeModal);
  elements.modalCancel.addEventListener('click', closeModal);
  elements.modal.addEventListener('click', handleBackdropClick);
  elements.nameInput.addEventListener('blur', handleNameBlur);
  elements.firstNameInput.addEventListener('input', handleFirstNameInput);
  elements.selectAll.addEventListener('change', handleSelectAllChange);
  elements.confirmClose.addEventListener('click', closeConfirmModal);
  elements.confirmCancel.addEventListener('click', closeConfirmModal);
  elements.confirmSubmit.addEventListener('click', handleConfirmSubmit);
  elements.confirmModal.addEventListener('click', handleBackdropClick);
  elements.importButton.addEventListener('click', openImportModal);
  elements.importClose.addEventListener('click', closeImportModal);
  elements.importCancel.addEventListener('click', closeImportModal);
  elements.importModal.addEventListener('click', handleBackdropClick);
  elements.importFile.addEventListener('change', handleImportFileChange);
  elements.importHasHeader.addEventListener('change', handleImportHeaderToggle);
  getImportColumns().forEach((select) => {
    select.addEventListener('change', handleImportMappingChange);
  });
  elements.importValidate.addEventListener('click', handleImportValidate);
  elements.importExecute.addEventListener('click', handleImportExecute);
  elements.downloadSkipped.addEventListener('click', handleDownloadSkipped);
  elements.downloadErrors.addEventListener('click', handleDownloadErrors);
  document.addEventListener('keydown', handleGlobalKeydown);

  loadStudents();
}

init();
math/public/assets/js/questions/input.js
/* =========================================================
   input.js — Input Question
   - If expected answer is numeric:
     - mobile keyboard shows numbers (inputmode="numeric")
     - field only accepts digits (even on PC)
     - compare by numeric value (2 == 02 == ٢ == ۲)
   - Otherwise: normal text compare after trim + collapse spaces
   - Mobile UX: keep input visible above keyboard while typing (VisualViewport)

   UPDATE (2026-01-14):
   - Pressing Enter/Go triggers the main "متابعة" button automatically
   - Persist input value across engine re-renders using question._value

   UPDATE (2026-01-14) #2:
   - Improve keyboard overlap fix:
     * scroll based on the whole question box (.question-wrap), not only the input
     * re-run visibility adjustment after check (so attempts/solution stay visible)
   ========================================================= */

export function renderInputQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-input';

  const desc = document.createElement('div');
  desc.className = 'q-desc';
  desc.textContent = question.text || '';

  const input = document.createElement('input');
  input.className = 'input ltr';
  input.type = 'text';
  input.autocomplete = 'off';
  input.placeholder = question.placeholder || 'اكتب إجابتك هنا';

  const feedback = document.createElement('div');
  feedback.className = 'q-feedback';
  feedback.textContent = '';

  wrap.appendChild(desc);
  wrap.appendChild(input);
  wrap.appendChild(feedback);

  mountEl.appendChild(wrap);

  function normalizeSpaces(s) {
    if (s == null) return '';
    return String(s).trim().replace(/\s+/g, ' ');
  }

  function toLatinDigits(str) {
    const map = {
      '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
      '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
      '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
      '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
    };
    return String(str).replace(/[٠-٩۰-۹]/g, (d) => map[d] ?? d);
  }

  function numericOnly(str) {
    return String(str).replace(/[^0-9]/g, '');
  }

  function isNumericAnswer(ans) {
    const a = numericOnly(toLatinDigits(normalizeSpaces(ans)));
    return a.length > 0 && /^[0-9]+$/.test(a);
  }

  const expectsNumber = isNumericAnswer(question.answer);

  // Restore previous value (persisted by engine via stable question object)
  if (typeof question._value === 'string' && question._value !== '') {
    input.value = question._value;
  }

  if (expectsNumber) {
    // Mobile: numeric keyboard
    input.inputMode = 'numeric';
    input.pattern = '[0-9]*';

    // Desktop/All: restrict to digits only + persist value
    input.addEventListener('input', () => {
      const before = input.value;
      const latin = toLatinDigits(before);
      const filtered = numericOnly(latin);
      if (before !== filtered) input.value = filtered;

      // Persist
      question._value = input.value;
    });

    // Block non-digit keys (extra safety)
    input.addEventListener('keydown', (e) => {
      const allowed = [
        'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
        'Tab', 'Home', 'End', 'Enter'
      ];
      if (allowed.includes(e.key)) return;
      if (e.ctrlKey || e.metaKey) return;
      if (!/^[0-9]$/.test(e.key)) e.preventDefault();
    });
  } else {
    // Text mode: persist as user types
    input.addEventListener('input', () => {
      question._value = input.value;
    });
  }

  /* ---------- Enter/Go triggers "متابعة" ---------- */
  input.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    if (e.shiftKey) return;

    e.preventDefault();

    // Find the single main button "متابعة" inside current concept
    const conceptBody = mountEl.closest('.concept-body') || mountEl.closest('.card') || document;
    const btn = conceptBody.querySelector('.lesson-nav .btn');

    if (btn && typeof btn.click === 'function') {
      btn.click();
    }
  });

  /* ---------- Mobile keyboard overlap fix ---------- */
  const isTouchLikely =
    ('ontouchstart' in window) ||
    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);

  let vvHandler = null;

  function ensureVisible() {
    // Delay to allow keyboard to open and viewport to resize
    setTimeout(() => {
      const vv = window.visualViewport;

      // Determine current visible bottom in layout viewport coordinates
      let visibleBottomY;
      if (vv) {
        visibleBottomY = vv.pageTop + vv.height;
      } else {
        visibleBottomY = window.scrollY + window.innerHeight;
      }

      // ✅ IMPORTANT: use the whole question box bottom, not just the input
      const qWrap = input.closest('.question-wrap') || input;
      const rect = qWrap.getBoundingClientRect();
      const targetBottomY = window.scrollY + rect.bottom;

      // Comfortable margin (bigger when keyboard is open)
      let extra = 18;
      if (vv) {
        const kb = Math.max(0, window.innerHeight - vv.height); // approximate keyboard height
        // raise more when keyboard is big
        extra += Math.min(160, Math.max(60, Math.round(kb * 0.35)));
      } else {
        extra += 60;
      }

      if (targetBottomY + extra > visibleBottomY) {
        const delta = (targetBottomY + extra) - visibleBottomY;
        window.scrollBy({ top: delta, left: 0, behavior: 'smooth' });
      }
    }, 260);
  }

  function onFocus() {
    if (!isTouchLikely) return;

    ensureVisible();

    // Also react to viewport changes while keyboard is animating
    const vv = window.visualViewport;
    if (vv && !vvHandler) {
      vvHandler = () => ensureVisible();
      vv.addEventListener('resize', vvHandler);
      vv.addEventListener('scroll', vvHandler);
    }
  }

  function onBlur() {
    const vv = window.visualViewport;
    if (vv && vvHandler) {
      vv.removeEventListener('resize', vvHandler);
      vv.removeEventListener('scroll', vvHandler);
      vvHandler = null;
    }
  }

  input.addEventListener('focus', onFocus);
  input.addEventListener('blur', onBlur);

  /* ---------- Check ---------- */
  function check() {
    const rawUser = input.value ?? '';
    const rawAns = question.answer ?? '';

    // Persist before checking (safety)
    question._value = rawUser;

    if (expectsNumber) {
      const userDigits = numericOnly(toLatinDigits(rawUser));
      const ansDigits = numericOnly(toLatinDigits(rawAns));

      const userNum = userDigits === '' ? NaN : Number(userDigits);
      const ansNum = ansDigits === '' ? NaN : Number(ansDigits);

      const ok = Number.isFinite(userNum) && Number.isFinite(ansNum) && userNum === ansNum;

      feedback.textContent = ok ? 'إجابة صحيحة ✅' : 'مش صحيح، جرّب مرة ثانية';
      feedback.classList.toggle('ok', ok);
      feedback.classList.toggle('err', !ok);

      // ✅ After checking (and possible solution injection), ensure visibility again
      if (!ok) {
        setTimeout(() => ensureVisible(), 80);
      }
      return ok;
    }

    // text mode
    const user = normalizeSpaces(rawUser);
    const ans = normalizeSpaces(rawAns);

    const ok = user !== '' && user === ans;

    feedback.textContent = ok ? 'إجابة صحيحة ✅' : 'مش صحيح، جرّب مرة ثانية';
    feedback.classList.toggle('ok', ok);
    feedback.classList.toggle('err', !ok);

    // ✅ After checking (and possible solution injection), ensure visibility again
    if (!ok) {
      setTimeout(() => ensureVisible(), 80);
    }
    return ok;
  }

  return { check };
}
math/public/assets/js/questions/match.js
/* =========================================================
   match.js — Matching Question (Structure Only - Phase 2)
   - For now: renders layout and always returns false
   ========================================================= */

export function renderMatchQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-match';

  const left = document.createElement('div');
  left.className = 'col';

  const right = document.createElement('div');
  right.className = 'col';

  (question.left || []).forEach((t) => {
    const item = document.createElement('div');
    item.className = 'item';
    item.textContent = t;
    left.appendChild(item);
  });

  (question.right || []).forEach((t) => {
    const item = document.createElement('div');
    item.className = 'item';
    item.textContent = t;
    right.appendChild(item);
  });

  wrap.appendChild(left);
  wrap.appendChild(right);

  mountEl.appendChild(wrap);

  function check() {
    // Phase 2: implement drag/select matching logic
    return false;
  }

  return { check };
}
math/public/assets/js/questions/mcq.js
/* =========================================================
   mcq.js — Multiple Choice Question (Single Correct)
   - Fix: enforce single selection by using one shared radio group name

   UPDATE (2026-01-14):
   - Persist MCQ selection across engine re-renders using question._selectedIndex
   ========================================================= */

export function renderMcqQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-mcq';

  const desc = document.createElement('div');
  desc.className = 'q-desc';
  desc.textContent = question.text || '';

  wrap.appendChild(desc);

  // Restore previous selection (if any)
  let selectedIndex = (typeof question._selectedIndex === 'number')
    ? question._selectedIndex
    : null;

  // IMPORTANT: one shared group name for all choices (prevents multi-select)
  const groupName = `mcq-${Math.random().toString(36).slice(2)}`;

  (question.choices || []).forEach((choice, idx) => {
    const label = document.createElement('label');
    label.className = 'choice';

    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = groupName;
    radio.value = String(idx);

    // Apply restored selection
    if (selectedIndex === idx) {
      radio.checked = true;
    }

    const span = document.createElement('span');
    span.textContent = choice;

    // Keep selectedIndex in sync + persist on question object
    radio.addEventListener('change', () => {
      selectedIndex = idx;
      question._selectedIndex = idx;
    });

    label.appendChild(radio);
    label.appendChild(span);

    wrap.appendChild(label);
  });

  const feedback = document.createElement('div');
  feedback.className = 'q-feedback';
  wrap.appendChild(feedback);

  mountEl.appendChild(wrap);

  function check() {
    // Persist selection (safety)
    if (typeof selectedIndex === 'number') {
      question._selectedIndex = selectedIndex;
    }

    const ok = selectedIndex === question.correctIndex;

    feedback.textContent = ok
      ? 'إجابة صحيحة ✅'
      : 'إجابة خاطئة ❌ حاول مرة ثانية';

    feedback.classList.toggle('ok', ok);
    feedback.classList.toggle('err', !ok);

    // visual mark
    const choicesEls = wrap.querySelectorAll('.choice');
    choicesEls.forEach((el, i) => {
      el.classList.remove('correct', 'wrong');
      if (selectedIndex != null) {
        if (i === question.correctIndex) el.classList.add('correct');
        else if (i === selectedIndex) el.classList.add('wrong');
      }
    });

    return ok;
  }

  return { check };
}
math/public/assets/js/questions/ordering.js
/* =========================================================
   ordering.js — Ordering Question (Tap/Drag into slots)
   - Horizontal pool + vertical slots
   - Keeps order state on question._order
   ========================================================= */

export function renderOrderingQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-ordering';

  const desc = document.createElement('div');
  desc.className = 'q-desc';
  desc.textContent = question.text || '';

  const pool = document.createElement('div');
  pool.className = 'ordering-pool';

  const slots = document.createElement('div');
  slots.className = 'ordering-slots';

  const feedback = document.createElement('div');
  feedback.className = 'q-feedback';

  wrap.appendChild(desc);
  wrap.appendChild(pool);
  wrap.appendChild(slots);
  wrap.appendChild(feedback);

  mountEl.appendChild(wrap);

  const originalItems = Array.isArray(question.items)
    ? question.items
    : Array.isArray(question.choices)
      ? question.choices
      : [];

  function normalizeValue(value) {
    return String(value ?? '').trim().replace(/\s+/g, ' ');
  }

  function getInitialPool() {
    const items = originalItems.map((item) => String(item ?? ''));
    if (!items.length) return [];

    const shuffled = [...items];
    for (let i = shuffled.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    const sameOrder = shuffled.every((item, index) => item === items[index]);
    if (sameOrder && shuffled.length > 1) {
      [shuffled[0], shuffled[1]] = [shuffled[1], shuffled[0]];
    }

    return shuffled;
  }

  let order = Array.isArray(question._order)
    ? question._order.map((item) => (item == null ? null : String(item)))
    : Array(originalItems.length).fill(null);
  let poolItems = Array.isArray(question._pool)
    ? question._pool.map((item) => String(item ?? ''))
    : [];

  if (order.length !== originalItems.length) {
    order = Array(originalItems.length).fill(null);
  }

  const normalizedOriginal = originalItems.map((item) => String(item ?? ''));
  const used = new Set(order.filter(Boolean));

  if (!poolItems.length) {
    poolItems = getInitialPool();
  }

  poolItems = poolItems.filter((item) => !used.has(item));
  if (!poolItems.length && used.size !== normalizedOriginal.length) {
    poolItems = normalizedOriginal.filter((item) => !used.has(item));
  }

  question._order = order;
  question._pool = poolItems;

  pool.addEventListener('dragover', (event) => {
    event.preventDefault();
  });

  pool.addEventListener('drop', (event) => {
    event.preventDefault();
    const source = event.dataTransfer?.getData('application/x-order-source');
    if (source !== 'slot') return;
    const fromIndex = Number(event.dataTransfer?.getData('application/x-order-index'));
    if (!Number.isFinite(fromIndex)) return;
    removeFromSlot(fromIndex);
  });

  function getNextEmptyIndex() {
    return order.findIndex((item) => item == null);
  }

  function setActiveSlot() {
    const nextEmpty = getNextEmptyIndex();
    slots.querySelectorAll('.ordering-slot').forEach((slotEl, index) => {
      slotEl.classList.toggle('is-active', index === nextEmpty);
    });
  }

  function updateState(nextOrder, nextPool) {
    order = nextOrder;
    poolItems = nextPool;
    question._order = order;
    question._pool = poolItems;
    render();
  }

  function placeInSlot(value, slotIndex) {
    if (slotIndex < 0 || slotIndex >= order.length) return;
    const nextOrder = [...order];
    const nextPool = [...poolItems];

    const existing = nextOrder[slotIndex];
    if (existing) {
      nextPool.push(existing);
    }

    nextOrder[slotIndex] = value;
    const poolIndex = nextPool.indexOf(value);
    if (poolIndex !== -1) {
      nextPool.splice(poolIndex, 1);
    }

    updateState(nextOrder, nextPool);
  }

  function removeFromSlot(slotIndex) {
    const nextOrder = [...order];
    const nextPool = [...poolItems];
    const existing = nextOrder[slotIndex];
    if (!existing) return;
    nextOrder[slotIndex] = null;
    nextPool.push(existing);
    updateState(nextOrder, nextPool);
  }

  function moveSlotItem(fromIndex, toIndex) {
    if (fromIndex === toIndex) return;
    if (toIndex < 0 || toIndex >= order.length) return;

    const nextOrder = [...order];
    const fromValue = nextOrder[fromIndex];
    const toValue = nextOrder[toIndex];

    nextOrder[toIndex] = fromValue ?? null;
    nextOrder[fromIndex] = toValue ?? null;

    updateState(nextOrder, [...poolItems]);
  }

  function renderPool() {
    pool.innerHTML = '';

    if (!normalizedOriginal.length) {
      const empty = document.createElement('div');
      empty.className = 'ordering-empty';
      empty.textContent = 'لا توجد عناصر للترتيب.';
      pool.appendChild(empty);
      return;
    }

    poolItems.forEach((item) => {
      const pill = document.createElement('button');
      pill.type = 'button';
      pill.className = 'ordering-choice';
      pill.textContent = item;
      pill.draggable = true;

      pill.addEventListener('click', () => {
        const nextEmpty = getNextEmptyIndex();
        if (nextEmpty === -1) return;
        placeInSlot(item, nextEmpty);
      });

      pill.addEventListener('dragstart', (event) => {
        event.dataTransfer?.setData('text/plain', item);
        event.dataTransfer?.setData('application/x-order-source', 'pool');
      });

      pool.appendChild(pill);
    });

  }

  function renderSlots() {
    slots.innerHTML = '';

    normalizedOriginal.forEach((_, index) => {
      const slot = document.createElement('div');
      slot.className = 'ordering-slot';
      slot.dataset.index = String(index);

      const value = order[index];
      if (value) {
        const pill = document.createElement('div');
        pill.className = 'ordering-slot-item';
        pill.textContent = value;
        pill.draggable = true;

        pill.addEventListener('dragstart', (event) => {
          event.dataTransfer?.setData('text/plain', value);
          event.dataTransfer?.setData('application/x-order-source', 'slot');
          event.dataTransfer?.setData('application/x-order-index', String(index));
        });

        pill.addEventListener('click', () => {
          removeFromSlot(index);
        });

        slot.appendChild(pill);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'ordering-placeholder';
        placeholder.textContent = 'ضع العنصر هنا';
        slot.appendChild(placeholder);
      }

      slot.addEventListener('dragover', (event) => {
        event.preventDefault();
        slot.classList.add('is-dragover');
      });

      slot.addEventListener('dragleave', () => {
        slot.classList.remove('is-dragover');
      });

      slot.addEventListener('drop', (event) => {
        event.preventDefault();
        slot.classList.remove('is-dragover');
        const source = event.dataTransfer?.getData('application/x-order-source');
        const value = event.dataTransfer?.getData('text/plain');
        if (!value) return;

        if (source === 'pool') {
          placeInSlot(value, index);
          return;
        }

        if (source === 'slot') {
          const fromIndex = Number(event.dataTransfer?.getData('application/x-order-index'));
          if (!Number.isFinite(fromIndex)) return;
          moveSlotItem(fromIndex, index);
        }
      });

      slot.addEventListener('click', () => {
        if (!value) {
          const nextItem = poolItems[0];
          if (!nextItem) return;
          placeInSlot(nextItem, index);
        }
      });

      slots.appendChild(slot);
    });

    setActiveSlot();
  }

  function render() {
    renderPool();
    renderSlots();
  }

  render();

  function check() {
    if (!originalItems.length) {
      feedback.textContent = 'لا توجد عناصر للترتيب.';
      feedback.classList.remove('ok', 'err');
      return true;
    }

    if (order.some((item) => item == null)) {
      feedback.textContent = 'رتّب كل العناصر أولًا.';
      feedback.classList.remove('ok');
      feedback.classList.add('err');
      return false;
    }

    const normalizedOrder = order.map(normalizeValue);
    const normalizedCorrect = originalItems.map(normalizeValue);
    const ok = normalizedOrder.every((value, index) => value === normalizedCorrect[index]);

    feedback.textContent = ok
      ? 'ترتيب صحيح ✅'
      : 'الترتيب غير صحيح، جرّب مرة ثانية';

    feedback.classList.toggle('ok', ok);
    feedback.classList.toggle('err', !ok);

    return ok;
  }

  return { check };
}
math/public/assets/js/questions/registry.js
/* =========================================================
   registry.js — Question Type Registry
   - renderQuestion({ mountEl, question }) => { check() }
   ========================================================= */

import { renderInputQuestion } from './input.js';
import { renderMcqQuestion } from './mcq.js';
import { renderMatchQuestion } from './match.js';
import { renderOrderingQuestion } from './ordering.js';

const REGISTRY = {
  input: renderInputQuestion,
  mcq: renderMcqQuestion,
  match: renderMatchQuestion, // structure only for now
  ordering: renderOrderingQuestion,
};

export function renderQuestion({ mountEl, question }) {
  if (!question || !question.type) {
    throw new Error('سؤال غير صالح: type مفقود');
  }

  const renderer = REGISTRY[question.type];
  if (!renderer) {
    throw new Error(`نوع سؤال غير مدعوم: ${question.type}`);
  }

  return renderer({ mountEl, question });
}

export function registerQuestionType(type, renderer) {
  REGISTRY[type] = renderer;
}
math/public/assets/js/ui/text.js
/* =========================================================
   text.js — Default Hint & Encouragement Texts (Arabic)
   Used when JSON does not provide custom text
   ========================================================= */

/* ---------- Encouragement (after success) ---------- */
export const ENCOURAGEMENTS = [
  'رائع 👏 كمل هيك!',
  'إجابة صحيحة 👍',
  'ممتاز! واضح إنك فاهم.',
  'أحسنت 🌟',
  'تمام، ننتقل للي بعدها.'
];

/* ---------- Hints (progressive) ---------- */
export const DEFAULT_HINTS = [
  'جرّب تفكّر بالخطوة الأساسية بالسؤال.',
  'راجع المثال المحلول فوق، فيه مفتاح الحل.',
  'ركّز على المطلوب بالضبط، بدون زيادة.'
];

/* ---------- Strong Hint (last attempt) ---------- */
export const FINAL_HINT = 'خذ نفس 😌 وراجع المعطيات بهدوء، الحل أبسط مما تتوقع.';

/* ---------- Helpers ---------- */
export function pickRandom(list = []) {
  if (!list.length) return '';
  return list[Math.floor(Math.random() * list.length)];
}
math/public/assets/js/ui/toast.js
/* =========================================================
   toast.js — Material Toast with Countdown Bar
   API: showToast(title, msg, type='info', duration=3000)

   UPDATE (2026-01-14):
   - Host is pinned to TOP of the VISUAL viewport (not the layout viewport)
     using visualViewport.offsetTop/offsetLeft + height/width.
   - This avoids cases where toast appears "too high" and requires scrolling
     to reveal it on mobile browsers.
   ========================================================= */

let hostEl = null;
let activeToast = null;
let rafId = null;
let bound = false;

function ensureHost() {
  if (hostEl) return hostEl;

  hostEl = document.createElement('div');
  hostEl.className = 'toast-host';
  document.body.appendChild(hostEl);

  updateHostToVisualViewport();

  if (!bound) {
    bound = true;

    // Resize/orientation changes
    window.addEventListener('resize', updateHostToVisualViewport, { passive: true });
    window.addEventListener('scroll', updateHostToVisualViewport, { passive: true });

    // Mobile browser UI + keyboard changes
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateHostToVisualViewport, { passive: true });
      window.visualViewport.addEventListener('scroll', updateHostToVisualViewport, { passive: true });
    }
  }

  return hostEl;
}

function updateHostToVisualViewport() {
  if (!hostEl) return;

  const vv = window.visualViewport;

  // Default (no VisualViewport support)
  let top = 0;
  let left = 0;
  let width = window.innerWidth;
  let height = window.innerHeight;

  if (vv) {
    top = Math.round(vv.offsetTop || 0);
    left = Math.round(vv.offsetLeft || 0);
    width = Math.round(vv.width || window.innerWidth);
    height = Math.round(vv.height || window.innerHeight);
  }

  // Place host at the top of the VISUAL viewport.
  // We keep position:fixed + inset:0 in CSS, and move the whole host.
  hostEl.style.transform = `translate(${left}px, ${top}px)`;

  // Limit interactions area to the visible viewport (optional but clean)
  hostEl.style.width = `${width}px`;
  hostEl.style.height = `${height}px`;
}

function iconSvg(type) {
  const common = (path) => `
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="${path}"></path>
    </svg>
  `;

  if (type === 'success') {
    return common('M9 16.2l-3.5-3.5L4 14.2l5 5L20 8.2l-1.5-1.5z');
  }
  if (type === 'warning') {
    return common('M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2V10z');
  }
  if (type === 'danger' || type === 'error') {
    return common('M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z');
  }
  // info
  return common('M11 7h2v2h-2V7zm0 4h2v8h-2v-8zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z');
}

function cleanup() {
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;
  if (activeToast) {
    activeToast.remove();
    activeToast = null;
  }
}

function animateBar(barEl, duration) {
  const start = performance.now();

  const tick = (now) => {
    const elapsed = now - start;
    const t = Math.min(1, elapsed / duration);
    barEl.style.transform = `scaleX(${t})`;
    if (t < 1) {
      rafId = requestAnimationFrame(tick);
    }
  };

  rafId = requestAnimationFrame(tick);
}

export function showToast(title, msg, type = 'info', duration = 3000) {
  ensureHost();

  // Refresh position each time (mobile UI can change between toasts)
  updateHostToVisualViewport();

  // replace any existing toast (single toast policy)
  cleanup();

  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.dataset.type = type;

  toast.innerHTML = `
    <div class="toast-inner">
      <div class="toast-ic">${iconSvg(type)}</div>
      <div class="toast-content">
        <p class="toast-title">${escapeHtml(String(title || ''))}</p>
        <p class="toast-msg">${escapeHtml(String(msg || ''))}</p>
      </div>
    </div>
    <div class="toast-bar"><i></i></div>
  `;

  hostEl.appendChild(toast);
  activeToast = toast;

  requestAnimationFrame(() => {
    toast.classList.add('is-show');
  });

  const bar = toast.querySelector('.toast-bar > i');
  if (bar) animateBar(bar, duration);

  window.setTimeout(() => {
    if (!activeToast) return;
    activeToast.classList.remove('is-show');
    window.setTimeout(() => cleanup(), 260);
  }, duration);
}

function escapeHtml(s) {
  return s
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
math/public/data/cards.json
[
  {
    "week": 999,
    "title": "بطاقة تجريبية — محرك بلا حدود",
    "prereq": null
  },
  {
    "week": 1000,
    "title": "بطاقة تجريبية — المربع (خصائصه ومحيطه ومساحته)",
    "prereq": 999
  }
]
math/public/data/students.json
{
  "version": 1,
  "note": "قائمة الطلاب للتحقق (رقم الهوية + سنة الميلاد). لا تضع بيانات حساسة إضافية. يمكن إضافة 200 طالب هنا.",
  "students": [
    {
      "id": "23432",
      "birthYear": "2012",
      "firstName": "أحمد",
      "fullName": "أحمد محمد",
      "class": "7/1"
    },
    {
      "id": "998877",
      "birthYear": "2011",
      "firstName": "خالد",
      "fullName": "خالد علي",
      "class": "7/2"
    },
    {
      "id": "444422265",
      "birthYear": "2023",
      "firstName": "ميرا",
      "fullName": "ميرا احمد",
      "class": "7/2"
    },
    {
      "id": "55511001",
      "birthYear": "2013",
      "firstName": "ليان",
      "fullName": "ليان حسن",
      "class": "6/1"
    },
    {
      "id": "55511002",
      "birthYear": "2012",
      "firstName": "سامي",
      "fullName": "سامي ناصر",
      "class": "6/2"
    },
    {
      "id": "55511003",
      "birthYear": "2011",
      "firstName": "هيا",
      "fullName": "هيا محمود",
      "class": "6/3"
    }
  ]
}
math/public/data/weeks/week1000.json
{
  "week": 1000,
  "title": "بطاقة المربع — خصائصه ومحيطه ومساحته",
  "goals": [
    "التعرّف على خصائص المربع وطريقة حساب محيطه.",
    "إتقان حساب مساحة المربع باستخدام طول الضلع."
  ],
  "prerequisites": [
    "معرفة مفهوم المحيط والمساحة بشكل عام.",
    "إتقان عمليات الجمع والضرب الأساسية."
  ],
  "assessment": {
    "title": "تقييم ختامي للمربع",
    "description": "أجب عن الأسئلة التالية لتحصل على نقاطك. بدون تصويب فوري.",
    "questions": [
      {
        "type": "input",
        "text": "طول ضلع مربع = 4 سم. ما محيطه؟",
        "answer": "16",
        "points": 2
      },
      {
        "type": "mcq",
        "text": "أي عبارة صحيحة عن المربع؟",
        "choices": [
          "كل زواياه حادة",
          "كل أضلاعه متساوية",
          "له ضلعان متساويان فقط",
          "ليس له زوايا قائمة"
        ],
        "correctIndex": 1,
        "points": 2
      },
      {
        "type": "input",
        "text": "طول ضلع مربع = 6 سم. ما مساحته؟",
        "answer": "36",
        "points": 3
      }
    ]
  },
  "concepts": [
    {
      "title": "خصائص المربع ومحيطه",
      "flow": [
        {
          "type": "goal",
          "text": "أن يتعرّف الطالب خصائص الشكل المربع وكيف نحسب محيطه.",
          "details": [
            "المربع شكل رباعي منتظم.",
            "جميع الأضلاع متساوية.",
            "كل زاوية تساوي 90°"
          ]
        },
        {
          "type": "explain",
          "text": "المربع شكل رباعي: أضلاعه الأربعة متساوية وزواياه قائمة (90°)."
        },
        {
          "type": "video",
          "title": "فيديو سريع عن خصائص المربع",
          "description": "شاهد هذا الفيديو لتثبيت فكرة الزوايا والأضلاع المتساوية.",
          "url": "https://www.youtube.com/watch?v=9e3r0W0bKpg"
        },
        {
          "type": "example",
          "text": "إذا كان طول ضلع المربع 5 سم، فمحيطه = 5 + 5 + 5 + 5 = 20 سم.",
          "details": [
            "قاعدة المحيط: 4 × طول الضلع.",
            "يمكنك أيضًا جمع الضلع 4 مرات."
          ]
        },
        {
          "type": "question",
          "text": "سؤال 1: طول ضلع مربع = 7 سم. ما محيطه؟",
          "answer": "28",
          "hints": [
            "محيط المربع = 4 × طول الضلع.",
            "4 × 7 = ؟",
            "اجمع 7 أربع مرات."
          ],
          "solution": "محيط المربع = 4 × 7 = 28 سم."
        },
        {
          "type": "question",
          "text": "سؤال 2: أي عبارة صحيحة عن المربع؟",
          "choices": [
            "له ضلعان متساويان فقط",
            "كل زواياه قائمة",
            "محيطه = طول الضلع × 2",
            "لا يملك أضلاعًا متوازية"
          ],
          "correctIndex": 1,
          "hints": [
            "المربع شكل رباعي منتظم.",
            "كل زواياه 90°.",
            "أضلاعه الأربعة متساوية."
          ],
          "solution": "العبارة الصحيحة: كل زوايا المربع قائمة."
        }
      ]
    },
    {
      "title": "مساحة المربع",
      "flow": [
        {
          "type": "goal",
          "text": "أن يحسب الطالب مساحة المربع باستخدام طول الضلع.",
          "details": [
            "مساحة المربع تعتمد على الضلع فقط.",
            "الوحدة تكون مربعة (سم²)."
          ]
        },
        {
          "type": "explain",
          "text": "مساحة المربع = طول الضلع × طول الضلع (الضلع²)."
        },
        {
          "type": "example",
          "text": "إذا كان طول الضلع 6 سم، فالمساحة = 6 × 6 = 36 سم²."
        },
        {
          "type": "question",
          "text": "سؤال 3: طول ضلع مربع = 9 سم. ما مساحته؟",
          "answer": "81",
          "hints": [
            "المساحة = الضلع × الضلع.",
            "9 × 9 = ؟",
            "اكتب الناتج فقط."
          ],
          "solution": "مساحة المربع = 9 × 9 = 81 سم²."
        },
        {
          "type": "note",
          "text": "تذكّر: المحيط يقيس طول الحدود، بينما المساحة تقيس مقدار السطح."
        }
      ]
    }
  ]
}
math/public/data/weeks/week999.json
{
  "week": 999,
  "title": "بطاقة تجريبية (week 999) — اختبار الـ Flow",
  "goals": [
    "فهم فكرة التدرّج وزر المتابعة.",
    "إتقان حل مسائل القسمة الأساسية."
  ],
  "prerequisites": [
    "إتقان جداول الضرب البسيطة.",
    "معرفة معنى القسمة كعملية توزيع متساوي."
  ],
  "assessment": {
    "title": "تقييم سريع للقسمة",
    "description": "أجب عن الأسئلة واحصل على نقاطك (بدون تصويب فوري).",
    "questions": [
      {
        "type": "input",
        "text": "اكتب ناتج 8 ÷ 4",
        "answer": "2",
        "points": 2
      },
      {
        "type": "mcq",
        "text": "أي عبارة صحيحة؟",
        "choices": ["6 ÷ 3 = 1", "6 ÷ 3 = 2", "6 ÷ 3 = 4"],
        "correctIndex": 1,
        "points": 2
      }
    ]
  },
  "concepts": [
    {
      "title": "اختبار تدفّق بلا حدود",
      "flow": [
        {
          "type": "goal",
          "text": "أن يفهم الطالب فكرة التدرّج، وأن زر (متابعة) يتحول للتحقق عند الأسئلة.",
          "details": [
            "كل متابعة تكشف عنصرًا جديدًا.",
            "عند السؤال تتحول المتابعة للتحقق."
          ]
        },
        {
          "type": "explain",
          "text": "في هذا النظام: كل ضغطة (متابعة) تكشف العنصر التالي. عند السؤال، نفس الزر يصبح تحقق للسؤال الحالي."
        },
        {
          "type": "example",
          "text": "مثال سريع: 6 ÷ 3 = 2 لأن 3 تدخل في 6 مرتين."
        },
        {
          "type": "question",
          "text": "السؤال 1: اكتب ناتج 6 ÷ 3",
          "answer": "2",
          "hints": [
            "تذكّر: كم مرة 3 تدخل في 6؟",
            "جرّب: 3 + 3 = 6، إذن مرتين.",
            "قسم 6 على 3 بالتساوي: نصيب كل واحد 2."
          ],
          "solution": "6 ÷ 3 = 2 لأن 3 تدخل في 6 مرتين."
        },
        {
          "type": "question",
          "text": "السؤال 2: أي عبارة صحيحة؟",
          "choices": ["9 ÷ 3 = 2", "9 ÷ 3 = 3", "9 ÷ 3 = 4", "9 ÷ 3 = 5"],
          "correctIndex": 1,
          "hints": [
            "تحقق بالضرب: 3 × ؟ = 9",
            "العدد اللي إذا ضربناه في 3 يعطينا 9 هو 3.",
            "9 = 3 + 3 + 3 (ثلاث مرات)."
          ],
          "solution": "الإجابة الصحيحة: 9 ÷ 3 = 3 لأن 3 × 3 = 9."
        },
        {
          "type": "note",
          "text": "ملاحظة: لاحظ كيف نفس زر (متابعة) كان تحقق للسؤال 1 ثم صار تحقق للسؤال 2."
        }
      ]
    },
    {
      "title": "مفهوم إضافي (تجربة انتقال)",
      "flow": [
        {
          "type": "goal",
          "text": "أن يميّز الطالب العلاقة بين القسمة والضرب.",
          "details": [
            "القسمة عكس الضرب.",
            "التحقق يكون بضرب الناتج في المقسوم عليه."
          ]
        },
        {
          "type": "explain",
          "text": "إذا كان a ÷ b = c فهذا يعني أن b × c = a. نستخدم الضرب للتحقق."
        },
        {
          "type": "question",
          "text": "اكتب عددًا يجعل: 5 × □ = 20",
          "answer": "4",
          "hints": [
            "ابحث عن عدد إذا ضربته في 5 يعطي 20.",
            "20 ÷ 5 = ؟",
            "العدد هو 4 لأن 5 × 4 = 20."
          ],
          "solution": "العدد هو 4 لأن 20 ÷ 5 = 4، وبالتالي 5 × 4 = 20."
        }
      ]
    }
  ]
}
math/public/docs/database-schema.md
# Database Schema Reference

> Source: user-provided table/column summary for the Math app database.

## AssessmentQuestionChoices

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| AssessmentChoiceId | int |  | NO |
| AssessmentQuestionId | int |  | NO |
| SortOrder | int |  | NO |
| ChoiceText | nvarchar | 300 | NO |

## AssessmentQuestions

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| AssessmentQuestionId | int |  | NO |
| AssessmentId | int |  | NO |
| SortOrder | int |  | NO |
| QuestionType | nvarchar | 50 | NO |
| QuestionText | nvarchar | 500 | NO |
| Answer | nvarchar | 200 | YES |
| Points | int |  | NO |
| CorrectIndex | int |  | YES |

## Assessments

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| AssessmentId | int |  | NO |
| Week | int |  | NO |
| Title | nvarchar | 300 | NO |
| Description | nvarchar | 500 | NO |

## CardCompletions

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| CompletionId | int |  | NO |
| StudentId | nvarchar | 20 | NO |
| Week | int |  | NO |
| FinalScore | int |  | NO |
| CompletedAt | datetime |  | NO |

## Cards

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| Week | int |  | NO |
| Title | nvarchar | 300 | NO |
| PrereqWeek | int |  | YES |

## Concepts

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| ConceptId | int |  | NO |
| Week | int |  | NO |
| SortOrder | int |  | NO |
| Title | nvarchar | 300 | NO |

## database_firewall_rules

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| id | int |  | NO |
| name | nvarchar | 128 | NO |
| start_ip_address | varchar | 45 | NO |
| end_ip_address | varchar | 45 | NO |
| create_date | datetime |  | NO |
| modify_date | datetime |  | NO |

## FlowItemChoices

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemChoiceId | int |  | NO |
| FlowItemId | int |  | NO |
| SortOrder | int |  | NO |
| ChoiceText | nvarchar | 300 | NO |

## FlowItemDetails

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemDetailId | int |  | NO |
| FlowItemId | int |  | NO |
| SortOrder | int |  | NO |
| DetailText | nvarchar | 500 | NO |

## FlowItemHints

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemHintId | int |  | NO |
| FlowItemId | int |  | NO |
| SortOrder | int |  | NO |
| HintText | nvarchar | 500 | NO |

## FlowItems

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemId | int |  | NO |
| ConceptId | int |  | NO |
| SortOrder | int |  | NO |
| ItemType | nvarchar | 50 | NO |
| ItemText | nvarchar | 1000 | YES |
| ItemTitle | nvarchar | 300 | YES |
| ItemDescription | nvarchar | 500 | YES |
| ItemUrl | nvarchar | 500 | YES |
| Answer | nvarchar | 200 | YES |
| CorrectIndex | int |  | YES |
| Solution | nvarchar | 1000 | YES |

## Students

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| StudentId | nvarchar | 20 | NO |
| BirthYear | nvarchar | 10 | NO |
| FirstName | nvarchar | 100 | NO |
| FullName | nvarchar | 200 | NO |
| Class | nvarchar | 20 | NO |

## WeekGoals

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| GoalId | int |  | NO |
| Week | int |  | NO |
| SortOrder | int |  | NO |
| GoalText | nvarchar | 500 | NO |

## WeekPrerequisites

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| PrerequisiteId | int |  | NO |
| Week | int |  | NO |
| SortOrder | int |  | NO |
| PrerequisiteText | nvarchar | 500 | NO |

## Weeks

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| Week | int |  | NO |
| Title | nvarchar | 300 | NO |
math/public/index.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — منصة الرياضيات</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
</head>

<body class="is-loading">
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="math">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
          </div>
        </div>

        <div class="row">
          <a class="btn btn-ghost btn-sm" href="/" aria-label="الصفحة الرئيسية">
            الرئيسية
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <!-- Screen: ID -->
      <section id="screen-id" class="stack">
        <div class="card">
          <div class="card-header">
            <div>
              <h1 class="h1">تسجيل الدخول</h1>
              <p class="p">أدخل رقم الهوية للمتابعة وحفظ التقدم.</p>
            </div>
            <span class="badge primary">نهاري</span>
          </div>

          <div class="card-body">
            <div class="field">
              <label class="label" for="studentId">رقم الهوية</label>
              <input id="studentId" class="input ltr" inputmode="numeric" autocomplete="off" placeholder="مثال: 123456789" />
              <div class="help">يُستخدم لحفظ التقدم على هذا الجهاز.</div>
            </div>

            <div class="row">
              <button id="btnLogin" class="btn btn-primary btn-lg w-100">دخول</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Screen: Welcome -->
      <section id="screen-welcome" class="stack hidden" hidden style="display:none;">
        <div class="card">
          <div class="card-header">
            <div>
              <h1 class="h1" id="welcomeTitle">مرحبًا 👋</h1>
              <p class="p" id="welcomeSub">هل تريد البدء ببطاقات الأسبوع؟</p>
            </div>
            <span class="badge primary" id="welcomeChip">طالب</span>
          </div>

          <div class="card-body">
            <div class="field">
              <label class="label">اسم الطالب</label>
              <div id="welcomeName" class="input is-static" role="status">طالب</div>
              <div class="help">يمكنك تغيير رقم الهوية من الزر أدناه.</div>
            </div>
            <button id="btnToCards" class="btn btn-primary btn-lg w-100">عرض البطاقات</button>
            <button id="btnChangeId" class="btn btn-outline w-100">تغيير رقم الهوية</button>
          </div>
        </div>
      </section>

      <!-- Screen: Cards -->
      <section id="screen-cards" class="stack hidden" hidden style="display:none;">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="h2">بطاقات الأسابيع</h2>
              <p class="p">اختر بطاقة مفتوحة؛ تُفتح البطاقات المقفلة بعد إكمال السابقة.</p>
            </div>
            <div class="row">
              <span class="badge primary" id="cardsStudentName">طالب</span>
              <button id="btnLogout" class="btn btn-ghost btn-sm">تبديل الطالب</button>
            </div>
          </div>

          <div class="card-body">
            <div id="cardsList" class="grid cards" aria-live="polite"></div>
          </div>

          <div class="card-footer">
            <span class="small">بطاقة تجريبية: week=999</span>
          </div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — منصة تعليمية تفاعلية</p>
    </footer>
  </div>

  <script type="module" src="/assets/js/app.js"></script>
</body>
</html>
math/public/lesson.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — الدرس</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/lesson.css" />
  <link rel="stylesheet" href="/assets/css/questions.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
</head>

<body>
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>درس تفاعلي</span>
          </div>
        </div>

        <a id="btnBackHome" class="btn btn-ghost btn-sm" href="/" aria-label="العودة للبطاقات">
          العودة للبطاقات
        </a>
      </div>
    </header>

    <main class="container section">
      <!-- Lesson Header -->
      <section class="lesson-header">
        <div class="lesson-title">
          <h1 id="lessonTitle" class="h1">تحميل البطاقة...</h1>
          <div class="lesson-meta">
            <span id="lessonStudent" class="lesson-student">طالب</span>
            <span id="lessonWeek" class="badge primary">week</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="progress-wrap">
          <div class="progress-label">
            <span>مستوى الفهم</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress">
            <i id="progressBar"></i>
          </div>
        </div>
      </section>

      <!-- Lesson Content -->
      <section id="lessonContent" class="stack" aria-live="polite">
        <!-- Concepts rendered here by engine -->
      </section>

      <!-- Completion -->
      <section id="lessonComplete" class="lesson-complete hidden" hidden>
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="h2">أحسنت 🎉</h2>
              <p class="p">أنهيت البطاقة بنجاح.</p>
            </div>
            <span class="badge done">منجزة</span>
          </div>

          <div class="card-body">
            <p class="p">تم حفظ الإنجاز، ويمكنك العودة للبطاقات لمتابعة التالي.</p>
            <div class="row">
              <a href="/" class="btn btn-primary btn-lg w-100">العودة للبطاقات</a>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — محرك دروس تفاعلي</p>
    </footer>
  </div>

  <script type="module" src="/assets/js/app.js"></script>
</body>
</html>
math/public/mng/card-editor.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — محرر محتوى البطاقة</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
  <link rel="stylesheet" href="/assets/css/mng/manager.css" />
  <link rel="stylesheet" href="/assets/css/mng/card-editor.css" />
</head>

<body>
  <div class="page-shell">
    <header class="editor-header">
      <div class="container header-inner">
        <div>
          <a id="btnBack" class="btn btn-ghost btn-sm" href="/mng/cards.html">رجوع للبطاقات</a>
          <h1 class="editor-title" id="cardTitle">بطاقة رقم —</h1>
          <p class="editor-subtitle" id="cardSubtitle">تحميل البيانات...</p>
        </div>
        <button id="btnSave" class="btn btn-primary">حفظ الآن</button>
      </div>
    </header>

    <main class="container editor-layout">
      <aside class="editor-sidebar">
        <div class="sidebar-title">الأقسام</div>
        <ul id="sectionsList" class="sidebar-list"></ul>
      </aside>

      <section class="editor-panel">
        <div id="editorContent">تحميل المحتوى...</div>
      </section>
    </main>

    <div class="floating-actions">
      <button id="btnAddConcept" class="btn btn-outline">إضافة قسم/مفهوم</button>
      <button id="btnAddItem" class="btn btn-outline">إضافة عنصر</button>
      <button id="btnAddQuestion" class="btn btn-outline">إضافة سؤال</button>
    </div>
  </div>

  <div id="confirmLeave" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-sm" role="dialog" aria-modal="true" aria-labelledby="confirmLeaveTitle">
      <div class="modal-header">
        <h2 id="confirmLeaveTitle" class="h2">تغييرات غير محفوظة</h2>
        <button id="btnCloseLeave" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <p class="p">لديك تغييرات غير محفوظة. هل تريد المتابعة بدون حفظ؟</p>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnConfirmLeave" class="btn btn-primary" type="button">متابعة بدون حفظ</button>
        <button id="btnCancelLeave" class="btn btn-outline" type="button">إلغاء</button>
      </div>
    </div>
  </div>

  <script type="module" src="/assets/js/mng/cardEditor.js"></script>
</body>
</html>
math/public/mng/cards.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — إدارة البطاقات</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
  <link rel="stylesheet" href="/assets/css/mng/manager.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="math">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>لوحة إدارة البطاقات</span>
          </div>
        </div>

        <div class="row">
          <a class="btn btn-ghost btn-sm" href="/" aria-label="الصفحة الرئيسية">
            الرئيسية
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <div class="warning-banner" role="alert">
        ⚠️ صفحة إدارة تجريبية — لا تُدخل بيانات حقيقية
      </div>

      <section class="card manager-card">
        <div class="card-header">
          <div>
            <h1 class="h1">Cards Manager</h1>
            <p class="p">إدارة بطاقات الأسابيع (عرض، إضافة، تعديل، حذف).</p>
          </div>
          <span class="badge primary">بدون تسجيل دخول</span>
        </div>

        <div class="card-body">
          <div class="manager-toolbar">
            <div class="row">
              <button id="btnAddCard" class="btn btn-primary">إضافة بطاقة</button>
              <button id="btnDeleteSelected" class="btn btn-outline" disabled>حذف المحدد</button>
              <button id="btnExportCards" class="btn btn-outline" disabled>تصدير Excel</button>
            </div>
            <div class="row filter-row">
              <div class="field">
                <label class="label" for="gradeFilter">الصف</label>
                <select id="gradeFilter" class="input">
                  <option value="">كل الصفوف</option>
                  <option value="1">الأول</option>
                  <option value="2">الثاني</option>
                  <option value="3">الثالث</option>
                  <option value="4">الرابع</option>
                  <option value="5">الخامس</option>
                  <option value="6">السادس</option>
                  <option value="7">السابع</option>
                  <option value="8">الثامن</option>
                  <option value="9">التاسع</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="classFilter">الشعبة</label>
                <select id="classFilter" class="input" disabled>
                  <option value="">كل الشعب</option>
                </select>
              </div>
            </div>
            <div class="row search-row">
              <div class="field w-100">
                <label class="label" for="searchInput">بحث سريع</label>
                <input id="searchInput" class="input" placeholder="ابحث برقم البطاقة أو العنوان" autocomplete="off" />
              </div>
              <button id="btnSearch" class="btn btn-outline">بحث</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table" aria-live="polite">
              <thead>
                <tr>
                  <th class="select-cell">
                    <input id="selectAllCards" type="checkbox" aria-label="تحديد الكل" />
                  </th>
                  <th>رقم البطاقة</th>
                  <th>العنوان</th>
                  <th>الصف</th>
                  <th>الشعب المستهدفة</th>
                  <th>المتطلب السابق</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="cardsBody">
                <tr>
                  <td colspan="7" class="muted center">تحميل البيانات...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — لوحة إدارة تجريبية</p>
    </footer>
  </div>

  <div id="cardModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle" class="h2">إضافة بطاقة</h2>
        <button id="btnCloseModal" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <form id="cardForm" class="modal-body">
        <div class="field" id="weekDisplayRow">
          <label class="label">معرف البطاقة</label>
          <div id="weekDisplay" class="help">—</div>
        </div>
        <div class="field">
          <label class="label" for="titleInput">العنوان</label>
          <input id="titleInput" class="input" autocomplete="off" required />
        </div>
        <div class="field">
          <label class="label" for="gradeInput">الصف</label>
          <select id="gradeInput" class="input" required>
            <option value="">اختر الصف</option>
            <option value="1">الأول</option>
            <option value="2">الثاني</option>
            <option value="3">الثالث</option>
            <option value="4">الرابع</option>
            <option value="5">الخامس</option>
            <option value="6">السادس</option>
            <option value="7">السابع</option>
            <option value="8">الثامن</option>
            <option value="9">التاسع</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="prereqSelect">المتطلب السابق</label>
          <select id="prereqSelect" class="input"></select>
          <div class="help">اختياري — تظهر بطاقات الصف نفسه فقط.</div>
        </div>
        <div class="field">
          <label class="label">الشعب المستهدفة</label>
          <label class="label" for="allClassesToggle">
            <input id="allClassesToggle" type="checkbox" checked />
            كل الشعب
          </label>
          <div id="classesPicker" class="field">
            <div class="row" id="classesOptions"></div>
            <div class="field">
              <label class="label" for="classesManual">إدخال يدوي (مفصول بفواصل)</label>
              <input id="classesManual" class="input" placeholder="مثال: 1,2,3" autocomplete="off" />
            </div>
          </div>
        </div>

        <div class="modal-footer modal-actions">
          <button id="btnSubmit" class="btn btn-primary" type="submit">حفظ</button>
          <button id="btnCancel" class="btn btn-outline" type="button">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirmModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-header">
        <h2 id="confirmTitle" class="h2">تأكيد الحذف</h2>
        <button id="btnCloseConfirm" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" class="p">هل أنت متأكد من حذف البطاقة؟</p>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnConfirmDelete" class="btn btn-primary" type="button">تأكيد الحذف</button>
        <button id="btnCancelDelete" class="btn btn-outline" type="button">إلغاء</button>
      </div>
    </div>
  </div>

  <div id="completionsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="completionsTitle">
      <div class="modal-header">
        <h2 id="completionsTitle" class="h2">من أنهى البطاقة</h2>
        <button id="btnCloseCompletions" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <div class="row space-between">
          <p id="completionsSubtitle" class="p muted">جاري التحميل...</p>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>رقم الطالب</th>
                <th>الاسم</th>
                <th>الشعبة</th>
                <th>النتيجة</th>
                <th>تاريخ الإكمال</th>
              </tr>
            </thead>
            <tbody id="completionsBody">
              <tr>
                <td colspan="5" class="muted center">تحميل البيانات...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module" src="/assets/js/mng/cardsManager.js"></script>
</body>
</html>
math/public/mng/students.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — إدارة الطلاب</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
  <link rel="stylesheet" href="/assets/css/mng/manager.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="math">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>لوحة إدارة الطلاب</span>
          </div>
        </div>

        <div class="row">
          <a class="btn btn-ghost btn-sm" href="/" aria-label="الصفحة الرئيسية">
            الرئيسية
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <div class="warning-banner" role="alert">
        ⚠️ صفحة إدارة تجريبية — لا تُدخل بيانات حقيقية
      </div>

      <section class="card manager-card">
        <div class="card-header">
          <div>
            <h1 class="h1">Student Manager</h1>
            <p class="p">إدارة بيانات الطلاب (عرض، إضافة، تعديل، حذف).</p>
          </div>
          <span class="badge primary">بدون تسجيل دخول</span>
        </div>

        <div class="card-body">
          <div class="manager-toolbar">
          <div class="row">
            <button id="btnAddStudent" class="btn btn-primary">إضافة طالب</button>
            <button id="btnImportStudents" class="btn btn-outline">استيراد من Excel</button>
            <button id="btnDeleteSelected" class="btn btn-outline" disabled>حذف المحدد</button>
            <button id="btnExportStudents" class="btn btn-outline" disabled>تصدير Excel</button>
          </div>
            <div class="row filter-row">
              <div class="field">
                <label class="label" for="gradeFilter">الصف</label>
                <select id="gradeFilter" class="input">
                  <option value="">كل الصفوف</option>
                  <option value="1">الأول</option>
                  <option value="2">الثاني</option>
                  <option value="3">الثالث</option>
                  <option value="4">الرابع</option>
                  <option value="5">الخامس</option>
                  <option value="6">السادس</option>
                  <option value="7">السابع</option>
                  <option value="8">الثامن</option>
                  <option value="9">التاسع</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="classFilter">الشعبة</label>
                <select id="classFilter" class="input" disabled>
                  <option value="">كل الشعب</option>
                </select>
              </div>
            </div>
            <div class="row search-row">
              <div class="field w-100">
                <label class="label" for="searchInput">بحث سريع</label>
                <input id="searchInput" class="input" placeholder="ابحث بالهوية أو الاسم" autocomplete="off" />
              </div>
              <button id="btnSearch" class="btn btn-outline">بحث</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table" aria-live="polite">
              <thead>
                <tr>
                  <th class="select-cell">
                    <input id="selectAllStudents" type="checkbox" aria-label="تحديد الكل" />
                  </th>
                  <th>رقم الهوية</th>
                  <th>سنة الميلاد</th>
                  <th>الاسم الرباعي</th>
                  <th>الصف</th>
                  <th>الشعبة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="studentsBody">
                <tr>
                  <td colspan="7" class="muted center">تحميل البيانات...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="studentsPagination" class="pagination" aria-label="الصفحات"></div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — لوحة إدارة تجريبية</p>
    </footer>
  </div>

  <div id="studentModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle" class="h2">إضافة طالب</h2>
        <button id="btnCloseModal" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <form id="studentForm" class="modal-body">
        <div class="field">
          <label class="label" for="studentIdInput">رقم الهوية</label>
          <input id="studentIdInput" class="input ltr" inputmode="numeric" autocomplete="off" required />
        </div>
        <div class="field">
          <label class="label">تاريخ الميلاد</label>
          <div class="wheel-row">
            <div id="wheelYear" class="wheel" aria-label="السنة"></div>
            <div id="wheelMonth" class="wheel" aria-label="الشهر"></div>
            <div id="wheelDay" class="wheel" aria-label="اليوم"></div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="nameInput">الاسم الرباعي</label>
          <input id="nameInput" class="input" autocomplete="off" required />
        </div>
        <div class="field">
          <label class="label" for="firstNameInput">الاسم الأول</label>
          <input id="firstNameInput" class="input" autocomplete="off" />
        </div>
        <div class="field">
          <label class="label">الصف</label>
          <div id="wheelGrade" class="wheel" aria-label="الصف"></div>
        </div>
        <div class="field">
          <label class="label" for="classInput">الشعبة</label>
          <input id="classInput" class="input" autocomplete="off" />
        </div>

        <div class="modal-footer modal-actions">
          <button id="btnSubmit" class="btn btn-primary" type="submit">حفظ</button>
          <button id="btnCancel" class="btn btn-outline" type="button">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirmModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-header">
        <h2 id="confirmTitle" class="h2">تأكيد الحذف</h2>
        <button id="btnCloseConfirm" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" class="p">هل أنت متأكد من حذف الطالب؟</p>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnConfirmDelete" class="btn btn-primary" type="button">تأكيد الحذف</button>
        <button id="btnCancelDelete" class="btn btn-outline" type="button">إلغاء</button>
      </div>
    </div>
  </div>

  <div id="importModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-lg" role="dialog" aria-modal="true" aria-labelledby="importTitle">
      <div class="modal-header">
        <h2 id="importTitle" class="h2">استيراد الطلاب من Excel</h2>
        <button id="btnCloseImport" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <div class="import-grid">
          <div class="field">
            <label class="label" for="importFile">ملف Excel أو CSV</label>
            <input id="importFile" class="input" type="file" accept=".xlsx,.csv" />
          </div>
          <div class="field field-inline">
            <label class="label" for="importHasHeader">
              <input id="importHasHeader" type="checkbox" checked />
              الصف الأول يحتوي عناوين
            </label>
          </div>
        </div>

        <div class="import-preview">
          <h3 class="h3">معاينة البيانات (أول 10 صفوف)</h3>
          <div class="preview-table">
            <table class="table table-compact" aria-live="polite">
              <thead id="importPreviewHead"></thead>
              <tbody id="importPreviewBody">
                <tr>
                  <td class="muted center">اختر ملفًا لعرض المعاينة.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="import-mapping">
          <h3 class="h3">تعيين الأعمدة</h3>
          <div class="mapping-grid">
            <div class="field">
              <label class="label" for="mapStudentId">رقم الهوية (إلزامي)</label>
              <select id="mapStudentId" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapName">الاسم (إلزامي)</label>
              <select id="mapName" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapBirthDate">تاريخ الميلاد (إلزامي)</label>
              <select id="mapBirthDate" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapGrade">الصف (اختياري)</label>
              <select id="mapGrade" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapClass">الشعبة (اختياري)</label>
              <select id="mapClass" class="input"></select>
            </div>
          </div>
        </div>

        <div class="import-actions">
          <button id="btnImportValidate" class="btn btn-outline" type="button">تحقق</button>
          <button id="btnImportExecute" class="btn btn-primary" type="button" disabled>تنفيذ الاستيراد</button>
        </div>

        <div class="import-progress">
          <div class="progress-header">
            <span class="muted">تقدّم التنفيذ</span>
            <span id="importProgressLabel" class="muted">0%</span>
          </div>
          <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div id="importProgressBar" class="progress-bar"></div>
          </div>
        </div>

        <div class="import-results">
          <h3 class="h3">النتائج</h3>
          <div id="importSummary" class="result-summary muted">لم يتم تنفيذ أي عملية بعد.</div>
          <div class="result-actions">
            <button id="btnDownloadSkipped" class="btn btn-outline btn-sm" type="button" disabled>تنزيل تقرير المتخطّين</button>
            <button id="btnDownloadErrors" class="btn btn-outline btn-sm" type="button" disabled>تنزيل تقرير الأخطاء</button>
          </div>
          <div class="field">
            <label class="label" for="importTeacherNote">نص موجّه للمعلم (قابل للنسخ)</label>
            <textarea id="importTeacherNote" class="input" rows="4" readonly></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnCancelImport" class="btn btn-outline" type="button">إغلاق</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module" src="/assets/js/mng/studentsManager.js"></script>
</body>
</html>
math/sql/migrations/2026-01-21_weeks_grade_weektargets.sql
IF COL_LENGTH('dbo.Weeks', 'Grade') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD Grade NVARCHAR(50) NULL;
END

IF COL_LENGTH('dbo.Weeks', 'IsDeleted') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD IsDeleted BIT NOT NULL
      CONSTRAINT DF_Weeks_IsDeleted DEFAULT(0);
END

IF OBJECT_ID('dbo.WeekTargets', 'U') IS NULL
BEGIN
  CREATE TABLE dbo.WeekTargets (
    Week INT NOT NULL,
    Class NVARCHAR(50) NOT NULL,
    CONSTRAINT PK_WeekTargets PRIMARY KEY (Week, Class),
    CONSTRAINT FK_WeekTargets_Weeks FOREIGN KEY (Week) REFERENCES dbo.Weeks(Week)
  );
END

IF OBJECT_ID('dbo.WeekTargets', 'U') IS NOT NULL
  AND NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IX_WeekTargets_Class'
      AND object_id = OBJECT_ID('dbo.WeekTargets')
  )
BEGIN
  CREATE INDEX IX_WeekTargets_Class ON dbo.WeekTargets(Class);
END

IF OBJECT_ID('dbo.WeekTargets', 'U') IS NOT NULL
  AND NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IX_WeekTargets_Week'
      AND object_id = OBJECT_ID('dbo.WeekTargets')
  )
BEGIN
  CREATE INDEX IX_WeekTargets_Week ON dbo.WeekTargets(Week);
END
math/public/assets/cert/certificate.css
/* =========================================================
   certificate.css — Certificate Page Styles (Light Material)
   هدف النسخة الحالية:
   - الشهادة تظهر كاملة داخل شاشة الجوال (Screenshot واحد بدون سكرول)
   - إخفاء أزرار الأكشن على الجوال عشان ما تزود الارتفاع
   ========================================================= */

.cert-app {
  background: #f6f7fb;
  min-height: 100vh;
}

.cert-shell {
  width: 100%;
  display: grid;
  place-items: center;
  min-height: calc(100vh - 120px);
  padding-bottom: 120px;
}

/* Certificate Paper */
.cert-paper {
  position: relative;
  background: #fff;
  border-radius: 16px;
  padding: 40px 36px 32px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
  border: 2px solid rgba(37, 99, 235, 0.15);
  aspect-ratio: 1 / 1;
  width: min(92vw, 560px);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  overflow: hidden;
}

/* Subtle background */
.cert-bg {
  position: absolute;
  inset: -20% -10% auto auto;
  width: 420px;
  height: 420px;
  background: radial-gradient(closest-side, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0));
  pointer-events: none;
}

/* Header */
.cert-head {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 16px;
  align-items: center;
  margin-bottom: 24px;
}

.cert-badge {
  font-size: 44px;
  line-height: 1;
}

.cert-title {
  font-size: 32px;
  margin: 0;
}

.cert-sub {
  margin: 4px 0 0;
  color: #64748b;
}

.cert-brand {
  font-weight: 700;
  color: #2563eb;
  letter-spacing: 0.4px;
}

/* Body */
.cert-body {
  margin-top: 8px;
}

.cert-line {
  margin: 18px 0 6px;
  color: #475569;
  font-size: 14px;
}

.cert-name {
  font-size: 34px;
  font-weight: 800;
  letter-spacing: 0.2px;
  color: #0f172a;
  padding: 6px 0 2px;
}

.cert-card {
  font-size: 22px;
  font-weight: 700;
  color: #1e293b;
  padding: 4px 0 10px;
}

.cert-id {
  font-size: 12px;
  color: #64748b;
}

/* Meta */
.cert-meta {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 20px;
}

.cert-meta-item {
  background: #f8fafc;
  border: 1px dashed #e5e7eb;
  border-radius: 12px;
  padding: 10px 12px;
  text-align: center;
}

.cert-meta-k {
  display: block;
  font-size: 12px;
  color: #64748b;
}

.cert-meta-v {
  display: block;
  margin-top: 2px;
  font-weight: 700;
  color: #0f172a;
}

/* Footer */
.cert-footer {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 16px;
  align-items: center;
  margin-top: 28px;
}

.cert-sign {
  display: flex;
  gap: 8px;
  align-items: baseline;
}

.cert-sign-k {
  font-size: 12px;
  color: #64748b;
}

.cert-sign-v {
  font-weight: 700;
}

/* Stamp */
.cert-stamp {
  position: relative;
  width: 86px;
  height: 86px;
}

.cert-stamp-ring {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid #2563eb;
  opacity: 0.9;
}

.cert-stamp-text {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-weight: 800;
  color: #2563eb;
  transform: rotate(-12deg);
}

/* Actions */
.cert-actions {
  position: fixed;
  inset: auto 0 0;
  z-index: 20;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
  background: rgba(246, 247, 251, 0.95);
  border-top: 1px solid rgba(15, 23, 42, 0.08);
  backdrop-filter: blur(8px);
}

.btn-whatsapp {
  background: #22c55e;
  color: #fff;
}

.btn-whatsapp:hover {
  background: #16a34a;
}

.cert-notice {
  position: fixed;
  top: 88px;
  right: 16px;
  left: 16px;
  background: #fff7ed;
  color: #9a3412;
  border: 1px solid #fed7aa;
  border-radius: 12px;
  padding: 12px 16px;
  box-shadow: 0 10px 18px rgba(15, 23, 42, 0.08);
  z-index: 25;
  font-size: 13px;
}

/* Empty */
#certEmpty.card {
  margin-top: 16px;
}

/* Print */
@media print {
  body {
    background: #fff;
  }

  .topbar,
  .cert-actions {
    display: none !important;
  }

  .cert-paper {
    box-shadow: none;
    border-radius: 0;
    padding: 24mm 20mm;
  }

  @page {
    size: A4;
    margin: 10mm;
  }
}

/* =========================================================
   Mobile Screenshot Mode (default on small screens)
   - Center certificate
   - Fit inside viewport (no scroll)
   - Hide actions to keep one-shot screenshot
   ========================================================= */
@media (max-width: 640px) {
  /* make page fit screen */
  html, body {
    height: 100%;
    overflow: hidden;
  }

  .container.section {
    padding-block: 12px;
  }

  .cert-shell {
    height: calc(100vh - 72px); /* تقريبًا ارتفاع topbar */
    display: grid;
    place-items: center;
    padding-bottom: 100px;
  }

  /* Fit paper into viewport */
  .cert-paper {
    width: min(94vw, 420px);
    max-height: calc(100vh - 140px);
    padding: 18px 16px 14px;
    box-shadow: 0 14px 30px rgba(15, 23, 42, 0.10);
    overflow: hidden;
  }

  .cert-bg {
    width: 320px;
    height: 320px;
    inset: -25% -20% auto auto;
  }

  .cert-head {
    gap: 12px;
    margin-bottom: 14px;
  }

  .cert-badge {
    font-size: 34px;
  }

  .cert-title {
    font-size: 22px;
  }

  .cert-sub {
    font-size: 12px;
  }

  .cert-line {
    margin: 10px 0 4px;
    font-size: 12px;
  }

  .cert-name {
    font-size: 22px;
    padding: 2px 0 2px;
  }

  .cert-card {
    font-size: 15px;
    padding: 2px 0 6px;
  }

  .cert-meta {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
  }

  .cert-meta-item {
    padding: 8px 8px;
    border-radius: 10px;
  }

  .cert-meta-k {
    font-size: 11px;
  }

  .cert-meta-v {
    font-size: 12px;
  }

  .cert-footer {
    margin-top: 12px;
    grid-template-columns: 1fr auto;
    gap: 10px;
  }

  .cert-stamp {
    width: 64px;
    height: 64px;
  }

  .cert-stamp-ring {
    border-width: 2px;
  }

  .cert-sign-k {
    font-size: 11px;
  }

  .cert-sign-v {
    font-size: 12px;
  }
}
math/public/assets/css/base.css
/* =========================================================
   base.css — Light Material Design System (Arabic-first)
   - Daylight theme, soft shadows, rounded buttons/cards
   - Mobile-first, responsive container
   - Works for index.html + lesson.html
   ========================================================= */

/* ---------- Fonts (system + Arabic-friendly fallbacks) ---------- */
:root{
  /* Typography */
  --font-sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Kufi Arabic", "Cairo", "Tajawal", Arial, sans-serif;

  /* Colors (Light Material) */
  --bg: #f6f8fc;
  --surface: #ffffff;
  --surface-2: #eef2f9;
  --text: #0b1324;
  --muted: #586174;
  --border: rgba(15, 23, 42, 0.08);

  /* Brand */
  --primary: #2563eb;
  --primary-600: #1d4ed8;
  --primary-100: rgba(37, 99, 235, 0.12);

  --success: #16a34a;
  --warning: #f59e0b;
  --danger:  #dc2626;

  /* Completion (Gold) */
  --gold: #d4af37;
  --gold-2: #f5d76e;
  --gold-surface: rgba(212, 175, 55, 0.12);

  /* Radii */
  --r-xs: 10px;
  --r-sm: 14px;
  --r-md: 18px;
  --r-lg: 24px;

  /* Shadows (soft) */
  --shadow-xs: 0 1px 2px rgba(15,23,42,.05), 0 1px 1px rgba(15,23,42,.03);
  --shadow-sm: 0 10px 20px rgba(15,23,42,.08);
  --shadow-md: 0 18px 36px rgba(15,23,42,.10);
  --shadow-lg: 0 30px 68px rgba(15,23,42,.14);
  --shadow-soft: 0 12px 34px rgba(15,23,42,.08);

  /* Spacing */
  --container: 1040px;
  --pad: 18px;

  /* Focus */
  --focus: 0 0 0 4px rgba(37, 99, 235, 0.18);
}

/* ---------- Reset & Base ---------- */
*{ box-sizing: border-box; }
html, body{ height:100%; }
html{ -webkit-text-size-adjust:100%; }
body{
  margin:0;
  font-family: var(--font-sans);
  background: radial-gradient(1200px 700px at 80% -10%, rgba(37,99,235,.08), transparent 60%),
              radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.08), transparent 55%),
              var(--bg);
  color: var(--text);
  line-height: 1.75;
  direction: rtl;
  font-weight: 500;
  letter-spacing: 0;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

body.is-loading #screen-id,
body.is-loading #screen-welcome,
body.is-loading #screen-cards{
  display: none !important;
}

.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.loading-overlay.hidden {
  display: none;
}

.loading-panel {
  background: var(--surface);
  padding: 18px 22px;
  border-radius: var(--r-md);
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  gap: 12px;
}

.loading-spinner {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 3px solid rgba(37, 99, 235, 0.2);
  border-top-color: var(--primary);
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

img{ max-width:100%; display:block; }
a{ color: inherit; text-decoration: none; }
button, input, select, textarea{
  font: inherit;
  color: inherit;
}
::selection{
  background: rgba(37, 99, 235, 0.18);
}

/* ---------- Layout ---------- */
.app{
  min-height: 100%;
  display:flex;
  flex-direction: column;
}
.container{
  width: min(var(--container), calc(100% - (var(--pad) * 2)));
  margin-inline: auto;
}
.section{
  padding-block: 28px;
}
.stack{ display:flex; flex-direction: column; gap: 18px; }
.row{ display:flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.grid{
  display:grid;
  gap: 18px;
}
.grid.cards{
  grid-template-columns: repeat(1, minmax(0, 1fr));
}
@media (min-width: 560px){
  .grid.cards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (min-width: 920px){
  .grid.cards{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
}

/* ---------- Top Bar ---------- */
.topbar{
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(246,248,252,.92);
  backdrop-filter: blur(14px);
  border-bottom: 1px solid rgba(15,23,42,.08);
  box-shadow: 0 6px 14px rgba(15,23,42,.04);
}
.topbar-inner{
  padding: 14px 0;
  display:flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
.brand{
  display:flex;
  align-items:center;
  gap: 10px;
  user-select:none;
}
.brand-mark{
  width: 38px;
  height: 38px;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(99,102,241,.90));
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow:hidden;
}
.brand-mark::after{
  content:"";
  position:absolute;
  inset: -40% -40% auto auto;
  width: 70px;
  height: 70px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 55%);
  transform: rotate(25deg);
}
.brand-title{
  display:flex;
  flex-direction: column;
  line-height: 1.2;
}
.brand-title b{
  font-size: 16px;
  letter-spacing: .2px;
}
.brand-title span{
  font-size: 12px;
  color: var(--muted);
}

/* ---------- Typography ---------- */
.h1{
  font-size: 25px;
  font-weight: 800;
  margin: 0;
  letter-spacing: .1px;
}
.h2{
  font-size: 20px;
  font-weight: 800;
  margin: 0;
}
.p{
  margin: 0;
  color: var(--muted);
  font-size: 15px;
}
.small{ font-size: 12px; color: var(--muted); }
.kbd{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 2px 8px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--surface);
  font-size: 12px;
  box-shadow: var(--shadow-xs);
}

/* ---------- Card ---------- */
.card{
  position: relative;
  overflow: hidden;
  background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-sm);
  padding: 20px;
  transition: box-shadow .2s ease, transform .2s ease;
}
.card::after{
  content:"";
  position:absolute;
  inset: 0;
  background: radial-gradient(320px 120px at 15% -20%, rgba(37,99,235,.08), transparent 70%);
  opacity: .7;
  pointer-events: none;
}
@media (hover: hover){
  .card:hover{
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
  }
}
.card.soft{
  background: linear-gradient(180deg, var(--surface), var(--surface-2));
}
.card-header{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.card-title{
  font-weight: 800;
  font-size: 16px;
  margin: 0;
}
.card-subtitle{
  margin: 6px 0 0;
  font-size: 13px;
  color: var(--muted);
}
.card-body{ display:flex; flex-direction: column; gap: 12px; }
.card-footer{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-top: 14px;
}

/* ---------- Buttons ---------- */
.btn{
  appearance:none;
  border: 1px solid transparent;
  border-radius: 999px;
  padding: 12px 18px;
  min-height: 44px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  font-weight: 800;
  font-size: 15px;
  user-select:none;
  transition: transform .08s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
}
.btn:active{ transform: translateY(1px); }
.btn:disabled{
  opacity: .55;
  cursor:not-allowed;
  transform:none;
}
.btn-primary{
  background: linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1));
  color:#fff;
  box-shadow: 0 12px 26px rgba(37,99,235,.20);
}
.btn-primary:hover{ box-shadow: 0 16px 34px rgba(37,99,235,.26); }
.btn-outline{
  background: rgba(255,255,255,.9);
  border-color: rgba(15,23,42,.14);
  color: var(--text);
  box-shadow: var(--shadow-xs);
}
.btn-outline:hover{
  background: var(--surface);
  box-shadow: var(--shadow-sm);
}
.btn-ghost{
  background: transparent;
  border-color: transparent;
  color: var(--text);
}
.btn-ghost:hover{
  background: rgba(17,24,39,.06);
}
.btn-sm{ padding: 9px 12px; font-size: 13px; min-height: 36px; }
.btn-lg{ padding: 14px 20px; font-size: 16px; }

/* ---------- Inputs ---------- */
.field{
  display:flex;
  flex-direction: column;
  gap: 8px;
}
.label{
  font-size: 14px;
  color: var(--muted);
  font-weight: 700;
}
.input{
  width: 100%;
  border: 1px solid rgba(15,23,42,.14);
  background: linear-gradient(180deg, #ffffff 0%, #f7faff 100%);
  border-radius: 16px;
  padding: 13px 14px;
  min-height: 44px;
  box-shadow: var(--shadow-xs);
  outline: none;
  transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
  font-size: 15px;
}
.input.is-static{
  display:flex;
  align-items:center;
  color: var(--text);
  user-select: text;
}
.input::placeholder{ color: rgba(107,114,128,.85); }
.input:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: var(--focus), var(--shadow-sm);
  background: #fff;
}
.help{
  font-size: 12px;
  color: var(--muted);
}

/* ---------- Badges & Status ---------- */
.badge{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 800;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.8);
}
.badge.primary{
  border-color: rgba(37,99,235,.22);
  background: rgba(37,99,235,.10);
  color: var(--primary-600);
}
.badge.locked{
  border-color: rgba(17,24,39,.14);
  background: rgba(17,24,39,.06);
  color: var(--muted);
}
.badge.disabled{
  border-color: rgba(148,163,184,.45);
  background: rgba(226,232,240,.6);
  color: rgba(100,116,139,.95);
}
.badge.done{
  border-color: rgba(212,175,55,.40);
  background: var(--gold-surface);
  color: #6b4f00;
}

/* ---------- Card States (Locked / Done) ---------- */
.card.is-locked{
  opacity: .72;
  filter: grayscale(.05);
}
.card.is-locked .card-title{ color: rgba(17,24,39,.80); }
.card.is-disabled{
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
  border-color: rgba(148,163,184,.35);
  opacity: .72;
  box-shadow: var(--shadow-xs);
}
.card.is-disabled::after{
  opacity: .35;
}
.card.is-disabled:hover{
  transform: none;
  box-shadow: var(--shadow-xs);
}
.card.is-done{
  border-color: rgba(212,175,55,.65);
  background:
    radial-gradient(700px 220px at 80% -40%, rgba(245,215,110,.28), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,1), rgba(255,248,226,1));
}
.star{
  width: 26px;
  height: 26px;
  border-radius: 10px;
  background: linear-gradient(180deg, var(--gold-2), var(--gold));
  box-shadow: 0 10px 18px rgba(212,175,55,.22);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 auto;
}
.star svg{
  width: 16px;
  height: 16px;
  fill: #6b4f00;
}

/* ---------- Divider ---------- */
.hr{
  border: none;
  height: 1px;
  background: rgba(15,23,42,.10);
  margin: 12px 0;
}

/* ---------- Focus ring for buttons/links ---------- */
:focus-visible{
  outline: none;
  box-shadow: var(--focus);
  border-radius: 14px;
}

/* ---------- Utility ---------- */
.hidden,
[hidden]{ display:none !important; }
.center{ text-align:center; }
.muted{ color: var(--muted); }
.spacer{ height: 10px; }
.w-100{ width:100%; }
.nowrap{ white-space:nowrap; }
.ltr{ direction:ltr; }
.rtl{ direction:rtl; }

@media (max-width: 640px){
  .topbar-inner{ padding: 12px 0; }
  .section{ padding-block: 22px; }
  .card{ padding: 16px; }
  .card-header{ flex-direction: column; align-items: flex-start; }
  .h1{ font-size: 22px; }
  .h2{ font-size: 18px; }
  .p{ font-size: 14px; }
  .btn{ width: 100%; }
  .btn.btn-sm{ width: auto; }
}
math/public/assets/css/lesson.css
/* =========================================================
   lesson.css — Lesson Page Layout & Progress (Light Material)
   Depends on base.css
   ========================================================= */

/* ---------- Header (Lesson Title) ---------- */
.lesson-header{
  margin-top: 14px;
}
.lesson-title{
  display:flex;
  flex-direction: column;
  gap: 6px;
}
.lesson-title .h1{
  font-size: 23px;
}
.lesson-meta{
  display:flex;
  gap: 12px;
  align-items:center;
  flex-wrap: wrap;
}
.lesson-student{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 12px;
  border-radius: 999px;
  background: rgba(37,99,235,.10);
  border: 1px solid rgba(37,99,235,.18);
  font-size: 12px;
  font-weight: 800;
}

/* ---------- Progress Bar ---------- */
.progress-wrap{
  margin: 20px 0 24px;
}
.progress-label{
  display:flex;
  align-items:center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.progress-label span{
  font-size: 12px;
  color: var(--muted);
  font-weight: 800;
}
.progress{
  height: 14px;
  border-radius: 999px;
  background: rgba(17,24,39,.10);
  overflow: hidden;
  box-shadow: inset 0 1px 2px rgba(17,24,39,.12);
}
.progress > i{
  display:block;
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, rgba(37,99,235,1), rgba(99,102,241,1));
  border-radius: 999px;
  transition: width .28s ease;
}

/* ---------- Concept Card ---------- */
.concept{
  margin-bottom: 22px;
}
.concept .card{
  padding: 20px;
}
.concept-header{
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 14px;
  flex-wrap: wrap;
}
.concept-index{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 34px;
  height: 34px;
  border-radius: 14px;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.18);
  font-weight: 900;
  font-size: 14px;
}
.concept-title{
  font-size: 18px;
  font-weight: 900;
  margin: 0;
}
.concept-body{
  display:flex;
  flex-direction: column;
  gap: 16px;
}
.lesson-stage{
  display:flex;
  flex-direction: column;
  gap: 16px;
  padding: 20px;
}
.stage-header{
  display:flex;
  flex-direction: column;
  gap: 6px;
}
.stage-badge{
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.18);
  font-size: 12px;
  font-weight: 800;
}
.stage-title{
  font-size: 18px;
  font-weight: 900;
  margin: 0;
}
.stage-desc{
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}
.stage-body{
  display:flex;
  flex-direction: column;
  gap: 12px;
}
.stage-empty{
  padding: 12px;
  border-radius: 12px;
  background: rgba(17,24,39,.04);
  border: 1px dashed rgba(17,24,39,.12);
  font-size: 14px;
  color: var(--muted);
}
.stage-progress{
  display:flex;
  flex-direction: column;
  gap: 12px;
  padding-bottom: 12px;
  margin-bottom: 12px;
  border-bottom: 1px solid rgba(17,24,39,.08);
}
.goal-list,
.goal-progress{
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.goal-item{
  display:flex;
  gap: 10px;
  align-items:center;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(17,24,39,.08);
  background: rgba(255,255,255,.9);
}
.goal-index{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.2);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 12px;
  font-weight: 900;
}
.goal-progress-item{
  display:flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(17,24,39,.08);
  background: rgba(255,255,255,.9);
}
.goal-progress-item .goal-text{
  font-size: 15px;
}
.goal-progress-item.done{
  border-color: rgba(16,185,129,.4);
  background: rgba(16,185,129,.08);
}
.goal-progress-item.current{
  border-color: rgba(37,99,235,.4);
  background: rgba(37,99,235,.08);
}
.goal-progress-item.current .goal-text{
  font-weight: 900;
}
.goal-progress-item.upcoming{
  color: rgba(17,24,39,.6);
  background: rgba(17,24,39,.03);
}
.goal-progress-item.muted{
  color: rgba(17,24,39,.5);
}
.goal-status{
  font-size: 12px;
  font-weight: 800;
  color: var(--muted);
}
.goal-progress-item.current .goal-status{
  color: #1d4ed8;
}
.goal-progress-item.done .goal-status{
  color: #16a34a;
}

/* ---------- Steps ---------- */
.step{
  border-radius: 16px;
  padding: 16px;
  border: 1px dashed rgba(17,24,39,.14);
  background: rgba(255,255,255,.86);
  box-shadow: var(--shadow-xs);
}
.step-title{
  font-weight: 900;
  font-size: 14px;
  margin: 0 0 6px;
}
.step-text{
  font-size: 15px;
  color: var(--text);
}
.step.muted{
  background: rgba(17,24,39,.04);
}
.step.example{
  background: rgba(37,99,235,.06);
  border-style: solid;
}
.step.warning{
  background: rgba(245,158,11,.10);
  border-style: solid;
}
.step.note{
  background: rgba(16,185,129,.08);
  border-style: solid;
}
.step.detail{
  background: rgba(99,102,241,.08);
  border-style: solid;
}
.step-details{
  margin: 10px 0 0;
  padding-inline-start: 18px;
  color: var(--muted);
  font-size: 14px;
}
.step.video{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.video-frame{
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(17,24,39,.12);
  background: rgba(17,24,39,.04);
}
.video-embed{
  width: 100%;
  min-height: 240px;
  border: 0;
  display: block;
}
.video-empty{
  padding: 16px;
  font-size: 14px;
  color: var(--muted);
}

/* ---------- Question Area ---------- */
.question-wrap{
  margin-top: 10px;
  padding: 18px;
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,1), rgba(243,245,251,1));
  border: 1px solid rgba(17,24,39,.14);
  box-shadow: var(--shadow-sm);
}
.question-title{
  font-size: 17px;
  font-weight: 900;
  margin: 0 0 10px;
}
.question-actions{
  display:flex;
  gap: 10px;
  align-items:center;
  justify-content: space-between;
  flex-wrap: wrap;
  margin-top: 12px;
}

/* ---------- Attempts / Status ---------- */
.attempts{
  display:flex;
  gap: 6px;
  align-items:center;
}
.dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: rgba(17,24,39,.18);
}
.dot.used{
@@ -173,49 +175,54 @@
}

/* ---------- Solution Box ---------- */
.solution{
  margin-top: 12px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(220,38,38,.06);
  border: 1px solid rgba(220,38,38,.18);
}
.solution-title{
  font-size: 13px;
  font-weight: 900;
  margin: 0 0 6px;
}
.solution-text{
  font-size: 14px;
}

/* ---------- Navigation Buttons ---------- */
.lesson-nav{
  display:flex;
  gap: 10px;
  justify-content: space-between;
  margin-top: 16px;
  flex-wrap: wrap;
}
.lesson-nav .btn{
  min-width: 120px;
}
.assessment{
  border: 1px solid rgba(37,99,235,.12);
}
.assessment-body{
  display:flex;
  flex-direction: column;
  gap: 14px;
}
.assessment-question{
  border-radius: 14px;
  padding: 12px;
  border: 1px dashed rgba(17,24,39,.12);
  background: rgba(255,255,255,.92);
}
.assessment-title{
  font-weight: 800;
  margin: 0 0 8px;
}
.assessment-result{
  margin-top: 16px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(37,99,235,.2);
  display:flex;
  flex-direction: column;
  gap: 8px;
}
.assessment-score{
  font-size: 15px;
}
.assessment-note{
  font-size: 13px;
  color: var(--muted);
}

/* ---------- Completion State ---------- */
.lesson-complete{
  margin-top: 18px;
}
.lesson-complete .card{
  border-color: rgba(212,175,55,.65);
  background:
    radial-gradient(800px 240px at 80% -40%, rgba(245,215,110,.28), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,1), rgba(255,248,226,1));
}
.lesson-complete .h2{
  color: #6b4f00;
}

/* ---------- Responsive tweaks ---------- */
@media (max-width: 480px){
  .lesson-title .h1{ font-size: 20px; }
  .lesson-meta{ gap: 8px; }
  .progress{ height: 12px; }
  .question-wrap{ padding: 12px; }
  .lesson-nav{ flex-direction: column; }
  .lesson-nav .btn{ width: 100%; }
}
math/public/assets/css/mng/card-editor.css
.page-shell {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.editor-header {
  background: #fff;
  border-bottom: 1px solid #e5e7eb;
  padding: 16px 0;
}

.editor-header .header-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

.editor-title {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
}

.editor-subtitle {
  margin: 4px 0 0;
  color: #6b7280;
  font-size: 14px;
}

.editor-layout {
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: 20px;
  padding: 20px 0 80px;
}

.editor-sidebar {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  position: sticky;
  top: 16px;
  height: fit-content;
}

.sidebar-title {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 12px;
}

.sidebar-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 8px;
}

.sidebar-item {
  padding: 10px 12px;
  border-radius: 10px;
  cursor: pointer;
  background: #f3f4f6;
  color: #111827;
  font-size: 14px;
}

.sidebar-item.active {
  background: #2563eb;
  color: #fff;
}

.editor-panel {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
  min-height: 400px;
}

.section-title {
  font-size: 18px;
  margin: 0 0 12px;
}

.item-card {
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  background: #f9fafb;
}

.item-card .row {
  gap: 8px;
}

.item-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.small-btn {
  padding: 4px 8px;
  font-size: 12px;
}

.flow-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  background: #eef2ff;
  color: #4f46e5;
  font-size: 12px;
  margin-bottom: 10px;
}

.inline-input {
  margin-top: 8px;
}

.floating-actions {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: grid;
  gap: 8px;
  z-index: 20;
}

.floating-actions .btn {
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
}

.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

@media (max-width: 960px) {
  .editor-layout {
    grid-template-columns: 1fr;
  }

  .editor-sidebar {
    position: static;
  }

  .floating-actions {
    right: 12px;
    bottom: 12px;
  }
}
math/public/assets/css/mng/manager.css
.warning-banner {
  background: rgba(245, 158, 11, 0.14);
  border: 1px solid rgba(245, 158, 11, 0.3);
  color: #8a4b00;
  padding: 12px 16px;
  border-radius: var(--r-md);
  box-shadow: var(--shadow-xs);
  margin-bottom: 16px;
  font-size: 14px;
}

.manager-card .card-body {
  gap: 16px;
}

.manager-toolbar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.search-row {
  align-items: flex-end;
}

.table-wrap {
  width: 100%;
  overflow: auto;
  max-height: 70vh;
  border-radius: var(--r-lg);
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-xs);
}

.table {
  width: 100%;
  border-collapse: collapse;
  min-width: 720px;
}

.table th,
.table td {
  padding: 6px 8px;
  text-align: right;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.table th {
  background: rgba(37, 99, 235, 0.06);
  color: var(--muted);
  font-weight: 800;
  position: sticky;
  top: 0;
  z-index: 1;
}

.table tbody tr:hover {
  background: rgba(37, 99, 235, 0.04);
}

.table td.actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  width: 132px;
  min-width: 132px;
}

.table .select-cell {
  width: 36px;
  text-align: center;
}

.icon-btn {
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--r-sm);
}

.pagination {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  flex-wrap: wrap;
}

.pagination-pages {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.pagination .btn.is-active {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
}

.modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
  max-height: 92vh;
}

.modal.hidden {
  display: none;
}

.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.4);
  backdrop-filter: blur(4px);
}

.modal-card {
  position: relative;
  background: var(--surface);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-lg);
  width: min(720px, 96vw);
  max-height: 92vh;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 1;
}

.modal-card-sm {
  width: min(420px, 92vw);
}

.modal-card-lg {
  width: min(960px, 96vw);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.modal-body {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: calc(92vh - 180px);
  overflow: auto;
}

.modal-footer {
  position: sticky;
  bottom: 0;
  background: var(--surface);
  padding-top: 8px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.import-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
  align-items: end;
}

.field-inline .label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.import-preview,
.import-mapping,
.import-results {
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 12px;
  background: rgba(37, 99, 235, 0.04);
}

.import-preview h3,
.import-mapping h3,
.import-results h3 {
  margin-bottom: 8px;
}

.preview-table {
  max-height: 220px;
  overflow: auto;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--surface);
}

.table-compact {
  min-width: 100%;
}

.table-compact th,
.table-compact td {
  font-size: 13px;
  padding: 6px;
}

.mapping-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.import-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.import-progress {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.progress-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 13px;
}

.progress-track {
  height: 10px;
  background: #e2e8f0;
  border-radius: 999px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  width: 0%;
  background: var(--primary);
  transition: width 0.2s ease;
}

.result-summary {
  white-space: pre-line;
}

.result-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 8px 0;
}

.wheel-row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: nowrap;
}

.wheel {
  width: 110px;
  height: 120px;
  overflow-y: auto;
  scroll-snap-type: y mandatory;
  border: 1px solid #ddd;
  border-radius: 10px;
  position: relative;
  padding: 40px 0;
  background: #fff;
}

.wheel-item {
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  scroll-snap-align: center;
  color: var(--muted);
}

.wheel-item.is-selected {
  color: var(--text);
  font-weight: 700;
}

.wheel::after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  height: 40px;
  border-top: 1px solid #bbb;
  border-bottom: 1px solid #bbb;
  pointer-events: none;
  background: rgba(0, 0, 0, 0.03);
}

@media (max-width: 640px) {
  .modal-card-lg {
    width: min(720px, 96vw);
  }

  .table {
    min-width: 600px;
  }

  .modal-actions .btn {
    width: 100%;
  }

  .wheel {
    width: 96px;
  }
}

@media (max-width: 520px) {
  .wheel-row {
    flex-wrap: wrap;
  }
}
math/public/assets/css/questions.css
/* =========================================================
   questions.css — Question Types Styling (Light Material)
   Depends on base.css
   ========================================================= */

/* ---------- Common Question Block ---------- */
.q{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.q-desc{
  font-size: 15px;
  color: var(--text);
  line-height: 1.75;
}

/* ---------- Input Question ---------- */
.q-input{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.q-input .input{
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  letter-spacing: .3px;
}
.q-input .hint{
  font-size: 12px;
  color: var(--muted);
}

/* ---------- MCQ ---------- */
.q-mcq{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
.q-mcq .choice{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 14px 16px;
  min-height: 48px;
  border-radius: 16px;
  border: 1px solid rgba(17,24,39,.14);
  background: rgba(255,255,255,.9);
  box-shadow: var(--shadow-xs);
  cursor:pointer;
  transition: background .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.q-mcq .choice:hover{
  background: #fff;
  box-shadow: var(--shadow-sm);
}
.q-mcq .choice input{
  accent-color: var(--primary);
  cursor:pointer;
}
.q-mcq .choice.correct{
  border-color: rgba(22,163,74,.45);
  background: rgba(22,163,74,.10);
}
.q-mcq .choice.wrong{
  border-color: rgba(220,38,38,.45);
  background: rgba(220,38,38,.10);
}

/* ---------- Ordering ---------- */
.q-ordering{
  display:flex;
  flex-direction: column;
  gap: 14px;
}
.ordering-pool{
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 12px;
  border-radius: 16px;
  border: 1px dashed rgba(37,99,235,.28);
  background: rgba(239,246,255,.7);
}
.ordering-choice{
  border: 1px solid rgba(37,99,235,.28);
  background: #fff;
  border-radius: 999px;
  padding: 8px 14px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  box-shadow: var(--shadow-xs);
  transition: transform .08s ease, box-shadow .18s ease, border-color .18s ease;
}
.ordering-choice:active{
  transform: translateY(1px);
}
.ordering-choice:hover{
  box-shadow: var(--shadow-sm);
}
.ordering-slots{
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.ordering-slot{
  min-height: 54px;
  border-radius: 14px;
  border: 1px dashed rgba(148,163,184,.6);
  background: rgba(248,250,252,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 10px;
  transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
}
.ordering-slot.is-active{
  border-color: rgba(37,99,235,.55);
  background: rgba(219,234,254,.6);
  box-shadow: var(--shadow-xs);
}
.ordering-slot.is-dragover{
  border-color: rgba(37,99,235,.8);
  background: rgba(191,219,254,.6);
}
.ordering-placeholder{
  color: var(--muted);
  font-size: 13px;
}
.ordering-slot-item{
  width: 100%;
  text-align:center;
  padding: 10px 12px;
  border-radius: 12px;
  background: #fff;
  border: 1px solid rgba(37,99,235,.28);
  font-weight: 700;
  box-shadow: var(--shadow-xs);
  cursor: pointer;
}
.ordering-empty{
  width: 100%;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px dashed rgba(15,23,42,.18);
  background: rgba(241,245,249,.6);
  color: var(--muted);
  text-align: center;
  font-size: 13px;
}

/* ---------- Match (Structure only / future) ---------- */
.q-match{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.q-match .col{
  display:flex;
  flex-direction: column;
  gap: 8px;
}
.q-match .item{
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(17,24,39,.14);
  background: rgba(255,255,255,.9);
  box-shadow: var(--shadow-xs);
}

/* ---------- Feedback ---------- */
.q-feedback{
  font-size: 13px;
  font-weight: 800;
}
.q-feedback.ok{
  color: var(--success);
}
.q-feedback.err{
  color: var(--danger);
}

@media (max-width: 560px){
  .q-match{
    grid-template-columns: 1fr;
  }
}
math/public/assets/css/toast.css
/* =========================================================
   toast.css — Material Light Toast + Countdown Bar
   used by assets/js/ui/toast.js

   UPDATE (2026-01-14):
   - Toast host is anchored to the TOP of the *visual viewport*
     (handled by JS via translateY + height adjustment).
   ========================================================= */

:root{
  --toast-max: 420px;
  --toast-pad: 12px;
  --toast-gap: 10px;

  --toast-bg: rgba(255,255,255,.86);
  --toast-border: rgba(17,24,39,.12);
  --toast-shadow: 0 18px 40px rgba(17,24,39,.16);
  --toast-blur: 12px;

  --toast-title: #111827;
  --toast-text: #4b5563;
  --toast-bar-bg: rgba(17,24,39,.10);
  --toast-bar: rgba(37,99,235,1);

  --toast-ok: rgba(22,163,74,1);
  --toast-warn: rgba(245,158,11,1);
  --toast-err: rgba(220,38,38,1);
}

/* Container fixed on viewport */
.toast-host{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  display:flex;
  align-items:flex-start;          /* top */
  justify-content:center;

  /* JS will place us at top of VISUAL viewport; keep a small inner padding */
  padding: 12px 16px;
}

/* Toast element */
.toast{
  width: min(var(--toast-max), calc(100vw - 32px));
  pointer-events: auto;
  background: var(--toast-bg);
  border: 1px solid var(--toast-border);
  border-radius: 18px;
  box-shadow: var(--toast-shadow);
  backdrop-filter: blur(var(--toast-blur));
  -webkit-backdrop-filter: blur(var(--toast-blur));
  overflow: hidden;

  transform: translateY(-10px) scale(.98);
  opacity: 0;
  transition: transform .22s ease, opacity .22s ease;
}

.toast.is-show{
  transform: translateY(0) scale(1);
  opacity: 1;
}

.toast-inner{
  display:flex;
  gap: var(--toast-gap);
  padding: var(--toast-pad);
  align-items:flex-start;
}

/* Icon pill */
.toast-ic{
  width: 34px;
  height: 34px;
  border-radius: 14px;
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(37,99,235,.12);
  border: 1px solid rgba(37,99,235,.18);
  box-shadow: 0 10px 18px rgba(37,99,235,.10);
}

.toast-ic svg{
  width: 18px;
  height: 18px;
  fill: rgba(29,78,216,1);
}

.toast-content{
  flex: 1 1 auto;
  min-width: 0;
}

.toast-title{
  margin: 0;
  font-weight: 900;
  font-size: 14px;
  color: var(--toast-title);
  line-height: 1.2;
}

.toast-msg{
  margin: 6px 0 0;
  font-size: 13px;
  color: var(--toast-text);
  line-height: 1.45;
  word-wrap: break-word;
}

/* Progress bar (countdown) */
.toast-bar{
  height: 4px;
  width: 100%;
  background: var(--toast-bar-bg);
  position: relative;
}

.toast-bar > i{
  display:block;
  height: 100%;
  width: 100%;
  background: var(--toast-bar);
  transform-origin: right center; /* RTL feel */
  transform: scaleX(0);
}

/* Variants */
.toast[data-type="info"] .toast-ic{
  background: rgba(37,99,235,.12);
  border-color: rgba(37,99,235,.18);
}
.toast[data-type="info"] .toast-ic svg{ fill: rgba(29,78,216,1); }
.toast[data-type="info"] .toast-bar > i{ background: rgba(37,99,235,1); }

.toast[data-type="success"] .toast-ic{
  background: rgba(22,163,74,.12);
  border-color: rgba(22,163,74,.18);
  box-shadow: 0 10px 18px rgba(22,163,74,.10);
}
.toast[data-type="success"] .toast-ic svg{ fill: var(--toast-ok); }
.toast[data-type="success"] .toast-bar > i{ background: var(--toast-ok); }

.toast[data-type="warning"] .toast-ic{
  background: rgba(245,158,11,.14);
  border-color: rgba(245,158,11,.22);
  box-shadow: 0 10px 18px rgba(245,158,11,.10);
}
.toast[data-type="warning"] .toast-ic svg{ fill: var(--toast-warn); }
.toast[data-type="warning"] .toast-bar > i{ background: var(--toast-warn); }

.toast[data-type="danger"] .toast-ic,
.toast[data-type="error"] .toast-ic{
  background: rgba(220,38,38,.12);
  border-color: rgba(220,38,38,.18);
  box-shadow: 0 10px 18px rgba(220,38,38,.10);
}
.toast[data-type="danger"] .toast-ic svg,
.toast[data-type="error"] .toast-ic svg{ fill: var(--toast-err); }
.toast[data-type="danger"] .toast-bar > i,
.toast[data-type="error"] .toast-bar > i{ background: var(--toast-err); }

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .toast{ transition: none; }
}

/* Mobile spacing tweak */
@media (max-width: 420px){
  .toast-inner{ padding: 10px; }
}
math/public/assets/js/app.js
/* =========================================================
   app.js — App Bootstrap & Page Router
   - Login uses: (Student ID + Birth Year) against local data
   - Greets by firstName
   - Stores current student profile for later certificates

   UPDATE (2026-01-14):
   - Fix UI flash: hide all screens first, show correct one
   - Remove old auto-welcome based on lastStudentId only
   ========================================================= */

import {
  clearStudentSession,
  getLastStudentId,
  getStudentSession,
  setCachedCards,
  setLastStudentId,
  setStudentCompletions,
  setStudentSession,
  syncCardCompletions,
} from './core/storage.js';
import { initCardsPage } from './cards/cardsPage.js';
import { getWeekParam } from './core/router.js';
import { showToast } from './ui/toast.js';
import { initLessonPage } from './lesson/lessonPage.js';
import { findStudentByIdentity } from './core/students.js';
import { fetchJson } from './core/api.js';
import { API_PATHS } from './core/constants.js';
import { normalizeDigits } from './core/normalizeDigits.js';

const LS_CURRENT_STUDENT = 'math:currentStudent'; // legacy cache

document.addEventListener('DOMContentLoaded', () => {
  const week = getWeekParam();

  if (week) {
    initLessonPage();
  } else {
    initIndexPage();
  }
});

/* ---------- Index Page Logic ---------- */
function initIndexPage() {
  const screenId = document.getElementById('screen-id');
  const screenWelcome = document.getElementById('screen-welcome');
  const screenCards = document.getElementById('screen-cards');

  const inputId = document.getElementById('studentId');
  const btnLogin = document.getElementById('btnLogin');
  const btnToCards = document.getElementById('btnToCards');
  const btnChangeId = document.getElementById('btnChangeId');
  const btnLogout = document.getElementById('btnLogout');

  const welcomeTitle = document.getElementById('welcomeTitle');
  const welcomeChip = document.getElementById('welcomeChip');
  const welcomeName = document.getElementById('welcomeName');

  // Ensure Birth Year input exists (inject if missing)
  const inputBirthYear = ensureBirthYearInput(inputId);

  hideAllScreens();

  let currentSession = normalizeStoredStudent(getStudentSession());
  if (!currentSession?.grade) {
    const legacyStudent = readCurrentStudent();
    if (legacyStudent && (legacyStudent?.Grade || legacyStudent?.grade || legacyStudent?.Class || legacyStudent?.class)) {
      const migratedSession = normalizeStoredStudent(legacyStudent);
      setStudentSession(migratedSession);
      currentSession = migratedSession;
    }
  }
  if (currentSession?.id && currentSession?.birthYear) {
    setLastStudentId(currentSession.id);
    showCards();
    loadStudentData(currentSession, { silent: true });
  } else {
    const lastId = getLastStudentId();
    if (lastId && inputId) inputId.value = String(lastId);
    showId();
  }

  async function attemptLogin() {
    const id = normalizeDigits(inputId?.value || '').trim();
    const birthYear = normalizeDigits(inputBirthYear?.value || '').trim();

    if (!id) {
      showToast('تنبيه', 'ادخل رقم الهوية أولًا', 'warning');
      return;
    }
    if (!birthYear) {
      showToast('تنبيه', 'ادخل سنة الميلاد (مثال: 2012)', 'warning');
      return;
    }

    const fallbackLogin = async () => {
      const found = await findStudentByIdentity(id, birthYear);

      if (!found) {
        showToast('بيانات غير صحيحة', 'تأكد من رقم الهوية وسنة الميلاد', 'warning', 3500);
        return;
      }

      const legacyClassValue = found?.class ?? found?.Class ?? '';
      const gradeValue = found?.grade ?? found?.Grade ?? '';
      let resolvedGrade = '';
      let resolvedClass = '';

      if (isLegacyClassString(legacyClassValue)) {
        const legacyInfo = parseStudentClass(legacyClassValue);
        resolvedGrade = legacyInfo.grade;
        resolvedClass = legacyInfo.className;
      } else if (gradeValue && legacyClassValue) {
        resolvedGrade = String(gradeValue);
        resolvedClass = String(legacyClassValue);
      }

      const student = {
        id: String(found.id),
        birthYear: String(found.birthYear),
        firstName: String(found.firstName || '').trim() || String(found.fullName || '').trim().split(' ')[0] || `طالب ${found.id}`,
        fullName: String(found.fullName || '').trim() || `طالب ${found.id}`,
        grade: resolvedGrade,
        class: resolvedClass,
      };

      setLastStudentId(student.id);
      setStudentSession(student);
      writeCurrentStudent(student);
      showWelcome(student);
      showToast('تم الدخول', `أهلًا ${student.firstName} 👋`, 'success', 2500);
      await loadStudentData(student);
    };

    try {
      setLoginLoading(true);
      const data = await fetchJson(API_PATHS.STUDENT_LOGIN, {
        method: 'POST',
        body: { studentId: id, birthYear },
      });

      const payload = data?.student ?? data;
      const profile = normalizeStoredStudent(payload);

      if (profile?.id && profile?.birthYear) {
        writeCurrentStudent(payload);
        setStudentSession(profile);
        if (profile?.id) setLastStudentId(profile.id);
        showWelcome(profile);
        showToast('تم الدخول', `أهلًا ${profile.firstName} 👋`, 'success', 2500);
        await loadStudentData(profile);
        return;
      }
    } catch (e) {
      console.warn('API login failed, falling back to local data.', e);
    } finally {
      setLoginLoading(false);
    }

    try {
      await fallbackLogin();
    } catch (e) {
      console.error(e);
      showToast('خطأ', 'تعذر تحميل بيانات الطلاب', 'error', 4000);
    }
  }

  btnLogin?.addEventListener('click', () => {
    attemptLogin();
  });

  const enterHandler = (event) => {
    if (event.key !== 'Enter') return;
    event.preventDefault();
    attemptLogin();
  };

  inputId?.addEventListener('keydown', enterHandler);
  inputBirthYear?.addEventListener('keydown', enterHandler);

  btnToCards?.addEventListener('click', () => showCards());
  btnChangeId?.addEventListener('click', () => showId());

  btnLogout?.addEventListener('click', () => {
    clearCurrentStudent();
    clearStudentSession();
    try { localStorage.removeItem('math:lastStudentId'); } catch {}
    showId();
    if (inputId) inputId.value = '';
    if (inputBirthYear) inputBirthYear.value = '';
  });

  function setScreenVisibility(screen, isVisible) {
    if (!screen) return;
    screen.classList.toggle('hidden', !isVisible);
    screen.toggleAttribute('hidden', !isVisible);
    if (isVisible) {
      screen.style.removeProperty('display');
      if (!screen.getAttribute('style')) {
        screen.removeAttribute('style');
      }
    } else {
      screen.style.display = 'none';
    }
  }

  function hideAllScreens() {
    setScreenVisibility(screenId, false);
    setScreenVisibility(screenWelcome, false);
    setScreenVisibility(screenCards, false);
  }

  function setAppReady() {
    document.body.classList.remove('is-loading');
  }

  function setLoginLoading(isLoading) {
    if (!btnLogin) return;
    btnLogin.disabled = isLoading;
    btnLogin.textContent = isLoading ? 'جارٍ التحقق...' : 'دخول';
  }

  function showId() {
    setAppReady();
    setScreenVisibility(screenId, true);
    setScreenVisibility(screenWelcome, false);
    setScreenVisibility(screenCards, false);
  }

  function showWelcome(student) {
    const firstName = student?.firstName || student?.id || 'طالب';
    const fullName = student?.fullName || `طالب ${student?.id || ''}`.trim();

    if (welcomeTitle) welcomeTitle.textContent = `مرحبًا يا ${firstName} 👋`;
    if (welcomeChip) welcomeChip.textContent = fullName;
    if (welcomeName) welcomeName.textContent = fullName;

    setAppReady();
    setScreenVisibility(screenId, false);
    setScreenVisibility(screenWelcome, true);
    setScreenVisibility(screenCards, false);

  }

  function showCards() {
    setAppReady();
    setScreenVisibility(screenId, false);
    setScreenVisibility(screenWelcome, false);
    setScreenVisibility(screenCards, true);
    initCardsPage();
  }

}

function writeCurrentStudent(student) {
  try {
    localStorage.setItem(LS_CURRENT_STUDENT, JSON.stringify(student));
  } catch {}
}

function readCurrentStudent() {
  try {
    const raw = localStorage.getItem(LS_CURRENT_STUDENT);
    return raw ? JSON.parse(raw) : null;
  } catch {
    return null;
  }
}

function clearCurrentStudent() {
  try {
    localStorage.removeItem(LS_CURRENT_STUDENT);
  } catch {}
}

async function loadStudentData(student, { silent = false } = {}) {
  if (!student?.id) return;

  const btnToCards = document.getElementById('btnToCards');
  const originalLabel = btnToCards?.textContent;
  if (btnToCards) {
    btnToCards.disabled = true;
    btnToCards.textContent = 'جاري التحميل...';
  }

  try {
    const session = normalizeStoredStudent(getStudentSession()) || normalizeStoredStudent(student);
    const gradeValue = session?.grade ?? session?.Grade ?? '';
    const hasGrade = isNumericValue(gradeValue);
    if (!hasGrade) {
      console.debug('Skip cards warmup: missing grade');
    }
    const cardsUrl = buildCardsUrl(session || student);
    const [progress, cards] = await Promise.all([
      fetchJson(`${API_PATHS.PROGRESS_COMPLETED}?studentId=${encodeURIComponent(student.id)}`, { noStore: true }),
      hasGrade ? fetchJson(cardsUrl, { noStore: true }) : Promise.resolve(null),
    ]);

    setStudentCompletions(student.id, Array.isArray(progress) ? progress : []);
    syncCardCompletions(student.id, Array.isArray(progress) ? progress : []);
    if (hasGrade) {
      setCachedCards(Array.isArray(cards) ? cards : []);
    }
  } catch (error) {
    if (!silent) {
      showToast('خطأ', error.message || 'تعذر تحميل بيانات الطالب', 'error');
    }
  } finally {
    if (btnToCards) {
      btnToCards.disabled = false;
      btnToCards.textContent = originalLabel || 'الانتقال للبطاقات';
    }
  }
}

function normalizeStoredStudent(student) {
  if (!student) return null;
  const normalizedId = student.id ?? student.studentId ?? student.StudentId ?? '';
  const normalizedBirthYear = student.birthYear ?? student.BirthYear ?? '';
  const fullName = student.fullName ?? student.FullName ?? student.name ?? student.Name ?? '';
  const firstName = student.firstName ?? student.FirstName ?? '';
  const resolvedFullName = String(fullName || '').trim() || `طالب ${normalizedId}`.trim();
  const resolvedFirstName =
    String(firstName || '').trim() ||
    resolvedFullName.split(' ')[0] ||
    `طالب ${normalizedId}`.trim();
  const resolvedGrade = student.grade ?? student.Grade ?? '';
  const resolvedClass = student.class ?? student.Class ?? '';
  let normalizedGrade = String(resolvedGrade);
  let normalizedClass = String(resolvedClass);

  if (!normalizedGrade && isLegacyClassString(normalizedClass)) {
    const legacyInfo = parseStudentClass(normalizedClass);
    normalizedGrade = legacyInfo.grade;
    normalizedClass = legacyInfo.className;
  }

  return {
    id: String(normalizedId),
    birthYear: String(normalizedBirthYear),
    firstName: resolvedFirstName,
    fullName: resolvedFullName,
    grade: normalizedGrade,
    class: normalizedClass
  };
}

function parseStudentClass(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  if (!raw) return { grade: '', className: '' };
  const match = raw.match(/^(\\d+)\\s*[/\\-]\\s*(\\d+)$/);
  if (match) {
    return { grade: match[1], className: match[2] };
  }
  return { grade: raw, className: raw };
}

function isLegacyClassString(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  return /^(\\d+)\\s*[/\\-]\\s*(\\d+)$/.test(raw);
}

function isNumericValue(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  return raw !== '' && /^\\d+$/.test(raw);
}

function buildCardsUrl(student) {
  const params = new URLSearchParams();
  const gradeValue = student?.grade ?? student?.Grade ?? '';
  const classValue = student?.class ?? student?.Class ?? '';

  if (isNumericValue(gradeValue) && isNumericValue(classValue)) {
    params.set('grade', normalizeDigits(String(gradeValue)).trim());
    params.set('class', normalizeDigits(String(classValue)).trim());
    return `${API_PATHS.CARDS}?${params.toString()}`;
  }

  const legacyValue = student?.class ?? student?.grade;
  if (isLegacyClassString(legacyValue)) {
    const { grade, className } = parseStudentClass(legacyValue);
    if (grade) params.set('grade', grade);
    if (className) params.set('class', className);
  }
  return `${API_PATHS.CARDS}?${params.toString()}`;
}

/* ---------- UI: Birth Year input injection ---------- */
function ensureBirthYearInput(inputIdEl) {
  let el = document.getElementById('studentBirthYear');
  if (el) return el;

  if (!inputIdEl) return null;

  const field = inputIdEl.closest('.field') || inputIdEl.parentElement;
  if (!field) return null;

  const wrap = document.createElement('div');
  wrap.className = 'field';
  wrap.style.marginTop = '12px';

  wrap.innerHTML = `
    <label class="label" for="studentBirthYear">سنة الميلاد</label>
    <input id="studentBirthYear" class="input ltr" inputmode="numeric" autocomplete="off" placeholder="مثال: 2012" />
    <div class="help">اكتب سنة الميلاد فقط (4 أرقام).</div>
  `;

  field.insertAdjacentElement('afterend', wrap);
  el = wrap.querySelector('#studentBirthYear');

  el.addEventListener('input', () => {
    el.value = normalizeDigits(String(el.value || '')).replace(/[^0-9]/g, '').slice(0, 4);
  });

  el.addEventListener('keydown', (e) => {
    const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Tab','Home','End','Enter'];
    if (allowed.includes(e.key)) return;
    if (e.ctrlKey || e.metaKey) return;
    if (!/^[0-9٠-٩۰-۹]$/.test(e.key)) e.preventDefault();
  });

  return el;
}
math/public/assets/js/cards/cardsPage.js
/* =========================================================
   cardsPage.js — Cards List Logic (index.html)
   - Loads cards from local data
   - Applies sequential locking via prereq
   - Shows completed cards as gold + star (base.css styles)
   - Shows student name (firstName/fullName) instead of "طالب {id}"
   ========================================================= */

import { fetchJson } from '../core/api.js';
import { API_PATHS } from '../core/constants.js';
import { normalizeDigits } from '../core/normalizeDigits.js';
import {
  getCachedCards,
  getLastStudentId,
  getStudentCompletions,
  getStudentSession,
  isCardDone,
  setCachedCards,
  setStudentSession,
  syncCardCompletions,
} from '../core/storage.js';
import { goToLesson } from '../core/router.js';
import { showToast } from '../ui/toast.js';

export async function initCardsPage(options = {}) {
  const { didRefresh = false } = options;
  const studentId = getLastStudentId();
  if (!studentId) return;

  const listEl = document.getElementById('cardsList');
  const studentNameEl = document.getElementById('cardsStudentName');
  let readyWeeks = null;

  let student = getStudentSession();
  if (!student?.grade && !didRefresh && student?.id && student?.birthYear) {
    const refreshed = await refreshStudentSession(student);
    if (refreshed) {
      return initCardsPage({ didRefresh: true });
    }
  }

  const gradeValue = normalizeDigits(student?.grade ?? '');
  const hasGrade = gradeValue !== '' && /^\\d+$/.test(gradeValue);
  const classInfo = {
    grade: gradeValue,
    className: normalizeDigits(student?.class ?? ''),
  };
  const displayName =
    (student?.firstName && String(student.firstName).trim()) ||
    (student?.fullName && String(student.fullName).trim()) ||
    `طالب ${studentId}`;

  if (studentNameEl) studentNameEl.textContent = displayName;

  try {
    const cached = getCachedCards();
    if (cached?.length) {
      renderCards(listEl, cached, studentId, readyWeeks);
    }

    const progress = getStudentCompletions(studentId);
    syncCardCompletions(studentId, progress);

    if (!hasGrade) {
      console.debug('Skip cards fetch: missing grade');
      return;
    }

    const cardsUrl = buildCardsUrl(classInfo);
    const [cards, weeks] = await Promise.all([
      fetchJson(cardsUrl, { noStore: true }),
      fetchJson(API_PATHS.WEEKS, { noStore: true }),
    ]);
    const normalized = Array.isArray(cards) ? cards : [];
    readyWeeks = normalizeReadyWeeks(weeks);
    setCachedCards(normalized);
    renderCards(listEl, normalized, studentId, readyWeeks);
  } catch (e) {
    showToast('خطأ', 'فشل تحميل البطاقات', 'error');
    console.error(e);
  }
}

async function refreshStudentSession(session) {
  try {
    const data = await fetchJson(API_PATHS.STUDENT_LOGIN, {
      method: 'POST',
      body: {
        studentId: session.id,
        birthYear: session.birthYear,
      },
    });

    const payload = data?.student ?? data;
    const normalized = normalizeSessionStudent(payload);
    if (normalized?.id) {
      setStudentSession(normalized);
      return normalized;
    }
  } catch (error) {
    console.warn('Student refresh failed', error);
  }

  return null;
}

function parseStudentClass(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  if (!raw) return { grade: '', className: '' };
  const match = raw.match(/^(\d+)\s*[/\\-]\s*(\d+)$/);
  if (match) {
    return { grade: match[1], className: match[2] };
  }
  return { grade: raw, className: raw };
}

function normalizeSessionStudent(student) {
  if (!student) return null;
  const normalizedId = student.id ?? student.studentId ?? student.StudentId ?? '';
  const normalizedBirthYear = student.birthYear ?? student.BirthYear ?? '';
  const fullName = student.fullName ?? student.FullName ?? student.name ?? student.Name ?? '';
  const firstName = student.firstName ?? student.FirstName ?? '';
  const resolvedFullName = String(fullName || '').trim() || `طالب ${normalizedId}`.trim();
  const resolvedFirstName =
    String(firstName || '').trim() ||
    resolvedFullName.split(' ')[0] ||
    `طالب ${normalizedId}`.trim();
  const resolvedGrade = student.grade ?? student.Grade ?? '';
  const resolvedClass = student.class ?? student.Class ?? '';
  let normalizedGrade = String(resolvedGrade);
  let normalizedClass = String(resolvedClass);

  if (!normalizedGrade && isLegacyClassString(normalizedClass)) {
    const legacyInfo = parseStudentClass(normalizedClass);
    normalizedGrade = legacyInfo.grade;
    normalizedClass = legacyInfo.className;
  }

  return {
    id: String(normalizedId),
    birthYear: String(normalizedBirthYear),
    firstName: resolvedFirstName,
    fullName: resolvedFullName,
    grade: normalizedGrade,
    class: normalizedClass,
  };
}

function isLegacyClassString(value) {
  const raw = normalizeDigits(String(value ?? '')).trim();
  return /^(\d+)\s*[/\\-]\s*(\d+)$/.test(raw);
}

function buildCardsUrl({ grade, className }) {
  const params = new URLSearchParams();
  if (grade) params.set('grade', grade);
  if (className) params.set('class', className);
  return `${API_PATHS.CARDS}?${params.toString()}`;
}

function normalizeReadyWeeks(weeks) {
  if (!Array.isArray(weeks)) return null;
  const list = weeks
    .map((week) => Number(week?.Week ?? week?.week))
    .filter((week) => Number.isFinite(week));
  return list.length ? new Set(list) : null;
}

function renderCards(container, cards, studentId, readyWeeks) {
  if (!container) return;
  container.innerHTML = '';

  cards.forEach((card) => {
    const weekValue = card.week ?? card.Week;
    const prereqWeek = card.prereqWeek ?? card.PrereqWeek ?? card.prereq;
    const done = isCardDone(studentId, weekValue);
    const prereqDone = !prereqWeek || isCardDone(studentId, prereqWeek);
    const locked = !prereqDone;
    const isReady = !readyWeeks || readyWeeks.has(Number(weekValue));
    const disabled = !isReady;

    const cardEl = document.createElement('div');
    cardEl.className = `card ${locked ? 'is-locked' : ''} ${done ? 'is-done' : ''} ${disabled ? 'is-disabled' : ''}`;

    cardEl.innerHTML = `
      <div class="card-header">
        <div>
          <h3 class="card-title">${escapeHtml(card.title ?? card.Title)}</h3>
          <p class="card-subtitle">الأسبوع ${escapeHtml(weekValue)}</p>
        </div>
        ${done ? starHtml() : ''}
      </div>

      <div class="card-body">
        <span class="badge ${done ? 'done' : disabled ? 'disabled' : locked ? 'locked' : 'primary'}">
          ${done ? 'منجزة' : disabled ? 'غير جاهزة' : locked ? 'مقفلة' : 'مفتوحة'}
        </span>
      </div>

      <div class="card-footer">
        <button class="btn ${locked || disabled ? 'btn-outline' : 'btn-primary'} w-100"
                ${locked || disabled ? 'disabled' : ''}>
          ${disabled ? 'غير متاحة' : done ? 'إعادة فتح' : 'ابدأ'}
        </button>
      </div>
    `;

    const btn = cardEl.querySelector('button');
    if (!locked && !disabled) {
      btn.addEventListener('click', () => {
        goToLesson(weekValue);
      });
    } else if (locked) {
      btn.addEventListener('click', () => {
        showToast('مقفلة 🔒', 'لازم تنهي البطاقة السابقة أولًا', 'warning');
      });
    }

    container.appendChild(cardEl);
  });
}

function starHtml() {
  return `
    <div class="star" title="منجزة">
      <svg viewBox="0 0 24 24">
        <path d="M12 2l2.9 6.6 7.1.6-5.4 4.7 1.6 7-6.2-3.6-6.2 3.6 1.6-7-5.4-4.7 7.1-.6z"></path>
      </svg>
    </div>
  `;
}

function escapeHtml(s) {
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
math/public/assets/js/core/api.js
/* =========================================================
   api.js — JSON Loader (API helpers)
   ========================================================= */

export async function fetchJson(url, { noStore = false, method = 'GET', body, headers } = {}) {
  const opts = {
    method,
    headers: {
      ...(headers || {}),
    },
  };

  if (body !== undefined) {
    opts.body = JSON.stringify(body);
    opts.headers['Content-Type'] = 'application/json';
  }

  if (noStore) {
    opts.cache = 'no-store';
    opts.headers['Cache-Control'] = 'no-store';
    opts.headers['Pragma'] = 'no-cache';
  }

  const res = await fetch(url, opts);
  if (!res.ok) {
    let message = `فشل تحميل البيانات: ${url}`;
    try {
      const errorPayload = await res.json();
      if (errorPayload?.error) {
        message = errorPayload.error;
      }
    } catch {
      // ignore parse errors
    }
    throw new Error(message);
  }

  if (res.status === 204) return null;
  return await res.json();
}
math/public/assets/js/core/constants.js
/* =========================================================
   constants.js — Global Constants & Paths
   ========================================================= */

// App
export const APP_NAME = 'math';

// Storage keys
export const STORAGE_KEYS = {
  LAST_STUDENT_ID: 'math:lastStudentId',
  STUDENTS: 'math:students', // root object for all students progress
  STUDENT_SESSION: 'math:studentSession',
  CACHED_CARDS: 'math:cardsCache',
  STUDENT_COMPLETIONS: 'math:studentCompletions',
};

// Data paths
export const DATA_PATHS = {
  CARDS: '/data/cards.json',
  WEEKS_DIR: '/data/weeks',
  STUDENTS: '/data/students.json',
};

// API paths
export const API_PATHS = {
  CARDS: '/api/cards',
  WEEKS: '/api/weeks',
  STUDENT_LOGIN: '/api/students/login',
  PROGRESS_COMPLETED: '/api/progress/completed',
  PROGRESS_COMPLETE: '/api/progress/complete',
};

// Lesson / Engine
export const ENGINE = {
  MAX_ATTEMPTS: 3,
};

// UI defaults
export const UI = {
  TOAST_DURATION_SHORT: 2500,
  TOAST_DURATION_MEDIUM: 3500,
  TOAST_DURATION_LONG: 5000,
};

// Progress
export const PROGRESS = {
  START: 0,
  COMPLETE: 100,
};

// Helpers
export function weekJsonPath(week) {
  return `/api/weeks/${encodeURIComponent(week)}`;
}
math/public/assets/js/core/gradeMap.js
export const GRADE_WEEK_MAP = {
  '7/1': [999, 1000],
  '7/2': [999],
  '8/1': [1000],
};

export function getWeeksForClass(studentClass) {
  if (!studentClass) return null;
  const key = String(studentClass).trim();
  return GRADE_WEEK_MAP[key] || null;
}
math/public/assets/js/core/normalizeDigits.js
export function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9',
  };

  return String(value).replace(/[٠-٩۰-۹]/g, (digit) => map[digit] ?? digit);
}
math/public/assets/js/core/router.js
/* =========================================================
   router.js — Query String Reader & Navigation Helpers
   ========================================================= */

export function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

export function getWeekParam() {
  const w = getQueryParam('week');
  if (!w) return null;
  const n = Number(w);
  return Number.isFinite(n) ? n : null;
}

export function goTo(url) {
  window.location.href = url;
}

export function goHome() {
  goTo('/');
}

export function goToLesson(week) {
  goTo(`/lesson.html?week=${encodeURIComponent(week)}`);
}
math/public/assets/js/core/storage.js
/* =========================================================
   storage.js — LocalStorage Persistence
   - Students progress per device
   ========================================================= */

import { STORAGE_KEYS } from './constants.js';

/* ---------- Internal helpers ---------- */
function readRoot() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.STUDENTS);
    return raw ? JSON.parse(raw) : {};
  } catch {
    return {};
  }
}

function writeRoot(root) {
  localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(root));
}

function readJson(key, fallback = null) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch {
    return fallback;
  }
}

function writeJson(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

/* ---------- Student Session ---------- */
export function getStudentSession() {
  return readJson(STORAGE_KEYS.STUDENT_SESSION, null);
}

export function setStudentSession(session) {
  if (!session) return;
  writeJson(STORAGE_KEYS.STUDENT_SESSION, session);
}

export function clearStudentSession() {
  try {
    localStorage.removeItem(STORAGE_KEYS.STUDENT_SESSION);
  } catch {}
}

/* ---------- Student ID ---------- */
export function getLastStudentId() {
  return localStorage.getItem(STORAGE_KEYS.LAST_STUDENT_ID);
}

export function setLastStudentId(studentId) {
  localStorage.setItem(STORAGE_KEYS.LAST_STUDENT_ID, studentId);
}

/* ---------- Student Progress ---------- */
/*
Structure:
students = {
  "123456": {
    cards: {
      "999": {
        done: false,
        progress: { conceptIndex: 0, stepIndex: 0 }
      }
    }
  }
}
*/

export function getStudent(studentId) {
  const root = readRoot();
  if (!root[studentId]) {
    root[studentId] = { cards: {} };
    writeRoot(root);
  }
  return root[studentId];
}

export function getStudentProgress(studentId, week) {
  const student = getStudent(studentId);
  return student.cards[String(week)] || null;
}

export function setStudentProgress(studentId, week, progress) {
  const root = readRoot();
  if (!root[studentId]) root[studentId] = { cards: {} };

  root[studentId].cards[String(week)] = {
    ...(root[studentId].cards[String(week)] || {}),
    progress,
  };

  writeRoot(root);
}

/* ---------- Completion helpers ---------- */
export function clearCardProgress(studentId, week) {
  const root = readRoot();
  if (!root[studentId]?.cards?.[String(week)]) return;

  const card = root[studentId].cards[String(week)];
  delete card.progress;

  root[studentId].cards[String(week)] = card;
  writeRoot(root);
}

export function markCardDone(studentId, week) {
  const root = readRoot();
  if (!root[studentId]) root[studentId] = { cards: {} };

  const key = String(week);
  const prev = root[studentId].cards[key] || {};

  // عندما تُنجز البطاقة: نثبت done ونحذف progress حتى ما يصير Resume على بطاقة منجزة
  const next = { ...prev, done: true };
  delete next.progress;

  root[studentId].cards[key] = next;

  writeRoot(root);
}

export function isCardDone(studentId, week) {
  const student = getStudent(studentId);
  return Boolean(student.cards[String(week)]?.done);
}

export function syncCardCompletions(studentId, completions) {
  if (!studentId || !Array.isArray(completions)) return;
  completions.forEach((completion) => {
    const weekValue = completion?.Week ?? completion?.week;
    if (Number.isInteger(Number(weekValue))) {
      markCardDone(studentId, Number(weekValue));
    }
  });
}

/* ---------- Cards cache ---------- */
export function getCachedCards() {
  return readJson(STORAGE_KEYS.CACHED_CARDS, []);
}

export function setCachedCards(cards) {
  if (!Array.isArray(cards)) return;
  writeJson(STORAGE_KEYS.CACHED_CARDS, cards);
}

/* ---------- Progress cache ---------- */
export function getStudentCompletions(studentId) {
  if (!studentId) return [];
  const root = readJson(STORAGE_KEYS.STUDENT_COMPLETIONS, {});
  return Array.isArray(root[studentId]) ? root[studentId] : [];
}

export function setStudentCompletions(studentId, completions) {
  if (!studentId || !Array.isArray(completions)) return;
  const root = readJson(STORAGE_KEYS.STUDENT_COMPLETIONS, {});
  root[studentId] = completions;
  writeJson(STORAGE_KEYS.STUDENT_COMPLETIONS, root);
}

export function upsertStudentCompletion(studentId, completion) {
  if (!studentId || !completion) return;
  const root = readJson(STORAGE_KEYS.STUDENT_COMPLETIONS, {});
  const current = Array.isArray(root[studentId]) ? root[studentId] : [];
  const weekValue = completion?.Week ?? completion?.week;
  const next = current.filter((item) => (item?.Week ?? item?.week) !== weekValue);
  next.unshift(completion);
  root[studentId] = next;
  writeJson(STORAGE_KEYS.STUDENT_COMPLETIONS, root);
}
math/public/assets/js/core/students.js
import { fetchJson } from './api.js';
import { DATA_PATHS } from './constants.js';
import { normalizeDigits } from './normalizeDigits.js';

let studentsCache = null;

/**
 * Load students list (cached after first load)
 */
export async function loadStudents() {
  if (studentsCache) {
    return studentsCache;
  }

  const data = await fetchJson(DATA_PATHS.STUDENTS, { noStore: true });
  const list = Array.isArray(data) ? data : data?.students;

  if (!Array.isArray(list)) {
    throw new Error('Students list format is invalid');
  }

  studentsCache = list.map(normalizeStudent);
  return studentsCache;
}

/**
 * Find student by ID number and birth year
 * @param {string} id
 * @param {string} birthYear
 * @returns {object|null}
 */
export async function findStudentByIdentity(id, birthYear) {
  const students = await loadStudents();

  const normalizedId = normalizeDigits(String(id).trim());
  const normalizedYear = normalizeDigits(String(birthYear).trim());

  const student = students.find(s =>
    normalizeDigits(String(s.id)) === normalizedId &&
    normalizeDigits(String(s.birthYear)) === normalizedYear
  );

  return student || null;
}

function normalizeStudent(student) {
  return {
    id: student.StudentId ?? student.studentId ?? student.id ?? '',
    birthYear: student.BirthYear ?? student.birthYear ?? '',
    firstName: student.FirstName ?? student.firstName ?? '',
    fullName: student.FullName ?? student.fullName ?? '',
    grade: student.Grade ?? student.grade ?? '',
    class: student.Class ?? student.class ?? '',
  };
}
math/public/assets/js/lesson/completion.js
/* =========================================================
   completion.js — Card Completion Handling + Certificate Hook
   - Marks card done
   - Prepares certificate payload
   - Stores last certificate payload in LocalStorage
   - Shows "عرض الشهادة" button on completion (no HTML edits needed)

   ========================================================= */

import { fetchJson } from '../core/api.js';
import { API_PATHS } from '../core/constants.js';
import { getStudentSession, isCardDone, markCardDone, upsertStudentCompletion } from '../core/storage.js';
import { showToast } from '../ui/toast.js';
import { goHome } from '../core/router.js';

const LS_LAST_CERTIFICATE = 'math:lastCertificate';      // prepared here
const CERT_URL = '/assets/cert/certificate.html';

export function completeLesson({ studentId, week, cardTitle = '', finalScore = 0 }) {
  const wasDone = isCardDone(studentId, week);
  // mark card as done
  markCardDone(studentId, week);

  // Prepare certificate payload
  const student = getStudentSession();
  const payload = buildCertificatePayload({ studentId, week, cardTitle, student });
  writeLastCertificate(payload);

  // UI: show completion section if exists
  const completeEl = document.getElementById('lessonComplete');
  if (completeEl) {
    completeEl.classList.remove('hidden');
    completeEl.removeAttribute('hidden');
    completeEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Inject data for future UI usage
    completeEl.setAttribute('data-student-name', payload.fullName || payload.firstName || '');
    completeEl.setAttribute('data-week', String(week));

    // Add certificate button (idempotent)
    ensureCertActions(completeEl);
  }

  // Toast includes first name
  if (!wasDone) {
    const firstName = payload.firstName || 'بطل';
    showToast('ممتاز 🎉', `أحسنت يا ${firstName} — تم إنجاز البطاقة`, 'success', 3500);
  }

  syncCompletionToApi({ studentId, week, finalScore });

  // NOTE: we no longer auto-return quickly, to allow opening the certificate
  setTimeout(() => {
    // goHome();
  }, 12000);
}

/* ---------- Certificate UI Actions ---------- */
function ensureCertActions(completeEl) {
  if (completeEl.querySelector('#btnViewCert')) return;

  // Find a good place to inject (card-body preferred)
  const body = completeEl.querySelector('.card-body') || completeEl;

  const wrap = document.createElement('div');
  wrap.className = 'row';
  wrap.style.marginTop = '12px';
  wrap.style.gap = '10px';

  const btnCert = document.createElement('a');
  btnCert.id = 'btnViewCert';
  btnCert.className = 'btn btn-primary btn-lg w-100';
  btnCert.href = CERT_URL;
  btnCert.textContent = 'عرض الشهادة';

  const btnBack = document.createElement('button');
  btnBack.type = 'button';
  btnBack.className = 'btn btn-outline w-100';
  btnBack.textContent = 'العودة للبطاقات';
  btnBack.addEventListener('click', () => goHome());

  wrap.appendChild(btnCert);
  wrap.appendChild(btnBack);
  body.appendChild(wrap);
}

/* ---------- Certificate Hook Helpers ---------- */
async function syncCompletionToApi({ studentId, week, finalScore }) {
  try {
    const response = await fetchJson(API_PATHS.PROGRESS_COMPLETE, {
      method: 'POST',
      body: { studentId, week, finalScore },
    });

    if (response?.ok === false) {
      throw new Error(response?.error || 'تعذر تسجيل الإنجاز');
    }

    upsertStudentCompletion(studentId, response);
  } catch (error) {
    showToast('تنبيه', error.message || 'تعذر تحديث الإنجاز في الخادم', 'warning');
  }
}

function buildCertificatePayload({ studentId, week, cardTitle, student }) {
  const fullName =
    (student?.fullName && String(student.fullName).trim()) ||
    `طالب ${studentId}`;

  const firstName =
    (student?.firstName && String(student.firstName).trim()) ||
    String(fullName).trim().split(' ')[0] ||
    '';

  const issuedAt = new Date().toISOString();

  return {
    version: 1,
    week: Number(week),
    cardTitle: String(cardTitle || ''),
    studentId: String(studentId),
    firstName,
    fullName,
    class: student?.class ? String(student.class) : '',
    issuedAt
  };
}

function writeLastCertificate(payload) {
  try {
    localStorage.setItem(LS_LAST_CERTIFICATE, JSON.stringify(payload));
  } catch {
    // ignore storage errors
  }
}
math/public/assets/js/lesson/engine.js
/* =========================================================
   engine.js — Unlimited Flow Engine (single "متابعة" button) + Resume + Completion
   - Concepts can use: concept.flow = [ {type:..., ...}, ... ]  ✅ (no limits)
   - Backward compatible: if no flow, we build flow from legacy fields
   - Stages: goals (once) -> prereq (once) -> goals per concept -> assessment (final)
   - One button only: "متابعة"
     * On text items: reveals next item
     * On question items: "متابعة" = تحقق للسؤال الحالي
       - Wrong: hints/attempts/solution
       - Correct: toast تعزيز + مهلة قصيرة ثم يكشف اللي بعده تلقائيًا
   - Auto scroll + focus to newly revealed item after advancing
   - Fix: infer question.type if flow item doesn't include it
   - Resume: load saved { stage, conceptIndex, stepIndex } from storage and continue
   - Completion: when finishing the last item -> mark done + show completion + return home
   - Certificate Hook: pass cardTitle to completion.js (data.title)

   UPDATE (2026-01-14):
   - Fix #1: Preserve question state across re-renders (input value / mcq selection)
     by caching built flow + caching normalized question object per flow item.
   ========================================================= */

import { ENGINE } from '../core/constants.js';
import { showToast } from '../ui/toast.js';
import { ENCOURAGEMENTS, DEFAULT_HINTS, FINAL_HINT, pickRandom } from '../ui/text.js';
import { renderQuestion } from '../questions/registry.js';
import { setStudentProgress, getStudentProgress, isCardDone, markCardDone } from '../core/storage.js';
import { setProgressUI } from './progress.js';
import { completeLesson } from './completion.js';

const LEGACY_ORDER = ['goal', 'explain', 'example', 'example2', 'mistake', 'note', 'question'];
const STAGES = {
  GOALS: 'goals',
  PREREQ: 'prereq',
  CONCEPT: 'concept',
  ASSESSMENT: 'assessment',
};

export function initEngine({ week, studentId, data, mountEl }) {
  mountEl.innerHTML = '';

  let stage = STAGES.GOALS;
  let conceptIndex = 0;
  let itemIndex = 0;

  let assessmentState = {
    attempts: 0,
    completed: false,
    score: null,
    total: null,
  };

  const goalsList = getGoalsList(data);
  const prereqList = getPrereqList(data);
  const assessment = normalizeAssessment(data?.assessment);

  // Scroll/focus control
  let pendingFocus = null; // { conceptIndex, itemIndex }
  let firstPaint = true;

  // Question state (for current question only)
  let activeQuestion = null; // { check, attempts, solutionShown, btn, dotsWrap, container, qData, verifiedOk }

  function getConceptFlow(concept) {
    // IMPORTANT: cache flow so items keep runtime state across re-renders
    if (concept && Array.isArray(concept._flowCache) && concept._flowCache.length) {
      return concept._flowCache;
    }

    let flow = null;

    if (Array.isArray(concept?.flow) && concept.flow.length) {
      // Use original flow array (stable reference) + cache it
      flow = concept.flow;
    } else {
      // Backward compatible: build flow from legacy keys (once)
      flow = [];
      for (const key of LEGACY_ORDER) {
        if (key === 'question') {
          if (concept?.question) {
            flow.push({ type: 'question', q: concept.question });
          }
        } else {
          if (concept?.[key]) flow.push({ type: key, text: concept[key] });
        }
      }
    }

    // cache for stability
    if (concept) concept._flowCache = flow || [];
    return concept?._flowCache || [];
  }

  function buildNormalizedQuestionFromItem(item) {
    // If flow item already contains q object:
    if (item?.q && typeof item.q === 'object') {
      // Use the same object reference as base, but ensure required fields exist
      const q = item.q;

      // Ensure type exists (if missing infer)
      if (!q.type) {
        q.type =
          item?.qtype ||
          item?.questionType ||
          (item?.type && item.type !== 'question' ? item.type : null) ||
          (Array.isArray(q?.choices) ? 'mcq' : 'input');
      }

      // Ensure common fields exist
      if (q.text == null) q.text = item?.text || 'سؤال';
      if (!Array.isArray(q.hints)) q.hints = q.hints ? [q.hints] : [];
      if (q.solution == null) q.solution = '';
      if (q.type === 'ordering' && !Array.isArray(q.items)) {
        q.items = Array.isArray(item?.items)
          ? item.items
          : Array.isArray(item?.choices)
            ? item.choices
            : Array.isArray(q?.choices)
              ? q.choices
              : [];
      }

      return q;
    }

    // Otherwise infer from item structure (question written directly in flow)
    const inferredType =
      item?.qtype ||
      item?.questionType ||
      (item?.type && item.type !== 'question' ? item.type : null) ||
      (Array.isArray(item?.choices) ? 'mcq' : 'input');

    const q = {
      type: inferredType,
      text: item?.text || 'سؤال',
      hints: Array.isArray(item?.hints) ? item.hints : [],
      solution: item?.solution || '',
    };

    if (inferredType === 'mcq') {
      q.choices = item?.choices || [];
      q.correctIndex = typeof item?.correctIndex === 'number' ? item.correctIndex : 0;
    } else if (inferredType === 'ordering') {
      q.items = Array.isArray(item?.items)
        ? item.items
        : Array.isArray(item?.choices)
          ? item.choices
          : [];
    } else {
      q.answer = item?.answer ?? '';
      q.placeholder = item?.placeholder;
    }

    return q;
  }

  function getStableQuestionObjectForFlowItem(item) {
    // IMPORTANT: keep one normalized question object per flow item
    // so UI state (like input value / selected choice) can persist across re-renders.
    if (item?._qState && typeof item._qState === 'object') {
      return item._qState;
    }

    const q = buildNormalizedQuestionFromItem(item);

    // Store on the flow item itself (stable if flow is cached)
    if (item) item._qState = q;

    return q;
  }

  function normalizeAssessment(assessmentData) {
    if (!assessmentData || !Array.isArray(assessmentData.questions)) return null;

    const questions = assessmentData.questions.map((question) => {
      if (!question || typeof question !== 'object') return null;

      const inferredType =
        question?.type ||
        (Array.isArray(question?.choices) ? 'mcq' : 'input');

      const normalized = {
        ...question,
        type: inferredType,
        text: question?.text || 'سؤال',
        points: Number.isFinite(question?.points) ? Number(question.points) : 1,
      };

      if (inferredType === 'mcq') {
        normalized.choices = Array.isArray(question?.choices) ? question.choices : [];
        normalized.correctIndex =
          typeof question?.correctIndex === 'number' ? question.correctIndex : 0;
      } else {
        normalized.answer = question?.answer ?? '';
        normalized.placeholder = question?.placeholder || 'اكتب إجابتك هنا';
      }

      return normalized;
    }).filter(Boolean);

    if (!questions.length) return null;

    return {
      title: assessmentData?.title || 'تقييم الدرس',
      description: assessmentData?.description || 'اختبار تقييم من نقاط دون تصويب.',
      questions,
    };
  }

  function totalFlowItems() {
    const concepts = data.concepts || [];
    let total = 0;
    for (const c of concepts) total += getConceptFlow(c).length;
    return total;
  }

  function totalStages() {
    const base = 2 + totalFlowItems();
    const total = assessment ? base + 1 : base;
    return Math.max(1, total);
  }

  function currentFlowPosition() {
    const concepts = data.concepts || [];
    let pos = 0;
    for (let i = 0; i < conceptIndex; i++) pos += getConceptFlow(concepts[i]).length;
    pos += itemIndex;
    return pos;
  }

  function currentStagePosition() {
    if (stage === STAGES.GOALS) return 0;
    if (stage === STAGES.PREREQ) return 1;
    if (stage === STAGES.CONCEPT) return 2 + currentFlowPosition();
    return totalStages() - 1;
  }

  function updateProgress() {
    const total = totalStages();
    const pos = currentStagePosition();
    const pct = Math.max(0, Math.min(100, Math.round(((pos + 1) / total) * 100)));
    setProgressUI(pct);
  }

  function saveProgress() {
    setStudentProgress(studentId, week, {
      stage,
      conceptIndex,
      stepIndex: itemIndex,
      assessment: assessmentState,
    });
  }

  function clampToValidPosition() {
    const concepts = data.concepts || [];
    if (!concepts.length) {
      conceptIndex = 0;
      itemIndex = 0;
      return;
    }

    conceptIndex = Math.max(0, Math.min(conceptIndex, concepts.length - 1));

    const flow = getConceptFlow(concepts[conceptIndex]);
    if (!flow.length) {
      itemIndex = 0;
      return;
    }

    itemIndex = Math.max(0, Math.min(itemIndex, flow.length - 1));
  }

  function applyResumeIfAvailable() {
    if (isCardDone(studentId, week)) return;

    const saved = getStudentProgress(studentId, week)?.progress;
    if (!saved) return;

    if (saved.stage && Object.values(STAGES).includes(saved.stage)) {
      stage = saved.stage;
    }

    if (Number.isFinite(saved.conceptIndex)) conceptIndex = Number(saved.conceptIndex);
    if (Number.isFinite(saved.stepIndex)) itemIndex = Number(saved.stepIndex);

    if (saved.assessment && typeof saved.assessment === 'object') {
      assessmentState = {
        ...assessmentState,
        ...saved.assessment,
      };
    }

    clampToValidPosition();

    // focus the current item after first render
    pendingFocus = { conceptIndex, itemIndex };
    firstPaint = true;
  }

  function isLastPosition() {
    const concepts = data.concepts || [];
    if (!concepts.length) return true;

    const lastConceptIdx = concepts.length - 1;
    const lastFlow = getConceptFlow(concepts[lastConceptIdx]);
    const lastItemIdx = Math.max(0, lastFlow.length - 1);

    return conceptIndex === lastConceptIdx && itemIndex === lastItemIdx;
  }

  function finishCard() {
    // Persist completion
    markCardDone(studentId, week);

    // Pass title for certificate hook readiness
    const cardTitle = String(data?.title || '');
    const finalScore = Number.isFinite(assessmentState?.score) ? assessmentState.score : 0;

    // Use existing completion handler (shows UI + returns home)
    completeLesson({ studentId, week, cardTitle, finalScore });
  }

  function render() {
    mountEl.innerHTML = '';
    activeQuestion = null;

    if (stage === STAGES.GOALS) {
      renderGoalsStage();
      return;
    }

    if (stage === STAGES.PREREQ) {
      renderPrereqStage();
      return;
    }

    if (stage === STAGES.ASSESSMENT) {
      renderAssessmentStage();
      return;
    }

    renderConceptStage();
  }

  function renderGoalsStage() {
    const card = document.createElement('div');
    card.className = 'lesson-stage card';

    card.innerHTML = `
      <div class="stage-header">
        <span class="stage-badge">المرحلة الأولى</span>
        <h3 class="stage-title">عرض الأهداف كاملة</h3>
      </div>
      <div class="stage-body"></div>
    `;

    const body = card.querySelector('.stage-body');
    const list = document.createElement('ul');
    list.className = 'goal-list';

    if (goalsList.length) {
      goalsList.forEach((goal, idx) => {
        const item = document.createElement('li');
        item.className = 'goal-item';
        item.innerHTML = `
          <span class="goal-index">${idx + 1}</span>
          <span class="goal-text">${escapeHtml(goal.text)}</span>
        `;
        list.appendChild(item);
      });
    } else {
      const empty = document.createElement('div');
      empty.className = 'stage-empty';
      empty.textContent = 'لا توجد أهداف مسجلة بعد.';
      body.appendChild(empty);
    }

    body.appendChild(list);

    const nav = document.createElement('div');
    nav.className = 'lesson-nav';

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary w-100';
    btn.textContent = 'متابعة';
    btn.addEventListener('click', () => {
      stage = STAGES.PREREQ;
      render();
    });

    nav.appendChild(btn);
    card.appendChild(nav);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();
  }

  function renderPrereqStage() {
    const card = document.createElement('div');
    card.className = 'lesson-stage card';

    card.innerHTML = `
      <div class="stage-header">
        <span class="stage-badge">المرحلة الثانية</span>
        <h3 class="stage-title">عرض المتطلبات السابقة</h3>
      </div>
      <div class="stage-body"></div>
    `;

    const body = card.querySelector('.stage-body');
    const list = document.createElement('ul');
    list.className = 'goal-list prereq-list';

    if (prereqList.length) {
      prereqList.forEach((req, idx) => {
        const item = document.createElement('li');
        item.className = 'goal-item';
        item.innerHTML = `
          <span class="goal-index">${idx + 1}</span>
          <span class="goal-text">${escapeHtml(req)}</span>
        `;
        list.appendChild(item);
      });
    } else {
      const empty = document.createElement('div');
      empty.className = 'stage-empty';
      empty.textContent = 'لا توجد متطلبات سابقة لهذه البطاقة.';
      body.appendChild(empty);
    }

    body.appendChild(list);

    const nav = document.createElement('div');
    nav.className = 'lesson-nav';

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary w-100';
    btn.textContent = 'متابعة';
    btn.addEventListener('click', () => {
      stage = STAGES.CONCEPT;
      conceptIndex = 0;
      itemIndex = 0;
      render();
    });

    nav.appendChild(btn);
    card.appendChild(nav);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();
  }

  function renderConceptStage() {
    const concept = data.concepts?.[conceptIndex];
    if (!concept) {
      if (assessment) {
        stage = STAGES.ASSESSMENT;
        render();
        return;
      }
      finishCard();
      return;
    }

    const flow = getConceptFlow(concept);
    if (!flow.length) {
      conceptIndex++;
      itemIndex = 0;
      render();
      return;
    }

    // clamp
    if (itemIndex < 0) itemIndex = 0;

    if (itemIndex >= flow.length) {
      conceptIndex++;
      itemIndex = 0;
      render();
      return;
    }

    const card = document.createElement('div');
    card.className = 'concept';

    const cardInner = document.createElement('div');
    cardInner.className = 'card';

    cardInner.innerHTML = `
      <div class="stage-progress">
        <span class="stage-badge">المرحلة الثالثة</span>
        <div class="stage-progress-body"></div>
      </div>
      <div class="concept-header">
        <div class="row">
          <span class="concept-index">${conceptIndex + 1}</span>
          <h3 class="concept-title">${escapeHtml(concept.title || '')}</h3>
        </div>
      </div>
      <div class="concept-body" data-concept-index="${conceptIndex}"></div>
    `;

    const stageBody = cardInner.querySelector('.stage-progress-body');
    stageBody.appendChild(renderGoalsProgress(conceptIndex));

    const body = cardInner.querySelector('.concept-body');

    // render items up to current
    for (let i = 0; i <= itemIndex; i++) {
      const item = flow[i];
      if (!item || !item.type) continue;

      if (isQuestionItem(item)) {
        body.appendChild(renderQuestionItem(item, i));
      } else if (item.type === 'video') {
        body.appendChild(renderVideoItem(item, i));
      } else {
        body.appendChild(renderTextItem(item, i));
      }
    }

    // single button bar (always)
    const bar = document.createElement('div');
    bar.className = 'lesson-nav';

    const btn = document.createElement('button');
    btn.className = 'btn btn-primary w-100';
    btn.textContent = 'متابعة';

    bar.appendChild(btn);
    body.appendChild(bar);

    // decide behavior for current item
    const currentItem = flow[itemIndex];
    if (isQuestionItem(currentItem) && activeQuestion) {
      activeQuestion.btn = btn;
      btn.addEventListener('click', () => onVerifyOrAdvanceQuestion());
    } else {
      btn.addEventListener('click', () => advanceWithFocus());
    }

    card.appendChild(cardInner);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();

    if (pendingFocus) {
      requestAnimationFrame(() => {
        scrollAndFocusToItem(pendingFocus.itemIndex);
        pendingFocus = null;
      });
    }
    firstPaint = false;
  }

  function renderAssessmentStage() {
    if (!assessment) {
      finishCard();
      return;
    }

    const card = document.createElement('div');
    card.className = 'lesson-stage card assessment';

    card.innerHTML = `
      <div class="stage-header">
        <span class="stage-badge">المرحلة الرابعة</span>
        <h3 class="stage-title">${escapeHtml(assessment.title)}</h3>
        <p class="stage-desc">${escapeHtml(assessment.description)}</p>
      </div>
      <div class="stage-body assessment-body"></div>
    `;

    const body = card.querySelector('.assessment-body');

    assessment.questions.forEach((question, index) => {
      const item = document.createElement('div');
      item.className = 'assessment-question';
      item.appendChild(renderAssessmentQuestion(question, index));
      body.appendChild(item);
    });

    const actions = document.createElement('div');
    actions.className = 'lesson-nav';

    const btnSubmit = document.createElement('button');
    btnSubmit.className = 'btn btn-primary w-100';
    btnSubmit.textContent = 'احسب النتيجة';

    const btnFinish = document.createElement('button');
    btnFinish.className = 'btn btn-outline w-100';
    btnFinish.textContent = 'إنهاء البطاقة';

    const result = document.createElement('div');
    result.className = 'assessment-result hidden';

    if (assessmentState.completed) {
      applyAssessmentResult(result, assessmentState);
      result.classList.remove('hidden');
      btnSubmit.disabled = true;
    }

    btnSubmit.addEventListener('click', () => {
      if (assessmentState.completed && assessmentState.attempts >= 2) return;

      const { score, total } = scoreAssessment(assessment.questions);
      assessmentState = {
        attempts: assessmentState.attempts + 1,
        completed: true,
        score,
        total,
      };

      showToast('نتيجة التقييم', `حصلت على ${score} من ${total} نقطة.`, 'success', 3500);
      render();
    });

    btnFinish.addEventListener('click', () => {
      if (!assessmentState.completed) {
        showToast('تنبيه', 'احسب النتيجة أولًا قبل إنهاء البطاقة', 'warning');
        return;
      }
      finishCard();
    });

    actions.appendChild(btnSubmit);
    actions.appendChild(btnFinish);

    card.appendChild(actions);
    card.appendChild(result);
    mountEl.appendChild(card);

    updateProgress();
    saveProgress();
  }

  function applyAssessmentResult(container, state) {
    const retryLeft = state.attempts < 2;

    container.innerHTML = `
      <div class="assessment-score">
        حصلت على <strong>${state.score}</strong> من <strong>${state.total}</strong> نقطة.
      </div>
      <div class="assessment-note">
        ${retryLeft ? 'يمكنك إعادة المحاولة مرة واحدة فقط.' : 'تم استهلاك فرصة إعادة المحاولة.'}
      </div>
    `;

    if (retryLeft) {
      const btnRetry = document.createElement('button');
      btnRetry.type = 'button';
      btnRetry.className = 'btn btn-ghost w-100';
      btnRetry.textContent = 'إعادة المحاولة (مرة واحدة)';
      btnRetry.addEventListener('click', () => {
        assessmentState = {
          attempts: state.attempts,
          completed: false,
          score: null,
          total: null,
        };

        assessment.questions.forEach((question) => resetAssessmentQuestion(question));
        render();
      });
      container.appendChild(btnRetry);
    }
  }

  function renderTextItem(item, idx) {
    const map = {
      goal:     { title: 'الهدف', cls: '' },
      explain:  { title: 'الشرح', cls: '' },
      example:  { title: 'مثال محلول', cls: 'example' },
      example2: { title: 'مثال إضافي', cls: 'example' },
      mistake:  { title: 'خطأ شائع', cls: 'warning' },
      note:     { title: 'ملاحظة', cls: 'note' },
      detail:   { title: 'تفصيل إضافي', cls: 'detail' },
    };

    const cfg = map[item.type] || { title: 'محتوى', cls: '' };

    const el = document.createElement('div');
    el.className = `step ${cfg.cls || ''}`.trim();
    el.setAttribute('data-step-index', String(idx));
    el.setAttribute('data-step-key', item.type);

    const details = Array.isArray(item.details)
      ? item.details.map((line) => `<li>${escapeHtml(line)}</li>`).join('')
      : '';

    el.innerHTML = `
      <p class="step-title">${cfg.title}</p>
      <div class="step-text">${escapeHtml(item.text ?? '')}</div>
      ${details ? `<ul class="step-details">${details}</ul>` : ''}
    `;
    return el;
  }

  function renderVideoItem(item, idx) {
    const el = document.createElement('div');
    el.className = 'step video';
    el.setAttribute('data-step-index', String(idx));
    el.setAttribute('data-step-key', 'video');

    const title = item?.title || 'فيديو توضيحي';
    const description = item?.description || item?.text || '';
    const url = item?.url || item?.src || '';

    const embed = renderVideoEmbed(url);

    el.innerHTML = `
      <p class="step-title">${escapeHtml(title)}</p>
      ${description ? `<div class="step-text">${escapeHtml(description)}</div>` : ''}
      <div class="video-frame">${embed}</div>
    `;

    return el;
  }

  function renderVideoEmbed(url) {
    if (!url) {
      return '<div class="video-empty">لم يتم إضافة رابط فيديو بعد.</div>';
    }

    const youtubeId = getYouTubeId(url);
    if (youtubeId) {
      const safeId = encodeURIComponent(youtubeId);
      return `
        <iframe
          class="video-embed"
          src="https://www.youtube.com/embed/${safeId}"
          title="فيديو الدرس"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      `;
    }

    return `
      <video class="video-embed" controls preload="metadata" src="${escapeHtml(url)}"></video>
    `;
  }

  function isQuestionItem(item) {
    return item?.type === 'question' || item?.type === 'ordering';
  }

  function renderQuestionItem(item, idx) {
    const wrap = document.createElement('div');
    wrap.className = 'question-wrap';
    wrap.setAttribute('data-step-index', String(idx));
    wrap.setAttribute('data-step-key', 'question');

    // IMPORTANT: stable question object for this flow item (persists across re-renders)
    const qData = getStableQuestionObjectForFlowItem(item);

    const title = document.createElement('p');
    title.className = 'question-title';
    title.textContent = qData.text || 'سؤال';

    const attemptsWrap = document.createElement('div');
    attemptsWrap.className = 'attempts';
    attemptsWrap.innerHTML = `
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    `;

    const qMount = document.createElement('div');

    const actions = document.createElement('div');
    actions.className = 'question-actions';
    actions.appendChild(attemptsWrap);

    wrap.appendChild(title);
    wrap.appendChild(qMount);
    wrap.appendChild(actions);

    try {
      const q = renderQuestion({ mountEl: qMount, question: qData });

      activeQuestion = {
        check: q.check,
        attempts: 0,
        solutionShown: false,
        btn: null,
        dotsWrap: attemptsWrap,
        container: wrap,
        qData,
        verifiedOk: false,
      };
    } catch (err) {
      console.error(err);
      const errBox = document.createElement('div');
      errBox.className = 'solution';
      errBox.innerHTML = `
        <p class="solution-title">خطأ في إعداد السؤال</p>
        <div class="solution-text">تأكد من نوع السؤال وحقوله (input/mcq).</div>
      `;
      wrap.appendChild(errBox);
      showToast('خطأ', 'في مشكلة ببيانات السؤال (JSON)', 'error', 4500);
      activeQuestion = null;
    }

    return wrap;
  }

  function renderAssessmentQuestion(question, index) {
    const wrap = document.createElement('div');
    wrap.className = 'assessment-item';

    const title = document.createElement('p');
    title.className = 'assessment-title';
    title.textContent = `${index + 1}. ${question.text}`;

    wrap.appendChild(title);

    if (question.type === 'mcq') {
      const groupName = `assessment-${index}`;

      (question.choices || []).forEach((choice, cIdx) => {
        const label = document.createElement('label');
        label.className = 'choice';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = groupName;
        radio.value = String(cIdx);
        radio.checked = question._selectedIndex === cIdx;
        radio.addEventListener('change', () => {
          question._selectedIndex = cIdx;
        });

        const span = document.createElement('span');
        span.textContent = choice;

        label.appendChild(radio);
        label.appendChild(span);
        wrap.appendChild(label);
      });

      return wrap;
    }

    const input = document.createElement('input');
    input.className = 'input ltr';
    input.type = 'text';
    input.placeholder = question.placeholder || 'اكتب إجابتك هنا';
    input.value = question._value || '';
    input.addEventListener('input', () => {
      question._value = input.value;
    });

    wrap.appendChild(input);
    return wrap;
  }

  function resetAssessmentQuestion(question) {
    delete question._value;
    delete question._selectedIndex;
  }

  function scoreAssessment(questions) {
    let score = 0;
    let total = 0;

    questions.forEach((question) => {
      const points = Number.isFinite(question.points) ? question.points : 1;
      total += points;

      if (question.type === 'mcq') {
        if (question._selectedIndex === question.correctIndex) score += points;
        return;
      }

      const rawUser = question._value ?? '';
      const rawAns = question.answer ?? '';
      const ok = compareAnswer(rawUser, rawAns);
      if (ok) score += points;
    });

    return { score, total };
  }

  function compareAnswer(userValue, answerValue) {
    const user = normalizeSpaces(userValue);
    const ans = normalizeSpaces(answerValue);

    if (isNumericAnswer(ans)) {
      const userNum = parseNumericValue(user);
      const ansNum = parseNumericValue(ans);

      return Number.isFinite(userNum) && Number.isFinite(ansNum) && userNum === ansNum;
    }

    return user !== '' && user === ans;
  }

  function normalizeSpaces(s) {
    if (s == null) return '';
    return String(s).trim().replace(/\s+/g, ' ');
  }

  function toLatinDigits(str) {
    const map = {
      '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
      '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
      '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
      '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
    };
    return String(str).replace(/[٠-٩۰-۹]/g, (d) => map[d] ?? d);
  }

  function parseNumericValue(value) {
    if (value == null) return NaN;
    const normalized = toLatinDigits(String(value))
      .trim()
      .replace(',', '.')
      .replace(/\s+/g, '');

    if (!/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(normalized)) return NaN;

    const num = Number(normalized);
    return Number.isFinite(num) ? num : NaN;
  }

  function isNumericAnswer(ans) {
    return Number.isFinite(parseNumericValue(ans));
  }

  function getYouTubeId(url) {
    try {
      const parsed = new URL(url);
      if (parsed.hostname.includes('youtu.be')) {
        return parsed.pathname.replace('/', '');
      }
      if (parsed.hostname.includes('youtube.com')) {
        return parsed.searchParams.get('v');
      }
    } catch {
      return null;
    }
    return null;
  }

  function onVerifyOrAdvanceQuestion() {
    if (!activeQuestion || !activeQuestion.btn) return;

    if (activeQuestion.verifiedOk) {
      advanceWithFocus();
      return;
    }

    const ok = activeQuestion.check();

    if (ok) {
      activeQuestion.verifiedOk = true;
      activeQuestion.btn.disabled = true;

      showToast('صح ✔', pickRandom(ENCOURAGEMENTS), 'success');

      setTimeout(() => {
        advanceWithFocus();
      }, 850);

      return;
    }

    activeQuestion.attempts++;
    const a = activeQuestion.attempts;

    if (a <= ENGINE.MAX_ATTEMPTS) {
      markAttempt(activeQuestion.dotsWrap, a);

      if (a < ENGINE.MAX_ATTEMPTS) {
        const hint =
          activeQuestion.qData.hints?.[a - 1] ||
          DEFAULT_HINTS[a - 1] ||
          FINAL_HINT;

        showToast('تلميح', hint, 'warning', 4000);
      } else {
        const hint3 = activeQuestion.qData.hints?.[a - 1] || FINAL_HINT;
        showToast('تلميح قوي', hint3, 'warning', 4500);

        if (!activeQuestion.solutionShown) {
          showToast('الحل', 'تم عرض الحل النموذجي تحت', 'danger', 4500);
          showSolution(activeQuestion.container, activeQuestion.qData.solution);
          activeQuestion.solutionShown = true;
        }
      }
    } else {
      showToast('جرّب كمان', 'ارجع للحل واعمل متابعة مرة ثانية', 'info', 2500);
    }
  }

  function markAttempt(wrap, count) {
    const dots = wrap.querySelectorAll('.dot');
    for (let i = 0; i < count && i < dots.length; i++) {
      dots[i].classList.add('used');
    }
  }

  function showSolution(container, solutionText) {
    const existing = container.querySelector('.solution');
    if (existing) return;

    const sol = document.createElement('div');
    sol.className = 'solution';
    sol.innerHTML = `
      <p class="solution-title">الحل النموذجي</p>
      <div class="solution-text">${escapeHtml(solutionText || '')}</div>
    `;
    container.appendChild(sol);
  }

  function setPendingFocusToNext() {
    const concepts = data.concepts || [];
    const concept = concepts[conceptIndex];
    const flow = concept ? getConceptFlow(concept) : [];

    let nextConcept = conceptIndex;
    let nextItem = itemIndex + 1;

    if (nextItem >= flow.length) {
      nextConcept = conceptIndex + 1;
      nextItem = 0;
    }

    pendingFocus = { conceptIndex: nextConcept, itemIndex: nextItem };
  }

  function advance() {
    const concepts = data.concepts || [];
    const concept = concepts[conceptIndex];
    const flow = concept ? getConceptFlow(concept) : [];

    // If we are at the last item of the last concept and trying to advance
    if (isLastPosition()) {
      if (assessment) {
        stage = STAGES.ASSESSMENT;
        render();
        return;
      }
      finishCard();
      return;
    }

    itemIndex++;
    if (itemIndex >= flow.length) {
      conceptIndex++;
      itemIndex = 0;
    }
    render();
  }

  function advanceWithFocus() {
    setPendingFocusToNext();
    advance();
  }

  function scrollAndFocusToItem(iIdx) {
    const target = mountEl.querySelector(`[data-step-index="${iIdx}"]`);
    if (!target) return;

    if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex', '-1');

    target.scrollIntoView({ behavior: 'smooth', block: 'start' });

    try {
      target.focus({ preventScroll: true });
    } catch {
      target.focus();
    }
  }

  function renderGoalsProgress(currentIndex) {
    const list = document.createElement('ul');
    list.className = 'goal-progress';

    if (!goalsList.length) {
      const empty = document.createElement('li');
      empty.className = 'goal-progress-item muted';
      empty.textContent = 'لم يتم تحديد أهداف لهذه البطاقة بعد.';
      list.appendChild(empty);
      return list;
    }

    goalsList.forEach((goal, idx) => {
      const item = document.createElement('li');
      let status = 'upcoming';
      let statusText = 'قادم';

      if (idx < currentIndex) {
        status = 'done';
        statusText = 'مكتمل ✔️';
      } else if (idx === currentIndex) {
        status = 'current';
        statusText = 'الهدف الحالي';
      }

      item.className = `goal-progress-item ${status}`;
      item.innerHTML = `
        <span class="goal-status">${statusText}</span>
        <span class="goal-text">${escapeHtml(goal.text)}</span>
      `;

      list.appendChild(item);
    });

    return list;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function getGoalsList(dataObj) {
    if (Array.isArray(dataObj?.goals) && dataObj.goals.length) {
      return dataObj.goals.map((goal) => ({
        text: typeof goal === 'string' ? goal : String(goal?.text || ''),
      })).filter((goal) => goal.text.trim() !== '');
    }

    const goals = [];
    (dataObj?.concepts || []).forEach((concept) => {
      const flow = Array.isArray(concept?.flow) ? concept.flow : [];
      const goalItem = flow.find((item) => item?.type === 'goal');
      const text = goalItem?.text || concept?.title || 'هدف';
      goals.push({ text: String(text) });
    });

    return goals;
  }

  function getPrereqList(dataObj) {
    if (Array.isArray(dataObj?.prerequisites)) {
      return dataObj.prerequisites.filter((item) => String(item).trim() !== '')
        .map((item) => String(item));
    }

    if (Array.isArray(dataObj?.prereq)) {
      return dataObj.prereq.filter((item) => String(item).trim() !== '')
        .map((item) => String(item));
    }

    return [];
  }

  // Apply resume (if any) before first render
  applyResumeIfAvailable();

  // start
  render();
}
math/public/assets/js/lesson/lessonPage.js
/* =========================================================
   lessonPage.js — Lesson Page Bootstrap
   - Reads student + week
   - Loads week JSON
   - Initializes engine
   - Shows student name (firstName/fullName) instead of id
   ========================================================= */

import { getWeekParam, goHome } from '../core/router.js';
import { fetchJson } from '../core/api.js';
import { weekJsonPath } from '../core/constants.js';
import { getLastStudentId, getStudentSession } from '../core/storage.js';
import { showToast } from '../ui/toast.js';
import { initEngine } from './engine.js';


export async function initLessonPage() {
  const week = getWeekParam();
  const studentId = getLastStudentId();

  if (!week) {
    goHome();
    return;
  }

  if (!studentId) {
    showToast('تنبيه', 'لازم تدخل بيانات الطالب أولًا', 'warning');
    goHome();
    return;
  }

  const student = getStudentSession();
  const displayName =
    (student?.firstName && String(student.firstName).trim()) ||
    (student?.fullName && String(student.fullName).trim()) ||
    `طالب ${studentId}`;

  // UI refs
  const titleEl = document.getElementById('lessonTitle');
  const studentEl = document.getElementById('lessonStudent');
  const weekEl = document.getElementById('lessonWeek');
  const contentEl = document.getElementById('lessonContent');
  const completeEl = document.getElementById('lessonComplete');

  studentEl.textContent = displayName;
  weekEl.textContent = `week ${week}`;

  if (completeEl) {
    completeEl.classList.add('hidden');
    completeEl.setAttribute('hidden', 'hidden');
  }

  try {
    const data = await fetchJson(weekJsonPath(week), { noStore: true });

    titleEl.textContent = data.title || `بطاقة الأسبوع ${week}`;

    // init engine
    initEngine({
      week,
      studentId,
      data,
      mountEl: contentEl,
    });
  } catch (e) {
    console.error(e);
    titleEl.textContent = 'خطأ في تحميل البطاقة';
    showToast('خطأ', 'تعذر تحميل بيانات الدرس', 'error');
  }
}
math/public/assets/js/lesson/progress.js
/* =========================================================
   progress.js — Progress Calculation & UI
   ========================================================= */

export function calcProgressPercent({ data, conceptIndex, stepIndex, stepsPerConcept }) {
  const concepts = data?.concepts || [];
  const totalConcepts = concepts.length || 1;

  const totalSteps = totalConcepts * stepsPerConcept;
  const currentStep = (conceptIndex * stepsPerConcept) + stepIndex;

  const pct = Math.max(0, Math.min(100, Math.round((currentStep / totalSteps) * 100)));
  return pct;
}

export function setProgressUI(percent) {
  const bar = document.getElementById('progressBar');
  const txt = document.getElementById('progressPercent');
  if (bar) bar.style.width = `${percent}%`;
  if (txt) txt.textContent = `${percent}%`;
}
math/public/assets/js/lesson/registry.js
/* =========================================================
   registry.js — Question Type Registry
   - renderQuestion({ mountEl, question }) => { check() }
   ========================================================= */

import { renderInputQuestion } from './input.js';
import { renderMcqQuestion } from './mcq.js';
import { renderMatchQuestion } from './match.js';

const REGISTRY = {
  input: renderInputQuestion,
  mcq: renderMcqQuestion,
  match: renderMatchQuestion, // structure only for now
};

export function renderQuestion({ mountEl, question }) {
  if (!question || !question.type) {
    throw new Error('سؤال غير صالح: type مفقود');
  }

  const renderer = REGISTRY[question.type];
  if (!renderer) {
    throw new Error(`نوع سؤال غير مدعوم: ${question.type}`);
  }

  return renderer({ mountEl, question });
}

export function registerQuestionType(type, renderer) {
  REGISTRY[type] = renderer;
}
math/public/assets/js/mng/cardEditor.js
import { showToast } from '../ui/toast.js';

const elements = {
  cardTitle: document.getElementById('cardTitle'),
  cardSubtitle: document.getElementById('cardSubtitle'),
  sectionsList: document.getElementById('sectionsList'),
  editorContent: document.getElementById('editorContent'),
  btnSave: document.getElementById('btnSave'),
  btnAddConcept: document.getElementById('btnAddConcept'),
  btnAddItem: document.getElementById('btnAddItem'),
  btnAddQuestion: document.getElementById('btnAddQuestion'),
  btnBack: document.getElementById('btnBack'),
  confirmLeave: document.getElementById('confirmLeave'),
  btnCloseLeave: document.getElementById('btnCloseLeave'),
  btnCancelLeave: document.getElementById('btnCancelLeave'),
  btnConfirmLeave: document.getElementById('btnConfirmLeave')
};

const state = {
  week: null,
  seq: null,
  title: '',
  goals: [],
  prerequisites: [],
  concepts: [],
  assessment: { title: '', description: '', questions: [] },
  activeSection: 'goals',
  dirty: false,
  pendingNavigation: null
};

function normalizeValue(value) {
  return value == null ? '' : String(value).trim();
}

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function setDirty(value = true) {
  state.dirty = value;
}

function getWeekParam() {
  const params = new URLSearchParams(window.location.search);
  const raw = params.get('week');
  const parsed = raw ? Number(raw) : null;
  return Number.isFinite(parsed) ? parsed : null;
}

function setHeader() {
  const seqLabel = state.seq != null ? state.seq : '—';
  const titleLabel = state.title || 'بدون عنوان';
  elements.cardTitle.textContent = `بطاقة رقم ${seqLabel}: ${titleLabel}`;
  elements.cardSubtitle.textContent = `المعرّف الداخلي: ${state.week ?? '—'}`;
}

function buildSections() {
  const sections = [
    { id: 'goals', label: 'ترحيب / ماذا سنتعلم' },
    { id: 'prerequisites', label: 'متطلب سابق' }
  ];

  state.concepts.forEach((concept, index) => {
    sections.push({
      id: `concept-${index}`,
      label: `المفهوم ${index + 1}: ${concept.title || 'بدون عنوان'}`
    });
  });

  sections.push({ id: 'assessment', label: 'التقييم النهائي' });
  return sections;
}

function renderSidebar() {
  const sections = buildSections();
  elements.sectionsList.innerHTML = sections
    .map((section) => {
      const activeClass = section.id === state.activeSection ? 'active' : '';
      return `<li class="sidebar-item ${activeClass}" data-section="${section.id}">${escapeHtml(section.label)}</li>`;
    })
    .join('');
}

function renderGoalsSection() {
  const items = state.goals.length ? state.goals : [''];
  elements.editorContent.innerHTML = `
    <h2 class="section-title">ترحيب / ماذا سنتعلم</h2>
    ${items
      .map(
        (goal, index) => `
          <div class="item-card" data-index="${index}">
            <label class="label">هدف ${index + 1}</label>
            <input class="input" data-type="goal" data-index="${index}" value="${escapeHtml(goal)}" />
            <div class="item-actions">
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-goal" data-direction="up" data-index="${index}">⬆️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-goal" data-direction="down" data-index="${index}">⬇️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-goal" data-index="${index}">حذف</button>
            </div>
          </div>
        `
      )
      .join('')}
    <button class="btn btn-outline" data-action="add-goal">إضافة هدف</button>
  `;
}

function renderPrereqSection() {
  const items = state.prerequisites.length ? state.prerequisites : [''];
  elements.editorContent.innerHTML = `
    <h2 class="section-title">المتطلب السابق</h2>
    ${items
      .map(
        (item, index) => `
          <div class="item-card" data-index="${index}">
            <label class="label">متطلب ${index + 1}</label>
            <input class="input" data-type="prereq" data-index="${index}" value="${escapeHtml(item)}" />
            <div class="item-actions">
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-prereq" data-direction="up" data-index="${index}">⬆️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="move-prereq" data-direction="down" data-index="${index}">⬇️</button>
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-prereq" data-index="${index}">حذف</button>
            </div>
          </div>
        `
      )
      .join('')}
    <button class="btn btn-outline" data-action="add-prereq">إضافة متطلب</button>
  `;
}

function renderStringList(list, listName, conceptIndex, flowIndex) {
  const items = list.length ? list : [''];
  return `
    <div class="inline-input">
      ${items
        .map(
          (value, index) => `
            <div class="row" style="margin-top: 6px;">
              <input class="input" data-list="${listName}" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" data-index="${index}" value="${escapeHtml(value)}" />
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-list-item" data-list="${listName}" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" data-index="${index}">حذف</button>
            </div>
          `
        )
        .join('')}
      <button class="btn btn-ghost btn-sm small-btn" data-action="add-list-item" data-list="${listName}" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">إضافة</button>
    </div>
  `;
}

function renderFlowItem(item, conceptIndex, flowIndex) {
  const type = item.type || 'goal';
  const showText = ['goal', 'explain', 'question', 'note', 'mcq'].includes(type);
  const showTitle = ['explain', 'video'].includes(type);
  const showDescription = ['explain', 'note', 'image', 'video'].includes(type);
  const showUrl = ['image', 'video'].includes(type);
  const showAnswer = ['question', 'mcq'].includes(type);
  const showChoices = type === 'mcq';

  return `
    <div class="item-card" data-flow-index="${flowIndex}">
      <div class="flow-badge">${escapeHtml(type.toUpperCase())}</div>
      <div class="field">
        <label class="label">نوع العنصر</label>
        <select class="input" data-field="type" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">
          <option value="goal" ${type === 'goal' ? 'selected' : ''}>هدف</option>
          <option value="explain" ${type === 'explain' ? 'selected' : ''}>شرح</option>
          <option value="question" ${type === 'question' ? 'selected' : ''}>سؤال نصي</option>
          <option value="note" ${type === 'note' ? 'selected' : ''}>ملاحظة</option>
          <option value="image" ${type === 'image' ? 'selected' : ''}>صورة</option>
          <option value="video" ${type === 'video' ? 'selected' : ''}>فيديو</option>
          <option value="mcq" ${type === 'mcq' ? 'selected' : ''}>اختيار متعدد</option>
        </select>
      </div>
      ${showTitle ? `
        <div class="field">
          <label class="label">العنوان</label>
          <input class="input" data-field="title" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.title || '')}" />
        </div>
      ` : ''}
      ${showText ? `
        <div class="field">
          <label class="label">النص</label>
          <textarea class="input" rows="3" data-field="text" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">${escapeHtml(item.text || '')}</textarea>
        </div>
      ` : ''}
      ${showDescription ? `
        <div class="field">
          <label class="label">الوصف</label>
          <textarea class="input" rows="2" data-field="description" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">${escapeHtml(item.description || '')}</textarea>
        </div>
      ` : ''}
      ${showUrl ? `
        <div class="field">
          <label class="label">الرابط</label>
          <input class="input ltr" data-field="url" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.url || '')}" />
        </div>
      ` : ''}
      ${showAnswer ? `
        <div class="field">
          <label class="label">الإجابة</label>
          <input class="input" data-field="answer" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.answer || '')}" />
        </div>
      ` : ''}
      ${showChoices ? `
        <div class="field">
          <label class="label">الاختيارات</label>
          ${renderStringList(item.choices || [], 'choices', conceptIndex, flowIndex)}
        </div>
        <div class="field">
          <label class="label">رقم الإجابة الصحيحة</label>
          <input class="input ltr" data-field="correctIndex" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.correctIndex ?? 0)}" />
        </div>
      ` : ''}
      <div class="field">
        <label class="label">تفاصيل إضافية</label>
        ${renderStringList(item.details || [], 'details', conceptIndex, flowIndex)}
      </div>
      <div class="field">
        <label class="label">تلميحات</label>
        ${renderStringList(item.hints || [], 'hints', conceptIndex, flowIndex)}
      </div>
      <div class="field">
        <label class="label">الحل</label>
        <input class="input" data-field="solution" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}" value="${escapeHtml(item.solution || '')}" />
      </div>
      <div class="item-actions">
        <button class="btn btn-ghost btn-sm small-btn" data-action="move-flow" data-direction="up" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">⬆️</button>
        <button class="btn btn-ghost btn-sm small-btn" data-action="move-flow" data-direction="down" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">⬇️</button>
        <button class="btn btn-ghost btn-sm small-btn" data-action="delete-flow" data-concept-index="${conceptIndex}" data-flow-index="${flowIndex}">حذف</button>
      </div>
    </div>
  `;
}

function renderConceptSection(index) {
  const concept = state.concepts[index] || { title: '', flow: [] };
  const flowItems = concept.flow.length ? concept.flow : [];

  elements.editorContent.innerHTML = `
    <h2 class="section-title">المفهوم ${index + 1}</h2>
    <div class="field">
      <label class="label">عنوان المفهوم</label>
      <input class="input" data-concept-title="true" data-concept-index="${index}" value="${escapeHtml(concept.title || '')}" />
    </div>
    <div>
      ${flowItems.length
        ? flowItems.map((item, flowIndex) => renderFlowItem(item, index, flowIndex)).join('')
        : '<p class="muted">لا يوجد عناصر بعد. استخدم زر إضافة عنصر.</p>'}
    </div>
  `;
}

function renderAssessmentSection() {
  const assessment = state.assessment || { title: '', description: '', questions: [] };
  const questions = assessment.questions.length ? assessment.questions : [];

  elements.editorContent.innerHTML = `
    <h2 class="section-title">التقييم النهائي</h2>
    <div class="field">
      <label class="label">عنوان التقييم</label>
      <input class="input" data-assessment-field="title" value="${escapeHtml(assessment.title || '')}" />
    </div>
    <div class="field">
      <label class="label">الوصف</label>
      <textarea class="input" rows="2" data-assessment-field="description">${escapeHtml(assessment.description || '')}</textarea>
    </div>
    <div>
      ${questions.length
        ? questions
            .map(
              (question, index) => `
                <div class="item-card" data-question-index="${index}">
                  <label class="label">سؤال ${index + 1}</label>
                  <select class="input" data-question-field="type" data-question-index="${index}">
                    <option value="mcq" ${question.type === 'mcq' ? 'selected' : ''}>اختيار متعدد</option>
                    <option value="input" ${question.type === 'input' ? 'selected' : ''}>إجابة نصية</option>
                  </select>
                  <input class="input" data-question-field="text" data-question-index="${index}" value="${escapeHtml(question.text || '')}" />
                  <div class="row" style="margin-top: 8px;">
                    <input class="input ltr" data-question-field="points" data-question-index="${index}" value="${escapeHtml(question.points ?? 1)}" />
                    <span class="small muted">الدرجة</span>
                  </div>
                  ${question.type === 'input' ? `
                    <div class="field">
                      <label class="label">الإجابة النموذجية</label>
                      <input class="input" data-question-field="answer" data-question-index="${index}" value="${escapeHtml(question.answer || '')}" />
                    </div>
                  ` : `
                    <div class="field">
                      <label class="label">الاختيارات</label>
                      ${renderAssessmentChoices(question.choices || [], index)}
                    </div>
                    <div class="field">
                      <label class="label">رقم الإجابة الصحيحة</label>
                      <input class="input ltr" data-question-field="correctIndex" data-question-index="${index}" value="${escapeHtml(question.correctIndex ?? 0)}" />
                    </div>
                  `}
                  <div class="item-actions">
                    <button class="btn btn-ghost btn-sm small-btn" data-action="move-question" data-direction="up" data-question-index="${index}">⬆️</button>
                    <button class="btn btn-ghost btn-sm small-btn" data-action="move-question" data-direction="down" data-question-index="${index}">⬇️</button>
                    <button class="btn btn-ghost btn-sm small-btn" data-action="delete-question" data-question-index="${index}">حذف</button>
                  </div>
                </div>
              `
            )
            .join('')
        : '<p class="muted">لا يوجد أسئلة بعد. استخدم زر إضافة سؤال.</p>'}
    </div>
  `;
}

function renderAssessmentChoices(list, questionIndex) {
  const items = list.length ? list : [''];
  return `
    <div class="inline-input">
      ${items
        .map(
          (value, index) => `
            <div class="row" style="margin-top: 6px;">
              <input class="input" data-question-choice="true" data-question-index="${questionIndex}" data-index="${index}" value="${escapeHtml(value)}" />
              <button class="btn btn-ghost btn-sm small-btn" data-action="delete-question-choice" data-question-index="${questionIndex}" data-index="${index}">حذف</button>
            </div>
          `
        )
        .join('')}
      <button class="btn btn-ghost btn-sm small-btn" data-action="add-question-choice" data-question-index="${questionIndex}">إضافة اختيار</button>
    </div>
  `;
}

function renderPanel() {
  if (state.activeSection === 'goals') {
    renderGoalsSection();
  } else if (state.activeSection === 'prerequisites') {
    renderPrereqSection();
  } else if (state.activeSection.startsWith('concept-')) {
    const index = Number(state.activeSection.split('-')[1]);
    renderConceptSection(index);
  } else if (state.activeSection === 'assessment') {
    renderAssessmentSection();
  }
}

function renderAll() {
  renderSidebar();
  renderPanel();
}

function moveItem(array, fromIndex, direction) {
  const toIndex = direction === 'up' ? fromIndex - 1 : fromIndex + 1;
  if (toIndex < 0 || toIndex >= array.length) return;
  const item = array.splice(fromIndex, 1)[0];
  array.splice(toIndex, 0, item);
  setDirty(true);
  renderAll();
}

function handleSidebarClick(event) {
  const item = event.target.closest('.sidebar-item');
  if (!item) return;
  state.activeSection = item.dataset.section;
  renderAll();
}

function handleEditorInput(event) {
  const target = event.target;
  if (target.dataset.type === 'goal') {
    const index = Number(target.dataset.index);
    state.goals[index] = target.value;
    setDirty(true);
    return;
  }

  if (target.dataset.type === 'prereq') {
    const index = Number(target.dataset.index);
    state.prerequisites[index] = target.value;
    setDirty(true);
    return;
  }

  if (target.dataset.conceptTitle) {
    const index = Number(target.dataset.conceptIndex);
    state.concepts[index].title = target.value;
    setDirty(true);
    renderSidebar();
    return;
  }

  if (target.dataset.field) {
    const conceptIndex = Number(target.dataset.conceptIndex);
    const flowIndex = Number(target.dataset.flowIndex);
    const field = target.dataset.field;
    state.concepts[conceptIndex].flow[flowIndex][field] = target.value;
    setDirty(true);
    if (field === 'type') {
      renderPanel();
    }
    return;
  }

  if (target.dataset.list) {
    const conceptIndex = Number(target.dataset.conceptIndex);
    const flowIndex = Number(target.dataset.flowIndex);
    const listName = target.dataset.list;
    const index = Number(target.dataset.index);
    const list = state.concepts[conceptIndex].flow[flowIndex][listName] || [];
    list[index] = target.value;
    state.concepts[conceptIndex].flow[flowIndex][listName] = list;
    setDirty(true);
    return;
  }

  if (target.dataset.assessmentField) {
    const field = target.dataset.assessmentField;
    state.assessment[field] = target.value;
    setDirty(true);
    return;
  }

  if (target.dataset.questionField) {
    const index = Number(target.dataset.questionIndex);
    const field = target.dataset.questionField;
    state.assessment.questions[index][field] = target.value;
    setDirty(true);
    renderPanel();
    return;
  }

  if (target.dataset.questionChoice) {
    const questionIndex = Number(target.dataset.questionIndex);
    const index = Number(target.dataset.index);
    const choices = state.assessment.questions[questionIndex].choices || [];
    choices[index] = target.value;
    state.assessment.questions[questionIndex].choices = choices;
    setDirty(true);
  }
}

function handleEditorClick(event) {
  const button = event.target.closest('button[data-action]');
  if (!button) return;

  const action = button.dataset.action;

  if (action === 'add-goal') {
    state.goals.push('');
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-goal') {
    const index = Number(button.dataset.index);
    state.goals.splice(index, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-goal') {
    const index = Number(button.dataset.index);
    moveItem(state.goals, index, button.dataset.direction);
    return;
  }

  if (action === 'add-prereq') {
    state.prerequisites.push('');
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-prereq') {
    const index = Number(button.dataset.index);
    state.prerequisites.splice(index, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-prereq') {
    const index = Number(button.dataset.index);
    moveItem(state.prerequisites, index, button.dataset.direction);
    return;
  }

  if (action === 'add-list-item') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    const listName = button.dataset.list;
    const list = state.concepts[conceptIndex].flow[flowIndex][listName] || [];
    list.push('');
    state.concepts[conceptIndex].flow[flowIndex][listName] = list;
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-list-item') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    const listName = button.dataset.list;
    const index = Number(button.dataset.index);
    const list = state.concepts[conceptIndex].flow[flowIndex][listName] || [];
    list.splice(index, 1);
    state.concepts[conceptIndex].flow[flowIndex][listName] = list;
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-flow') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    state.concepts[conceptIndex].flow.splice(flowIndex, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-flow') {
    const conceptIndex = Number(button.dataset.conceptIndex);
    const flowIndex = Number(button.dataset.flowIndex);
    moveItem(state.concepts[conceptIndex].flow, flowIndex, button.dataset.direction);
    return;
  }

  if (action === 'delete-question') {
    const index = Number(button.dataset.questionIndex);
    state.assessment.questions.splice(index, 1);
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'move-question') {
    const index = Number(button.dataset.questionIndex);
    moveItem(state.assessment.questions, index, button.dataset.direction);
    return;
  }

  if (action === 'add-question-choice') {
    const questionIndex = Number(button.dataset.questionIndex);
    const choices = state.assessment.questions[questionIndex].choices || [];
    choices.push('');
    state.assessment.questions[questionIndex].choices = choices;
    setDirty(true);
    renderPanel();
    return;
  }

  if (action === 'delete-question-choice') {
    const questionIndex = Number(button.dataset.questionIndex);
    const index = Number(button.dataset.index);
    const choices = state.assessment.questions[questionIndex].choices || [];
    choices.splice(index, 1);
    state.assessment.questions[questionIndex].choices = choices;
    setDirty(true);
    renderPanel();
  }
}

function addConcept() {
  state.concepts.push({ title: '', flow: [] });
  state.activeSection = `concept-${state.concepts.length - 1}`;
  setDirty(true);
  renderAll();
}

function addFlowItem() {
  if (!state.activeSection.startsWith('concept-')) {
    showToast('تنبيه', 'اختر مفهومًا لإضافة عنصر.', 'warning');
    return;
  }
  const index = Number(state.activeSection.split('-')[1]);
  state.concepts[index].flow.push({ type: 'goal', text: '', title: '', description: '', url: '', answer: '', correctIndex: 0, solution: '', details: [], hints: [], choices: [] });
  setDirty(true);
  renderPanel();
}

function addQuestion() {
  const questions = state.assessment.questions || [];
  questions.push({ type: 'mcq', text: '', points: 1, choices: [''], correctIndex: 0, answer: '' });
  state.assessment.questions = questions;
  setDirty(true);
  renderPanel();
}

async function saveContent() {
  const payload = {
    week: state.week,
    seq: state.seq,
    title: state.title,
    goals: state.goals.filter((goal) => normalizeValue(goal)),
    prerequisites: state.prerequisites.filter((item) => normalizeValue(item)),
    concepts: state.concepts.map((concept) => ({
      title: normalizeValue(concept.title),
      flow: (concept.flow || []).map((item) => ({
        type: normalizeValue(item.type),
        text: normalizeValue(item.text),
        title: normalizeValue(item.title),
        description: normalizeValue(item.description),
        url: normalizeValue(item.url),
        answer: normalizeValue(item.answer),
        correctIndex: item.correctIndex ?? 0,
        solution: normalizeValue(item.solution),
        details: (item.details || []).filter((entry) => normalizeValue(entry)),
        hints: (item.hints || []).filter((entry) => normalizeValue(entry)),
        choices: (item.choices || []).filter((entry) => normalizeValue(entry))
      }))
    })),
    assessment: {
      title: normalizeValue(state.assessment.title),
      description: normalizeValue(state.assessment.description),
      questions: (state.assessment.questions || []).map((question) => ({
        type: normalizeValue(question.type) || 'input',
        text: normalizeValue(question.text),
        points: Number(question.points) || 1,
        answer: normalizeValue(question.answer),
        correctIndex: question.correctIndex ?? 0,
        choices: (question.choices || []).filter((entry) => normalizeValue(entry))
      }))
    }
  };

  try {
    const response = await fetch(`/api/mng/weeks/${encodeURIComponent(state.week)}/content`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر حفظ المحتوى.');
    }

    setDirty(false);
    showToast('نجاح', 'تم الحفظ', 'success');
  } catch (error) {
    showToast('خطأ', error.message || 'تعذر حفظ المحتوى.', 'error');
  }
}

function openLeaveModal(callback) {
  state.pendingNavigation = callback;
  elements.confirmLeave.classList.remove('hidden');
  elements.confirmLeave.setAttribute('aria-hidden', 'false');
}

function closeLeaveModal() {
  elements.confirmLeave.classList.add('hidden');
  elements.confirmLeave.setAttribute('aria-hidden', 'true');
  state.pendingNavigation = null;
}

function handleBackClick(event) {
  if (!state.dirty) return;
  event.preventDefault();
  openLeaveModal(() => {
    window.location.href = event.currentTarget.href;
  });
}

function bindEvents() {
  elements.sectionsList.addEventListener('click', handleSidebarClick);
  elements.editorContent.addEventListener('input', handleEditorInput);
  elements.editorContent.addEventListener('click', handleEditorClick);
  elements.btnAddConcept.addEventListener('click', addConcept);
  elements.btnAddItem.addEventListener('click', addFlowItem);
  elements.btnAddQuestion.addEventListener('click', addQuestion);
  elements.btnSave.addEventListener('click', saveContent);
  elements.btnBack.addEventListener('click', handleBackClick);
  elements.btnCloseLeave.addEventListener('click', closeLeaveModal);
  elements.btnCancelLeave.addEventListener('click', closeLeaveModal);
  elements.confirmLeave.addEventListener('click', (event) => {
    if (event.target.dataset?.close) closeLeaveModal();
  });
  elements.btnConfirmLeave.addEventListener('click', () => {
    if (state.pendingNavigation) {
      const next = state.pendingNavigation;
      closeLeaveModal();
      next();
    }
  });

  window.addEventListener('beforeunload', (event) => {
    if (!state.dirty) return;
    event.preventDefault();
    event.returnValue = '';
  });
}

async function init() {
  const week = getWeekParam();
  if (!week) {
    elements.editorContent.textContent = 'رقم البطاقة غير صالح.';
    return;
  }

  state.week = week;
  bindEvents();

  try {
    const response = await fetch(`/api/mng/weeks/${encodeURIComponent(week)}/content`, { cache: 'no-store' });
    const data = await response.json();
    if (!response.ok || data?.ok === false) {
      throw new Error(data?.error || 'تعذر تحميل المحتوى.');
    }

    state.seq = data.seq;
    state.title = data.title || '';
    state.goals = Array.isArray(data.goals) ? data.goals : [];
    state.prerequisites = Array.isArray(data.prerequisites) ? data.prerequisites : [];
    state.concepts = Array.isArray(data.concepts) ? data.concepts : [];
    state.assessment = data.assessment || { title: '', description: '', questions: [] };

    setHeader();
    renderAll();
  } catch (error) {
    elements.editorContent.textContent = 'تعذر تحميل المحتوى.';
    showToast('خطأ', error.message || 'تعذر تحميل المحتوى.', 'error');
  }
}

init();
math/public/assets/js/mng/cardsManager.js
import { showToast } from '../ui/toast.js';

const API_BASE = '/api/mng/cards';

const elements = {
  body: document.getElementById('cardsBody'),
  addButton: document.getElementById('btnAddCard'),
  deleteSelectedButton: document.getElementById('btnDeleteSelected'),
  exportButton: document.getElementById('btnExportCards'),
  searchInput: document.getElementById('searchInput'),
  searchButton: document.getElementById('btnSearch'),
  gradeFilter: document.getElementById('gradeFilter'),
  classFilter: document.getElementById('classFilter'),
  selectAll: document.getElementById('selectAllCards'),
  modal: document.getElementById('cardModal'),
  modalTitle: document.getElementById('modalTitle'),
  modalClose: document.getElementById('btnCloseModal'),
  modalCancel: document.getElementById('btnCancel'),
  form: document.getElementById('cardForm'),
  submitButton: document.getElementById('btnSubmit'),
  weekDisplayRow: document.getElementById('weekDisplayRow'),
  weekDisplay: document.getElementById('weekDisplay'),
  titleInput: document.getElementById('titleInput'),
  gradeInput: document.getElementById('gradeInput'),
  prereqSelect: document.getElementById('prereqSelect'),
  allClassesToggle: document.getElementById('allClassesToggle'),
  classesOptions: document.getElementById('classesOptions'),
  classesManual: document.getElementById('classesManual'),
  confirmModal: document.getElementById('confirmModal'),
  confirmTitle: document.getElementById('confirmTitle'),
  confirmMessage: document.getElementById('confirmMessage'),
  confirmClose: document.getElementById('btnCloseConfirm'),
  confirmCancel: document.getElementById('btnCancelDelete'),
  confirmSubmit: document.getElementById('btnConfirmDelete'),
  completionsModal: document.getElementById('completionsModal'),
  completionsTitle: document.getElementById('completionsTitle'),
  completionsSubtitle: document.getElementById('completionsSubtitle'),
  completionsBody: document.getElementById('completionsBody'),
  completionsClose: document.getElementById('btnCloseCompletions')
};

const state = {
  cards: [],
  mode: 'add',
  activeWeek: null,
  prereqOptions: []
};

const gradeLabels = {
  '1': 'الأول',
  '2': 'الثاني',
  '3': 'الثالث',
  '4': 'الرابع',
  '5': 'الخامس',
  '6': 'السادس',
  '7': 'السابع',
  '8': 'الثامن',
  '9': 'التاسع'
};

const classOptions = Array.from({ length: 10 }, (_, index) => String(index + 1));

let searchTimeout = null;
let confirmAction = null;
let confirmBusy = false;

function setLoading(message) {
  elements.body.innerHTML = `
    <tr>
      <td colspan="7" class="muted center">${message}</td>
    </tr>
  `;
}

function setCompletionsLoading(message) {
  elements.completionsBody.innerHTML = `
    <tr>
      <td colspan="5" class="muted center">${message}</td>
    </tr>
  `;
}

function normalizeValue(value) {
  return value == null ? '' : String(value).trim();
}

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };
  return normalizeValue(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

function formatGrade(value) {
  const normalized = normalizeDigits(value);
  return gradeLabels[normalized] || normalized || '-';
}

function formatPrereqLabel(card) {
  const prereqSeq = normalizeDigits(card.prereqSeq);
  const prereqTitle = normalizeValue(card.prereqTitle);
  if (!prereqSeq && !prereqTitle) return '—';
  return `${escapeHtml(prereqSeq)} — ${escapeHtml(prereqTitle || 'بدون عنوان')}`;
}

function setClassFilterEnabled(enabled) {
  if (!elements.classFilter) return;
  if (!enabled) {
    elements.classFilter.innerHTML = '<option value="">كل الشعب</option>';
    elements.classFilter.value = '';
    elements.classFilter.disabled = true;
    return;
  }

  const options = ['<option value="">كل الشعب</option>'];
  classOptions.forEach((className) => {
    options.push(`<option value="${escapeHtml(className)}">${escapeHtml(className)}</option>`);
  });
  elements.classFilter.innerHTML = options.join('');
  elements.classFilter.disabled = false;
}

function buildClassOptions() {
  if (!elements.classesOptions) return;
  elements.classesOptions.innerHTML = classOptions
    .map(
      (className) => `
        <label class="label">
          <input class="class-check" type="checkbox" value="${escapeHtml(className)}" />
          شعبة ${escapeHtml(className)}
        </label>
      `
    )
    .join('');
}

function setClassesDisabled(disabled) {
  const inputs = elements.classesOptions?.querySelectorAll('.class-check') || [];
  inputs.forEach((input) => {
    input.disabled = disabled;
  });
  if (elements.classesManual) {
    elements.classesManual.disabled = disabled;
  }
}

function getFilters() {
  return {
    grade: normalizeDigits(elements.gradeFilter.value),
    className: normalizeDigits(elements.classFilter.value),
    q: normalizeValue(elements.searchInput.value)
  };
}

async function fetchCards() {
  setLoading('تحميل البيانات...');
  const { grade, className, q } = getFilters();
  const params = new URLSearchParams();
  if (grade) params.set('grade', grade);
  if (className) params.set('class', className);
  if (q) params.set('q', q);

  try {
    const response = await fetch(`${API_BASE}?${params.toString()}`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر تحميل البيانات.');
    }

    state.cards = data.cards || [];
    renderCards(state.cards);
    updateExportButtonState(state.cards.length);
    updateBulkDeleteState();
  } catch (error) {
    setLoading('تعذر تحميل البيانات.');
    showToast('خطأ', error.message || 'تعذر تحميل البيانات.', 'error');
  }
}

function renderCards(list) {
  if (!list.length) {
    setLoading('لا توجد نتائج حالياً.');
    return;
  }

  elements.body.innerHTML = list
    .map((card) => {
      const week = normalizeDigits(card.week);
      const seq = normalizeDigits(card.seq);
      const title = normalizeValue(card.title);
      const gradeLabel = formatGrade(card.grade);
      const classes = Array.isArray(card.classes) ? card.classes : [];
      const hasAllClasses = Boolean(card.isAllClasses);
      const classesLabel = hasAllClasses
        ? 'كل الشعب'
        : classes.length
          ? classes.map((entry) => escapeHtml(normalizeDigits(entry))).join(', ')
          : 'غير محدد';
      const prereqLabel = formatPrereqLabel(card);

      return `
        <tr>
          <td class="select-cell">
            <input class="row-check" type="checkbox" data-week="${escapeHtml(week)}" aria-label="تحديد البطاقة" />
          </td>
          <td class="ltr">${escapeHtml(seq || '-')}
            <div class="small muted">ID: ${escapeHtml(week)}</div>
          </td>
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(gradeLabel)}</td>
          <td>${classesLabel}</td>
          <td>${prereqLabel}</td>
          <td class="actions">
            <button class="btn btn-outline btn-sm icon-btn" data-action="edit" data-week="${escapeHtml(week)}" title="تعديل" aria-label="تعديل">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M3 17.25V21h3.75l11-11-3.75-3.75-11 11zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="content" data-week="${escapeHtml(week)}" title="تحرير المحتوى" aria-label="تحرير المحتوى">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14H7v-2h3v2zm0-4H7v-2h3v2zm0-4H7V7h3v2zm7 8h-5v-2h5v2zm0-4h-5v-2h5v2zm0-4h-5V7h5v2z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="completions" data-week="${escapeHtml(week)}" title="من أنهى البطاقة" aria-label="من أنهى البطاقة">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="delete" data-week="${escapeHtml(week)}" title="حذف" aria-label="حذف">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 13.41l-6.29 6.3-1.42-1.42L10.59 12 4.29 5.71 5.7 4.29 12 10.59l6.29-6.3z"/>
              </svg>
            </button>
          </td>
        </tr>
      `;
    })
    .join('');
}

function getSelectedWeeks() {
  return Array.from(elements.body.querySelectorAll('.row-check:checked'))
    .map((checkbox) => checkbox.dataset.week)
    .filter(Boolean);
}

function updateBulkDeleteState() {
  const selected = getSelectedWeeks();
  elements.deleteSelectedButton.disabled = selected.length === 0;
  elements.deleteSelectedButton.textContent = selected.length
    ? `حذف المحدد (${selected.length})`
    : 'حذف المحدد';

  if (elements.selectAll) {
    const total = elements.body.querySelectorAll('.row-check').length;
    elements.selectAll.checked = total > 0 && selected.length === total;
    elements.selectAll.indeterminate = selected.length > 0 && selected.length < total;
  }
}

function updateExportButtonState(total) {
  if (!elements.exportButton) return;
  elements.exportButton.disabled = total === 0;
}

function buildExportFileName() {
  const gradePart = normalizeDigits(elements.gradeFilter.value) || 'all';
  const classPart = normalizeDigits(elements.classFilter.value) || 'all';
  const datePart = new Date().toISOString().split('T')[0];
  return `cards_${datePart}_grade-${gradePart}_class-${classPart}.xlsx`;
}

function handleExportCards() {
  if (!state.cards.length) {
    updateExportButtonState(0);
    showToast('تنبيه', 'لا توجد نتائج للتصدير.', 'warning');
    return;
  }

  if (!window.XLSX) {
    showToast('خطأ', 'تعذر تحميل مكتبة تصدير Excel.', 'error');
    return;
  }

  const headers = ['Seq', 'Title', 'Grade', 'Classes', 'Prereq', 'CompletedCount'];
  const rows = state.cards.map((card) => {
    const seq = normalizeDigits(card.seq);
    const title = normalizeValue(card.title);
    const grade = normalizeDigits(card.grade);
    const classes = Array.isArray(card.classes) ? card.classes : [];
    const classesText = classes.map((entry) => normalizeDigits(entry)).join(', ');
    const prereqSeq = normalizeDigits(card.prereqSeq);
    const prereqTitle = normalizeValue(card.prereqTitle);
    const prereqText = prereqSeq || prereqTitle ? `${prereqSeq} - ${prereqTitle}` : '';
    const completedCount = Number(card.completedCount || 0);

    return [seq, title, grade, classesText, prereqText, completedCount];
  });

  const worksheet = window.XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const workbook = window.XLSX.utils.book_new();
  window.XLSX.utils.book_append_sheet(workbook, worksheet, 'Cards');
  window.XLSX.writeFile(workbook, buildExportFileName());
}

function buildPrereqOptions(cards, currentWeek) {
  const options = ['<option value="">لا يوجد</option>'];
  cards
    .filter((card) => normalizeDigits(card.week) !== normalizeDigits(currentWeek))
    .forEach((card) => {
      const seq = normalizeDigits(card.seq);
      const title = normalizeValue(card.title);
      const week = normalizeDigits(card.week);
      options.push(`<option value="${escapeHtml(week)}">${escapeHtml(seq || '-') } - ${escapeHtml(title || 'بدون عنوان')}</option>`);
    });
  return options.join('');
}

async function updatePrereqOptions(grade, currentWeek, selectedWeek) {
  if (!elements.prereqSelect) return;
  if (!grade) {
    elements.prereqSelect.innerHTML = '<option value="">لا يوجد</option>';
    elements.prereqSelect.disabled = true;
    return;
  }

  elements.prereqSelect.disabled = true;
  elements.prereqSelect.innerHTML = '<option value="">جاري التحميل...</option>';

  try {
    const params = new URLSearchParams();
    params.set('grade', grade);
    params.set('class', 'ALL_CLASSES');

    const response = await fetch(`${API_BASE}?${params.toString()}`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر تحميل المتطلبات السابقة.');
    }

    const cards = Array.isArray(data.cards) ? data.cards : [];
    cards.sort((a, b) => Number(a.seq) - Number(b.seq));
    state.prereqOptions = cards;
    elements.prereqSelect.innerHTML = buildPrereqOptions(cards, currentWeek);
    elements.prereqSelect.value = normalizeDigits(selectedWeek || '');
    elements.prereqSelect.disabled = false;
  } catch (error) {
    elements.prereqSelect.innerHTML = '<option value="">لا يوجد</option>';
    elements.prereqSelect.disabled = false;
    showToast('خطأ', error.message || 'تعذر تحميل المتطلبات السابقة.', 'error');
  }
}

function openModal(mode, card = {}) {
  state.mode = mode;
  state.activeWeek = normalizeDigits(card.week);
  const isEdit = mode === 'edit';

  elements.modalTitle.textContent = isEdit ? 'تعديل بيانات البطاقة' : 'إضافة بطاقة';
  elements.submitButton.textContent = isEdit ? 'حفظ التعديلات' : 'إضافة البطاقة';

  elements.modal.classList.remove('hidden');
  elements.modal.setAttribute('aria-hidden', 'false');

  elements.weekDisplayRow.style.display = isEdit ? 'block' : 'none';
  if (elements.weekDisplay) {
    elements.weekDisplay.textContent = isEdit ? `ID: ${normalizeDigits(card.week)}` : 'سيتم توليد المعرّف تلقائياً';
  }

  elements.titleInput.value = normalizeValue(card.title);
  elements.gradeInput.value = normalizeDigits(card.grade);
  elements.classesManual.value = '';

  const hasAllClasses = Boolean(card.isAllClasses);
  elements.allClassesToggle.checked = hasAllClasses || !Array.isArray(card.classes) || !card.classes.length;

  const checkedClasses = new Set(
    (card.classes || []).map((entry) => normalizeDigits(entry)).filter(Boolean)
  );
  const checkboxes = elements.classesOptions.querySelectorAll('.class-check');
  checkboxes.forEach((checkbox) => {
    checkbox.checked = checkedClasses.has(checkbox.value);
  });

  setClassesDisabled(elements.allClassesToggle.checked);
  updatePrereqOptions(elements.gradeInput.value, card.week, card.prereqWeek);
}

function closeModal() {
  elements.modal.classList.add('hidden');
  elements.modal.setAttribute('aria-hidden', 'true');
  elements.form.reset();
  setClassesDisabled(elements.allClassesToggle.checked);
}

function openConfirmModal({ title, message, onConfirm }) {
  confirmAction = onConfirm;
  elements.confirmTitle.textContent = title;
  elements.confirmMessage.textContent = message;
  elements.confirmModal.classList.remove('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'false');
}

function closeConfirmModal(force = false) {
  if (confirmBusy && !force) return;
  confirmAction = null;
  elements.confirmModal.classList.add('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'true');
}

function openCompletionsModal(card) {
  elements.completionsTitle.textContent = `من أنهى البطاقة ${normalizeDigits(card.seq)}`;
  elements.completionsSubtitle.textContent = 'جاري التحميل...';
  setCompletionsLoading('تحميل البيانات...');
  elements.completionsModal.classList.remove('hidden');
  elements.completionsModal.setAttribute('aria-hidden', 'false');

  fetchCompletions(card);
}

function closeCompletionsModal() {
  elements.completionsModal.classList.add('hidden');
  elements.completionsModal.setAttribute('aria-hidden', 'true');
}

async function fetchCompletions(card) {
  const className = normalizeDigits(elements.classFilter.value) || 'ALL_CLASSES';
  const params = new URLSearchParams();
  if (className) params.set('class', className);

  try {
    const response = await fetch(`${API_BASE}/${encodeURIComponent(card.week)}/completions?${params.toString()}`);
    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر تحميل البيانات.');
    }

    const students = Array.isArray(data.students) ? data.students : [];
    elements.completionsSubtitle.textContent = `الإجمالي: ${students.length}`;

    if (!students.length) {
      setCompletionsLoading('لا يوجد طلاب أكملوا البطاقة بعد.');
      return;
    }

    elements.completionsBody.innerHTML = students
      .map((student) => `
        <tr>
          <td class="ltr">${escapeHtml(student.StudentId)}</td>
          <td>${escapeHtml(student.FullName || '—')}</td>
          <td>${escapeHtml(student.Class || '—')}</td>
          <td>${escapeHtml(student.FinalScore ?? '-') }</td>
          <td>${escapeHtml(new Date(student.CompletedAt).toLocaleString('ar'))}</td>
        </tr>
      `)
      .join('');
  } catch (error) {
    elements.completionsSubtitle.textContent = 'تعذر تحميل البيانات.';
    setCompletionsLoading('تعذر تحميل البيانات.');
    showToast('خطأ', error.message || 'تعذر تحميل البيانات.', 'error');
  }
}

async function handleConfirmSubmit() {
  if (!confirmAction || confirmBusy) return;
  confirmBusy = true;
  elements.confirmSubmit.disabled = true;

  try {
    await confirmAction();
    closeConfirmModal(true);
  } catch (error) {
    showToast('خطأ', error.message || 'حدث خطأ أثناء الحذف.', 'error');
  } finally {
    confirmBusy = false;
    elements.confirmSubmit.disabled = false;
  }
}

function collectClasses() {
  if (elements.allClassesToggle.checked) return [];

  const selected = Array.from(elements.classesOptions.querySelectorAll('.class-check:checked'))
    .map((input) => normalizeDigits(input.value))
    .filter(Boolean);

  const manualValues = normalizeValue(elements.classesManual.value)
    .split(',')
    .map((entry) => normalizeDigits(entry))
    .map((entry) => entry.trim())
    .filter(Boolean);

  return Array.from(new Set([...selected, ...manualValues]));
}

async function handleSubmit(event) {
  event.preventDefault();

  const title = normalizeValue(elements.titleInput.value);
  const grade = normalizeDigits(elements.gradeInput.value);
  const allClasses = Boolean(elements.allClassesToggle.checked);
  const classes = collectClasses();
  const prereqWeekRaw = normalizeDigits(elements.prereqSelect.value);
  const prereqWeek = prereqWeekRaw ? Number(prereqWeekRaw) : null;

  if (!title) {
    showToast('تنبيه', 'العنوان مطلوب.', 'warning');
    return;
  }

  if (!grade) {
    showToast('تنبيه', 'اختر الصف.', 'warning');
    return;
  }

  const payload = {
    title,
    grade,
    classes,
    allClasses,
    prereqWeek
  };

  const isEdit = state.mode === 'edit';
  const url = isEdit ? `${API_BASE}/${encodeURIComponent(state.activeWeek)}` : API_BASE;
  const method = isEdit ? 'PUT' : 'POST';

  try {
    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (!response.ok || !data.ok) {
      throw new Error(data?.error || 'تعذر حفظ البطاقة.');
    }

    closeModal();
    showToast('نجاح', isEdit ? 'تم تحديث البطاقة.' : 'تمت إضافة البطاقة.', 'success');
    await fetchCards();
  } catch (error) {
    showToast('خطأ', error.message || 'تعذر حفظ البطاقة.', 'error');
  }
}

function handleEdit(week) {
  const card = state.cards.find((item) => normalizeDigits(item.week) === normalizeDigits(week));
  if (!card) return;
  openModal('edit', card);
}

function handleDelete(week) {
  openConfirmModal({
    title: 'تأكيد الحذف',
    message: 'هل أنت متأكد من حذف البطاقة؟',
    onConfirm: async () => {
      const response = await fetch(`${API_BASE}/${encodeURIComponent(week)}`, {
        method: 'DELETE'
      });
      const data = await response.json();
      if (!response.ok || !data.ok) {
        throw new Error(data?.error || 'تعذر حذف البطاقة.');
      }
      showToast('نجاح', 'تم حذف البطاقة.', 'success');
      await fetchCards();
    }
  });
}

function handleBulkDelete() {
  const selected = getSelectedWeeks();
  if (!selected.length) return;

  openConfirmModal({
    title: 'تأكيد الحذف',
    message: `هل أنت متأكد من حذف البطاقات المحددة؟ (${selected.length})`,
    onConfirm: async () => {
      const results = await Promise.all(
        selected.map((week) =>
          fetch(`${API_BASE}/${encodeURIComponent(week)}`, { method: 'DELETE' })
            .then((response) => response.json().then((data) => ({ response, data })))
        )
      );

      const failed = results.filter(({ response, data }) => !response.ok || !data.ok);
      if (failed.length) {
        throw new Error('تعذر حذف بعض البطاقات.');
      }

      showToast('نجاح', 'تم حذف البطاقات المحددة.', 'success');
      await fetchCards();
    }
  });
}

function handleTableClick(event) {
  const button = event.target.closest('button[data-action]');
  if (!button) return;
  const action = button.dataset.action;
  const week = button.dataset.week;
  if (!week) return;
  if (action === 'edit') {
    handleEdit(week);
  }
  if (action === 'delete') {
    handleDelete(week);
  }
  if (action === 'content') {
    window.open(`/mng/card-editor.html?week=${encodeURIComponent(week)}`, '_blank');
  }
  if (action === 'completions') {
    const card = state.cards.find((item) => normalizeDigits(item.week) === normalizeDigits(week));
    if (card) openCompletionsModal(card);
  }
}

function handleTableChange(event) {
  if (event.target?.classList.contains('row-check')) {
    updateBulkDeleteState();
  }
}

function handleSelectAllChange() {
  const shouldSelect = elements.selectAll.checked;
  elements.body.querySelectorAll('.row-check').forEach((checkbox) => {
    checkbox.checked = shouldSelect;
  });
  updateBulkDeleteState();
}

function handleSearch() {
  fetchCards();
}

function handleSearchInput() {
  if (searchTimeout) window.clearTimeout(searchTimeout);
  searchTimeout = window.setTimeout(() => {
    handleSearch();
  }, 350);
}

function handleGradeFilterChange() {
  const grade = normalizeDigits(elements.gradeFilter.value);
  setClassFilterEnabled(Boolean(grade));
  fetchCards();
}

function handleClassFilterChange() {
  fetchCards();
}

function handleAllClassesToggle() {
  setClassesDisabled(elements.allClassesToggle.checked);
}

function handleBackdropClick(event) {
  if (event.target.dataset?.close) {
    closeModal();
  }
}

function handleConfirmBackdropClick(event) {
  if (event.target.dataset?.close) {
    closeConfirmModal();
  }
}

function handleCompletionsBackdropClick(event) {
  if (event.target.dataset?.close) {
    closeCompletionsModal();
  }
}

function bindEvents() {
  elements.addButton.addEventListener('click', () => openModal('add'));
  elements.modalClose.addEventListener('click', closeModal);
  elements.modalCancel.addEventListener('click', closeModal);
  elements.modal.addEventListener('click', handleBackdropClick);
  elements.form.addEventListener('submit', handleSubmit);
  elements.body.addEventListener('click', handleTableClick);
  elements.body.addEventListener('change', handleTableChange);
  elements.selectAll.addEventListener('change', handleSelectAllChange);
  elements.deleteSelectedButton.addEventListener('click', handleBulkDelete);
  elements.exportButton.addEventListener('click', handleExportCards);
  elements.searchButton.addEventListener('click', handleSearch);
  elements.searchInput.addEventListener('input', handleSearchInput);
  elements.gradeFilter.addEventListener('change', handleGradeFilterChange);
  elements.classFilter.addEventListener('change', handleClassFilterChange);
  elements.gradeInput.addEventListener('change', () => {
    updatePrereqOptions(normalizeDigits(elements.gradeInput.value), state.activeWeek, null);
  });
  elements.allClassesToggle.addEventListener('change', handleAllClassesToggle);
  elements.confirmClose.addEventListener('click', closeConfirmModal);
  elements.confirmCancel.addEventListener('click', closeConfirmModal);
  elements.confirmModal.addEventListener('click', handleConfirmBackdropClick);
  elements.confirmSubmit.addEventListener('click', handleConfirmSubmit);
  elements.completionsClose.addEventListener('click', closeCompletionsModal);
  elements.completionsModal.addEventListener('click', handleCompletionsBackdropClick);
}

function init() {
  buildClassOptions();
  setClassFilterEnabled(false);
  bindEvents();
  fetchCards();
}

init();
math/public/assets/js/mng/studentsManager.js
import { showToast } from '../ui/toast.js';

const API_BASE = '/api/mng/students';

const elements = {
  body: document.getElementById('studentsBody'),
  addButton: document.getElementById('btnAddStudent'),
  deleteSelectedButton: document.getElementById('btnDeleteSelected'),
  exportButton: document.getElementById('btnExportStudents'),
  searchInput: document.getElementById('searchInput'),
  searchButton: document.getElementById('btnSearch'),
  gradeFilter: document.getElementById('gradeFilter'),
  classFilter: document.getElementById('classFilter'),
  pagination: document.getElementById('studentsPagination'),
  selectAll: document.getElementById('selectAllStudents'),
  modal: document.getElementById('studentModal'),
  modalTitle: document.getElementById('modalTitle'),
  modalClose: document.getElementById('btnCloseModal'),
  modalCancel: document.getElementById('btnCancel'),
  form: document.getElementById('studentForm'),
  submitButton: document.getElementById('btnSubmit'),
  studentIdInput: document.getElementById('studentIdInput'),
  wheelYear: document.getElementById('wheelYear'),
  wheelMonth: document.getElementById('wheelMonth'),
  wheelDay: document.getElementById('wheelDay'),
  nameInput: document.getElementById('nameInput'),
  firstNameInput: document.getElementById('firstNameInput'),
  wheelGrade: document.getElementById('wheelGrade'),
  classInput: document.getElementById('classInput'),
  confirmModal: document.getElementById('confirmModal'),
  confirmTitle: document.getElementById('confirmTitle'),
  confirmMessage: document.getElementById('confirmMessage'),
  confirmClose: document.getElementById('btnCloseConfirm'),
  confirmCancel: document.getElementById('btnCancelDelete'),
  confirmSubmit: document.getElementById('btnConfirmDelete'),
  importButton: document.getElementById('btnImportStudents'),
  importModal: document.getElementById('importModal'),
  importClose: document.getElementById('btnCloseImport'),
  importCancel: document.getElementById('btnCancelImport'),
  importFile: document.getElementById('importFile'),
  importHasHeader: document.getElementById('importHasHeader'),
  importPreviewHead: document.getElementById('importPreviewHead'),
  importPreviewBody: document.getElementById('importPreviewBody'),
  mapStudentId: document.getElementById('mapStudentId'),
  mapName: document.getElementById('mapName'),
  mapBirthDate: document.getElementById('mapBirthDate'),
  mapGrade: document.getElementById('mapGrade'),
  mapClass: document.getElementById('mapClass'),
  importValidate: document.getElementById('btnImportValidate'),
  importExecute: document.getElementById('btnImportExecute'),
  importProgressBar: document.getElementById('importProgressBar'),
  importProgressLabel: document.getElementById('importProgressLabel'),
  importProgressTrack: document.querySelector('.progress-track'),
  importSummary: document.getElementById('importSummary'),
  downloadSkipped: document.getElementById('btnDownloadSkipped'),
  downloadErrors: document.getElementById('btnDownloadErrors'),
  importTeacherNote: document.getElementById('importTeacherNote')
};

const state = {
  students: [],
  mode: 'add',
  currentPage: 1,
  pageSize: 10
};

let searchTimeout = null;
let firstNameTouched = false;
let confirmAction = null;
let confirmBusy = false;
let importBusy = false;

const importState = {
  rows: [],
  hasHeader: true,
  headers: [],
  columnLabels: [],
  validated: false,
  existingSet: null,
  results: {
    toAdd: [],
    skipped: [],
    invalid: []
  }
};

const gradeLabels = {
  '1': 'الأول',
  '2': 'الثاني',
  '3': 'الثالث',
  '4': 'الرابع',
  '5': 'الخامس',
  '6': 'السادس',
  '7': 'السابع',
  '8': 'الثامن',
  '9': 'التاسع'
};

function setLoading(message) {
  elements.body.innerHTML = `
    <tr>
      <td colspan="7" class="muted center">${message}</td>
    </tr>
  `;
}

function normalizeValue(value) {
  return value == null ? '' : String(value).trim();
}

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function normalizeDigits(value) {
  const map = {
    '٠': '0',
    '١': '1',
    '٢': '2',
    '٣': '3',
    '٤': '4',
    '٥': '5',
    '٦': '6',
    '٧': '7',
    '٨': '8',
    '٩': '9',
    '۰': '0',
    '۱': '1',
    '۲': '2',
    '۳': '3',
    '۴': '4',
    '۵': '5',
    '۶': '6',
    '۷': '7',
    '۸': '8',
    '۹': '9'
  };
  return normalizeValue(value)
    .split('')
    .map((char) => map[char] ?? char)
    .join('');
}

function normalizeGrade(value) {
  const normalized = normalizeDigits(value);
  const trimmed = normalizeValue(normalized);
  if (!trimmed) return '';
  if (/^[1-9]$/.test(trimmed)) return trimmed;

  let text = trimmed.replace(/\s+/g, '');
  text = text.replace(/^الصف/, '').replace(/^صف/, '').replace(/^ال/, '');
  text = text.replace(/[أإآ]/g, 'ا');

  const gradeMap = {
    اول: '1',
    ثاني: '2',
    ثالث: '3',
    رابع: '4',
    خامس: '5',
    سادس: '6',
    سابع: '7',
    ثامن: '8',
    تاسع: '9'
  };

  return gradeMap[text] || trimmed;
}

function toNumber(value) {
  return Number.parseInt(value, 10);
}

function deriveFirstNameFromName(name) {
  const parts = normalizeValue(name).split(/\s+/).filter(Boolean);
  if (!parts.length) return '';
  if (parts[0] === 'عبد' && parts[1]) {
    return `عبد ${parts[1]}`;
  }
  return parts[0];
}

function padTwo(value) {
  return String(value).padStart(2, '0');
}

function formatIsoDate(year, month, day) {
  if (!year || !month || !day) return '';
  return `${year}-${padTwo(month)}-${padTwo(day)}`;
}

function excelSerialToDate(serial) {
  const excelEpoch = Date.UTC(1899, 11, 30);
  const utc = excelEpoch + Number(serial) * 86400000;
  return new Date(utc);
}

function parseBirthDate(value) {
  if (value == null || value === '') {
    return { iso: '', error: 'تاريخ الميلاد مطلوب.' };
  }

  if (value instanceof Date && !Number.isNaN(value.getTime())) {
    const year = value.getUTCFullYear();
    const month = value.getUTCMonth() + 1;
    const day = value.getUTCDate();
    return { iso: formatIsoDate(year, month, day), error: '' };
  }

  const normalized = normalizeDigits(value);
  const numeric = Number(normalized);
  if (!Number.isNaN(numeric) && Number.isFinite(numeric) && String(normalized).trim() !== '') {
    const date = excelSerialToDate(numeric);
    if (!Number.isNaN(date.getTime())) {
      return {
        iso: formatIsoDate(date.getUTCFullYear(), date.getUTCMonth() + 1, date.getUTCDate()),
        error: ''
      };
    }
  }

  const text = normalizeDigits(value).replace(/\s+/g, '');
  let match = text.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (match) {
    const [, year, month, day] = match;
    const date = new Date(Number(year), Number(month) - 1, Number(day));
    if (
      date.getFullYear() === Number(year) &&
      date.getMonth() === Number(month) - 1 &&
      date.getDate() === Number(day)
    ) {
      return { iso: formatIsoDate(year, month, day), error: '' };
    }
  }

  match = text.match(/^(\d{2})[/-](\d{2})[/-](\d{4})$/);
  if (match) {
    const [, day, month, year] = match;
    const date = new Date(Number(year), Number(month) - 1, Number(day));
    if (
      date.getFullYear() === Number(year) &&
      date.getMonth() === Number(month) - 1 &&
      date.getDate() === Number(day)
    ) {
      return { iso: formatIsoDate(year, month, day), error: '' };
    }
  }

  return { iso: '', error: 'تاريخ الميلاد غير صالح.' };
}

function toColumnLabel(index) {
  let label = '';
  let current = index;
  while (current >= 0) {
    label = String.fromCharCode((current % 26) + 65) + label;
    current = Math.floor(current / 26) - 1;
  }
  return label;
}

function getImportColumns() {
  return [elements.mapStudentId, elements.mapName, elements.mapBirthDate, elements.mapGrade, elements.mapClass];
}

function resetImportState() {
  importState.rows = [];
  importState.headers = [];
  importState.columnLabels = [];
  importState.validated = false;
  importState.results = { toAdd: [], skipped: [], invalid: [] };
  elements.importFile.value = '';
  elements.importHasHeader.checked = true;
  elements.importPreviewHead.innerHTML = '';
  elements.importPreviewBody.innerHTML = `
    <tr>
      <td class="muted center">اختر ملفًا لعرض المعاينة.</td>
    </tr>
  `;
  getImportColumns().forEach((select) => {
    if (select) select.innerHTML = '';
  });
  updateImportResultsSummary('لم يتم تنفيذ أي عملية بعد.');
  updateImportProgress(0);
  elements.importExecute.disabled = true;
  elements.downloadSkipped.disabled = true;
  elements.downloadErrors.disabled = true;
  elements.importTeacherNote.value = '';
  importState.hasHeader = true;
}

function updateImportProgress(percent) {
  const safePercent = Math.max(0, Math.min(100, percent));
  elements.importProgressBar.style.width = `${safePercent}%`;
  elements.importProgressLabel.textContent = `${safePercent}%`;
  if (elements.importProgressTrack) {
    elements.importProgressTrack.setAttribute('aria-valuenow', String(safePercent));
  }
}

function updateImportResultsSummary(text) {
  elements.importSummary.textContent = text;
}

function openImportModal() {
  resetImportState();
  elements.importModal.classList.remove('hidden');
  elements.importModal.setAttribute('aria-hidden', 'false');
  window.setTimeout(() => {
    elements.importFile?.focus();
  }, 0);
}

function closeImportModal() {
  if (importBusy) return;
  elements.importModal.classList.add('hidden');
  elements.importModal.setAttribute('aria-hidden', 'true');
}

function buildWheelItems(wheel, items) {
  wheel.innerHTML = '';
  const fragment = document.createDocumentFragment();
  items.forEach((item) => {
    const div = document.createElement('div');
    div.className = 'wheel-item';
    div.textContent = item.label;
    div.dataset.value = item.value;
    fragment.appendChild(div);
  });
  wheel.appendChild(fragment);
}

function getWheelItems(wheel) {
  return Array.from(wheel.querySelectorAll('.wheel-item'));
}

function getWheelSelectedItem(wheel) {
  const items = getWheelItems(wheel);
  if (!items.length) return null;
  const wheelRect = wheel.getBoundingClientRect();
  const center = wheelRect.top + wheelRect.height / 2;
  let closest = items[0];
  let closestDistance = Infinity;
  items.forEach((item) => {
    const rect = item.getBoundingClientRect();
    const distance = Math.abs(rect.top + rect.height / 2 - center);
    if (distance < closestDistance) {
      closest = item;
      closestDistance = distance;
    }
  });
  return closest;
}

function setWheelSelectedItem(wheel, targetItem, smooth = true) {
  if (!targetItem) return;
  getWheelItems(wheel).forEach((item) => item.classList.remove('is-selected'));
  targetItem.classList.add('is-selected');
  const wheelRect = wheel.getBoundingClientRect();
  const itemRect = targetItem.getBoundingClientRect();
  const offset = itemRect.top - wheelRect.top + wheel.scrollTop;
  const targetScroll = offset - (wheelRect.height / 2 - itemRect.height / 2);
  wheel.scrollTo({ top: targetScroll, behavior: smooth ? 'smooth' : 'auto' });
}

function selectWheelValue(wheel, value, smooth = false) {
  const items = getWheelItems(wheel);
  if (!items.length) return;
  const match = items.find((item) => item.dataset.value === String(value));
  setWheelSelectedItem(wheel, match || items[0], smooth);
}

function getWheelValue(wheel) {
  const selected = getWheelSelectedItem(wheel);
  return selected?.dataset.value ?? '';
}

function attachWheelHandler(wheel, onChange) {
  let timeout = null;
  wheel.addEventListener('scroll', () => {
    if (timeout) window.clearTimeout(timeout);
    timeout = window.setTimeout(() => {
      const selected = getWheelSelectedItem(wheel);
      setWheelSelectedItem(wheel, selected, true);
      if (onChange) onChange(selected?.dataset.value ?? '');
    }, 120);
  });
}

function buildBirthYearWheel() {
  const currentYear = new Date().getFullYear();
  const startYear = 1980;
  const years = [];
  for (let year = currentYear; year >= startYear; year -= 1) {
    years.push({ value: year, label: year });
  }
  buildWheelItems(elements.wheelYear, years);
}

function buildBirthMonthWheel() {
  const months = [
    { value: 1, label: 'يناير' },
    { value: 2, label: 'فبراير' },
    { value: 3, label: 'مارس' },
    { value: 4, label: 'أبريل' },
    { value: 5, label: 'مايو' },
    { value: 6, label: 'يونيو' },
    { value: 7, label: 'يوليو' },
    { value: 8, label: 'أغسطس' },
    { value: 9, label: 'سبتمبر' },
    { value: 10, label: 'أكتوبر' },
    { value: 11, label: 'نوفمبر' },
    { value: 12, label: 'ديسمبر' }
  ];
  buildWheelItems(elements.wheelMonth, months);
}

function buildBirthDayWheel(year, month, selectedDay) {
  const daysInMonth = new Date(year, month, 0).getDate();
  const days = Array.from({ length: daysInMonth }, (_, index) => {
    const day = index + 1;
    return { value: day, label: padTwo(day) };
  });
  buildWheelItems(elements.wheelDay, days);
  const targetDay = Math.min(selectedDay || 1, daysInMonth);
  selectWheelValue(elements.wheelDay, targetDay);
}

function buildGradeWheel() {
  const items = [
    { value: '', label: 'غير محدد' },
    ...Object.entries(gradeLabels).map(([value, label]) => ({ value, label }))
  ];
  buildWheelItems(elements.wheelGrade, items);
}

function parseDateParts(value) {
  if (!value) return null;
  const match = String(value).match(/(\d{4})-(\d{2})-(\d{2})/);
  if (!match) return null;
  return {
    year: match[1],
    month: String(parseInt(match[2], 10)),
    day: String(parseInt(match[3], 10))
  };
}

function initializeWheels() {
  buildBirthYearWheel();
  buildBirthMonthWheel();
  buildGradeWheel();

  const currentYear = new Date().getFullYear();
  selectWheelValue(elements.wheelYear, currentYear);
  selectWheelValue(elements.wheelMonth, 1);
  buildBirthDayWheel(currentYear, 1, 1);
  selectWheelValue(elements.wheelGrade, '');

  attachWheelHandler(elements.wheelYear, (value) => {
    const year = toNumber(value) || currentYear;
    const month = toNumber(getWheelValue(elements.wheelMonth)) || 1;
    const day = toNumber(getWheelValue(elements.wheelDay)) || 1;
    buildBirthDayWheel(year, month, day);
  });
  attachWheelHandler(elements.wheelMonth, (value) => {
    const year = toNumber(getWheelValue(elements.wheelYear)) || currentYear;
    const month = toNumber(value) || 1;
    const day = toNumber(getWheelValue(elements.wheelDay)) || 1;
    buildBirthDayWheel(year, month, day);
  });
  attachWheelHandler(elements.wheelDay);
  attachWheelHandler(elements.wheelGrade);
}

async function fetchJson(url, options) {
  const response = await fetch(url, options);
  const data = await response.json().catch(() => ({}));
  if (!response.ok) {
    const message = data?.error || data?.message || 'تعذر تنفيذ الطلب.';
    const error = new Error(message);
    error.status = response.status;
    error.data = data;
    throw error;
  }
  return data;
}

async function loadStudents() {
  setLoading('جاري تحميل البيانات...');
  try {
    const data = await fetchJson(API_BASE);
    const list = Array.isArray(data) ? data : data.students || [];
    state.students = list;
    updateClassFilterOptions(elements.gradeFilter.value);
    applyFilters({ resetPage: true });
  } catch (error) {
    setLoading('تعذر تحميل البيانات.');
    showToast('خطأ', error.message, 'error');
    updateExportButtonState(0);
  }
}

function buildImportHeaders(rows, hasHeader) {
  const maxColumns = rows.reduce((max, row) => Math.max(max, row.length), 0);
  const headerRow = hasHeader ? rows[0] || [] : [];
  const headers = Array.from({ length: maxColumns }, (_, index) => {
    const value = normalizeValue(headerRow[index]);
    return value || toColumnLabel(index);
  });
  return {
    headers,
    dataRows: hasHeader ? rows.slice(1) : rows
  };
}

function renderImportPreview(headers, rows) {
  if (!headers.length) {
    elements.importPreviewHead.innerHTML = '';
  } else {
    const headerCells = headers
      .map((label) => `<th>${escapeHtml(label)}</th>`)
      .join('');
    elements.importPreviewHead.innerHTML = `<tr>${headerCells}</tr>`;
  }

  if (!rows.length) {
    elements.importPreviewBody.innerHTML = `
      <tr>
        <td class="muted center">لا توجد بيانات للعرض.</td>
      </tr>
    `;
    return;
  }

  const previewRows = rows.slice(0, 10).map((row) => {
    const cells = headers.map((_, index) => `<td>${escapeHtml(normalizeValue(row[index]))}</td>`);
    return `<tr>${cells.join('')}</tr>`;
  });
  elements.importPreviewBody.innerHTML = previewRows.join('');
}

function buildMappingOptions(headers) {
  const options = ['<option value="">— اختر العمود —</option>'];
  headers.forEach((label, index) => {
    options.push(`<option value="${index}">${escapeHtml(label)}</option>`);
  });
  return options.join('');
}

function normalizeHeaderLabel(label) {
  return normalizeValue(label).toLowerCase().replace(/\s+/g, '');
}

function guessColumn(headers, keywords) {
  const normalizedHeaders = headers.map((label) => normalizeHeaderLabel(label));
  for (const keyword of keywords) {
    const index = normalizedHeaders.findIndex((label) => label.includes(keyword));
    if (index !== -1) return index;
  }
  return '';
}

function applyMappingDefaults(headers) {
  const studentIdIndex = guessColumn(headers, ['رقمالهوية', 'الهوية', 'studentid', 'id']);
  const nameIndex = guessColumn(headers, ['الاسم', 'name', 'studentname']);
  const birthIndex = guessColumn(headers, ['تاريخالميلاد', 'تاريخ', 'birthdate', 'dob']);
  const gradeIndex = guessColumn(headers, ['الصف', 'grade']);
  const classIndex = guessColumn(headers, ['الشعبة', 'class', 'section']);

  elements.mapStudentId.value = studentIdIndex !== '' ? String(studentIdIndex) : '';
  elements.mapName.value = nameIndex !== '' ? String(nameIndex) : '';
  elements.mapBirthDate.value = birthIndex !== '' ? String(birthIndex) : '';
  elements.mapGrade.value = gradeIndex !== '' ? String(gradeIndex) : '';
  elements.mapClass.value = classIndex !== '' ? String(classIndex) : '';
}

function refreshImportMapping() {
  const options = buildMappingOptions(importState.headers);
  getImportColumns().forEach((select) => {
    if (select) select.innerHTML = options;
  });
  applyMappingDefaults(importState.headers);
}

async function handleImportFileChange() {
  const file = elements.importFile.files?.[0];
  if (!file) return;
  if (!window.XLSX) {
    showToast('خطأ', 'تعذر تحميل مكتبة قراءة Excel.', 'error');
    return;
  }

  try {
    const arrayBuffer = await file.arrayBuffer();
    const workbook = window.XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    if (!sheet) {
      showToast('تنبيه', 'تعذر قراءة الملف المحدد.', 'warning');
      return;
    }

    const rows = window.XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: '' });
    importState.rows = rows;
    importState.hasHeader = elements.importHasHeader.checked;
    const { headers, dataRows } = buildImportHeaders(rows, importState.hasHeader);
    importState.headers = headers;
    importState.columnLabels = headers;
    renderImportPreview(headers, dataRows);
    refreshImportMapping();
    importState.validated = false;
    elements.importExecute.disabled = true;
    updateImportResultsSummary('تم تحميل الملف. يرجى تعيين الأعمدة ثم الضغط على "تحقق".');
  } catch (error) {
    showToast('خطأ', 'تعذر قراءة الملف. يرجى التأكد من صحة الملف.', 'error');
  }
}

function handleImportHeaderToggle() {
  if (!importState.rows.length) return;
  importState.hasHeader = elements.importHasHeader.checked;
  const { headers, dataRows } = buildImportHeaders(importState.rows, importState.hasHeader);
  importState.headers = headers;
  renderImportPreview(headers, dataRows);
  refreshImportMapping();
  importState.validated = false;
  elements.importExecute.disabled = true;
  updateImportResultsSummary('تم تحديث المعاينة. يرجى الضغط على "تحقق" مرة أخرى.');
}

function buildCsvContent(headers, rows) {
  const escapeCsv = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
  const lines = [headers.map(escapeCsv).join(',')];
  rows.forEach((row) => {
    lines.push(headers.map((header) => escapeCsv(row[header])).join(','));
  });
  return `\ufeff${lines.join('\n')}`;
}

function downloadCsv(filename, headers, rows) {
  const content = buildCsvContent(headers, rows);
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function buildImportRows() {
  const mapping = {
    studentId: elements.mapStudentId.value,
    name: elements.mapName.value,
    birthDate: elements.mapBirthDate.value,
    grade: elements.mapGrade.value,
    className: elements.mapClass.value
  };

  if (!mapping.studentId || !mapping.name || !mapping.birthDate) {
    showToast('تنبيه', 'يرجى تعيين الأعمدة الإلزامية قبل التحقق.', 'warning');
    return null;
  }

  const dataRows = importState.hasHeader ? importState.rows.slice(1) : importState.rows;
  const rows = [];

  dataRows.forEach((row, index) => {
    const values = Array.isArray(row) ? row : [];
    const rowNumber = importState.hasHeader ? index + 2 : index + 1;
    const allValues = values.map((cell) => normalizeValue(cell)).filter(Boolean);
    if (!allValues.length) return;

    const studentIdRaw = values[Number(mapping.studentId)];
    const nameRaw = values[Number(mapping.name)];
    const birthRaw = values[Number(mapping.birthDate)];
    const gradeRaw = mapping.grade ? values[Number(mapping.grade)] : '';
    const classRaw = mapping.className ? values[Number(mapping.className)] : '';

    const studentId = normalizeDigits(studentIdRaw);
    const name = normalizeValue(nameRaw);
    const { iso: birthDate, error: birthError } = parseBirthDate(birthRaw);
    const grade = normalizeGrade(gradeRaw);
    const className = normalizeDigits(classRaw);

    rows.push({
      rowNumber,
      studentId,
      name,
      birthDate,
      grade,
      className,
      birthError
    });
  });

  return rows;
}

async function handleImportValidate() {
  if (!importState.rows.length) {
    showToast('تنبيه', 'يرجى اختيار ملف أولًا.', 'warning');
    return;
  }

  const rows = buildImportRows();
  if (!rows) return;

  if (!importState.existingSet) {
    try {
      const data = await fetchJson(API_BASE);
      const list = Array.isArray(data) ? data : data.students || [];
      importState.existingSet = new Set(
        list.map((student) => normalizeDigits(student.StudentId || student.studentId))
      );
    } catch (error) {
      showToast('خطأ', 'تعذر التحقق من قائمة الطلاب الحالية.', 'error');
      return;
    }
  }

  const results = { toAdd: [], skipped: [], invalid: [] };
  rows.forEach((row) => {
    const errors = [];
    if (!row.studentId) {
      errors.push('رقم الهوية مفقود.');
    }
    if (!row.name) {
      errors.push('الاسم مفقود.');
    }
    if (!row.birthDate) {
      errors.push(row.birthError || 'تاريخ الميلاد مفقود.');
    }

    if (errors.length) {
      results.invalid.push({
        ...row,
        error: errors.join(' ')
      });
      return;
    }

    if (importState.existingSet?.has(row.studentId)) {
      results.skipped.push({
        ...row,
        reason: 'لم تتم إضافة هذا الطالب لأنه موجود مسبقًا في النظام.'
      });
      return;
    }

    const [birthYear, birthMonth, birthDay] = row.birthDate.split('-');
    results.toAdd.push({
      studentId: row.studentId,
      name: row.name,
      birthDate: row.birthDate,
      birthYear,
      birthMonth,
      birthDay,
      grade: row.grade,
      class: row.className,
      firstName: deriveFirstNameFromName(row.name),
      rowNumber: row.rowNumber
    });
  });

  importState.results = results;
  importState.validated = true;
  elements.importExecute.disabled = results.toAdd.length === 0;
  updateImportResultsSummary(
    `تم التحقق من الملف.\nالمرشّح للإضافة: ${results.toAdd.length} طالبًا.\n` +
      `المتخطّون (موجودون مسبقًا): ${results.skipped.length} طالبًا.\n` +
      `الصفوف ذات الأخطاء: ${results.invalid.length} صفًا.`
  );
}

async function handleImportExecute() {
  if (!importState.validated) {
    showToast('تنبيه', 'يرجى تنفيذ التحقق أولًا.', 'warning');
    return;
  }

  if (!importState.results.toAdd.length) {
    showToast('تنبيه', 'لا توجد بيانات جديدة للإضافة.', 'warning');
    return;
  }

  importBusy = true;
  elements.importExecute.disabled = true;
  elements.importValidate.disabled = true;

  const batchSize = 30;
  const total = importState.results.toAdd.length;
  let completed = 0;
  let added = 0;
  const skipped = [...importState.results.skipped];
  const invalid = [...importState.results.invalid];

  for (let i = 0; i < total; i += batchSize) {
    const batch = importState.results.toAdd.slice(i, i + batchSize);
    const results = await Promise.allSettled(
      batch.map((student) =>
        fetchJson(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            studentId: student.studentId,
            birthYear: student.birthYear,
            birthMonth: student.birthMonth,
            birthDay: student.birthDay,
            name: student.name,
            firstName: student.firstName,
            birthDate: student.birthDate,
            grade: student.grade,
            class: student.class
          })
        })
      )
    );

    results.forEach((result, index) => {
      const student = batch[index];
      if (result.status === 'fulfilled') {
        added += 1;
        return;
      }

      const error = result.reason;
      const message = normalizeValue(error?.message || error?.data?.message || '');
      const isExisting =
        error?.status === 409 ||
        message.includes('موجود') ||
        message.toLowerCase().includes('exists');

      if (isExisting) {
        skipped.push({
          studentId: student.studentId,
          name: student.name,
          birthDate: student.birthDate,
          grade: student.grade,
          className: student.class,
          reason: 'لم تتم إضافة هذا الطالب لأنه موجود مسبقًا في النظام.'
        });
      } else {
        invalid.push({
          rowNumber: student.rowNumber,
          studentId: student.studentId,
          name: student.name,
          birthDate: student.birthDate,
          grade: student.grade,
          className: student.class,
          error: message || 'تعذر إضافة الطالب بسبب خطأ غير معروف.'
        });
      }
    });

    completed += batch.length;
    const percent = Math.round((completed / total) * 100);
    updateImportProgress(percent);
  }

  const summaryText = [
    `تمّت إضافة (${added}) طالبًا بنجاح.`,
    `لم تتم إضافة (${skipped.length}) طالبًا لأنهم موجودون مسبقًا في النظام.`,
    `تعذّرت معالجة (${invalid.length}) صفوف بسبب أخطاء في البيانات.`
  ].join('\n');

  updateImportResultsSummary(summaryText);
  elements.importTeacherNote.value = summaryText;
  elements.downloadSkipped.disabled = skipped.length === 0;
  elements.downloadErrors.disabled = invalid.length === 0;
  importState.results = { toAdd: [], skipped, invalid };
  importBusy = false;
  elements.importValidate.disabled = false;
  elements.importExecute.disabled = true;
  showToast('اكتمل الاستيراد', 'تمت معالجة ملف الاستيراد.', 'success');
  loadStudents();
}

function handleDownloadSkipped() {
  const skipped = importState.results.skipped || [];
  if (!skipped.length) return;
  downloadCsv(
    'report-skipped.csv',
    ['StudentId', 'Name', 'BirthDate', 'Grade', 'Class', 'Reason'],
    skipped.map((row) => ({
      StudentId: row.studentId,
      Name: row.name,
      BirthDate: row.birthDate,
      Grade: row.grade,
      Class: row.className,
      Reason: row.reason
    }))
  );
}

function handleDownloadErrors() {
  const invalid = importState.results.invalid || [];
  if (!invalid.length) return;
  downloadCsv(
    'report-errors.csv',
    ['RowNumber', 'StudentId', 'Name', 'BirthDate', 'Grade', 'Class', 'Error'],
    invalid.map((row) => ({
      RowNumber: row.rowNumber,
      StudentId: row.studentId,
      Name: row.name,
      BirthDate: row.birthDate,
      Grade: row.grade,
      Class: row.className,
      Error: row.error
    }))
  );
}

function renderStudents(list) {
  if (!list.length) {
    setLoading('لا توجد نتائج حالياً.');
    return;
  }

  elements.body.innerHTML = list
    .map((student) => {
      const studentId = normalizeDigits(student.StudentId || student.studentId);
      const birthYear = normalizeDigits(student.BirthYear || student.birthYear);
      const name = normalizeValue(student.Name || student.name);
      const grade = normalizeGrade(student.Grade || student.grade);
      const className = normalizeDigits(student.Class || student.class);
      const gradeLabel = gradeLabels[grade] || grade;

      return `
        <tr>
          <td class="select-cell">
            <input class="row-check" type="checkbox" data-id="${escapeHtml(studentId)}" aria-label="تحديد الطالب" />
          </td>
          <td class="ltr">${escapeHtml(studentId)}</td>
          <td class="ltr">${escapeHtml(birthYear)}</td>
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(gradeLabel)}</td>
          <td>${escapeHtml(className)}</td>
          <td class="actions">
            <button class="btn btn-outline btn-sm icon-btn" data-action="edit" data-id="${escapeHtml(studentId)}" title="تعديل" aria-label="تعديل">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M3 17.25V21h3.75l11-11-3.75-3.75-11 11zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
              </svg>
            </button>
            <button class="btn btn-ghost btn-sm icon-btn" data-action="delete" data-id="${escapeHtml(studentId)}" title="حذف" aria-label="حذف">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 13.41l-6.29 6.3-1.42-1.42L10.59 12 4.29 5.71 5.7 4.29 12 10.59l6.29-6.3z"/>
              </svg>
            </button>
          </td>
        </tr>
      `;
    })
    .join('');
}

function openModal(mode, student = {}) {
  state.mode = mode;
  const isEdit = mode === 'edit';
  firstNameTouched = false;

  elements.modalTitle.textContent = isEdit ? 'تعديل بيانات الطالب' : 'إضافة طالب';
  elements.submitButton.textContent = isEdit ? 'حفظ التعديلات' : 'إضافة الطالب';

  elements.modal.classList.remove('hidden');
  elements.modal.setAttribute('aria-hidden', 'false');

  elements.studentIdInput.value = normalizeValue(student.StudentId || student.studentId);
  elements.nameInput.value = normalizeValue(student.Name || student.name);
  elements.firstNameInput.value = normalizeValue(student.FirstName || student.firstName);
  elements.classInput.value = normalizeValue(student.Class || student.class);

  const birthDateParts = parseDateParts(student.BirthDate || student.birthDate);
  const fallbackBirthYear = normalizeValue(student.BirthYear || student.birthYear);
  const yearValue = birthDateParts?.year || fallbackBirthYear || String(new Date().getFullYear());
  const monthValue = birthDateParts?.month || '1';
  const dayValue = birthDateParts?.day || '1';
  selectWheelValue(elements.wheelYear, yearValue);
  selectWheelValue(elements.wheelMonth, monthValue);
  buildBirthDayWheel(toNumber(yearValue), toNumber(monthValue), toNumber(dayValue));

  const gradeValue = normalizeGrade(student.Grade || student.grade);
  selectWheelValue(elements.wheelGrade, gradeValue);

  elements.studentIdInput.disabled = isEdit;
}

function closeModal() {
  elements.form.reset();
  const currentYear = new Date().getFullYear();
  selectWheelValue(elements.wheelYear, currentYear);
  selectWheelValue(elements.wheelMonth, 1);
  buildBirthDayWheel(currentYear, 1, 1);
  selectWheelValue(elements.wheelGrade, '');
  elements.studentIdInput.disabled = false;
  firstNameTouched = false;
  elements.modal.classList.add('hidden');
  elements.modal.setAttribute('aria-hidden', 'true');
}

function findStudentById(studentId) {
  return state.students.find((student) =>
    normalizeValue(student.StudentId || student.studentId) === studentId
  );
}

async function handleSubmit(event) {
  event.preventDefault();

  const payload = {
    studentId: normalizeValue(elements.studentIdInput.value),
    birthYear: normalizeValue(getWheelValue(elements.wheelYear)),
    birthMonth: normalizeValue(getWheelValue(elements.wheelMonth)),
    birthDay: normalizeValue(getWheelValue(elements.wheelDay)),
    name: normalizeValue(elements.nameInput.value),
    firstName: normalizeValue(elements.firstNameInput.value),
    grade: normalizeValue(getWheelValue(elements.wheelGrade)),
    class: normalizeValue(elements.classInput.value)
  };

  if (!payload.studentId || !payload.birthYear || !payload.name) {
    showToast('تنبيه', 'يرجى تعبئة الحقول المطلوبة.', 'warning');
    return;
  }

  if (!payload.birthMonth || !payload.birthDay) {
    showToast('تنبيه', 'يرجى اختيار تاريخ الميلاد بالكامل.', 'warning');
    return;
  }

  const birthDate = `${payload.birthYear}-${padTwo(payload.birthMonth)}-${padTwo(payload.birthDay)}`;

  try {
    if (state.mode === 'add') {
      await fetchJson(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          studentId: payload.studentId,
          birthYear: payload.birthYear,
          name: payload.name,
          firstName: payload.firstName,
          birthDate,
          grade: payload.grade,
          class: payload.class
        })
      });
      showToast('تمت الإضافة', 'تم إضافة الطالب بنجاح.', 'success');
    } else {
      await fetchJson(`${API_BASE}/${encodeURIComponent(payload.studentId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          birthYear: payload.birthYear,
          name: payload.name,
          firstName: payload.firstName,
          birthDate,
          grade: payload.grade,
          class: payload.class
        })
      });
      showToast('تم التعديل', 'تم تحديث بيانات الطالب.', 'success');
    }

    closeModal();
    loadStudents();
  } catch (error) {
    showToast('خطأ', error.message, 'error');
  }
}

function handleNameBlur() {
  const nameValue = normalizeValue(elements.nameInput.value);
  const firstNameValue = normalizeValue(elements.firstNameInput.value);
  if (!nameValue) return;
  if (!firstNameValue || !firstNameTouched) {
    elements.firstNameInput.value = deriveFirstNameFromName(nameValue);
    firstNameTouched = false;
  }
}

function handleFirstNameInput() {
  firstNameTouched = true;
}

function getSelectedStudentIds() {
  return Array.from(elements.body.querySelectorAll('.row-check:checked'))
    .map((checkbox) => checkbox.dataset.id)
    .filter(Boolean);
}

function updateBulkDeleteState() {
  const selected = getSelectedStudentIds();
  elements.deleteSelectedButton.disabled = selected.length === 0;
  elements.deleteSelectedButton.textContent = selected.length
    ? `حذف المحدد (${selected.length})`
    : 'حذف المحدد';
  if (elements.selectAll) {
    const total = elements.body.querySelectorAll('.row-check').length;
    elements.selectAll.checked = total > 0 && selected.length === total;
    elements.selectAll.indeterminate = selected.length > 0 && selected.length < total;
  }
}

function updateExportButtonState(total) {
  if (!elements.exportButton) return;
  elements.exportButton.disabled = total === 0;
}

function buildExportFileName() {
  const rawGrade = normalizeGrade(elements.gradeFilter.value);
  const rawClass = normalizeDigits(elements.classFilter.value);
  const toSafePart = (value) => {
    const text = normalizeValue(value);
    return text ? text.replace(/\s+/g, '-') : 'all';
  };
  const gradePart = toSafePart(rawGrade);
  const classPart = toSafePart(rawClass);
  return `students_grade-${gradePart}_class-${classPart}.xlsx`;
}

function handleExportStudents() {
  const filtered = getFilteredStudents();
  if (!filtered.length) {
    updateExportButtonState(0);
    showToast('تنبيه', 'لا توجد نتائج للتصدير.', 'warning');
    return;
  }

  if (!window.XLSX) {
    showToast('خطأ', 'تعذر تحميل مكتبة تصدير Excel.', 'error');
    return;
  }

  const headers = ['StudentId', 'BirthYear', 'Name', 'FirstName', 'Grade', 'Class', 'BirthDate'];
  const rows = filtered.map((student) => {
    const studentId = normalizeDigits(student.StudentId || student.studentId);
    const birthYear = normalizeDigits(student.BirthYear || student.birthYear);
    const name = normalizeValue(student.Name || student.name);
    const firstName = normalizeValue(student.FirstName || student.firstName);
    const grade = normalizeGrade(student.Grade || student.grade);
    const className = normalizeDigits(student.Class || student.class);
    const birthDate = normalizeValue(student.BirthDate || student.birthDate);

    return [studentId, birthYear, name, firstName, grade, className, birthDate];
  });

  const worksheet = window.XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const workbook = window.XLSX.utils.book_new();
  window.XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
  window.XLSX.writeFile(workbook, buildExportFileName());
}

function openConfirmModal({ title, message, onConfirm }) {
  confirmAction = onConfirm;
  elements.confirmTitle.textContent = title;
  elements.confirmMessage.textContent = message;
  elements.confirmModal.classList.remove('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'false');
}

function closeConfirmModal(force = false) {
  if (confirmBusy && !force) return;
  confirmAction = null;
  elements.confirmModal.classList.add('hidden');
  elements.confirmModal.setAttribute('aria-hidden', 'true');
}

async function handleConfirmSubmit() {
  if (!confirmAction || confirmBusy) return;
  confirmBusy = true;
  elements.confirmSubmit.disabled = true;
  try {
    await confirmAction();
    confirmBusy = false;
    closeConfirmModal(true);
  } catch (error) {
    showToast('خطأ', error.message, 'error');
  } finally {
    confirmBusy = false;
    elements.confirmSubmit.disabled = false;
  }
}

async function handleDelete(studentId) {
  openConfirmModal({
    title: 'تأكيد الحذف',
    message: 'هل أنت متأكد من حذف الطالب؟',
    onConfirm: async () => {
      await fetchJson(`${API_BASE}/${encodeURIComponent(studentId)}`, {
        method: 'DELETE'
      });
      showToast('تم الحذف', 'تم حذف الطالب بنجاح.', 'success');
      loadStudents();
    }
  });
}

function handleDeleteSelected() {
  const selected = getSelectedStudentIds();
  if (!selected.length) return;
  openConfirmModal({
    title: 'تأكيد الحذف الجماعي',
    message: `سيتم حذف ${selected.length} طالب/طلاب. هل تريد المتابعة؟`,
    onConfirm: async () => {
      const deletions = await Promise.allSettled(
        selected.map((id) =>
          fetchJson(`${API_BASE}/${encodeURIComponent(id)}`, { method: 'DELETE' })
        )
      );
      const failed = deletions.filter((result) => result.status === 'rejected');
      if (failed.length) {
        throw new Error('حدثت أخطاء أثناء الحذف الجماعي.');
      }
      showToast('تم الحذف', 'تم حذف الطلاب المحددين بنجاح.', 'success');
      loadStudents();
    }
  });
}

function handleTableClick(event) {
  const actionButton = event.target?.closest('[data-action]');
  const action = actionButton?.dataset?.action;
  const studentId = actionButton?.dataset?.id;
  if (!action || !studentId) return;

  if (action === 'edit') {
    const student = findStudentById(studentId);
    if (!student) {
      showToast('تنبيه', 'تعذر العثور على بيانات الطالب.', 'warning');
      return;
    }
    openModal('edit', student);
    return;
  }

  if (action === 'delete') {
    handleDelete(studentId);
  }
}

function handleTableChange(event) {
  if (event.target?.classList.contains('row-check')) {
    updateBulkDeleteState();
  }
}

function handleSelectAllChange() {
  const shouldSelect = elements.selectAll.checked;
  elements.body.querySelectorAll('.row-check').forEach((checkbox) => {
    checkbox.checked = shouldSelect;
  });
  updateBulkDeleteState();
}

function handleSearch() {
  applyFilters({ resetPage: true });
}

function handleSearchInput() {
  if (searchTimeout) window.clearTimeout(searchTimeout);
  searchTimeout = window.setTimeout(() => {
    handleSearch();
  }, 350);
}

function updateClassFilterOptions(gradeValue) {
  if (!elements.classFilter) return;
  const grade = normalizeGrade(gradeValue);
  if (!grade) {
    elements.classFilter.innerHTML = '<option value="">كل الشعب</option>';
    elements.classFilter.value = '';
    elements.classFilter.disabled = true;
    return;
  }

  const classes = new Set();
  state.students.forEach((student) => {
    const studentGrade = normalizeGrade(student.Grade || student.grade);
    if (studentGrade !== grade) return;
    const className = normalizeDigits(student.Class || student.class);
    if (className) classes.add(className);
  });

  const options = ['<option value="">كل الشعب</option>'];
  Array.from(classes)
    .sort((a, b) => a.localeCompare(b, 'ar'))
    .forEach((className) => {
      options.push(`<option value="${escapeHtml(className)}">${escapeHtml(className)}</option>`);
    });

  const currentValue = elements.classFilter.value;
  elements.classFilter.innerHTML = options.join('');
  elements.classFilter.disabled = false;
  elements.classFilter.value = classes.has(currentValue) ? currentValue : '';
}

function getFilteredStudents() {
  const query = normalizeValue(elements.searchInput.value).toLowerCase();
  const gradeFilter = normalizeGrade(elements.gradeFilter.value);
  const classFilter = normalizeDigits(elements.classFilter.value);

  return state.students.filter((student) => {
    const studentId = normalizeDigits(student.StudentId || student.studentId);
    const name = normalizeValue(student.Name || student.name);
    const grade = normalizeGrade(student.Grade || student.grade);
    const className = normalizeDigits(student.Class || student.class);

    if (query) {
      const matchesId = studentId.toLowerCase().includes(query);
      const matchesName = name.toLowerCase().includes(query);
      if (!matchesId && !matchesName) return false;
    }

    if (gradeFilter && grade !== gradeFilter) return false;
    if (classFilter && className !== classFilter) return false;

    return true;
  });
}

function updatePagination(totalPages) {
  if (!elements.pagination) return;
  if (!totalPages || totalPages <= 1) {
    elements.pagination.innerHTML = '';
    return;
  }

  const pageButtons = Array.from({ length: totalPages }, (_, index) => {
    const page = index + 1;
    const isActive = page === state.currentPage;
    return `
      <button class="btn btn-outline btn-sm${isActive ? ' is-active' : ''}" data-page="${page}">
        ${page}
      </button>
    `;
  }).join('');

  elements.pagination.innerHTML = `
    <button class="btn btn-outline btn-sm" data-page="prev" ${state.currentPage === 1 ? 'disabled' : ''}>
      السابق
    </button>
    <div class="pagination-pages">${pageButtons}</div>
    <button class="btn btn-outline btn-sm" data-page="next" ${state.currentPage === totalPages ? 'disabled' : ''}>
      التالي
    </button>
  `;
}

function applyFilters({ resetPage = false } = {}) {
  if (resetPage) {
    state.currentPage = 1;
  }

  const filtered = getFilteredStudents();
  const totalPages = filtered.length ? Math.ceil(filtered.length / state.pageSize) : 0;
  if (totalPages && state.currentPage > totalPages) {
    state.currentPage = totalPages;
  }
  const start = (state.currentPage - 1) * state.pageSize;
  const paginated = filtered.slice(start, start + state.pageSize);
  renderStudents(paginated);
  updatePagination(totalPages);
  updateBulkDeleteState();
  updateExportButtonState(filtered.length);
}

function handleGradeFilterChange() {
  updateClassFilterOptions(elements.gradeFilter.value);
  applyFilters({ resetPage: true });
}

function handleClassFilterChange() {
  applyFilters({ resetPage: true });
}

function handlePaginationClick(event) {
  const button = event.target.closest('[data-page]');
  if (!button || button.disabled) return;
  const pageValue = button.dataset.page;
  const totalPages = Math.ceil(getFilteredStudents().length / state.pageSize);
  if (!totalPages) return;

  if (pageValue === 'prev') {
    state.currentPage = Math.max(1, state.currentPage - 1);
  } else if (pageValue === 'next') {
    state.currentPage = Math.min(totalPages, state.currentPage + 1);
  } else {
    state.currentPage = Number(pageValue) || 1;
  }

  applyFilters();
}

function handleBackdropClick(event) {
  if (event.target?.dataset?.close) {
    if (event.currentTarget === elements.modal) {
      closeModal();
    }
    if (event.currentTarget === elements.confirmModal) {
      closeConfirmModal();
    }
    if (event.currentTarget === elements.importModal) {
      closeImportModal();
    }
  }
}

function handleImportMappingChange() {
  importState.validated = false;
  elements.importExecute.disabled = true;
}

function handleGlobalKeydown(event) {
  if (event.key !== 'Escape') return;
  if (!elements.importModal.classList.contains('hidden')) {
    closeImportModal();
    return;
  }
  if (!elements.modal.classList.contains('hidden')) {
    closeModal();
    return;
  }
  if (!elements.confirmModal.classList.contains('hidden')) {
    closeConfirmModal();
  }
}

function init() {
  initializeWheels();
  elements.addButton.addEventListener('click', () => openModal('add'));
  elements.deleteSelectedButton.addEventListener('click', handleDeleteSelected);
  if (elements.exportButton) {
    elements.exportButton.addEventListener('click', handleExportStudents);
  }
  elements.searchButton.addEventListener('click', handleSearch);
  elements.searchInput.addEventListener('input', handleSearchInput);
  elements.gradeFilter.addEventListener('change', handleGradeFilterChange);
  elements.classFilter.addEventListener('change', handleClassFilterChange);
  elements.pagination.addEventListener('click', handlePaginationClick);
  elements.body.addEventListener('click', handleTableClick);
  elements.body.addEventListener('change', handleTableChange);
  elements.form.addEventListener('submit', handleSubmit);
  elements.modalClose.addEventListener('click', closeModal);
  elements.modalCancel.addEventListener('click', closeModal);
  elements.modal.addEventListener('click', handleBackdropClick);
  elements.nameInput.addEventListener('blur', handleNameBlur);
  elements.firstNameInput.addEventListener('input', handleFirstNameInput);
  elements.selectAll.addEventListener('change', handleSelectAllChange);
  elements.confirmClose.addEventListener('click', closeConfirmModal);
  elements.confirmCancel.addEventListener('click', closeConfirmModal);
  elements.confirmSubmit.addEventListener('click', handleConfirmSubmit);
  elements.confirmModal.addEventListener('click', handleBackdropClick);
  elements.importButton.addEventListener('click', openImportModal);
  elements.importClose.addEventListener('click', closeImportModal);
  elements.importCancel.addEventListener('click', closeImportModal);
  elements.importModal.addEventListener('click', handleBackdropClick);
  elements.importFile.addEventListener('change', handleImportFileChange);
  elements.importHasHeader.addEventListener('change', handleImportHeaderToggle);
  getImportColumns().forEach((select) => {
    select.addEventListener('change', handleImportMappingChange);
  });
  elements.importValidate.addEventListener('click', handleImportValidate);
  elements.importExecute.addEventListener('click', handleImportExecute);
  elements.downloadSkipped.addEventListener('click', handleDownloadSkipped);
  elements.downloadErrors.addEventListener('click', handleDownloadErrors);
  document.addEventListener('keydown', handleGlobalKeydown);

  loadStudents();
}

init();
math/public/assets/js/questions/input.js
/* =========================================================
   input.js — Input Question
   - If expected answer is numeric:
     - mobile keyboard shows numbers (inputmode="numeric")
     - field only accepts digits (even on PC)
     - compare by numeric value (2 == 02 == ٢ == ۲)
   - Otherwise: normal text compare after trim + collapse spaces
   - Mobile UX: keep input visible above keyboard while typing (VisualViewport)

   UPDATE (2026-01-14):
   - Pressing Enter/Go triggers the main "متابعة" button automatically
   - Persist input value across engine re-renders using question._value

   UPDATE (2026-01-14) #2:
   - Improve keyboard overlap fix:
     * scroll based on the whole question box (.question-wrap), not only the input
     * re-run visibility adjustment after check (so attempts/solution stay visible)
   ========================================================= */

export function renderInputQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-input';

  const desc = document.createElement('div');
  desc.className = 'q-desc';
  desc.textContent = question.text || '';

  const input = document.createElement('input');
  input.className = 'input ltr';
  input.type = 'text';
  input.autocomplete = 'off';
  input.placeholder = question.placeholder || 'اكتب إجابتك هنا';

  const feedback = document.createElement('div');
  feedback.className = 'q-feedback';
  feedback.textContent = '';

  wrap.appendChild(desc);
  wrap.appendChild(input);
  wrap.appendChild(feedback);

  mountEl.appendChild(wrap);

  function normalizeSpaces(s) {
    if (s == null) return '';
    return String(s).trim().replace(/\s+/g, ' ');
  }

  function toLatinDigits(str) {
    const map = {
      '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
      '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
      '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
      '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
    };
    return String(str).replace(/[٠-٩۰-۹]/g, (d) => map[d] ?? d);
  }

  function numericOnly(str) {
    return String(str).replace(/[^0-9]/g, '');
  }

  function isNumericAnswer(ans) {
    const a = numericOnly(toLatinDigits(normalizeSpaces(ans)));
    return a.length > 0 && /^[0-9]+$/.test(a);
  }

  const expectsNumber = isNumericAnswer(question.answer);

  // Restore previous value (persisted by engine via stable question object)
  if (typeof question._value === 'string' && question._value !== '') {
    input.value = question._value;
  }

  if (expectsNumber) {
    // Mobile: numeric keyboard
    input.inputMode = 'numeric';
    input.pattern = '[0-9]*';

    // Desktop/All: restrict to digits only + persist value
    input.addEventListener('input', () => {
      const before = input.value;
      const latin = toLatinDigits(before);
      const filtered = numericOnly(latin);
      if (before !== filtered) input.value = filtered;

      // Persist
      question._value = input.value;
    });

    // Block non-digit keys (extra safety)
    input.addEventListener('keydown', (e) => {
      const allowed = [
        'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
        'Tab', 'Home', 'End', 'Enter'
      ];
      if (allowed.includes(e.key)) return;
      if (e.ctrlKey || e.metaKey) return;
      if (!/^[0-9]$/.test(e.key)) e.preventDefault();
    });
  } else {
    // Text mode: persist as user types
    input.addEventListener('input', () => {
      question._value = input.value;
    });
  }

  /* ---------- Enter/Go triggers "متابعة" ---------- */
  input.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    if (e.shiftKey) return;

    e.preventDefault();

    // Find the single main button "متابعة" inside current concept
    const conceptBody = mountEl.closest('.concept-body') || mountEl.closest('.card') || document;
    const btn = conceptBody.querySelector('.lesson-nav .btn');

    if (btn && typeof btn.click === 'function') {
      btn.click();
    }
  });

  /* ---------- Mobile keyboard overlap fix ---------- */
  const isTouchLikely =
    ('ontouchstart' in window) ||
    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);

  let vvHandler = null;

  function ensureVisible() {
    // Delay to allow keyboard to open and viewport to resize
    setTimeout(() => {
      const vv = window.visualViewport;

      // Determine current visible bottom in layout viewport coordinates
      let visibleBottomY;
      if (vv) {
        visibleBottomY = vv.pageTop + vv.height;
      } else {
        visibleBottomY = window.scrollY + window.innerHeight;
      }

      // ✅ IMPORTANT: use the whole question box bottom, not just the input
      const qWrap = input.closest('.question-wrap') || input;
      const rect = qWrap.getBoundingClientRect();
      const targetBottomY = window.scrollY + rect.bottom;

      // Comfortable margin (bigger when keyboard is open)
      let extra = 18;
      if (vv) {
        const kb = Math.max(0, window.innerHeight - vv.height); // approximate keyboard height
        // raise more when keyboard is big
        extra += Math.min(160, Math.max(60, Math.round(kb * 0.35)));
      } else {
        extra += 60;
      }

      if (targetBottomY + extra > visibleBottomY) {
        const delta = (targetBottomY + extra) - visibleBottomY;
        window.scrollBy({ top: delta, left: 0, behavior: 'smooth' });
      }
    }, 260);
  }

  function onFocus() {
    if (!isTouchLikely) return;

    ensureVisible();

    // Also react to viewport changes while keyboard is animating
    const vv = window.visualViewport;
    if (vv && !vvHandler) {
      vvHandler = () => ensureVisible();
      vv.addEventListener('resize', vvHandler);
      vv.addEventListener('scroll', vvHandler);
    }
  }

  function onBlur() {
    const vv = window.visualViewport;
    if (vv && vvHandler) {
      vv.removeEventListener('resize', vvHandler);
      vv.removeEventListener('scroll', vvHandler);
      vvHandler = null;
    }
  }

  input.addEventListener('focus', onFocus);
  input.addEventListener('blur', onBlur);

  /* ---------- Check ---------- */
  function check() {
    const rawUser = input.value ?? '';
    const rawAns = question.answer ?? '';

    // Persist before checking (safety)
    question._value = rawUser;

    if (expectsNumber) {
      const userDigits = numericOnly(toLatinDigits(rawUser));
      const ansDigits = numericOnly(toLatinDigits(rawAns));

      const userNum = userDigits === '' ? NaN : Number(userDigits);
      const ansNum = ansDigits === '' ? NaN : Number(ansDigits);

      const ok = Number.isFinite(userNum) && Number.isFinite(ansNum) && userNum === ansNum;

      feedback.textContent = ok ? 'إجابة صحيحة ✅' : 'مش صحيح، جرّب مرة ثانية';
      feedback.classList.toggle('ok', ok);
      feedback.classList.toggle('err', !ok);

      // ✅ After checking (and possible solution injection), ensure visibility again
      if (!ok) {
        setTimeout(() => ensureVisible(), 80);
      }
      return ok;
    }

    // text mode
    const user = normalizeSpaces(rawUser);
    const ans = normalizeSpaces(rawAns);

    const ok = user !== '' && user === ans;

    feedback.textContent = ok ? 'إجابة صحيحة ✅' : 'مش صحيح، جرّب مرة ثانية';
    feedback.classList.toggle('ok', ok);
    feedback.classList.toggle('err', !ok);

    // ✅ After checking (and possible solution injection), ensure visibility again
    if (!ok) {
      setTimeout(() => ensureVisible(), 80);
    }
    return ok;
  }

  return { check };
}
math/public/assets/js/questions/match.js
/* =========================================================
   match.js — Matching Question (Structure Only - Phase 2)
   - For now: renders layout and always returns false
   ========================================================= */

export function renderMatchQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-match';

  const left = document.createElement('div');
  left.className = 'col';

  const right = document.createElement('div');
  right.className = 'col';

  (question.left || []).forEach((t) => {
    const item = document.createElement('div');
    item.className = 'item';
    item.textContent = t;
    left.appendChild(item);
  });

  (question.right || []).forEach((t) => {
    const item = document.createElement('div');
    item.className = 'item';
    item.textContent = t;
    right.appendChild(item);
  });

  wrap.appendChild(left);
  wrap.appendChild(right);

  mountEl.appendChild(wrap);

  function check() {
    // Phase 2: implement drag/select matching logic
    return false;
  }

  return { check };
}
math/public/assets/js/questions/mcq.js
/* =========================================================
   mcq.js — Multiple Choice Question (Single Correct)
   - Fix: enforce single selection by using one shared radio group name

   UPDATE (2026-01-14):
   - Persist MCQ selection across engine re-renders using question._selectedIndex
   ========================================================= */

export function renderMcqQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-mcq';

  const desc = document.createElement('div');
  desc.className = 'q-desc';
  desc.textContent = question.text || '';

  wrap.appendChild(desc);

  // Restore previous selection (if any)
  let selectedIndex = (typeof question._selectedIndex === 'number')
    ? question._selectedIndex
    : null;

  // IMPORTANT: one shared group name for all choices (prevents multi-select)
  const groupName = `mcq-${Math.random().toString(36).slice(2)}`;

  (question.choices || []).forEach((choice, idx) => {
    const label = document.createElement('label');
    label.className = 'choice';

    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = groupName;
    radio.value = String(idx);

    // Apply restored selection
    if (selectedIndex === idx) {
      radio.checked = true;
    }

    const span = document.createElement('span');
    span.textContent = choice;

    // Keep selectedIndex in sync + persist on question object
    radio.addEventListener('change', () => {
      selectedIndex = idx;
      question._selectedIndex = idx;
    });

    label.appendChild(radio);
    label.appendChild(span);

    wrap.appendChild(label);
  });

  const feedback = document.createElement('div');
  feedback.className = 'q-feedback';
  wrap.appendChild(feedback);

  mountEl.appendChild(wrap);

  function check() {
    // Persist selection (safety)
    if (typeof selectedIndex === 'number') {
      question._selectedIndex = selectedIndex;
    }

    const ok = selectedIndex === question.correctIndex;

    feedback.textContent = ok
      ? 'إجابة صحيحة ✅'
      : 'إجابة خاطئة ❌ حاول مرة ثانية';

    feedback.classList.toggle('ok', ok);
    feedback.classList.toggle('err', !ok);

    // visual mark
    const choicesEls = wrap.querySelectorAll('.choice');
    choicesEls.forEach((el, i) => {
      el.classList.remove('correct', 'wrong');
      if (selectedIndex != null) {
        if (i === question.correctIndex) el.classList.add('correct');
        else if (i === selectedIndex) el.classList.add('wrong');
      }
    });

    return ok;
  }

  return { check };
}
math/public/assets/js/questions/ordering.js
/* =========================================================
   ordering.js — Ordering Question (Tap/Drag into slots)
   - Horizontal pool + vertical slots
   - Keeps order state on question._order
   ========================================================= */

export function renderOrderingQuestion({ mountEl, question }) {
  mountEl.innerHTML = '';

  const wrap = document.createElement('div');
  wrap.className = 'q q-ordering';

  const desc = document.createElement('div');
  desc.className = 'q-desc';
  desc.textContent = question.text || '';

  const pool = document.createElement('div');
  pool.className = 'ordering-pool';

  const slots = document.createElement('div');
  slots.className = 'ordering-slots';

  const feedback = document.createElement('div');
  feedback.className = 'q-feedback';

  wrap.appendChild(desc);
  wrap.appendChild(pool);
  wrap.appendChild(slots);
  wrap.appendChild(feedback);

  mountEl.appendChild(wrap);

  const originalItems = Array.isArray(question.items)
    ? question.items
    : Array.isArray(question.choices)
      ? question.choices
      : [];

  function normalizeValue(value) {
    return String(value ?? '').trim().replace(/\s+/g, ' ');
  }

  function getInitialPool() {
    const items = originalItems.map((item) => String(item ?? ''));
    if (!items.length) return [];

    const shuffled = [...items];
    for (let i = shuffled.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    const sameOrder = shuffled.every((item, index) => item === items[index]);
    if (sameOrder && shuffled.length > 1) {
      [shuffled[0], shuffled[1]] = [shuffled[1], shuffled[0]];
    }

    return shuffled;
  }

  let order = Array.isArray(question._order)
    ? question._order.map((item) => (item == null ? null : String(item)))
    : Array(originalItems.length).fill(null);
  let poolItems = Array.isArray(question._pool)
    ? question._pool.map((item) => String(item ?? ''))
    : [];

  if (order.length !== originalItems.length) {
    order = Array(originalItems.length).fill(null);
  }

  const normalizedOriginal = originalItems.map((item) => String(item ?? ''));
  const used = new Set(order.filter(Boolean));

  if (!poolItems.length) {
    poolItems = getInitialPool();
  }

  poolItems = poolItems.filter((item) => !used.has(item));
  if (!poolItems.length && used.size !== normalizedOriginal.length) {
    poolItems = normalizedOriginal.filter((item) => !used.has(item));
  }

  question._order = order;
  question._pool = poolItems;

  pool.addEventListener('dragover', (event) => {
    event.preventDefault();
  });

  pool.addEventListener('drop', (event) => {
    event.preventDefault();
    const source = event.dataTransfer?.getData('application/x-order-source');
    if (source !== 'slot') return;
    const fromIndex = Number(event.dataTransfer?.getData('application/x-order-index'));
    if (!Number.isFinite(fromIndex)) return;
    removeFromSlot(fromIndex);
  });

  function getNextEmptyIndex() {
    return order.findIndex((item) => item == null);
  }

  function setActiveSlot() {
    const nextEmpty = getNextEmptyIndex();
    slots.querySelectorAll('.ordering-slot').forEach((slotEl, index) => {
      slotEl.classList.toggle('is-active', index === nextEmpty);
    });
  }

  function updateState(nextOrder, nextPool) {
    order = nextOrder;
    poolItems = nextPool;
    question._order = order;
    question._pool = poolItems;
    render();
  }

  function placeInSlot(value, slotIndex) {
    if (slotIndex < 0 || slotIndex >= order.length) return;
    const nextOrder = [...order];
    const nextPool = [...poolItems];

    const existing = nextOrder[slotIndex];
    if (existing) {
      nextPool.push(existing);
    }

    nextOrder[slotIndex] = value;
    const poolIndex = nextPool.indexOf(value);
    if (poolIndex !== -1) {
      nextPool.splice(poolIndex, 1);
    }

    updateState(nextOrder, nextPool);
  }

  function removeFromSlot(slotIndex) {
    const nextOrder = [...order];
    const nextPool = [...poolItems];
    const existing = nextOrder[slotIndex];
    if (!existing) return;
    nextOrder[slotIndex] = null;
    nextPool.push(existing);
    updateState(nextOrder, nextPool);
  }

  function moveSlotItem(fromIndex, toIndex) {
    if (fromIndex === toIndex) return;
    if (toIndex < 0 || toIndex >= order.length) return;

    const nextOrder = [...order];
    const fromValue = nextOrder[fromIndex];
    const toValue = nextOrder[toIndex];

    nextOrder[toIndex] = fromValue ?? null;
    nextOrder[fromIndex] = toValue ?? null;

    updateState(nextOrder, [...poolItems]);
  }

  function renderPool() {
    pool.innerHTML = '';

    if (!normalizedOriginal.length) {
      const empty = document.createElement('div');
      empty.className = 'ordering-empty';
      empty.textContent = 'لا توجد عناصر للترتيب.';
      pool.appendChild(empty);
      return;
    }

    poolItems.forEach((item) => {
      const pill = document.createElement('button');
      pill.type = 'button';
      pill.className = 'ordering-choice';
      pill.textContent = item;
      pill.draggable = true;

      pill.addEventListener('click', () => {
        const nextEmpty = getNextEmptyIndex();
        if (nextEmpty === -1) return;
        placeInSlot(item, nextEmpty);
      });

      pill.addEventListener('dragstart', (event) => {
        event.dataTransfer?.setData('text/plain', item);
        event.dataTransfer?.setData('application/x-order-source', 'pool');
      });

      pool.appendChild(pill);
    });

  }

  function renderSlots() {
    slots.innerHTML = '';

    normalizedOriginal.forEach((_, index) => {
      const slot = document.createElement('div');
      slot.className = 'ordering-slot';
      slot.dataset.index = String(index);

      const value = order[index];
      if (value) {
        const pill = document.createElement('div');
        pill.className = 'ordering-slot-item';
        pill.textContent = value;
        pill.draggable = true;

        pill.addEventListener('dragstart', (event) => {
          event.dataTransfer?.setData('text/plain', value);
          event.dataTransfer?.setData('application/x-order-source', 'slot');
          event.dataTransfer?.setData('application/x-order-index', String(index));
        });

        pill.addEventListener('click', () => {
          removeFromSlot(index);
        });

        slot.appendChild(pill);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'ordering-placeholder';
        placeholder.textContent = 'ضع العنصر هنا';
        slot.appendChild(placeholder);
      }

      slot.addEventListener('dragover', (event) => {
        event.preventDefault();
        slot.classList.add('is-dragover');
      });

      slot.addEventListener('dragleave', () => {
        slot.classList.remove('is-dragover');
      });

      slot.addEventListener('drop', (event) => {
        event.preventDefault();
        slot.classList.remove('is-dragover');
        const source = event.dataTransfer?.getData('application/x-order-source');
        const value = event.dataTransfer?.getData('text/plain');
        if (!value) return;

        if (source === 'pool') {
          placeInSlot(value, index);
          return;
        }

        if (source === 'slot') {
          const fromIndex = Number(event.dataTransfer?.getData('application/x-order-index'));
          if (!Number.isFinite(fromIndex)) return;
          moveSlotItem(fromIndex, index);
        }
      });

      slot.addEventListener('click', () => {
        if (!value) {
          const nextItem = poolItems[0];
          if (!nextItem) return;
          placeInSlot(nextItem, index);
        }
      });

      slots.appendChild(slot);
    });

    setActiveSlot();
  }

  function render() {
    renderPool();
    renderSlots();
  }

  render();

  function check() {
    if (!originalItems.length) {
      feedback.textContent = 'لا توجد عناصر للترتيب.';
      feedback.classList.remove('ok', 'err');
      return true;
    }

    if (order.some((item) => item == null)) {
      feedback.textContent = 'رتّب كل العناصر أولًا.';
      feedback.classList.remove('ok');
      feedback.classList.add('err');
      return false;
    }

    const normalizedOrder = order.map(normalizeValue);
    const normalizedCorrect = originalItems.map(normalizeValue);
    const ok = normalizedOrder.every((value, index) => value === normalizedCorrect[index]);

    feedback.textContent = ok
      ? 'ترتيب صحيح ✅'
      : 'الترتيب غير صحيح، جرّب مرة ثانية';

    feedback.classList.toggle('ok', ok);
    feedback.classList.toggle('err', !ok);

    return ok;
  }

  return { check };
}
math/public/assets/js/questions/registry.js
/* =========================================================
   registry.js — Question Type Registry
   - renderQuestion({ mountEl, question }) => { check() }
   ========================================================= */

import { renderInputQuestion } from './input.js';
import { renderMcqQuestion } from './mcq.js';
import { renderMatchQuestion } from './match.js';
import { renderOrderingQuestion } from './ordering.js';

const REGISTRY = {
  input: renderInputQuestion,
  mcq: renderMcqQuestion,
  match: renderMatchQuestion, // structure only for now
  ordering: renderOrderingQuestion,
};

export function renderQuestion({ mountEl, question }) {
  if (!question || !question.type) {
    throw new Error('سؤال غير صالح: type مفقود');
  }

  const renderer = REGISTRY[question.type];
  if (!renderer) {
    throw new Error(`نوع سؤال غير مدعوم: ${question.type}`);
  }

  return renderer({ mountEl, question });
}

export function registerQuestionType(type, renderer) {
  REGISTRY[type] = renderer;
}
math/public/assets/js/ui/text.js
/* =========================================================
   text.js — Default Hint & Encouragement Texts (Arabic)
   Used when JSON does not provide custom text
   ========================================================= */

/* ---------- Encouragement (after success) ---------- */
export const ENCOURAGEMENTS = [
  'رائع 👏 كمل هيك!',
  'إجابة صحيحة 👍',
  'ممتاز! واضح إنك فاهم.',
  'أحسنت 🌟',
  'تمام، ننتقل للي بعدها.'
];

/* ---------- Hints (progressive) ---------- */
export const DEFAULT_HINTS = [
  'جرّب تفكّر بالخطوة الأساسية بالسؤال.',
  'راجع المثال المحلول فوق، فيه مفتاح الحل.',
  'ركّز على المطلوب بالضبط، بدون زيادة.'
];

/* ---------- Strong Hint (last attempt) ---------- */
export const FINAL_HINT = 'خذ نفس 😌 وراجع المعطيات بهدوء، الحل أبسط مما تتوقع.';

/* ---------- Helpers ---------- */
export function pickRandom(list = []) {
  if (!list.length) return '';
  return list[Math.floor(Math.random() * list.length)];
}
math/public/assets/js/ui/toast.js
/* =========================================================
   toast.js — Material Toast with Countdown Bar
   API: showToast(title, msg, type='info', duration=3000)

   UPDATE (2026-01-14):
   - Host is pinned to TOP of the VISUAL viewport (not the layout viewport)
     using visualViewport.offsetTop/offsetLeft + height/width.
   - This avoids cases where toast appears "too high" and requires scrolling
     to reveal it on mobile browsers.
   ========================================================= */

let hostEl = null;
let activeToast = null;
let rafId = null;
let bound = false;

function ensureHost() {
  if (hostEl) return hostEl;

  hostEl = document.createElement('div');
  hostEl.className = 'toast-host';
  document.body.appendChild(hostEl);

  updateHostToVisualViewport();

  if (!bound) {
    bound = true;

    // Resize/orientation changes
    window.addEventListener('resize', updateHostToVisualViewport, { passive: true });
    window.addEventListener('scroll', updateHostToVisualViewport, { passive: true });

    // Mobile browser UI + keyboard changes
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateHostToVisualViewport, { passive: true });
      window.visualViewport.addEventListener('scroll', updateHostToVisualViewport, { passive: true });
    }
  }

  return hostEl;
}

function updateHostToVisualViewport() {
  if (!hostEl) return;

  const vv = window.visualViewport;

  // Default (no VisualViewport support)
  let top = 0;
  let left = 0;
  let width = window.innerWidth;
  let height = window.innerHeight;

  if (vv) {
    top = Math.round(vv.offsetTop || 0);
    left = Math.round(vv.offsetLeft || 0);
    width = Math.round(vv.width || window.innerWidth);
    height = Math.round(vv.height || window.innerHeight);
  }

  // Place host at the top of the VISUAL viewport.
  // We keep position:fixed + inset:0 in CSS, and move the whole host.
  hostEl.style.transform = `translate(${left}px, ${top}px)`;

  // Limit interactions area to the visible viewport (optional but clean)
  hostEl.style.width = `${width}px`;
  hostEl.style.height = `${height}px`;
}

function iconSvg(type) {
  const common = (path) => `
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="${path}"></path>
    </svg>
  `;

  if (type === 'success') {
    return common('M9 16.2l-3.5-3.5L4 14.2l5 5L20 8.2l-1.5-1.5z');
  }
  if (type === 'warning') {
    return common('M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2V10z');
  }
  if (type === 'danger' || type === 'error') {
    return common('M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z');
  }
  // info
  return common('M11 7h2v2h-2V7zm0 4h2v8h-2v-8zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z');
}

function cleanup() {
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;
  if (activeToast) {
    activeToast.remove();
    activeToast = null;
  }
}

function animateBar(barEl, duration) {
  const start = performance.now();

  const tick = (now) => {
    const elapsed = now - start;
    const t = Math.min(1, elapsed / duration);
    barEl.style.transform = `scaleX(${t})`;
    if (t < 1) {
      rafId = requestAnimationFrame(tick);
    }
  };

  rafId = requestAnimationFrame(tick);
}

export function showToast(title, msg, type = 'info', duration = 3000) {
  ensureHost();

  // Refresh position each time (mobile UI can change between toasts)
  updateHostToVisualViewport();

  // replace any existing toast (single toast policy)
  cleanup();

  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.dataset.type = type;

  toast.innerHTML = `
    <div class="toast-inner">
      <div class="toast-ic">${iconSvg(type)}</div>
      <div class="toast-content">
        <p class="toast-title">${escapeHtml(String(title || ''))}</p>
        <p class="toast-msg">${escapeHtml(String(msg || ''))}</p>
      </div>
    </div>
    <div class="toast-bar"><i></i></div>
  `;

  hostEl.appendChild(toast);
  activeToast = toast;

  requestAnimationFrame(() => {
    toast.classList.add('is-show');
  });

  const bar = toast.querySelector('.toast-bar > i');
  if (bar) animateBar(bar, duration);

  window.setTimeout(() => {
    if (!activeToast) return;
    activeToast.classList.remove('is-show');
    window.setTimeout(() => cleanup(), 260);
  }, duration);
}

function escapeHtml(s) {
  return s
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
math/public/data/cards.json
[
  {
    "week": 999,
    "title": "بطاقة تجريبية — محرك بلا حدود",
    "prereq": null
  },
  {
    "week": 1000,
    "title": "بطاقة تجريبية — المربع (خصائصه ومحيطه ومساحته)",
    "prereq": 999
  }
]
math/public/data/students.json
{
  "version": 1,
  "note": "قائمة الطلاب للتحقق (رقم الهوية + سنة الميلاد). لا تضع بيانات حساسة إضافية. يمكن إضافة 200 طالب هنا.",
  "students": [
    {
      "id": "23432",
      "birthYear": "2012",
      "firstName": "أحمد",
      "fullName": "أحمد محمد",
      "class": "7/1"
    },
    {
      "id": "998877",
      "birthYear": "2011",
      "firstName": "خالد",
      "fullName": "خالد علي",
      "class": "7/2"
    },
    {
      "id": "444422265",
      "birthYear": "2023",
      "firstName": "ميرا",
      "fullName": "ميرا احمد",
      "class": "7/2"
    },
    {
      "id": "55511001",
      "birthYear": "2013",
      "firstName": "ليان",
      "fullName": "ليان حسن",
      "class": "6/1"
    },
    {
      "id": "55511002",
      "birthYear": "2012",
      "firstName": "سامي",
      "fullName": "سامي ناصر",
      "class": "6/2"
    },
    {
      "id": "55511003",
      "birthYear": "2011",
      "firstName": "هيا",
      "fullName": "هيا محمود",
      "class": "6/3"
    }
  ]
}
math/public/data/weeks/week1000.json
{
  "week": 1000,
  "title": "بطاقة المربع — خصائصه ومحيطه ومساحته",
  "goals": [
    "التعرّف على خصائص المربع وطريقة حساب محيطه.",
    "إتقان حساب مساحة المربع باستخدام طول الضلع."
  ],
  "prerequisites": [
    "معرفة مفهوم المحيط والمساحة بشكل عام.",
    "إتقان عمليات الجمع والضرب الأساسية."
  ],
  "assessment": {
    "title": "تقييم ختامي للمربع",
    "description": "أجب عن الأسئلة التالية لتحصل على نقاطك. بدون تصويب فوري.",
    "questions": [
      {
        "type": "input",
        "text": "طول ضلع مربع = 4 سم. ما محيطه؟",
        "answer": "16",
        "points": 2
      },
      {
        "type": "mcq",
        "text": "أي عبارة صحيحة عن المربع؟",
        "choices": [
          "كل زواياه حادة",
          "كل أضلاعه متساوية",
          "له ضلعان متساويان فقط",
          "ليس له زوايا قائمة"
        ],
        "correctIndex": 1,
        "points": 2
      },
      {
        "type": "input",
        "text": "طول ضلع مربع = 6 سم. ما مساحته؟",
        "answer": "36",
        "points": 3
      }
    ]
  },
  "concepts": [
    {
      "title": "خصائص المربع ومحيطه",
      "flow": [
        {
          "type": "goal",
          "text": "أن يتعرّف الطالب خصائص الشكل المربع وكيف نحسب محيطه.",
          "details": [
            "المربع شكل رباعي منتظم.",
            "جميع الأضلاع متساوية.",
            "كل زاوية تساوي 90°"
          ]
        },
        {
          "type": "explain",
          "text": "المربع شكل رباعي: أضلاعه الأربعة متساوية وزواياه قائمة (90°)."
        },
        {
          "type": "video",
          "title": "فيديو سريع عن خصائص المربع",
          "description": "شاهد هذا الفيديو لتثبيت فكرة الزوايا والأضلاع المتساوية.",
          "url": "https://www.youtube.com/watch?v=9e3r0W0bKpg"
        },
        {
          "type": "example",
          "text": "إذا كان طول ضلع المربع 5 سم، فمحيطه = 5 + 5 + 5 + 5 = 20 سم.",
          "details": [
            "قاعدة المحيط: 4 × طول الضلع.",
            "يمكنك أيضًا جمع الضلع 4 مرات."
          ]
        },
        {
          "type": "question",
          "text": "سؤال 1: طول ضلع مربع = 7 سم. ما محيطه؟",
          "answer": "28",
          "hints": [
            "محيط المربع = 4 × طول الضلع.",
            "4 × 7 = ؟",
            "اجمع 7 أربع مرات."
          ],
          "solution": "محيط المربع = 4 × 7 = 28 سم."
        },
        {
          "type": "question",
          "text": "سؤال 2: أي عبارة صحيحة عن المربع؟",
          "choices": [
            "له ضلعان متساويان فقط",
            "كل زواياه قائمة",
            "محيطه = طول الضلع × 2",
            "لا يملك أضلاعًا متوازية"
          ],
          "correctIndex": 1,
          "hints": [
            "المربع شكل رباعي منتظم.",
            "كل زواياه 90°.",
            "أضلاعه الأربعة متساوية."
          ],
          "solution": "العبارة الصحيحة: كل زوايا المربع قائمة."
        }
      ]
    },
    {
      "title": "مساحة المربع",
      "flow": [
        {
          "type": "goal",
          "text": "أن يحسب الطالب مساحة المربع باستخدام طول الضلع.",
          "details": [
            "مساحة المربع تعتمد على الضلع فقط.",
            "الوحدة تكون مربعة (سم²)."
          ]
        },
        {
          "type": "explain",
          "text": "مساحة المربع = طول الضلع × طول الضلع (الضلع²)."
        },
        {
          "type": "example",
          "text": "إذا كان طول الضلع 6 سم، فالمساحة = 6 × 6 = 36 سم²."
        },
        {
          "type": "question",
          "text": "سؤال 3: طول ضلع مربع = 9 سم. ما مساحته؟",
          "answer": "81",
          "hints": [
            "المساحة = الضلع × الضلع.",
            "9 × 9 = ؟",
            "اكتب الناتج فقط."
          ],
          "solution": "مساحة المربع = 9 × 9 = 81 سم²."
        },
        {
          "type": "note",
          "text": "تذكّر: المحيط يقيس طول الحدود، بينما المساحة تقيس مقدار السطح."
        }
      ]
    }
  ]
}
math/public/data/weeks/week999.json
{
  "week": 999,
  "title": "بطاقة تجريبية (week 999) — اختبار الـ Flow",
  "goals": [
    "فهم فكرة التدرّج وزر المتابعة.",
    "إتقان حل مسائل القسمة الأساسية."
  ],
  "prerequisites": [
    "إتقان جداول الضرب البسيطة.",
    "معرفة معنى القسمة كعملية توزيع متساوي."
  ],
  "assessment": {
    "title": "تقييم سريع للقسمة",
    "description": "أجب عن الأسئلة واحصل على نقاطك (بدون تصويب فوري).",
    "questions": [
      {
        "type": "input",
        "text": "اكتب ناتج 8 ÷ 4",
        "answer": "2",
        "points": 2
      },
      {
        "type": "mcq",
        "text": "أي عبارة صحيحة؟",
        "choices": ["6 ÷ 3 = 1", "6 ÷ 3 = 2", "6 ÷ 3 = 4"],
        "correctIndex": 1,
        "points": 2
      }
    ]
  },
  "concepts": [
    {
      "title": "اختبار تدفّق بلا حدود",
      "flow": [
        {
          "type": "goal",
          "text": "أن يفهم الطالب فكرة التدرّج، وأن زر (متابعة) يتحول للتحقق عند الأسئلة.",
          "details": [
            "كل متابعة تكشف عنصرًا جديدًا.",
            "عند السؤال تتحول المتابعة للتحقق."
          ]
        },
        {
          "type": "explain",
          "text": "في هذا النظام: كل ضغطة (متابعة) تكشف العنصر التالي. عند السؤال، نفس الزر يصبح تحقق للسؤال الحالي."
        },
        {
          "type": "example",
          "text": "مثال سريع: 6 ÷ 3 = 2 لأن 3 تدخل في 6 مرتين."
        },
        {
          "type": "question",
          "text": "السؤال 1: اكتب ناتج 6 ÷ 3",
          "answer": "2",
          "hints": [
            "تذكّر: كم مرة 3 تدخل في 6؟",
            "جرّب: 3 + 3 = 6، إذن مرتين.",
            "قسم 6 على 3 بالتساوي: نصيب كل واحد 2."
          ],
          "solution": "6 ÷ 3 = 2 لأن 3 تدخل في 6 مرتين."
        },
        {
          "type": "question",
          "text": "السؤال 2: أي عبارة صحيحة؟",
          "choices": ["9 ÷ 3 = 2", "9 ÷ 3 = 3", "9 ÷ 3 = 4", "9 ÷ 3 = 5"],
          "correctIndex": 1,
          "hints": [
            "تحقق بالضرب: 3 × ؟ = 9",
            "العدد اللي إذا ضربناه في 3 يعطينا 9 هو 3.",
            "9 = 3 + 3 + 3 (ثلاث مرات)."
          ],
          "solution": "الإجابة الصحيحة: 9 ÷ 3 = 3 لأن 3 × 3 = 9."
        },
        {
          "type": "note",
          "text": "ملاحظة: لاحظ كيف نفس زر (متابعة) كان تحقق للسؤال 1 ثم صار تحقق للسؤال 2."
        }
      ]
    },
    {
      "title": "مفهوم إضافي (تجربة انتقال)",
      "flow": [
        {
          "type": "goal",
          "text": "أن يميّز الطالب العلاقة بين القسمة والضرب.",
          "details": [
            "القسمة عكس الضرب.",
            "التحقق يكون بضرب الناتج في المقسوم عليه."
          ]
        },
        {
          "type": "explain",
          "text": "إذا كان a ÷ b = c فهذا يعني أن b × c = a. نستخدم الضرب للتحقق."
        },
        {
          "type": "question",
          "text": "اكتب عددًا يجعل: 5 × □ = 20",
          "answer": "4",
          "hints": [
            "ابحث عن عدد إذا ضربته في 5 يعطي 20.",
            "20 ÷ 5 = ؟",
            "العدد هو 4 لأن 5 × 4 = 20."
          ],
          "solution": "العدد هو 4 لأن 20 ÷ 5 = 4، وبالتالي 5 × 4 = 20."
        }
      ]
    }
  ]
}
math/public/docs/database-schema.md
# Database Schema Reference

> Source: user-provided table/column summary for the Math app database.

## AssessmentQuestionChoices

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| AssessmentChoiceId | int |  | NO |
| AssessmentQuestionId | int |  | NO |
| SortOrder | int |  | NO |
| ChoiceText | nvarchar | 300 | NO |

## AssessmentQuestions

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| AssessmentQuestionId | int |  | NO |
| AssessmentId | int |  | NO |
| SortOrder | int |  | NO |
| QuestionType | nvarchar | 50 | NO |
| QuestionText | nvarchar | 500 | NO |
| Answer | nvarchar | 200 | YES |
| Points | int |  | NO |
| CorrectIndex | int |  | YES |

## Assessments

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| AssessmentId | int |  | NO |
| Week | int |  | NO |
| Title | nvarchar | 300 | NO |
| Description | nvarchar | 500 | NO |

## CardCompletions

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| CompletionId | int |  | NO |
| StudentId | nvarchar | 20 | NO |
| Week | int |  | NO |
| FinalScore | int |  | NO |
| CompletedAt | datetime |  | NO |

## Cards

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| Week | int |  | NO |
| Title | nvarchar | 300 | NO |
| PrereqWeek | int |  | YES |

## Concepts

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| ConceptId | int |  | NO |
| Week | int |  | NO |
| SortOrder | int |  | NO |
| Title | nvarchar | 300 | NO |

## database_firewall_rules

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| id | int |  | NO |
| name | nvarchar | 128 | NO |
| start_ip_address | varchar | 45 | NO |
| end_ip_address | varchar | 45 | NO |
| create_date | datetime |  | NO |
| modify_date | datetime |  | NO |

## FlowItemChoices

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemChoiceId | int |  | NO |
| FlowItemId | int |  | NO |
| SortOrder | int |  | NO |
| ChoiceText | nvarchar | 300 | NO |

## FlowItemDetails

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemDetailId | int |  | NO |
| FlowItemId | int |  | NO |
| SortOrder | int |  | NO |
| DetailText | nvarchar | 500 | NO |

## FlowItemHints

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemHintId | int |  | NO |
| FlowItemId | int |  | NO |
| SortOrder | int |  | NO |
| HintText | nvarchar | 500 | NO |

## FlowItems

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| FlowItemId | int |  | NO |
| ConceptId | int |  | NO |
| SortOrder | int |  | NO |
| ItemType | nvarchar | 50 | NO |
| ItemText | nvarchar | 1000 | YES |
| ItemTitle | nvarchar | 300 | YES |
| ItemDescription | nvarchar | 500 | YES |
| ItemUrl | nvarchar | 500 | YES |
| Answer | nvarchar | 200 | YES |
| CorrectIndex | int |  | YES |
| Solution | nvarchar | 1000 | YES |

## Students

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| StudentId | nvarchar | 20 | NO |
| BirthYear | nvarchar | 10 | NO |
| FirstName | nvarchar | 100 | NO |
| FullName | nvarchar | 200 | NO |
| Class | nvarchar | 20 | NO |

## WeekGoals

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| GoalId | int |  | NO |
| Week | int |  | NO |
| SortOrder | int |  | NO |
| GoalText | nvarchar | 500 | NO |

## WeekPrerequisites

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| PrerequisiteId | int |  | NO |
| Week | int |  | NO |
| SortOrder | int |  | NO |
| PrerequisiteText | nvarchar | 500 | NO |

## Weeks

| Column | Type | Max Length | Nullable |
| --- | --- | --- | --- |
| Week | int |  | NO |
| Title | nvarchar | 300 | NO |
math/public/index.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — منصة الرياضيات</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
</head>

<body class="is-loading">
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="math">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
          </div>
        </div>

        <div class="row">
          <a class="btn btn-ghost btn-sm" href="/" aria-label="الصفحة الرئيسية">
            الرئيسية
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <!-- Screen: ID -->
      <section id="screen-id" class="stack">
        <div class="card">
          <div class="card-header">
            <div>
              <h1 class="h1">تسجيل الدخول</h1>
              <p class="p">أدخل رقم الهوية للمتابعة وحفظ التقدم.</p>
            </div>
            <span class="badge primary">نهاري</span>
          </div>

          <div class="card-body">
            <div class="field">
              <label class="label" for="studentId">رقم الهوية</label>
              <input id="studentId" class="input ltr" inputmode="numeric" autocomplete="off" placeholder="مثال: 123456789" />
              <div class="help">يُستخدم لحفظ التقدم على هذا الجهاز.</div>
            </div>

            <div class="row">
              <button id="btnLogin" class="btn btn-primary btn-lg w-100">دخول</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Screen: Welcome -->
      <section id="screen-welcome" class="stack hidden" hidden style="display:none;">
        <div class="card">
          <div class="card-header">
            <div>
              <h1 class="h1" id="welcomeTitle">مرحبًا 👋</h1>
              <p class="p" id="welcomeSub">هل تريد البدء ببطاقات الأسبوع؟</p>
            </div>
            <span class="badge primary" id="welcomeChip">طالب</span>
          </div>

          <div class="card-body">
            <div class="field">
              <label class="label">اسم الطالب</label>
              <div id="welcomeName" class="input is-static" role="status">طالب</div>
              <div class="help">يمكنك تغيير رقم الهوية من الزر أدناه.</div>
            </div>
            <button id="btnToCards" class="btn btn-primary btn-lg w-100">عرض البطاقات</button>
            <button id="btnChangeId" class="btn btn-outline w-100">تغيير رقم الهوية</button>
          </div>
        </div>
      </section>

      <!-- Screen: Cards -->
      <section id="screen-cards" class="stack hidden" hidden style="display:none;">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="h2">بطاقات الأسابيع</h2>
              <p class="p">اختر بطاقة مفتوحة؛ تُفتح البطاقات المقفلة بعد إكمال السابقة.</p>
            </div>
            <div class="row">
              <span class="badge primary" id="cardsStudentName">طالب</span>
              <button id="btnLogout" class="btn btn-ghost btn-sm">تبديل الطالب</button>
            </div>
          </div>

          <div class="card-body">
            <div id="cardsList" class="grid cards" aria-live="polite"></div>
          </div>

          <div class="card-footer">
            <span class="small">بطاقة تجريبية: week=999</span>
          </div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — منصة تعليمية تفاعلية</p>
    </footer>
  </div>

  <script type="module" src="/assets/js/app.js"></script>
</body>
</html>
math/public/lesson.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — الدرس</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/lesson.css" />
  <link rel="stylesheet" href="/assets/css/questions.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
</head>

<body>
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>درس تفاعلي</span>
          </div>
        </div>

        <a id="btnBackHome" class="btn btn-ghost btn-sm" href="/" aria-label="العودة للبطاقات">
          العودة للبطاقات
        </a>
      </div>
    </header>

    <main class="container section">
      <!-- Lesson Header -->
      <section class="lesson-header">
        <div class="lesson-title">
          <h1 id="lessonTitle" class="h1">تحميل البطاقة...</h1>
          <div class="lesson-meta">
            <span id="lessonStudent" class="lesson-student">طالب</span>
            <span id="lessonWeek" class="badge primary">week</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="progress-wrap">
          <div class="progress-label">
            <span>مستوى الفهم</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress">
            <i id="progressBar"></i>
          </div>
        </div>
      </section>

      <!-- Lesson Content -->
      <section id="lessonContent" class="stack" aria-live="polite">
        <!-- Concepts rendered here by engine -->
      </section>

      <!-- Completion -->
      <section id="lessonComplete" class="lesson-complete hidden" hidden>
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="h2">أحسنت 🎉</h2>
              <p class="p">أنهيت البطاقة بنجاح.</p>
            </div>
            <span class="badge done">منجزة</span>
          </div>

          <div class="card-body">
            <p class="p">تم حفظ الإنجاز، ويمكنك العودة للبطاقات لمتابعة التالي.</p>
            <div class="row">
              <a href="/" class="btn btn-primary btn-lg w-100">العودة للبطاقات</a>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — محرك دروس تفاعلي</p>
    </footer>
  </div>

  <script type="module" src="/assets/js/app.js"></script>
</body>
</html>
math/public/mng/card-editor.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — محرر محتوى البطاقة</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
  <link rel="stylesheet" href="/assets/css/mng/manager.css" />
  <link rel="stylesheet" href="/assets/css/mng/card-editor.css" />
</head>

<body>
  <div class="page-shell">
    <header class="editor-header">
      <div class="container header-inner">
        <div>
          <a id="btnBack" class="btn btn-ghost btn-sm" href="/mng/cards.html">رجوع للبطاقات</a>
          <h1 class="editor-title" id="cardTitle">بطاقة رقم —</h1>
          <p class="editor-subtitle" id="cardSubtitle">تحميل البيانات...</p>
        </div>
        <button id="btnSave" class="btn btn-primary">حفظ الآن</button>
      </div>
    </header>

    <main class="container editor-layout">
      <aside class="editor-sidebar">
        <div class="sidebar-title">الأقسام</div>
        <ul id="sectionsList" class="sidebar-list"></ul>
      </aside>

      <section class="editor-panel">
        <div id="editorContent">تحميل المحتوى...</div>
      </section>
    </main>

    <div class="floating-actions">
      <button id="btnAddConcept" class="btn btn-outline">إضافة قسم/مفهوم</button>
      <button id="btnAddItem" class="btn btn-outline">إضافة عنصر</button>
      <button id="btnAddQuestion" class="btn btn-outline">إضافة سؤال</button>
    </div>
  </div>

  <div id="confirmLeave" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-sm" role="dialog" aria-modal="true" aria-labelledby="confirmLeaveTitle">
      <div class="modal-header">
        <h2 id="confirmLeaveTitle" class="h2">تغييرات غير محفوظة</h2>
        <button id="btnCloseLeave" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <p class="p">لديك تغييرات غير محفوظة. هل تريد المتابعة بدون حفظ؟</p>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnConfirmLeave" class="btn btn-primary" type="button">متابعة بدون حفظ</button>
        <button id="btnCancelLeave" class="btn btn-outline" type="button">إلغاء</button>
      </div>
    </div>
  </div>

  <script type="module" src="/assets/js/mng/cardEditor.js"></script>
</body>
</html>
math/public/mng/cards.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — إدارة البطاقات</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
  <link rel="stylesheet" href="/assets/css/mng/manager.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="math">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>لوحة إدارة البطاقات</span>
          </div>
        </div>

        <div class="row">
          <a class="btn btn-ghost btn-sm" href="/" aria-label="الصفحة الرئيسية">
            الرئيسية
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <div class="warning-banner" role="alert">
        ⚠️ صفحة إدارة تجريبية — لا تُدخل بيانات حقيقية
      </div>

      <section class="card manager-card">
        <div class="card-header">
          <div>
            <h1 class="h1">Cards Manager</h1>
            <p class="p">إدارة بطاقات الأسابيع (عرض، إضافة، تعديل، حذف).</p>
          </div>
          <span class="badge primary">بدون تسجيل دخول</span>
        </div>

        <div class="card-body">
          <div class="manager-toolbar">
            <div class="row">
              <button id="btnAddCard" class="btn btn-primary">إضافة بطاقة</button>
              <button id="btnDeleteSelected" class="btn btn-outline" disabled>حذف المحدد</button>
              <button id="btnExportCards" class="btn btn-outline" disabled>تصدير Excel</button>
            </div>
            <div class="row filter-row">
              <div class="field">
                <label class="label" for="gradeFilter">الصف</label>
                <select id="gradeFilter" class="input">
                  <option value="">كل الصفوف</option>
                  <option value="1">الأول</option>
                  <option value="2">الثاني</option>
                  <option value="3">الثالث</option>
                  <option value="4">الرابع</option>
                  <option value="5">الخامس</option>
                  <option value="6">السادس</option>
                  <option value="7">السابع</option>
                  <option value="8">الثامن</option>
                  <option value="9">التاسع</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="classFilter">الشعبة</label>
                <select id="classFilter" class="input" disabled>
                  <option value="">كل الشعب</option>
                </select>
              </div>
            </div>
            <div class="row search-row">
              <div class="field w-100">
                <label class="label" for="searchInput">بحث سريع</label>
                <input id="searchInput" class="input" placeholder="ابحث برقم البطاقة أو العنوان" autocomplete="off" />
              </div>
              <button id="btnSearch" class="btn btn-outline">بحث</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table" aria-live="polite">
              <thead>
                <tr>
                  <th class="select-cell">
                    <input id="selectAllCards" type="checkbox" aria-label="تحديد الكل" />
                  </th>
                  <th>رقم البطاقة</th>
                  <th>العنوان</th>
                  <th>الصف</th>
                  <th>الشعب المستهدفة</th>
                  <th>المتطلب السابق</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="cardsBody">
                <tr>
                  <td colspan="7" class="muted center">تحميل البيانات...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — لوحة إدارة تجريبية</p>
    </footer>
  </div>

  <div id="cardModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle" class="h2">إضافة بطاقة</h2>
        <button id="btnCloseModal" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <form id="cardForm" class="modal-body">
        <div class="field" id="weekDisplayRow">
          <label class="label">معرف البطاقة</label>
          <div id="weekDisplay" class="help">—</div>
        </div>
        <div class="field">
          <label class="label" for="titleInput">العنوان</label>
          <input id="titleInput" class="input" autocomplete="off" required />
        </div>
        <div class="field">
          <label class="label" for="gradeInput">الصف</label>
          <select id="gradeInput" class="input" required>
            <option value="">اختر الصف</option>
            <option value="1">الأول</option>
            <option value="2">الثاني</option>
            <option value="3">الثالث</option>
            <option value="4">الرابع</option>
            <option value="5">الخامس</option>
            <option value="6">السادس</option>
            <option value="7">السابع</option>
            <option value="8">الثامن</option>
            <option value="9">التاسع</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="prereqSelect">المتطلب السابق</label>
          <select id="prereqSelect" class="input"></select>
          <div class="help">اختياري — تظهر بطاقات الصف نفسه فقط.</div>
        </div>
        <div class="field">
          <label class="label">الشعب المستهدفة</label>
          <label class="label" for="allClassesToggle">
            <input id="allClassesToggle" type="checkbox" checked />
            كل الشعب
          </label>
          <div id="classesPicker" class="field">
            <div class="row" id="classesOptions"></div>
            <div class="field">
              <label class="label" for="classesManual">إدخال يدوي (مفصول بفواصل)</label>
              <input id="classesManual" class="input" placeholder="مثال: 1,2,3" autocomplete="off" />
            </div>
          </div>
        </div>

        <div class="modal-footer modal-actions">
          <button id="btnSubmit" class="btn btn-primary" type="submit">حفظ</button>
          <button id="btnCancel" class="btn btn-outline" type="button">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirmModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-header">
        <h2 id="confirmTitle" class="h2">تأكيد الحذف</h2>
        <button id="btnCloseConfirm" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" class="p">هل أنت متأكد من حذف البطاقة؟</p>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnConfirmDelete" class="btn btn-primary" type="button">تأكيد الحذف</button>
        <button id="btnCancelDelete" class="btn btn-outline" type="button">إلغاء</button>
      </div>
    </div>
  </div>

  <div id="completionsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="completionsTitle">
      <div class="modal-header">
        <h2 id="completionsTitle" class="h2">من أنهى البطاقة</h2>
        <button id="btnCloseCompletions" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <div class="row space-between">
          <p id="completionsSubtitle" class="p muted">جاري التحميل...</p>
        </div>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>رقم الطالب</th>
                <th>الاسم</th>
                <th>الشعبة</th>
                <th>النتيجة</th>
                <th>تاريخ الإكمال</th>
              </tr>
            </thead>
            <tbody id="completionsBody">
              <tr>
                <td colspan="5" class="muted center">تحميل البيانات...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module" src="/assets/js/mng/cardsManager.js"></script>
</body>
</html>
math/public/mng/students.html
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>math — إدارة الطلاب</title>

  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/toast.css" />
  <link rel="stylesheet" href="/assets/css/mng/manager.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="container topbar-inner">
        <div class="brand" aria-label="math">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <b>math</b>
            <span>لوحة إدارة الطلاب</span>
          </div>
        </div>

        <div class="row">
          <a class="btn btn-ghost btn-sm" href="/" aria-label="الصفحة الرئيسية">
            الرئيسية
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <div class="warning-banner" role="alert">
        ⚠️ صفحة إدارة تجريبية — لا تُدخل بيانات حقيقية
      </div>

      <section class="card manager-card">
        <div class="card-header">
          <div>
            <h1 class="h1">Student Manager</h1>
            <p class="p">إدارة بيانات الطلاب (عرض، إضافة، تعديل، حذف).</p>
          </div>
          <span class="badge primary">بدون تسجيل دخول</span>
        </div>

        <div class="card-body">
          <div class="manager-toolbar">
          <div class="row">
            <button id="btnAddStudent" class="btn btn-primary">إضافة طالب</button>
            <button id="btnImportStudents" class="btn btn-outline">استيراد من Excel</button>
            <button id="btnDeleteSelected" class="btn btn-outline" disabled>حذف المحدد</button>
            <button id="btnExportStudents" class="btn btn-outline" disabled>تصدير Excel</button>
          </div>
            <div class="row filter-row">
              <div class="field">
                <label class="label" for="gradeFilter">الصف</label>
                <select id="gradeFilter" class="input">
                  <option value="">كل الصفوف</option>
                  <option value="1">الأول</option>
                  <option value="2">الثاني</option>
                  <option value="3">الثالث</option>
                  <option value="4">الرابع</option>
                  <option value="5">الخامس</option>
                  <option value="6">السادس</option>
                  <option value="7">السابع</option>
                  <option value="8">الثامن</option>
                  <option value="9">التاسع</option>
                </select>
              </div>
              <div class="field">
                <label class="label" for="classFilter">الشعبة</label>
                <select id="classFilter" class="input" disabled>
                  <option value="">كل الشعب</option>
                </select>
              </div>
            </div>
            <div class="row search-row">
              <div class="field w-100">
                <label class="label" for="searchInput">بحث سريع</label>
                <input id="searchInput" class="input" placeholder="ابحث بالهوية أو الاسم" autocomplete="off" />
              </div>
              <button id="btnSearch" class="btn btn-outline">بحث</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="table" aria-live="polite">
              <thead>
                <tr>
                  <th class="select-cell">
                    <input id="selectAllStudents" type="checkbox" aria-label="تحديد الكل" />
                  </th>
                  <th>رقم الهوية</th>
                  <th>سنة الميلاد</th>
                  <th>الاسم الرباعي</th>
                  <th>الصف</th>
                  <th>الشعبة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="studentsBody">
                <tr>
                  <td colspan="7" class="muted center">تحميل البيانات...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="studentsPagination" class="pagination" aria-label="الصفحات"></div>
        </div>
      </section>
    </main>

    <footer class="container section center">
      <p class="small">© math — لوحة إدارة تجريبية</p>
    </footer>
  </div>

  <div id="studentModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle" class="h2">إضافة طالب</h2>
        <button id="btnCloseModal" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <form id="studentForm" class="modal-body">
        <div class="field">
          <label class="label" for="studentIdInput">رقم الهوية</label>
          <input id="studentIdInput" class="input ltr" inputmode="numeric" autocomplete="off" required />
        </div>
        <div class="field">
          <label class="label">تاريخ الميلاد</label>
          <div class="wheel-row">
            <div id="wheelYear" class="wheel" aria-label="السنة"></div>
            <div id="wheelMonth" class="wheel" aria-label="الشهر"></div>
            <div id="wheelDay" class="wheel" aria-label="اليوم"></div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="nameInput">الاسم الرباعي</label>
          <input id="nameInput" class="input" autocomplete="off" required />
        </div>
        <div class="field">
          <label class="label" for="firstNameInput">الاسم الأول</label>
          <input id="firstNameInput" class="input" autocomplete="off" />
        </div>
        <div class="field">
          <label class="label">الصف</label>
          <div id="wheelGrade" class="wheel" aria-label="الصف"></div>
        </div>
        <div class="field">
          <label class="label" for="classInput">الشعبة</label>
          <input id="classInput" class="input" autocomplete="off" />
        </div>

        <div class="modal-footer modal-actions">
          <button id="btnSubmit" class="btn btn-primary" type="submit">حفظ</button>
          <button id="btnCancel" class="btn btn-outline" type="button">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirmModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-header">
        <h2 id="confirmTitle" class="h2">تأكيد الحذف</h2>
        <button id="btnCloseConfirm" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" class="p">هل أنت متأكد من حذف الطالب؟</p>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnConfirmDelete" class="btn btn-primary" type="button">تأكيد الحذف</button>
        <button id="btnCancelDelete" class="btn btn-outline" type="button">إلغاء</button>
      </div>
    </div>
  </div>

  <div id="importModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card modal-card-lg" role="dialog" aria-modal="true" aria-labelledby="importTitle">
      <div class="modal-header">
        <h2 id="importTitle" class="h2">استيراد الطلاب من Excel</h2>
        <button id="btnCloseImport" class="btn btn-ghost btn-sm" type="button">إغلاق</button>
      </div>
      <div class="modal-body">
        <div class="import-grid">
          <div class="field">
            <label class="label" for="importFile">ملف Excel أو CSV</label>
            <input id="importFile" class="input" type="file" accept=".xlsx,.csv" />
          </div>
          <div class="field field-inline">
            <label class="label" for="importHasHeader">
              <input id="importHasHeader" type="checkbox" checked />
              الصف الأول يحتوي عناوين
            </label>
          </div>
        </div>

        <div class="import-preview">
          <h3 class="h3">معاينة البيانات (أول 10 صفوف)</h3>
          <div class="preview-table">
            <table class="table table-compact" aria-live="polite">
              <thead id="importPreviewHead"></thead>
              <tbody id="importPreviewBody">
                <tr>
                  <td class="muted center">اختر ملفًا لعرض المعاينة.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="import-mapping">
          <h3 class="h3">تعيين الأعمدة</h3>
          <div class="mapping-grid">
            <div class="field">
              <label class="label" for="mapStudentId">رقم الهوية (إلزامي)</label>
              <select id="mapStudentId" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapName">الاسم (إلزامي)</label>
              <select id="mapName" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapBirthDate">تاريخ الميلاد (إلزامي)</label>
              <select id="mapBirthDate" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapGrade">الصف (اختياري)</label>
              <select id="mapGrade" class="input"></select>
            </div>
            <div class="field">
              <label class="label" for="mapClass">الشعبة (اختياري)</label>
              <select id="mapClass" class="input"></select>
            </div>
          </div>
        </div>

        <div class="import-actions">
          <button id="btnImportValidate" class="btn btn-outline" type="button">تحقق</button>
          <button id="btnImportExecute" class="btn btn-primary" type="button" disabled>تنفيذ الاستيراد</button>
        </div>

        <div class="import-progress">
          <div class="progress-header">
            <span class="muted">تقدّم التنفيذ</span>
            <span id="importProgressLabel" class="muted">0%</span>
          </div>
          <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div id="importProgressBar" class="progress-bar"></div>
          </div>
        </div>

        <div class="import-results">
          <h3 class="h3">النتائج</h3>
          <div id="importSummary" class="result-summary muted">لم يتم تنفيذ أي عملية بعد.</div>
          <div class="result-actions">
            <button id="btnDownloadSkipped" class="btn btn-outline btn-sm" type="button" disabled>تنزيل تقرير المتخطّين</button>
            <button id="btnDownloadErrors" class="btn btn-outline btn-sm" type="button" disabled>تنزيل تقرير الأخطاء</button>
          </div>
          <div class="field">
            <label class="label" for="importTeacherNote">نص موجّه للمعلم (قابل للنسخ)</label>
            <textarea id="importTeacherNote" class="input" rows="4" readonly></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer modal-actions">
        <button id="btnCancelImport" class="btn btn-outline" type="button">إغلاق</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module" src="/assets/js/mng/studentsManager.js"></script>
</body>
</html>
math/sql/migrations/2026-01-21_weeks_grade_weektargets.sql
IF COL_LENGTH('dbo.Weeks', 'Grade') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD Grade NVARCHAR(50) NULL;
END

IF COL_LENGTH('dbo.Weeks', 'IsDeleted') IS NULL
BEGIN
  ALTER TABLE dbo.Weeks
    ADD IsDeleted BIT NOT NULL
      CONSTRAINT DF_Weeks_IsDeleted DEFAULT(0);
END

IF OBJECT_ID('dbo.WeekTargets', 'U') IS NULL
BEGIN
  CREATE TABLE dbo.WeekTargets (
    Week INT NOT NULL,
    Class NVARCHAR(50) NOT NULL,
    CONSTRAINT PK_WeekTargets PRIMARY KEY (Week, Class),
    CONSTRAINT FK_WeekTargets_Weeks FOREIGN KEY (Week) REFERENCES dbo.Weeks(Week)
  );
END

IF OBJECT_ID('dbo.WeekTargets', 'U') IS NOT NULL
  AND NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IX_WeekTargets_Class'
      AND object_id = OBJECT_ID('dbo.WeekTargets')
  )
BEGIN
  CREATE INDEX IX_WeekTargets_Class ON dbo.WeekTargets(Class);
END

IF OBJECT_ID('dbo.WeekTargets', 'U') IS NOT NULL
  AND NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IX_WeekTargets_Week'
      AND object_id = OBJECT_ID('dbo.WeekTargets')
  )
BEGIN
  CREATE INDEX IX_WeekTargets_Week ON dbo.WeekTargets(Week);
END
